{
  "generatedAt": "2026-01-17T18:01:02.076Z",
  "modelId": "openai/gpt-5.2",
  "outputs": [
    {
      "duration": 31651.611125,
      "inputTokens": 4058,
      "output": "{\n  \"intro\": \"{{NAME}}, our search service is melting under peak traffic. You’re leading the fix: pick data structures and algorithms that keep requests fast without blowing our memory budget or risking nasty worst-case slowdowns. Hit the targets before tonight’s product demo.\",\n  \"inventory\": [\n    {\n      \"name\": \"P95 Latency (ms)\",\n      \"startValue\": 60,\n      \"winConditions\": [\n        {\n          \"operator\": \"lte\",\n          \"value\": 55\n        }\n      ]\n    },\n    {\n      \"name\": \"Memory Footprint\",\n      \"startValue\": 55,\n      \"winConditions\": [\n        {\n          \"operator\": \"lte\",\n          \"value\": 70\n        }\n      ]\n    },\n    {\n      \"name\": \"Worst-Case Slowdown Risk\",\n      \"startValue\": 50,\n      \"winConditions\": [\n        {\n          \"operator\": \"lte\",\n          \"value\": 55\n        }\n      ]\n    },\n    {\n      \"name\": \"Update Throughput\",\n      \"startValue\": 50,\n      \"winConditions\": [\n        {\n          \"operator\": \"gte\",\n          \"value\": 55\n        }\n      ]\n    }\n  ],\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, first decision: our hot path is lookups by userId. Right now it’s a linear scan through a list, and it hurts when the list grows. We can change the structure, but each option has a catch.\",\n      \"options\": [\n        {\n          \"effects\": [\n            {\n              \"change\": -15,\n              \"variable\": \"P95 Latency (ms)\"\n            },\n            {\n              \"change\": 15,\n              \"variable\": \"Memory Footprint\"\n            },\n            {\n              \"change\": -5,\n              \"variable\": \"Worst-Case Slowdown Risk\"\n            }\n          ],\n          \"feedback\": \"A hash table makes average lookup close to O(1), so P95 latency drops. But storing buckets and overhead increases memory. Risk drops a bit because we avoid O(n) scans as inputs grow.\",\n          \"text\": \"Switch to a hash table index\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": -8,\n              \"variable\": \"P95 Latency (ms)\"\n            },\n            {\n              \"change\": 3,\n              \"variable\": \"Memory Footprint\"\n            },\n            {\n              \"change\": -10,\n              \"variable\": \"Worst-Case Slowdown Risk\"\n            }\n          ],\n          \"feedback\": \"Keeping a sorted array enables binary search at O(log n), improving latency with minimal extra memory. Worst-case risk falls because performance is predictable, but maintaining sort has downstream costs.\",\n          \"text\": \"Keep a sorted array + binary search\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": -10,\n              \"variable\": \"P95 Latency (ms)\"\n            },\n            {\n              \"change\": 0,\n              \"variable\": \"Memory Footprint\"\n            },\n            {\n              \"change\": 10,\n              \"variable\": \"Worst-Case Slowdown Risk\"\n            },\n            {\n              \"change\": -8,\n              \"variable\": \"Update Throughput\"\n            }\n          ],\n          \"feedback\": \"A balanced tree gives O(log n) lookups without much extra space, so latency improves. But worst-case behavior can creep up if the tree isn’t truly balanced in practice, and updates pay log factors, reducing throughput.\",\n          \"text\": \"Use a tree-based map\"\n        }\n      ],\n      \"question\": \"What do we use for userId lookups?\"\n    },\n    {\n      \"context\": \"Now the painful part: our leaderboard sorts a big array of scores whenever the page loads. It’s fine on average, but during certain traffic patterns it spikes hard. We need a sorting strategy that matches our risk tolerance.\",\n      \"options\": [\n        {\n          \"effects\": [\n            {\n              \"change\": -10,\n              \"variable\": \"P95 Latency (ms)\"\n            },\n            {\n              \"change\": 0,\n              \"variable\": \"Memory Footprint\"\n            },\n            {\n              \"change\": 15,\n              \"variable\": \"Worst-Case Slowdown Risk\"\n            },\n            {\n              \"change\": 5,\n              \"variable\": \"Update Throughput\"\n            }\n          ],\n          \"feedback\": \"Quicksort is fast on average (often near O(n log n)), so typical latency improves. But worst-case can degrade to O(n²) on unlucky distributions, raising slowdown risk. In-place operation keeps memory flat; fewer moves can help throughput.\",\n          \"text\": \"Use Quicksort and accept worst-case risk\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": -7,\n              \"variable\": \"P95 Latency (ms)\"\n            },\n            {\n              \"change\": 8,\n              \"variable\": \"Memory Footprint\"\n            },\n            {\n              \"change\": -12,\n              \"variable\": \"Worst-Case Slowdown Risk\"\n            }\n          ],\n          \"feedback\": \"Mergesort keeps O(n log n) even in the worst case, lowering slowdown risk. It needs extra arrays for merging, increasing memory. Latency improves, though not always as much as quicksort’s best typical case.\",\n          \"text\": \"Use Mergesort for predictable worst-case\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 6,\n              \"variable\": \"P95 Latency (ms)\"\n            },\n            {\n              \"change\": 0,\n              \"variable\": \"Memory Footprint\"\n            },\n            {\n              \"change\": -8,\n              \"variable\": \"Worst-Case Slowdown Risk\"\n            },\n            {\n              \"change\": 12,\n              \"variable\": \"Update Throughput\"\n            }\n          ],\n          \"feedback\": \"If we avoid frequent full sorts, requests do more work later, so P95 latency rises. But we reduce exposure to pathological sorting spikes, lowering worst-case risk. Updates get faster because we stop re-sorting large arrays repeatedly.\",\n          \"text\": \"Defer sorting; keep data partially ordered\"\n        }\n      ],\n      \"question\": \"How do we handle leaderboard sorting?\"\n    },\n    {\n      \"context\": \"{{NAME}}, users also filter results repeatedly with the same few queries. We can cache computations to save time, but memory is already a pressure point. This is the classic time-space trade-off moment.\",\n      \"options\": [\n        {\n          \"effects\": [\n            {\n              \"change\": -12,\n              \"variable\": \"P95 Latency (ms)\"\n            },\n            {\n              \"change\": 12,\n              \"variable\": \"Memory Footprint\"\n            },\n            {\n              \"change\": -5,\n              \"variable\": \"Worst-Case Slowdown Risk\"\n            }\n          ],\n          \"feedback\": \"Caching frequent query results reduces repeated work, lowering latency. The cached entries consume memory. Risk drops slightly because we’re less dependent on repeated heavy computations during peaks.\",\n          \"text\": \"Cache top query results (memoize)\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": -5,\n              \"variable\": \"P95 Latency (ms)\"\n            },\n            {\n              \"change\": 5,\n              \"variable\": \"Memory Footprint\"\n            },\n            {\n              \"change\": -2,\n              \"variable\": \"Worst-Case Slowdown Risk\"\n            },\n            {\n              \"change\": -6,\n              \"variable\": \"Update Throughput\"\n            }\n          ],\n          \"feedback\": \"Precomputing aggregates speeds reads somewhat, improving latency, but it stores extra structures so memory rises. Keeping them updated adds work on writes, reducing update throughput. Risk improves a little because reads become more consistent.\",\n          \"text\": \"Precompute aggregates; pay cost on writes\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 8,\n              \"variable\": \"P95 Latency (ms)\"\n            },\n            {\n              \"change\": -10,\n              \"variable\": \"Memory Footprint\"\n            },\n            {\n              \"change\": 8,\n              \"variable\": \"Worst-Case Slowdown Risk\"\n            },\n            {\n              \"change\": 6,\n              \"variable\": \"Update Throughput\"\n            }\n          ],\n          \"feedback\": \"Avoiding caches saves memory. But every request recomputes results, increasing latency and making spikes more likely under load, raising worst-case risk. Updates get simpler and faster because there’s nothing to maintain.\",\n          \"text\": \"No cache; recompute every time\"\n        }\n      ],\n      \"question\": \"What’s our caching strategy?\"\n    },\n    {\n      \"context\": \"One more thing: ingestion writes come in bursts. Our dynamic arrays occasionally resize and stall everything. It’s rare, but users feel it when it hits. We can tune for amortized behavior or try to eliminate spikes.\",\n      \"options\": [\n        {\n          \"effects\": [\n            {\n              \"change\": -6,\n              \"variable\": \"P95 Latency (ms)\"\n            },\n            {\n              \"change\": 6,\n              \"variable\": \"Memory Footprint\"\n            },\n            {\n              \"change\": -6,\n              \"variable\": \"Worst-Case Slowdown Risk\"\n            },\n            {\n              \"change\": 10,\n              \"variable\": \"Update Throughput\"\n            }\n          ],\n          \"feedback\": \"Pre-sizing capacity reduces resize frequency, so append stays closer to amortized O(1) with fewer O(n) resize events. That boosts throughput and lowers worst-case spike risk, but keeping extra reserved space increases memory footprint.\",\n          \"text\": \"Pre-size arrays for expected peaks\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 2,\n              \"variable\": \"P95 Latency (ms)\"\n            },\n            {\n              \"change\": -5,\n              \"variable\": \"Memory Footprint\"\n            },\n            {\n              \"change\": 6,\n              \"variable\": \"Worst-Case Slowdown Risk\"\n            },\n            {\n              \"change\": -8,\n              \"variable\": \"Update Throughput\"\n            }\n          ],\n          \"feedback\": \"Tight memory limits reduce reserved space, so memory footprint drops. But resizes happen more often, increasing the chance of O(n) stalls (higher risk) and lowering update throughput; occasional stalls can bump P95 latency too.\",\n          \"text\": \"Keep arrays tight; accept more resizes\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": -4,\n              \"variable\": \"P95 Latency (ms)\"\n            },\n            {\n              \"change\": 10,\n              \"variable\": \"Memory Footprint\"\n            },\n            {\n              \"change\": -10,\n              \"variable\": \"Worst-Case Slowdown Risk\"\n            },\n            {\n              \"change\": 4,\n              \"variable\": \"Update Throughput\"\n            }\n          ],\n          \"feedback\": \"Chunked buffers reduce big copy operations during growth, smoothing worst-case behavior. That lowers slowdown risk and can help latency during bursts. The extra buffer management and slack space increases memory, though updates remain fairly efficient.\",\n          \"text\": \"Switch to chunked buffers to avoid big copies\"\n        }\n      ],\n      \"question\": \"How do we handle resize spikes on ingestion?\"\n    }\n  ]\n}",
      "outputTokens": 1669,
      "systemPrompt": "# Role\n\nYou are an expert educational game designer creating a **Challenge** activity for a learning app. Your mission is to design a strategic simulation where learners make decisions that affect inventory variables, navigating trade-offs to meet win conditions using the lesson's concepts.\n\nYou specialize in crafting game-like experiences that test strategic thinking and problem-solving — not just knowledge recall, but the ability to apply concepts under constraints.\n\n# The Art of Strategic Learning\n\nA great Challenge activity doesn't quiz — it simulates. Learners face realistic constraints where every choice has consequences. They must think strategically about trade-offs, just like real-world decision-making.\n\n## Why Trade-Off-Based Scenarios Work\n\n1. **Authentic Complexity**: Real problems have multiple variables that interact. Improving one often affects another.\n\n2. **Strategic Reasoning**: Learners must think several steps ahead, considering how choices compound.\n\n3. **No \"Right Answer\"**: When every option has pros and cons, learners engage with the WHY behind principles.\n\n4. **Memorable Stakes**: Managing resources and meeting goals creates emotional investment in outcomes.\n\n## The Trade-Off Principle\n\nEvery great Challenge activity creates genuine dilemmas:\n\n- **No Perfect Options**: Each choice improves some variables while affecting others\n- **Interconnected Systems**: Variables influence each other meaningfully\n- **Strategic Planning**: Success requires thinking beyond the immediate step\n- **Concept Application**: Understanding the lesson's principles helps navigate trade-offs\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a challenge around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Introduction\n\nThe `intro` field sets the scene (max 500 characters). It should:\n\n- Establish the scenario and the learner's role\n- Explain what they're trying to achieve\n- Create stakes that feel meaningful\n- Use `{{NAME}}` to personalize\n\n## Inventory Design\n\nDesign 3-5 inventory items. Each item includes:\n\n- **name**: Variable name (intuitive, e.g., \"Budget\", \"Team Morale\", \"Code Quality\")\n- **startValue**: Initial value (typically 40-70, leaving room for gains and losses)\n- **winConditions**: Array of 1-2 conditions the learner must meet for this variable\n\nEach variable must:\n\n- **Represent lesson concepts**: Connect to something the learner studied\n- **Have clear meanings**: Names should be intuitive and unambiguous\n- **Interact meaningfully**: Actions that help one variable should plausibly affect others\n- **Name precisely**: Use specific names (e.g., \"Quantity Demanded\" not \"Market Demand\")\n\n### Variable Definition Lock\n\n**Once defined, a variable's meaning is FIXED for all steps.**\n\nBefore creating effects, explicitly define what each variable measures. Then for EVERY effect on that variable, verify the justification uses THE SAME CONCEPT:\n\n- ❌ \"Production Throughput\" defined as units manufactured per hour, but effect justified by \"worker satisfaction\" — these are different things\n- ✅ \"Production Throughput\" increases because \"the new machinery processes components faster\" — same concept\n\n**The test:** Could you replace the variable name with its definition in the feedback and have it still make sense? If not, you've drifted.\n\n### Win Conditions Structure\n\nEach inventory item's `winConditions` array defines success criteria:\n\n- **operator**: `gte` (>=), `lte` (<=), `gt` (>), `lt` (<), `eq` (==)\n- **value**: Target number the variable must meet\n\n**Common patterns:**\n\n- **Minimum threshold**: `[{ \"operator\": \"gte\", \"value\": 30 }]` — \"Don't let Budget drop below 30\"\n- **Maximum threshold**: `[{ \"operator\": \"lte\", \"value\": 70 }]` — \"Keep Risk below 70\"\n- **Range constraint** (two conditions): `[{ \"operator\": \"gte\", \"value\": 20 }, { \"operator\": \"lte\", \"value\": 80 }]` — \"Keep Budget balanced\"\n\n**Example inventory item:**\n\n```json\n{\n  \"name\": \"Budget\",\n  \"startValue\": 50,\n  \"winConditions\": [\n    { \"operator\": \"gte\", \"value\": 20 },\n    { \"operator\": \"lte\", \"value\": 80 }\n  ]\n}\n```\n\n### Win Condition Achievability Check\n\n**MANDATORY**: Before finalizing, verify each win condition is mathematically achievable:\n\n1. Start with `startValue`, calculate achievable range based on cumulative effects\n2. For `gte` conditions: Target ≤ `startValue + (steps × max_positive_effect_per_step)`\n3. For `lte` conditions: Target ≥ `startValue + (steps × max_negative_effect_per_step)`\n4. Leave margin for strategic flexibility — don't require perfect play to win\n\n**Common mistake**: Setting `lte` targets too LOW or `gte` targets too HIGH. If a variable starts at 55 with max -15 per step across 4 steps, minimum achievable is -5. A target of `lte 5` requires dropping 50 points — verify your effects allow this!\n\n## Step Structure\n\nEach step must have:\n\n- **context**: Maximum 500 characters. Pure dialogue from your colleague setting up the decision. Use a conversational style: no narrator, no character prefixes.\n- **question**: Maximum 100 characters. A clear question about what to do.\n- **options**: **EXACTLY 3-4 choices** (never fewer than 3), each with:\n  - **text**: The choice description (max 80 characters)\n  - **effects**: Array of {variable, change} pairs showing how this choice affects inventory\n  - **feedback**: Why this choice has these effects — max 300 characters. Should explain the reasoning, not just state the outcome.\n\n**CRITICAL**: Every step MUST have at least 3 options. Having only 2 options is a format violation.\n\n## Step Count\n\n- Minimum: 3 steps\n- Maximum: 6 steps\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character prefixes, NO action descriptions\n- **Natural conversation**: Colleagues working through a problem together\n- **Professional but warm**: Light humor when appropriate\n- **Second-person immersion**: The colleague speaks TO the learner\n- **Strategic framing**: Dialogue should hint at trade-offs without giving away optimal choices\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear. For example:\n\n- \"{{NAME}}, we need to make a call here.\"\n- \"Good thinking, {{NAME}}. But we should consider the trade-offs.\"\n\n## Effect Design\n\nEvery option must:\n\n- **Have meaningful effects**: At least 1-2 variables should change\n- **Show trade-offs**: Most options should help some variables while hurting others\n- **Use realistic magnitudes**: Changes of 5-20 points are typical; dramatic swings (30+) should be rare\n- **Connect to lesson concepts**: The REASON for effects should reflect lesson principles\n\nExample effects structure:\n\n```json\n{\n  \"effects\": [\n    { \"variable\": \"Budget\", \"change\": -15 },\n    { \"variable\": \"Quality\", \"change\": 10 }\n  ]\n}\n```\n\n## Effect Direction: The Measurement Rule\n\n**ONE RULE**: The sign reflects whether the MEASURED NUMBER goes up or down.\n\n### The Algorithm\n\nFor EVERY effect, apply this test:\n\n1. Imagine a meter/gauge displaying the variable's current value as a number\n2. After this action, will the number on that meter be HIGHER or LOWER?\n3. Higher → positive (+) / Lower → negative (-)\n\nThat's it. Ignore whether the outcome is \"good\" or \"bad\" for the player.\n\n### Why This Works\n\nVariables measure QUANTITIES. The sign indicates CHANGE IN QUANTITY:\n\n- Cost measures dollars spent → spending less → number goes DOWN → negative\n- Time measures duration → finishing faster → number goes DOWN → negative\n- Quality measures goodness → better work → number goes UP → positive\n- Risk measures danger level → safer choice → number goes DOWN → negative\n\n### Self-Check\n\nBefore finalizing each effect, ask:\n\n> \"If this variable were displayed as a number on screen, would this action make that number go UP or DOWN?\"\n\n- UP → use positive (+)\n- DOWN → use negative (-)\n\nThe player's happiness about the outcome is IRRELEVANT to the sign.\n\n### Feedback-Effect Coherence\n\n**The feedback text MUST match the effect direction.**\n\nBefore writing feedback, check that your explanation matches the sign:\n\n- ❌ Effect: `{\"variable\": \"Cost\", \"change\": -10}` + Feedback: \"This increases our costs\" — CONTRADICTION\n- ✅ Effect: `{\"variable\": \"Cost\", \"change\": -10}` + Feedback: \"This reduces our spending\" — COHERENT\n- ❌ Effect: `{\"variable\": \"Risk\", \"change\": 15}` + Feedback: \"This makes things safer\" — CONTRADICTION\n- ✅ Effect: `{\"variable\": \"Risk\", \"change\": 15}` + Feedback: \"This introduces more uncertainty\" — COHERENT\n\n**The test:** Read your feedback aloud, then check the effect sign. Do they tell the same story?\n\n## What to Avoid\n\n- **Dominant options**: No choice should be obviously best across all variables. For EACH step, compare options: if one option has BETTER OR EQUAL effects on ALL variables compared to another, it's dominant. Example: Option A (+10 Quality, -5 Budget) vs Option B (+5 Quality, -10 Budget) — A dominates B. Fix by giving B something A lacks, like +5 Morale.\n- **Trivial decisions**: Every step should require real thought about trade-offs\n- **Disconnected variables**: Effects should make conceptual sense\n- **Extreme swings**: Avoid changes that guarantee win/loss in one step\n- **Narrator text or descriptions**: Keep it pure dialogue\n- **Quiz-style questions**: This tests strategic thinking and problem-solving, not recall\n- **Inverted effect signs**: Never confuse \"good outcome\" with \"positive change\". Apply the Measurement Rule: would the NUMBER go up or down?\n- **Single-path variables**: NEVER create a variable that can only be improved by ONE option in the entire game. Every win condition variable MUST be influenceable by options in multiple steps. Otherwise, that option becomes mandatory and removes player agency\n\n## Scope\n\n- **Stay focused**: The scenario should require THIS lesson's concepts to navigate well\n- **Meaningful variables**: Each inventory variable should connect to lesson principles\n- **Realistic trade-offs**: The trade-offs should reflect how these concepts work in practice\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n- **Story**: WHEN to apply this (dialogue-based problem solving)\n\nYour Challenge activity is the capstone: **CAN YOU HANDLE THIS?** It tests whether learners can apply concepts strategically under constraints. This is the most challenging activity — it should feel like a real test of understanding.\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this?\"\n- **Challenge: \"CAN I navigate complex trade-offs using this?\"**\n\n# Structure Guide\n\nA typical Challenge follows this arc:\n\n1. **Setup**: Establish the scenario, variables, and goal in the intro\n2. **Initial Decision**: First choice with clear trade-offs to teach the mechanics\n3. **Escalating Complexity**: Middle decisions where variables interact more\n4. **Critical Choice**: A pivotal decision that significantly affects outcomes\n5. **Resolution Setup**: Final decision that determines if win conditions are met\n\nNote: The challenge should feel winnable but require understanding the lesson's principles to succeed consistently.\n\n# Dialogue Tone Examples\n\n## Setting Up Trade-Offs\n\n> \"{{NAME}}, here's our situation. We can push for faster delivery, but that means cutting corners on testing. Or we take our time and risk missing the window. What's our priority?\"\n\n> \"The client wants both lower costs AND higher quality. {{NAME}}, we both know we can't maximize both. Where do we compromise?\"\n\n## Explaining Consequences\n\n> \"Interesting choice, {{NAME}}. Going that route saved us time, but I'm already seeing signs of technical debt building up. Let's see how this plays out.\"\n\n> \"That definitely boosted our short-term numbers. But {{NAME}}, remember — these variables are connected. Watch what happens next.\"\n\n## Strategic Moments\n\n> \"{{NAME}}, we're at a crossroads. Our budget is tight, but team morale is dropping. If we don't address one, the other gets worse. What's your call?\"\n\n> \"This is the big one, {{NAME}}. The choice we make here pretty much determines whether we hit our targets. No pressure.\"\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Does the intro clearly establish the scenario, goal, and stakes?\n- [ ] Do inventory variables connect meaningfully to lesson concepts?\n- [ ] MATHEMATICAL ACHIEVABILITY: For each win condition, is the target mathematically reachable given startValue and cumulative effect ranges? (Calculate: startValue + sum of max effects in desired direction)\n- [ ] Does every option have genuine trade-offs (no dominant choices)?\n- [ ] Do effects make conceptual sense given the lesson content?\n- [ ] Is `{{NAME}}` used appropriately throughout?\n- [ ] Is all dialogue pure conversation (no narrator, no prefixes)?\n- [ ] Does feedback explain WHY effects occur, not just state them?\n- [ ] Is the scope exactly the lesson topic?\n- [ ] Are all constraints met (intro ≤500 chars, context ≤500 chars, question ≤100 chars, text ≤80 chars, feedback ≤300 chars)?\n- [ ] Is the step count between 3 and 6?\n- [ ] Do inventory values start in a reasonable range (typically 40-70)?\n- [ ] Are effect magnitudes reasonable (typically 5-20 points)?\n- [ ] For EACH effect, apply the Measurement Rule: if this variable were a number on screen, would this action make it go UP (+) or DOWN (-)?\n- [ ] Does EVERY step have at least 3 options? (Never just 2 options)\n- [ ] Does each inventory item have at least one win condition?\n- [ ] For each variable, are there multiple options across different steps that can affect it? (No single-path variables)\n- [ ] FEEDBACK-EFFECT COHERENCE: For each option, does the feedback text match the effect direction? (e.g., negative change + \"reduces X\" = coherent; negative change + \"increases X\" = contradiction)\n- [ ] VARIABLE DEFINITION: For each variable, is the justification in every feedback consistent with the variable's original definition?\n- [ ] DOMINANT OPTIONS: For each step, is there any option that beats another on ALL variables? If so, fix it by giving the weaker option a unique advantage.\n\n# Output Format\n\nReturn an object with:\n\n- **intro**: Scenario introduction (max 500 chars)\n- **inventory**: Array of 3-5 inventory items, each with:\n  - **name**: Variable name\n  - **startValue**: Initial value (typically 40-70)\n  - **winConditions**: Array of 1-2 conditions, each with:\n    - **operator**: One of \"gte\", \"lte\", \"gt\", \"lt\", \"eq\"\n    - **value**: Target number\n- **steps**: Array of 3-6 step objects, each with:\n  - **context**: Pure dialogue (max 500 chars)\n  - **question**: Decision prompt (max 100 chars)\n  - **options**: Array of 3-4 objects with:\n    - **text**: Choice description (max 80 chars)\n    - **effects**: Array of {variable, change} pairs\n    - **feedback**: Explanation of effects (max 300 chars)\n",
      "testCaseId": "en-cs-algorithm-complexity-1",
      "userPrompt": "LESSON_TITLE: Algorithm Complexity Trade-offs\nLESSON_DESCRIPTION: Understanding and applying algorithm complexity analysis to make informed trade-offs in software design\nCHAPTER_TITLE: Algorithm Analysis\nCOURSE_TITLE: Data Structures and Algorithms\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. Time Complexity: Time complexity measures how execution time grows with input size. O(n) means linear growth — double the input, double the time. O(n²) means quadratic — double the input, quadruple the time.\n2. Space Complexity: Space complexity measures memory usage growth. Some algorithms trade time for space — storing precomputed results to avoid recalculation. Others trade space for time — using less memory but computing more.\n3. Time-Space Trade-off: The time-space trade-off is fundamental. Hash tables give O(1) lookup but use extra memory. Binary search uses O(1) space but requires sorted data. Choose based on constraints.\n4. Amortized Analysis: Amortized analysis looks at average performance over many operations. ArrayList append is usually O(1), but occasionally O(n) when resizing. Amortized, it's still O(1).\n5. Case Analysis: Best, average, and worst case can differ dramatically. Quicksort averages O(n log n) but worst-cases to O(n²). Know your data distribution to choose wisely."
    },
    {
      "duration": 48642.513249999996,
      "inputTokens": 4025,
      "output": "{\n  \"intro\": \"{{NAME}}, you’re running pricing for a new bottled cold-brew launch. We need to hit strong weekly sales without ending up with angry retailers stuck with surplus—or shelves empty from shortages. Your goal: set price and adjust supply/demand levers using elasticity, equilibrium, and shifts vs. movements.\",\n  \"inventory\": [\n    {\n      \"name\": \"Weekly Profit Index\",\n      \"startValue\": 55,\n      \"winConditions\": [\n        {\n          \"operator\": \"gte\",\n          \"value\": 65\n        }\n      ]\n    },\n    {\n      \"name\": \"Inventory Balance\",\n      \"startValue\": 50,\n      \"winConditions\": [\n        {\n          \"operator\": \"gte\",\n          \"value\": 40\n        },\n        {\n          \"operator\": \"lte\",\n          \"value\": 70\n        }\n      ]\n    },\n    {\n      \"name\": \"Customer Loyalty\",\n      \"startValue\": 60,\n      \"winConditions\": [\n        {\n          \"operator\": \"gte\",\n          \"value\": 55\n        }\n      ]\n    },\n    {\n      \"name\": \"Competitive Pressure\",\n      \"startValue\": 45,\n      \"winConditions\": [\n        {\n          \"operator\": \"lte\",\n          \"value\": 60\n        }\n      ]\n    }\n  ],\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, retailers want our opening price today. If we price high, we might move less along the demand curve. If we price low, we could trigger a shortage if supply can’t keep up. What’s your opening move?\",\n      \"options\": [\n        {\n          \"effects\": [\n            {\n              \"change\": 12,\n              \"variable\": \"Weekly Profit Index\"\n            },\n            {\n              \"change\": -8,\n              \"variable\": \"Inventory Balance\"\n            },\n            {\n              \"change\": -10,\n              \"variable\": \"Customer Loyalty\"\n            },\n            {\n              \"change\": 5,\n              \"variable\": \"Competitive Pressure\"\n            }\n          ],\n          \"feedback\": \"A higher price raises margin (profit index up) but moves us up the demand curve, lowering quantity demanded and risking unsold stock (inventory balance down). Some customers feel gouged (loyalty down), and rivals smell an opportunity to undercut (pressure up).\",\n          \"text\": \"Launch with a premium price\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": -4,\n              \"variable\": \"Weekly Profit Index\"\n            },\n            {\n              \"change\": -12,\n              \"variable\": \"Inventory Balance\"\n            },\n            {\n              \"change\": 6,\n              \"variable\": \"Customer Loyalty\"\n            },\n            {\n              \"change\": -3,\n              \"variable\": \"Competitive Pressure\"\n            }\n          ],\n          \"feedback\": \"A low intro price cuts margin (profit index down) but moves us down the demand curve, boosting quantity demanded and risking stockouts (inventory balance down). Customers like the deal (loyalty up), and it’s harder for competitors to look cheaper (pressure down).\",\n          \"text\": \"Launch with a penetration price\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 6,\n              \"variable\": \"Weekly Profit Index\"\n            },\n            {\n              \"change\": 5,\n              \"variable\": \"Inventory Balance\"\n            },\n            {\n              \"change\": -2,\n              \"variable\": \"Customer Loyalty\"\n            },\n            {\n              \"change\": 2,\n              \"variable\": \"Competitive Pressure\"\n            }\n          ],\n          \"feedback\": \"A mid price aims closer to equilibrium: margin improves without collapsing demand (profit index up) and reduces extreme surplus/shortage risk (inventory balance up). Some customers still wish it were cheaper (loyalty slightly down). Rivals still compete (pressure up).\",\n          \"text\": \"Set a near-equilibrium price\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 3,\n              \"variable\": \"Weekly Profit Index\"\n            },\n            {\n              \"change\": 8,\n              \"variable\": \"Inventory Balance\"\n            },\n            {\n              \"change\": 3,\n              \"variable\": \"Customer Loyalty\"\n            },\n            {\n              \"change\": 4,\n              \"variable\": \"Competitive Pressure\"\n            }\n          ],\n          \"feedback\": \"Two tiers capture some high willingness-to-pay (profit index up) while offering a lower-price option to keep volume steadier (inventory balance up). Choice can feel customer-friendly (loyalty up), but competitors may respond with their own versions (pressure up).\",\n          \"text\": \"Offer two sizes at different prices\"\n        }\n      ],\n      \"question\": \"What opening pricing strategy do we choose?\"\n    },\n    {\n      \"context\": \"We’re seeing early sales data. Demand looks pretty elastic—small price changes are moving volume a lot. We can adjust price, or we can shift demand with marketing, or shift supply with production changes. Which lever do you want?\",\n      \"options\": [\n        {\n          \"effects\": [\n            {\n              \"change\": -6,\n              \"variable\": \"Weekly Profit Index\"\n            },\n            {\n              \"change\": 10,\n              \"variable\": \"Inventory Balance\"\n            },\n            {\n              \"change\": 7,\n              \"variable\": \"Customer Loyalty\"\n            },\n            {\n              \"change\": -2,\n              \"variable\": \"Competitive Pressure\"\n            }\n          ],\n          \"feedback\": \"With elastic demand, a price cut boosts quantity demanded a lot (reducing stock mismatch, inventory balance up). But lower price reduces margin (profit index down). Customers respond well to lower prices (loyalty up), and rivals have less room to look meaningfully cheaper (pressure down).\",\n          \"text\": \"Cut price slightly to match elastic demand\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 7,\n              \"variable\": \"Weekly Profit Index\"\n            },\n            {\n              \"change\": -10,\n              \"variable\": \"Inventory Balance\"\n            },\n            {\n              \"change\": -8,\n              \"variable\": \"Customer Loyalty\"\n            },\n            {\n              \"change\": 6,\n              \"variable\": \"Competitive Pressure\"\n            }\n          ],\n          \"feedback\": \"Raising price with elastic demand drops quantity demanded sharply (risking surplus, inventory balance down). Margin per unit rises (profit index up), but customers notice and churn (loyalty down). Competitors can capture the lost volume (pressure up).\",\n          \"text\": \"Raise price to protect margin\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 5,\n              \"variable\": \"Weekly Profit Index\"\n            },\n            {\n              \"change\": -6,\n              \"variable\": \"Inventory Balance\"\n            },\n            {\n              \"change\": 10,\n              \"variable\": \"Customer Loyalty\"\n            },\n            {\n              \"change\": 3,\n              \"variable\": \"Competitive Pressure\"\n            }\n          ],\n          \"feedback\": \"A branding push shifts the demand curve right (more demand at every price), lifting revenue potential (profit index up). If supply doesn’t rise, the higher demand can create shortages (inventory balance down). Loyalty improves because the product feels more valuable (up). Rivals react to our buzz (pressure up).\",\n          \"text\": \"Run a brand campaign to shift demand\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": -3,\n              \"variable\": \"Weekly Profit Index\"\n            },\n            {\n              \"change\": 12,\n              \"variable\": \"Inventory Balance\"\n            },\n            {\n              \"change\": -2,\n              \"variable\": \"Customer Loyalty\"\n            },\n            {\n              \"change\": 1,\n              \"variable\": \"Competitive Pressure\"\n            }\n          ],\n          \"feedback\": \"Investing in capacity improves quantity supplied at each price (a rightward supply shift), reducing shortage/surplus swings (inventory balance up). It costs money short run (profit index down). Customers may not feel a benefit immediately (loyalty slightly down). Competitors may still watch closely (pressure up a bit).\",\n          \"text\": \"Increase production capacity to shift supply\"\n        }\n      ],\n      \"question\": \"Elastic demand is showing—what do we adjust next?\"\n    },\n    {\n      \"context\": \"Retailers report either empty shelves in some stores or slow movement in others. That’s classic price-above or price-below equilibrium playing out locally. We can standardize, or tailor by neighborhood, or use promos to smooth it out. What’s the call, {{NAME}}?\",\n      \"options\": [\n        {\n          \"effects\": [\n            {\n              \"change\": 4,\n              \"variable\": \"Weekly Profit Index\"\n            },\n            {\n              \"change\": 9,\n              \"variable\": \"Inventory Balance\"\n            },\n            {\n              \"change\": -6,\n              \"variable\": \"Customer Loyalty\"\n            },\n            {\n              \"change\": 2,\n              \"variable\": \"Competitive Pressure\"\n            }\n          ],\n          \"feedback\": \"Uniform pricing simplifies execution and reduces extreme local surplus/shortage issues through consistent ordering (inventory balance up). It can improve profitability via cleaner operations (profit index up). Some customers dislike paying the same despite local conditions (loyalty down). Rivals may target the unhappy pockets (pressure up).\",\n          \"text\": \"Standardize one price across all stores\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 8,\n              \"variable\": \"Weekly Profit Index\"\n            },\n            {\n              \"change\": 12,\n              \"variable\": \"Inventory Balance\"\n            },\n            {\n              \"change\": -10,\n              \"variable\": \"Customer Loyalty\"\n            },\n            {\n              \"change\": 5,\n              \"variable\": \"Competitive Pressure\"\n            }\n          ],\n          \"feedback\": \"Local pricing moves each store closer to its own equilibrium, reducing both surplus and shortage (inventory balance up) and capturing margin where willingness-to-pay is higher (profit index up). But customers can perceive it as unfair (loyalty down). Competitors may exploit the controversy (pressure up).\",\n          \"text\": \"Use neighborhood-based pricing\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 2,\n              \"variable\": \"Weekly Profit Index\"\n            },\n            {\n              \"change\": 7,\n              \"variable\": \"Inventory Balance\"\n            },\n            {\n              \"change\": 6,\n              \"variable\": \"Customer Loyalty\"\n            },\n            {\n              \"change\": -1,\n              \"variable\": \"Competitive Pressure\"\n            }\n          ],\n          \"feedback\": \"Targeted promos act like temporary price cuts where demand is weak, moving along the demand curve to clear surplus (inventory balance up). The discount trims margin somewhat but can still lift overall results (profit index up slightly). Customers like deals (loyalty up). Rivals’ advantage shrinks (pressure down).\",\n          \"text\": \"Run targeted promos only in slow stores\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": -2,\n              \"variable\": \"Weekly Profit Index\"\n            },\n            {\n              \"change\": 14,\n              \"variable\": \"Inventory Balance\"\n            },\n            {\n              \"change\": 2,\n              \"variable\": \"Customer Loyalty\"\n            },\n            {\n              \"change\": 3,\n              \"variable\": \"Competitive Pressure\"\n            }\n          ],\n          \"feedback\": \"Reallocating shipments increases supplied quantity where demand is high and reduces oversupply where it’s low, improving balance without changing price (inventory balance up). Logistics costs hit profit (down). Customers in formerly-empty areas are happier (loyalty up). Rivals see we’re responsive (pressure up).\",\n          \"text\": \"Rebalance distribution across stores\"\n        }\n      ],\n      \"question\": \"How do we handle surplus vs. shortages across stores?\"\n    },\n    {\n      \"context\": \"Competitor just dropped a similar cold-brew price. That changes the environment—our demand curve could shift left if people switch. We can match price, differentiate to shift preferences, or lean into a premium niche. How do you want to respond, {{NAME}}?\",\n      \"options\": [\n        {\n          \"effects\": [\n            {\n              \"change\": -6,\n              \"variable\": \"Weekly Profit Index\"\n            },\n            {\n              \"change\": 6,\n              \"variable\": \"Inventory Balance\"\n            },\n            {\n              \"change\": 4,\n              \"variable\": \"Customer Loyalty\"\n            },\n            {\n              \"change\": -8,\n              \"variable\": \"Competitive Pressure\"\n            }\n          ],\n          \"feedback\": \"Matching their lower price reduces margin (profit index down) but protects quantity demanded (inventory balance up by avoiding surplus). Customers feel we’re fair (loyalty up). The gap with the competitor shrinks, easing their threat (competitive pressure down).\",\n          \"text\": \"Match the competitor’s price cut\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 5,\n              \"variable\": \"Weekly Profit Index\"\n            },\n            {\n              \"change\": -4,\n              \"variable\": \"Inventory Balance\"\n            },\n            {\n              \"change\": 9,\n              \"variable\": \"Customer Loyalty\"\n            },\n            {\n              \"change\": -3,\n              \"variable\": \"Competitive Pressure\"\n            }\n          ],\n          \"feedback\": \"Differentiation (taste, sustainability, bundles) shifts our demand curve right by changing preferences, supporting profit (up) and loyalty (up). If demand rises faster than supply, we risk localized shortages (inventory balance down). A clearer unique value reduces direct rivalry (pressure down).\",\n          \"text\": \"Differentiate with product upgrades and messaging\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 9,\n              \"variable\": \"Weekly Profit Index\"\n            },\n            {\n              \"change\": -10,\n              \"variable\": \"Inventory Balance\"\n            },\n            {\n              \"change\": -8,\n              \"variable\": \"Customer Loyalty\"\n            },\n            {\n              \"change\": 7,\n              \"variable\": \"Competitive Pressure\"\n            }\n          ],\n          \"feedback\": \"Holding price high aims for premium margins (profit index up), but with a cheaper substitute available, quantity demanded can fall sharply (inventory balance down via surplus risk). Some customers switch away (loyalty down). The competitor’s move raises the threat level (pressure up).\",\n          \"text\": \"Hold price and lean premium\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 1,\n              \"variable\": \"Weekly Profit Index\"\n            },\n            {\n              \"change\": 5,\n              \"variable\": \"Inventory Balance\"\n            },\n            {\n              \"change\": -2,\n              \"variable\": \"Customer Loyalty\"\n            },\n            {\n              \"change\": -5,\n              \"variable\": \"Competitive Pressure\"\n            }\n          ],\n          \"feedback\": \"Reducing placements in the most competitive channels cuts head-to-head battles (pressure down) and helps align supply with likely sales (inventory balance up). But it limits volume opportunity (profit up only slightly). Some customers can’t find us as easily (loyalty down).\",\n          \"text\": \"Pull back from the most competitive stores\"\n        }\n      ],\n      \"question\": \"Competitor undercut us—what response do we take?\"\n    },\n    {\n      \"context\": \"We have one week left before the quarterly review. Leadership wants a clean story: we understand movements along curves, true shifts, and where equilibrium sits. We can do one final move to lock in results. What’s your final adjustment, {{NAME}}?\",\n      \"options\": [\n        {\n          \"effects\": [\n            {\n              \"change\": 6,\n              \"variable\": \"Weekly Profit Index\"\n            },\n            {\n              \"change\": -8,\n              \"variable\": \"Inventory Balance\"\n            },\n            {\n              \"change\": -6,\n              \"variable\": \"Customer Loyalty\"\n            },\n            {\n              \"change\": 4,\n              \"variable\": \"Competitive Pressure\"\n            }\n          ],\n          \"feedback\": \"A last-minute price hike is a movement up the demand curve: higher margin can lift profit (up), but quantity demanded drops, risking surplus (inventory balance down). Customers may feel whiplash (loyalty down). Rivals can grab price-sensitive buyers (pressure up).\",\n          \"text\": \"Increase price for the final week\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": -4,\n              \"variable\": \"Weekly Profit Index\"\n            },\n            {\n              \"change\": 10,\n              \"variable\": \"Inventory Balance\"\n            },\n            {\n              \"change\": 5,\n              \"variable\": \"Customer Loyalty\"\n            },\n            {\n              \"change\": -2,\n              \"variable\": \"Competitive Pressure\"\n            }\n          ],\n          \"feedback\": \"A short promo is a movement down the demand curve: more quantity demanded helps clear excess inventory and reduce stock mismatch (inventory balance up). Margin falls (profit down). Customers enjoy the deal (loyalty up). Competitors have less room to claim value (pressure down).\",\n          \"text\": \"Run a one-week promo to clear imbalances\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 3,\n              \"variable\": \"Weekly Profit Index\"\n            },\n            {\n              \"change\": 8,\n              \"variable\": \"Inventory Balance\"\n            },\n            {\n              \"change\": 2,\n              \"variable\": \"Customer Loyalty\"\n            },\n            {\n              \"change\": -1,\n              \"variable\": \"Competitive Pressure\"\n            }\n          ],\n          \"feedback\": \"Stabilizing at an estimated equilibrium price reduces both shortage and surplus risk (inventory balance up) while keeping profit steady (up slightly). Consistency supports trust (loyalty up). Competitors have fewer openings if we’re reliably in stock (pressure down a bit).\",\n          \"text\": \"Lock in an equilibrium-focused price and keep it steady\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": -2,\n              \"variable\": \"Weekly Profit Index\"\n            },\n            {\n              \"change\": 12,\n              \"variable\": \"Inventory Balance\"\n            },\n            {\n              \"change\": -1,\n              \"variable\": \"Customer Loyalty\"\n            },\n            {\n              \"change\": 1,\n              \"variable\": \"Competitive Pressure\"\n            }\n          ],\n          \"feedback\": \"Improving forecasting and replenishment increases supplied quantity where it’s needed, reducing both empty shelves and overstocks without changing price (inventory balance up). It costs time/money now (profit down). Customers barely notice immediately (loyalty slightly down). Competitors won’t wait (pressure up a bit).\",\n          \"text\": \"Invest in forecasting and replenishment accuracy\"\n        }\n      ],\n      \"question\": \"What’s our final move before the review?\"\n    }\n  ]\n}",
      "outputTokens": 2761,
      "systemPrompt": "# Role\n\nYou are an expert educational game designer creating a **Challenge** activity for a learning app. Your mission is to design a strategic simulation where learners make decisions that affect inventory variables, navigating trade-offs to meet win conditions using the lesson's concepts.\n\nYou specialize in crafting game-like experiences that test strategic thinking and problem-solving — not just knowledge recall, but the ability to apply concepts under constraints.\n\n# The Art of Strategic Learning\n\nA great Challenge activity doesn't quiz — it simulates. Learners face realistic constraints where every choice has consequences. They must think strategically about trade-offs, just like real-world decision-making.\n\n## Why Trade-Off-Based Scenarios Work\n\n1. **Authentic Complexity**: Real problems have multiple variables that interact. Improving one often affects another.\n\n2. **Strategic Reasoning**: Learners must think several steps ahead, considering how choices compound.\n\n3. **No \"Right Answer\"**: When every option has pros and cons, learners engage with the WHY behind principles.\n\n4. **Memorable Stakes**: Managing resources and meeting goals creates emotional investment in outcomes.\n\n## The Trade-Off Principle\n\nEvery great Challenge activity creates genuine dilemmas:\n\n- **No Perfect Options**: Each choice improves some variables while affecting others\n- **Interconnected Systems**: Variables influence each other meaningfully\n- **Strategic Planning**: Success requires thinking beyond the immediate step\n- **Concept Application**: Understanding the lesson's principles helps navigate trade-offs\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a challenge around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Introduction\n\nThe `intro` field sets the scene (max 500 characters). It should:\n\n- Establish the scenario and the learner's role\n- Explain what they're trying to achieve\n- Create stakes that feel meaningful\n- Use `{{NAME}}` to personalize\n\n## Inventory Design\n\nDesign 3-5 inventory items. Each item includes:\n\n- **name**: Variable name (intuitive, e.g., \"Budget\", \"Team Morale\", \"Code Quality\")\n- **startValue**: Initial value (typically 40-70, leaving room for gains and losses)\n- **winConditions**: Array of 1-2 conditions the learner must meet for this variable\n\nEach variable must:\n\n- **Represent lesson concepts**: Connect to something the learner studied\n- **Have clear meanings**: Names should be intuitive and unambiguous\n- **Interact meaningfully**: Actions that help one variable should plausibly affect others\n- **Name precisely**: Use specific names (e.g., \"Quantity Demanded\" not \"Market Demand\")\n\n### Variable Definition Lock\n\n**Once defined, a variable's meaning is FIXED for all steps.**\n\nBefore creating effects, explicitly define what each variable measures. Then for EVERY effect on that variable, verify the justification uses THE SAME CONCEPT:\n\n- ❌ \"Production Throughput\" defined as units manufactured per hour, but effect justified by \"worker satisfaction\" — these are different things\n- ✅ \"Production Throughput\" increases because \"the new machinery processes components faster\" — same concept\n\n**The test:** Could you replace the variable name with its definition in the feedback and have it still make sense? If not, you've drifted.\n\n### Win Conditions Structure\n\nEach inventory item's `winConditions` array defines success criteria:\n\n- **operator**: `gte` (>=), `lte` (<=), `gt` (>), `lt` (<), `eq` (==)\n- **value**: Target number the variable must meet\n\n**Common patterns:**\n\n- **Minimum threshold**: `[{ \"operator\": \"gte\", \"value\": 30 }]` — \"Don't let Budget drop below 30\"\n- **Maximum threshold**: `[{ \"operator\": \"lte\", \"value\": 70 }]` — \"Keep Risk below 70\"\n- **Range constraint** (two conditions): `[{ \"operator\": \"gte\", \"value\": 20 }, { \"operator\": \"lte\", \"value\": 80 }]` — \"Keep Budget balanced\"\n\n**Example inventory item:**\n\n```json\n{\n  \"name\": \"Budget\",\n  \"startValue\": 50,\n  \"winConditions\": [\n    { \"operator\": \"gte\", \"value\": 20 },\n    { \"operator\": \"lte\", \"value\": 80 }\n  ]\n}\n```\n\n### Win Condition Achievability Check\n\n**MANDATORY**: Before finalizing, verify each win condition is mathematically achievable:\n\n1. Start with `startValue`, calculate achievable range based on cumulative effects\n2. For `gte` conditions: Target ≤ `startValue + (steps × max_positive_effect_per_step)`\n3. For `lte` conditions: Target ≥ `startValue + (steps × max_negative_effect_per_step)`\n4. Leave margin for strategic flexibility — don't require perfect play to win\n\n**Common mistake**: Setting `lte` targets too LOW or `gte` targets too HIGH. If a variable starts at 55 with max -15 per step across 4 steps, minimum achievable is -5. A target of `lte 5` requires dropping 50 points — verify your effects allow this!\n\n## Step Structure\n\nEach step must have:\n\n- **context**: Maximum 500 characters. Pure dialogue from your colleague setting up the decision. Use a conversational style: no narrator, no character prefixes.\n- **question**: Maximum 100 characters. A clear question about what to do.\n- **options**: **EXACTLY 3-4 choices** (never fewer than 3), each with:\n  - **text**: The choice description (max 80 characters)\n  - **effects**: Array of {variable, change} pairs showing how this choice affects inventory\n  - **feedback**: Why this choice has these effects — max 300 characters. Should explain the reasoning, not just state the outcome.\n\n**CRITICAL**: Every step MUST have at least 3 options. Having only 2 options is a format violation.\n\n## Step Count\n\n- Minimum: 3 steps\n- Maximum: 6 steps\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character prefixes, NO action descriptions\n- **Natural conversation**: Colleagues working through a problem together\n- **Professional but warm**: Light humor when appropriate\n- **Second-person immersion**: The colleague speaks TO the learner\n- **Strategic framing**: Dialogue should hint at trade-offs without giving away optimal choices\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear. For example:\n\n- \"{{NAME}}, we need to make a call here.\"\n- \"Good thinking, {{NAME}}. But we should consider the trade-offs.\"\n\n## Effect Design\n\nEvery option must:\n\n- **Have meaningful effects**: At least 1-2 variables should change\n- **Show trade-offs**: Most options should help some variables while hurting others\n- **Use realistic magnitudes**: Changes of 5-20 points are typical; dramatic swings (30+) should be rare\n- **Connect to lesson concepts**: The REASON for effects should reflect lesson principles\n\nExample effects structure:\n\n```json\n{\n  \"effects\": [\n    { \"variable\": \"Budget\", \"change\": -15 },\n    { \"variable\": \"Quality\", \"change\": 10 }\n  ]\n}\n```\n\n## Effect Direction: The Measurement Rule\n\n**ONE RULE**: The sign reflects whether the MEASURED NUMBER goes up or down.\n\n### The Algorithm\n\nFor EVERY effect, apply this test:\n\n1. Imagine a meter/gauge displaying the variable's current value as a number\n2. After this action, will the number on that meter be HIGHER or LOWER?\n3. Higher → positive (+) / Lower → negative (-)\n\nThat's it. Ignore whether the outcome is \"good\" or \"bad\" for the player.\n\n### Why This Works\n\nVariables measure QUANTITIES. The sign indicates CHANGE IN QUANTITY:\n\n- Cost measures dollars spent → spending less → number goes DOWN → negative\n- Time measures duration → finishing faster → number goes DOWN → negative\n- Quality measures goodness → better work → number goes UP → positive\n- Risk measures danger level → safer choice → number goes DOWN → negative\n\n### Self-Check\n\nBefore finalizing each effect, ask:\n\n> \"If this variable were displayed as a number on screen, would this action make that number go UP or DOWN?\"\n\n- UP → use positive (+)\n- DOWN → use negative (-)\n\nThe player's happiness about the outcome is IRRELEVANT to the sign.\n\n### Feedback-Effect Coherence\n\n**The feedback text MUST match the effect direction.**\n\nBefore writing feedback, check that your explanation matches the sign:\n\n- ❌ Effect: `{\"variable\": \"Cost\", \"change\": -10}` + Feedback: \"This increases our costs\" — CONTRADICTION\n- ✅ Effect: `{\"variable\": \"Cost\", \"change\": -10}` + Feedback: \"This reduces our spending\" — COHERENT\n- ❌ Effect: `{\"variable\": \"Risk\", \"change\": 15}` + Feedback: \"This makes things safer\" — CONTRADICTION\n- ✅ Effect: `{\"variable\": \"Risk\", \"change\": 15}` + Feedback: \"This introduces more uncertainty\" — COHERENT\n\n**The test:** Read your feedback aloud, then check the effect sign. Do they tell the same story?\n\n## What to Avoid\n\n- **Dominant options**: No choice should be obviously best across all variables. For EACH step, compare options: if one option has BETTER OR EQUAL effects on ALL variables compared to another, it's dominant. Example: Option A (+10 Quality, -5 Budget) vs Option B (+5 Quality, -10 Budget) — A dominates B. Fix by giving B something A lacks, like +5 Morale.\n- **Trivial decisions**: Every step should require real thought about trade-offs\n- **Disconnected variables**: Effects should make conceptual sense\n- **Extreme swings**: Avoid changes that guarantee win/loss in one step\n- **Narrator text or descriptions**: Keep it pure dialogue\n- **Quiz-style questions**: This tests strategic thinking and problem-solving, not recall\n- **Inverted effect signs**: Never confuse \"good outcome\" with \"positive change\". Apply the Measurement Rule: would the NUMBER go up or down?\n- **Single-path variables**: NEVER create a variable that can only be improved by ONE option in the entire game. Every win condition variable MUST be influenceable by options in multiple steps. Otherwise, that option becomes mandatory and removes player agency\n\n## Scope\n\n- **Stay focused**: The scenario should require THIS lesson's concepts to navigate well\n- **Meaningful variables**: Each inventory variable should connect to lesson principles\n- **Realistic trade-offs**: The trade-offs should reflect how these concepts work in practice\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n- **Story**: WHEN to apply this (dialogue-based problem solving)\n\nYour Challenge activity is the capstone: **CAN YOU HANDLE THIS?** It tests whether learners can apply concepts strategically under constraints. This is the most challenging activity — it should feel like a real test of understanding.\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this?\"\n- **Challenge: \"CAN I navigate complex trade-offs using this?\"**\n\n# Structure Guide\n\nA typical Challenge follows this arc:\n\n1. **Setup**: Establish the scenario, variables, and goal in the intro\n2. **Initial Decision**: First choice with clear trade-offs to teach the mechanics\n3. **Escalating Complexity**: Middle decisions where variables interact more\n4. **Critical Choice**: A pivotal decision that significantly affects outcomes\n5. **Resolution Setup**: Final decision that determines if win conditions are met\n\nNote: The challenge should feel winnable but require understanding the lesson's principles to succeed consistently.\n\n# Dialogue Tone Examples\n\n## Setting Up Trade-Offs\n\n> \"{{NAME}}, here's our situation. We can push for faster delivery, but that means cutting corners on testing. Or we take our time and risk missing the window. What's our priority?\"\n\n> \"The client wants both lower costs AND higher quality. {{NAME}}, we both know we can't maximize both. Where do we compromise?\"\n\n## Explaining Consequences\n\n> \"Interesting choice, {{NAME}}. Going that route saved us time, but I'm already seeing signs of technical debt building up. Let's see how this plays out.\"\n\n> \"That definitely boosted our short-term numbers. But {{NAME}}, remember — these variables are connected. Watch what happens next.\"\n\n## Strategic Moments\n\n> \"{{NAME}}, we're at a crossroads. Our budget is tight, but team morale is dropping. If we don't address one, the other gets worse. What's your call?\"\n\n> \"This is the big one, {{NAME}}. The choice we make here pretty much determines whether we hit our targets. No pressure.\"\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Does the intro clearly establish the scenario, goal, and stakes?\n- [ ] Do inventory variables connect meaningfully to lesson concepts?\n- [ ] MATHEMATICAL ACHIEVABILITY: For each win condition, is the target mathematically reachable given startValue and cumulative effect ranges? (Calculate: startValue + sum of max effects in desired direction)\n- [ ] Does every option have genuine trade-offs (no dominant choices)?\n- [ ] Do effects make conceptual sense given the lesson content?\n- [ ] Is `{{NAME}}` used appropriately throughout?\n- [ ] Is all dialogue pure conversation (no narrator, no prefixes)?\n- [ ] Does feedback explain WHY effects occur, not just state them?\n- [ ] Is the scope exactly the lesson topic?\n- [ ] Are all constraints met (intro ≤500 chars, context ≤500 chars, question ≤100 chars, text ≤80 chars, feedback ≤300 chars)?\n- [ ] Is the step count between 3 and 6?\n- [ ] Do inventory values start in a reasonable range (typically 40-70)?\n- [ ] Are effect magnitudes reasonable (typically 5-20 points)?\n- [ ] For EACH effect, apply the Measurement Rule: if this variable were a number on screen, would this action make it go UP (+) or DOWN (-)?\n- [ ] Does EVERY step have at least 3 options? (Never just 2 options)\n- [ ] Does each inventory item have at least one win condition?\n- [ ] For each variable, are there multiple options across different steps that can affect it? (No single-path variables)\n- [ ] FEEDBACK-EFFECT COHERENCE: For each option, does the feedback text match the effect direction? (e.g., negative change + \"reduces X\" = coherent; negative change + \"increases X\" = contradiction)\n- [ ] VARIABLE DEFINITION: For each variable, is the justification in every feedback consistent with the variable's original definition?\n- [ ] DOMINANT OPTIONS: For each step, is there any option that beats another on ALL variables? If so, fix it by giving the weaker option a unique advantage.\n\n# Output Format\n\nReturn an object with:\n\n- **intro**: Scenario introduction (max 500 chars)\n- **inventory**: Array of 3-5 inventory items, each with:\n  - **name**: Variable name\n  - **startValue**: Initial value (typically 40-70)\n  - **winConditions**: Array of 1-2 conditions, each with:\n    - **operator**: One of \"gte\", \"lte\", \"gt\", \"lt\", \"eq\"\n    - **value**: Target number\n- **steps**: Array of 3-6 step objects, each with:\n  - **context**: Pure dialogue (max 500 chars)\n  - **question**: Decision prompt (max 100 chars)\n  - **options**: Array of 3-4 objects with:\n    - **text**: Choice description (max 80 chars)\n    - **effects**: Array of {variable, change} pairs\n    - **feedback**: Explanation of effects (max 300 chars)\n",
      "testCaseId": "en-economics-supply-demand-1",
      "userPrompt": "LESSON_TITLE: Supply and Demand in Practice\nLESSON_DESCRIPTION: Applying supply and demand principles to make strategic pricing and market decisions\nCHAPTER_TITLE: Market Dynamics\nCOURSE_TITLE: Microeconomics Fundamentals\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. The Demand Curve: Demand curves slope downward — as price rises, quantity demanded falls. This reflects the law of demand: people buy less when things cost more, all else equal.\n2. The Supply Curve: Supply curves slope upward — as price rises, quantity supplied increases. Higher prices incentivize producers to make more. Lower prices make production less worthwhile.\n3. Market Equilibrium: Equilibrium occurs where supply meets demand. At this price, quantity supplied equals quantity demanded. Prices above equilibrium create surplus; prices below create shortage.\n4. Price Elasticity: Price elasticity measures responsiveness to price changes. Elastic demand (>1) means sales drop sharply with price increases. Inelastic demand (<1) means sales barely change.\n5. Shifts vs. Movements: Shifts vs. movements: A change in price moves along the curve. Changes in other factors (income, preferences, costs) shift the entire curve. This distinction is crucial."
    },
    {
      "duration": 41482.558209,
      "inputTokens": 4033,
      "output": "{\n  \"intro\": \"{{NAME}}, the park board wants a 12‑month management plan for Willow Marsh. Visitors want more wildlife sightings, farmers want less crop damage, and the wetland has to stay resilient. You’ll choose interventions; each one shifts the ecosystem. Hit the targets without triggering a cascade.\",\n  \"inventory\": [\n    {\n      \"name\": \"Food Web Stability\",\n      \"startValue\": 55,\n      \"winConditions\": [\n        {\n          \"operator\": \"gte\",\n          \"value\": 60\n        }\n      ]\n    },\n    {\n      \"name\": \"Herbivore Pressure\",\n      \"startValue\": 60,\n      \"winConditions\": [\n        {\n          \"operator\": \"lte\",\n          \"value\": 55\n        }\n      ]\n    },\n    {\n      \"name\": \"Biodiversity Resilience\",\n      \"startValue\": 50,\n      \"winConditions\": [\n        {\n          \"operator\": \"gte\",\n          \"value\": 60\n        }\n      ]\n    },\n    {\n      \"name\": \"Habitat Carrying Capacity\",\n      \"startValue\": 50,\n      \"winConditions\": [\n        {\n          \"operator\": \"gte\",\n          \"value\": 55\n        },\n        {\n          \"operator\": \"lte\",\n          \"value\": 70\n        }\n      ]\n    }\n  ],\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, first issue: deer and geese are hammering shoreline plants. We can act fast, but the board is nervous about upsetting predator-prey dynamics. What’s our opening move?\",\n      \"options\": [\n        {\n          \"effects\": [\n            {\n              \"change\": 12,\n              \"variable\": \"Food Web Stability\"\n            },\n            {\n              \"change\": -10,\n              \"variable\": \"Herbivore Pressure\"\n            },\n            {\n              \"change\": -5,\n              \"variable\": \"Biodiversity Resilience\"\n            }\n          ],\n          \"feedback\": \"Restoring a top predator (or predator access) can trigger a trophic cascade that lowers herbivore numbers, which stabilizes interactions. But it can temporarily reduce some mid-level species as the community readjusts, lowering resilience in the short run.\",\n          \"text\": \"Reintroduce/encourage a top predator\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": -8,\n              \"variable\": \"Food Web Stability\"\n            },\n            {\n              \"change\": -12,\n              \"variable\": \"Herbivore Pressure\"\n            },\n            {\n              \"change\": 6,\n              \"variable\": \"Habitat Carrying Capacity\"\n            }\n          ],\n          \"feedback\": \"Culling drops herbivore pressure quickly, so plants recover and the habitat can support more biomass. But removing animals outside the food web can destabilize predator-prey links and reduce overall stability.\",\n          \"text\": \"Targeted cull of herbivores\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 5,\n              \"variable\": \"Food Web Stability\"\n            },\n            {\n              \"change\": -6,\n              \"variable\": \"Herbivore Pressure\"\n            },\n            {\n              \"change\": 10,\n              \"variable\": \"Biodiversity Resilience\"\n            },\n            {\n              \"change\": -4,\n              \"variable\": \"Habitat Carrying Capacity\"\n            }\n          ],\n          \"feedback\": \"Fencing and planting native buffers spreads grazing across more plant types and adds niches, boosting resilience. It reduces browsing in key areas and can smooth interactions, but fenced-off zones limit accessible habitat for some species, slightly lowering carrying capacity.\",\n          \"text\": \"Fence hotspots and plant native buffer strips\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": -6,\n              \"variable\": \"Food Web Stability\"\n            },\n            {\n              \"change\": 4,\n              \"variable\": \"Herbivore Pressure\"\n            },\n            {\n              \"change\": -3,\n              \"variable\": \"Biodiversity Resilience\"\n            },\n            {\n              \"change\": 8,\n              \"variable\": \"Habitat Carrying Capacity\"\n            }\n          ],\n          \"feedback\": \"Supplemental feeding can keep animals away from farms and lets more individuals survive, increasing carrying capacity. But it pushes populations upward toward (or past) natural limits and weakens natural foraging/predation patterns, raising herbivore pressure and lowering stability and resilience.\",\n          \"text\": \"Provide supplemental feed away from farms\"\n        }\n      ],\n      \"question\": \"How do we reduce plant damage without destabilizing the system?\"\n    },\n    {\n      \"context\": \"Okay, next: the marsh is full of one fast-growing grass after last year’s disturbance. It’s productive, but storms hit hard and everything responds the same way. Do we steer succession or let it run?\",\n      \"options\": [\n        {\n          \"effects\": [\n            {\n              \"change\": 10,\n              \"variable\": \"Biodiversity Resilience\"\n            },\n            {\n              \"change\": -5,\n              \"variable\": \"Herbivore Pressure\"\n            },\n            {\n              \"change\": -3,\n              \"variable\": \"Habitat Carrying Capacity\"\n            },\n            {\n              \"change\": 6,\n              \"variable\": \"Food Web Stability\"\n            }\n          ],\n          \"feedback\": \"Interplanting shrubs, sedges, and flowering natives increases functional diversity, improving resilience and offering varied forage so grazing pressure concentrates less. Mixed structure can slightly lower immediate carrying capacity while plants establish, but it tends to stabilize the food web.\",\n          \"text\": \"Actively plant mid/late-succession natives\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 6,\n              \"variable\": \"Habitat Carrying Capacity\"\n            },\n            {\n              \"change\": -6,\n              \"variable\": \"Biodiversity Resilience\"\n            },\n            {\n              \"change\": -4,\n              \"variable\": \"Food Web Stability\"\n            },\n            {\n              \"change\": 3,\n              \"variable\": \"Herbivore Pressure\"\n            }\n          ],\n          \"feedback\": \"Favoring the dominant grass can maximize near-term biomass, raising carrying capacity. But monoculture-like dominance reduces response options to change, lowering resilience, and simplified structure can weaken food-web buffering, reducing stability. More palatable uniform forage can raise herbivore pressure.\",\n          \"text\": \"Optimize for the dominant grass (mow/seed it)\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": -7,\n              \"variable\": \"Food Web Stability\"\n            },\n            {\n              \"change\": -8,\n              \"variable\": \"Herbivore Pressure\"\n            },\n            {\n              \"change\": 4,\n              \"variable\": \"Biodiversity Resilience\"\n            },\n            {\n              \"change\": -2,\n              \"variable\": \"Habitat Carrying Capacity\"\n            }\n          ],\n          \"feedback\": \"A controlled burn can reset patches and create a mosaic that supports different species, boosting resilience. It can reduce forage short-term, lowering herbivore pressure and slightly lowering carrying capacity, but the disturbance temporarily disrupts interactions, reducing stability.\",\n          \"text\": \"Do a controlled burn to reset patches\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 2,\n              \"variable\": \"Food Web Stability\"\n            },\n            {\n              \"change\": 2,\n              \"variable\": \"Herbivore Pressure\"\n            },\n            {\n              \"change\": -2,\n              \"variable\": \"Biodiversity Resilience\"\n            },\n            {\n              \"change\": 4,\n              \"variable\": \"Habitat Carrying Capacity\"\n            }\n          ],\n          \"feedback\": \"Letting succession proceed avoids a big shock, which can keep stability slightly improving. But without intervention, the dominant species may keep excluding others, reducing resilience. Biomass keeps accumulating, raising carrying capacity, and uniform forage can keep herbivore pressure creeping up.\",\n          \"text\": \"Hands-off: monitor and let succession proceed\"\n        }\n      ],\n      \"question\": \"What do we do about the grass dominance?\"\n    },\n    {\n      \"context\": \"{{NAME}}, we got lab results: nutrient runoff from upstream is spiking algae. Fish are stressed, and oxygen dips are starting. We can’t control the farms directly, but we can manage the marsh’s response. What’s the play?\",\n      \"options\": [\n        {\n          \"effects\": [\n            {\n              \"change\": -8,\n              \"variable\": \"Habitat Carrying Capacity\"\n            },\n            {\n              \"change\": 10,\n              \"variable\": \"Biodiversity Resilience\"\n            },\n            {\n              \"change\": 6,\n              \"variable\": \"Food Web Stability\"\n            },\n            {\n              \"change\": -4,\n              \"variable\": \"Herbivore Pressure\"\n            }\n          ],\n          \"feedback\": \"Building wetlands/filters and expanding riparian plants reduces nutrient pulses and creates more microhabitats, raising resilience and stabilizing the food web. Some open-water habitat gets converted during construction, lowering carrying capacity a bit. Better plant quality and structure can reduce herbivore pressure.\",\n          \"text\": \"Add nutrient-filter wetlands and riparian plantings\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 6,\n              \"variable\": \"Habitat Carrying Capacity\"\n            },\n            {\n              \"change\": -8,\n              \"variable\": \"Biodiversity Resilience\"\n            },\n            {\n              \"change\": -10,\n              \"variable\": \"Food Web Stability\"\n            },\n            {\n              \"change\": 3,\n              \"variable\": \"Herbivore Pressure\"\n            }\n          ],\n          \"feedback\": \"Algaecide can make water look better fast, but it can also remove primary producers abruptly and cause die-offs that destabilize the food web. Collateral damage to non-target species lowers resilience. If water plants rebound uniformly, carrying capacity can rise, and herbivores may increase with easier forage.\",\n          \"text\": \"Use chemical treatment to knock back algae\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": -6,\n              \"variable\": \"Habitat Carrying Capacity\"\n            },\n            {\n              \"change\": 4,\n              \"variable\": \"Food Web Stability\"\n            },\n            {\n              \"change\": -4,\n              \"variable\": \"Herbivore Pressure\"\n            },\n            {\n              \"change\": 2,\n              \"variable\": \"Biodiversity Resilience\"\n            }\n          ],\n          \"feedback\": \"Aeration prevents low-oxygen crashes, which supports more stable interactions and avoids fish kills. It doesn’t add habitat and can disrupt sediments, lowering carrying capacity slightly. By keeping plants and fish healthier, grazing pressure can ease a bit, with a modest resilience gain.\",\n          \"text\": \"Install aerators to prevent oxygen crashes\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": -2,\n              \"variable\": \"Food Web Stability\"\n            },\n            {\n              \"change\": -6,\n              \"variable\": \"Herbivore Pressure\"\n            },\n            {\n              \"change\": -2,\n              \"variable\": \"Biodiversity Resilience\"\n            },\n            {\n              \"change\": -4,\n              \"variable\": \"Habitat Carrying Capacity\"\n            }\n          ],\n          \"feedback\": \"Increasing harvest/angling on herbivores reduces pressure quickly. But pulling biomass out of the system can lower carrying capacity, and selective removal can unintentionally disrupt interactions, slightly lowering stability and resilience.\",\n          \"text\": \"Increase harvest/angling of herbivores\"\n        }\n      ],\n      \"question\": \"How do we respond to the runoff-driven algae problem?\"\n    },\n    {\n      \"context\": \"One more curveball, {{NAME}}: a beaver family moved in. Great for wetland creation, but the board worries about flooding trails and changing plant communities. Do we treat beavers as a problem or a partner?\",\n      \"options\": [\n        {\n          \"effects\": [\n            {\n              \"change\": 12,\n              \"variable\": \"Biodiversity Resilience\"\n            },\n            {\n              \"change\": 5,\n              \"variable\": \"Habitat Carrying Capacity\"\n            },\n            {\n              \"change\": 6,\n              \"variable\": \"Food Web Stability\"\n            },\n            {\n              \"change\": 2,\n              \"variable\": \"Herbivore Pressure\"\n            }\n          ],\n          \"feedback\": \"Letting beavers engineer habitat increases structural diversity and creates new niches, boosting resilience. More wetland area can raise carrying capacity and stabilize food-web pathways. But more woody growth and edge habitat can increase herbivore use slightly, nudging pressure up.\",\n          \"text\": \"Coexist: protect key trees, keep beavers in place\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": -6,\n              \"variable\": \"Biodiversity Resilience\"\n            },\n            {\n              \"change\": -4,\n              \"variable\": \"Habitat Carrying Capacity\"\n            },\n            {\n              \"change\": -5,\n              \"variable\": \"Food Web Stability\"\n            },\n            {\n              \"change\": -2,\n              \"variable\": \"Herbivore Pressure\"\n            }\n          ],\n          \"feedback\": \"Removing beavers prevents some localized flooding but also removes a keystone-like engineer that creates habitat heterogeneity. That reduces resilience, carrying capacity, and stability. With fewer new willow/shrub areas, some herbivore pressure can drop slightly.\",\n          \"text\": \"Relocate/remove the beavers\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 6,\n              \"variable\": \"Food Web Stability\"\n            },\n            {\n              \"change\": 3,\n              \"variable\": \"Biodiversity Resilience\"\n            },\n            {\n              \"change\": 2,\n              \"variable\": \"Habitat Carrying Capacity\"\n            },\n            {\n              \"change\": -4,\n              \"variable\": \"Herbivore Pressure\"\n            }\n          ],\n          \"feedback\": \"Flow devices reduce extreme flooding while keeping dams, so the system keeps many benefits of beaver-driven succession. You retain habitat gains and add predictability, improving stability and resilience. Controlled water levels can reduce lush shoreline browse, lowering herbivore pressure.\",\n          \"text\": \"Install flow devices to control water levels\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": -3,\n              \"variable\": \"Food Web Stability\"\n            },\n            {\n              \"change\": -6,\n              \"variable\": \"Habitat Carrying Capacity\"\n            },\n            {\n              \"change\": -2,\n              \"variable\": \"Biodiversity Resilience\"\n            },\n            {\n              \"change\": 6,\n              \"variable\": \"Herbivore Pressure\"\n            }\n          ],\n          \"feedback\": \"Hardening banks and cutting channels protects trails, but it simplifies habitat and can drain shallow areas, lowering carrying capacity and resilience. The disturbance can destabilize interactions, and concentrating remaining forage can raise herbivore pressure.\",\n          \"text\": \"Harden banks and dredge a channel for drainage\"\n        }\n      ],\n      \"question\": \"What do we do about the beavers?\"\n    }\n  ]\n}",
      "outputTokens": 2230,
      "systemPrompt": "# Role\n\nYou are an expert educational game designer creating a **Challenge** activity for a learning app. Your mission is to design a strategic simulation where learners make decisions that affect inventory variables, navigating trade-offs to meet win conditions using the lesson's concepts.\n\nYou specialize in crafting game-like experiences that test strategic thinking and problem-solving — not just knowledge recall, but the ability to apply concepts under constraints.\n\n# The Art of Strategic Learning\n\nA great Challenge activity doesn't quiz — it simulates. Learners face realistic constraints where every choice has consequences. They must think strategically about trade-offs, just like real-world decision-making.\n\n## Why Trade-Off-Based Scenarios Work\n\n1. **Authentic Complexity**: Real problems have multiple variables that interact. Improving one often affects another.\n\n2. **Strategic Reasoning**: Learners must think several steps ahead, considering how choices compound.\n\n3. **No \"Right Answer\"**: When every option has pros and cons, learners engage with the WHY behind principles.\n\n4. **Memorable Stakes**: Managing resources and meeting goals creates emotional investment in outcomes.\n\n## The Trade-Off Principle\n\nEvery great Challenge activity creates genuine dilemmas:\n\n- **No Perfect Options**: Each choice improves some variables while affecting others\n- **Interconnected Systems**: Variables influence each other meaningfully\n- **Strategic Planning**: Success requires thinking beyond the immediate step\n- **Concept Application**: Understanding the lesson's principles helps navigate trade-offs\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a challenge around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Introduction\n\nThe `intro` field sets the scene (max 500 characters). It should:\n\n- Establish the scenario and the learner's role\n- Explain what they're trying to achieve\n- Create stakes that feel meaningful\n- Use `{{NAME}}` to personalize\n\n## Inventory Design\n\nDesign 3-5 inventory items. Each item includes:\n\n- **name**: Variable name (intuitive, e.g., \"Budget\", \"Team Morale\", \"Code Quality\")\n- **startValue**: Initial value (typically 40-70, leaving room for gains and losses)\n- **winConditions**: Array of 1-2 conditions the learner must meet for this variable\n\nEach variable must:\n\n- **Represent lesson concepts**: Connect to something the learner studied\n- **Have clear meanings**: Names should be intuitive and unambiguous\n- **Interact meaningfully**: Actions that help one variable should plausibly affect others\n- **Name precisely**: Use specific names (e.g., \"Quantity Demanded\" not \"Market Demand\")\n\n### Variable Definition Lock\n\n**Once defined, a variable's meaning is FIXED for all steps.**\n\nBefore creating effects, explicitly define what each variable measures. Then for EVERY effect on that variable, verify the justification uses THE SAME CONCEPT:\n\n- ❌ \"Production Throughput\" defined as units manufactured per hour, but effect justified by \"worker satisfaction\" — these are different things\n- ✅ \"Production Throughput\" increases because \"the new machinery processes components faster\" — same concept\n\n**The test:** Could you replace the variable name with its definition in the feedback and have it still make sense? If not, you've drifted.\n\n### Win Conditions Structure\n\nEach inventory item's `winConditions` array defines success criteria:\n\n- **operator**: `gte` (>=), `lte` (<=), `gt` (>), `lt` (<), `eq` (==)\n- **value**: Target number the variable must meet\n\n**Common patterns:**\n\n- **Minimum threshold**: `[{ \"operator\": \"gte\", \"value\": 30 }]` — \"Don't let Budget drop below 30\"\n- **Maximum threshold**: `[{ \"operator\": \"lte\", \"value\": 70 }]` — \"Keep Risk below 70\"\n- **Range constraint** (two conditions): `[{ \"operator\": \"gte\", \"value\": 20 }, { \"operator\": \"lte\", \"value\": 80 }]` — \"Keep Budget balanced\"\n\n**Example inventory item:**\n\n```json\n{\n  \"name\": \"Budget\",\n  \"startValue\": 50,\n  \"winConditions\": [\n    { \"operator\": \"gte\", \"value\": 20 },\n    { \"operator\": \"lte\", \"value\": 80 }\n  ]\n}\n```\n\n### Win Condition Achievability Check\n\n**MANDATORY**: Before finalizing, verify each win condition is mathematically achievable:\n\n1. Start with `startValue`, calculate achievable range based on cumulative effects\n2. For `gte` conditions: Target ≤ `startValue + (steps × max_positive_effect_per_step)`\n3. For `lte` conditions: Target ≥ `startValue + (steps × max_negative_effect_per_step)`\n4. Leave margin for strategic flexibility — don't require perfect play to win\n\n**Common mistake**: Setting `lte` targets too LOW or `gte` targets too HIGH. If a variable starts at 55 with max -15 per step across 4 steps, minimum achievable is -5. A target of `lte 5` requires dropping 50 points — verify your effects allow this!\n\n## Step Structure\n\nEach step must have:\n\n- **context**: Maximum 500 characters. Pure dialogue from your colleague setting up the decision. Use a conversational style: no narrator, no character prefixes.\n- **question**: Maximum 100 characters. A clear question about what to do.\n- **options**: **EXACTLY 3-4 choices** (never fewer than 3), each with:\n  - **text**: The choice description (max 80 characters)\n  - **effects**: Array of {variable, change} pairs showing how this choice affects inventory\n  - **feedback**: Why this choice has these effects — max 300 characters. Should explain the reasoning, not just state the outcome.\n\n**CRITICAL**: Every step MUST have at least 3 options. Having only 2 options is a format violation.\n\n## Step Count\n\n- Minimum: 3 steps\n- Maximum: 6 steps\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character prefixes, NO action descriptions\n- **Natural conversation**: Colleagues working through a problem together\n- **Professional but warm**: Light humor when appropriate\n- **Second-person immersion**: The colleague speaks TO the learner\n- **Strategic framing**: Dialogue should hint at trade-offs without giving away optimal choices\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear. For example:\n\n- \"{{NAME}}, we need to make a call here.\"\n- \"Good thinking, {{NAME}}. But we should consider the trade-offs.\"\n\n## Effect Design\n\nEvery option must:\n\n- **Have meaningful effects**: At least 1-2 variables should change\n- **Show trade-offs**: Most options should help some variables while hurting others\n- **Use realistic magnitudes**: Changes of 5-20 points are typical; dramatic swings (30+) should be rare\n- **Connect to lesson concepts**: The REASON for effects should reflect lesson principles\n\nExample effects structure:\n\n```json\n{\n  \"effects\": [\n    { \"variable\": \"Budget\", \"change\": -15 },\n    { \"variable\": \"Quality\", \"change\": 10 }\n  ]\n}\n```\n\n## Effect Direction: The Measurement Rule\n\n**ONE RULE**: The sign reflects whether the MEASURED NUMBER goes up or down.\n\n### The Algorithm\n\nFor EVERY effect, apply this test:\n\n1. Imagine a meter/gauge displaying the variable's current value as a number\n2. After this action, will the number on that meter be HIGHER or LOWER?\n3. Higher → positive (+) / Lower → negative (-)\n\nThat's it. Ignore whether the outcome is \"good\" or \"bad\" for the player.\n\n### Why This Works\n\nVariables measure QUANTITIES. The sign indicates CHANGE IN QUANTITY:\n\n- Cost measures dollars spent → spending less → number goes DOWN → negative\n- Time measures duration → finishing faster → number goes DOWN → negative\n- Quality measures goodness → better work → number goes UP → positive\n- Risk measures danger level → safer choice → number goes DOWN → negative\n\n### Self-Check\n\nBefore finalizing each effect, ask:\n\n> \"If this variable were displayed as a number on screen, would this action make that number go UP or DOWN?\"\n\n- UP → use positive (+)\n- DOWN → use negative (-)\n\nThe player's happiness about the outcome is IRRELEVANT to the sign.\n\n### Feedback-Effect Coherence\n\n**The feedback text MUST match the effect direction.**\n\nBefore writing feedback, check that your explanation matches the sign:\n\n- ❌ Effect: `{\"variable\": \"Cost\", \"change\": -10}` + Feedback: \"This increases our costs\" — CONTRADICTION\n- ✅ Effect: `{\"variable\": \"Cost\", \"change\": -10}` + Feedback: \"This reduces our spending\" — COHERENT\n- ❌ Effect: `{\"variable\": \"Risk\", \"change\": 15}` + Feedback: \"This makes things safer\" — CONTRADICTION\n- ✅ Effect: `{\"variable\": \"Risk\", \"change\": 15}` + Feedback: \"This introduces more uncertainty\" — COHERENT\n\n**The test:** Read your feedback aloud, then check the effect sign. Do they tell the same story?\n\n## What to Avoid\n\n- **Dominant options**: No choice should be obviously best across all variables. For EACH step, compare options: if one option has BETTER OR EQUAL effects on ALL variables compared to another, it's dominant. Example: Option A (+10 Quality, -5 Budget) vs Option B (+5 Quality, -10 Budget) — A dominates B. Fix by giving B something A lacks, like +5 Morale.\n- **Trivial decisions**: Every step should require real thought about trade-offs\n- **Disconnected variables**: Effects should make conceptual sense\n- **Extreme swings**: Avoid changes that guarantee win/loss in one step\n- **Narrator text or descriptions**: Keep it pure dialogue\n- **Quiz-style questions**: This tests strategic thinking and problem-solving, not recall\n- **Inverted effect signs**: Never confuse \"good outcome\" with \"positive change\". Apply the Measurement Rule: would the NUMBER go up or down?\n- **Single-path variables**: NEVER create a variable that can only be improved by ONE option in the entire game. Every win condition variable MUST be influenceable by options in multiple steps. Otherwise, that option becomes mandatory and removes player agency\n\n## Scope\n\n- **Stay focused**: The scenario should require THIS lesson's concepts to navigate well\n- **Meaningful variables**: Each inventory variable should connect to lesson principles\n- **Realistic trade-offs**: The trade-offs should reflect how these concepts work in practice\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n- **Story**: WHEN to apply this (dialogue-based problem solving)\n\nYour Challenge activity is the capstone: **CAN YOU HANDLE THIS?** It tests whether learners can apply concepts strategically under constraints. This is the most challenging activity — it should feel like a real test of understanding.\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this?\"\n- **Challenge: \"CAN I navigate complex trade-offs using this?\"**\n\n# Structure Guide\n\nA typical Challenge follows this arc:\n\n1. **Setup**: Establish the scenario, variables, and goal in the intro\n2. **Initial Decision**: First choice with clear trade-offs to teach the mechanics\n3. **Escalating Complexity**: Middle decisions where variables interact more\n4. **Critical Choice**: A pivotal decision that significantly affects outcomes\n5. **Resolution Setup**: Final decision that determines if win conditions are met\n\nNote: The challenge should feel winnable but require understanding the lesson's principles to succeed consistently.\n\n# Dialogue Tone Examples\n\n## Setting Up Trade-Offs\n\n> \"{{NAME}}, here's our situation. We can push for faster delivery, but that means cutting corners on testing. Or we take our time and risk missing the window. What's our priority?\"\n\n> \"The client wants both lower costs AND higher quality. {{NAME}}, we both know we can't maximize both. Where do we compromise?\"\n\n## Explaining Consequences\n\n> \"Interesting choice, {{NAME}}. Going that route saved us time, but I'm already seeing signs of technical debt building up. Let's see how this plays out.\"\n\n> \"That definitely boosted our short-term numbers. But {{NAME}}, remember — these variables are connected. Watch what happens next.\"\n\n## Strategic Moments\n\n> \"{{NAME}}, we're at a crossroads. Our budget is tight, but team morale is dropping. If we don't address one, the other gets worse. What's your call?\"\n\n> \"This is the big one, {{NAME}}. The choice we make here pretty much determines whether we hit our targets. No pressure.\"\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Does the intro clearly establish the scenario, goal, and stakes?\n- [ ] Do inventory variables connect meaningfully to lesson concepts?\n- [ ] MATHEMATICAL ACHIEVABILITY: For each win condition, is the target mathematically reachable given startValue and cumulative effect ranges? (Calculate: startValue + sum of max effects in desired direction)\n- [ ] Does every option have genuine trade-offs (no dominant choices)?\n- [ ] Do effects make conceptual sense given the lesson content?\n- [ ] Is `{{NAME}}` used appropriately throughout?\n- [ ] Is all dialogue pure conversation (no narrator, no prefixes)?\n- [ ] Does feedback explain WHY effects occur, not just state them?\n- [ ] Is the scope exactly the lesson topic?\n- [ ] Are all constraints met (intro ≤500 chars, context ≤500 chars, question ≤100 chars, text ≤80 chars, feedback ≤300 chars)?\n- [ ] Is the step count between 3 and 6?\n- [ ] Do inventory values start in a reasonable range (typically 40-70)?\n- [ ] Are effect magnitudes reasonable (typically 5-20 points)?\n- [ ] For EACH effect, apply the Measurement Rule: if this variable were a number on screen, would this action make it go UP (+) or DOWN (-)?\n- [ ] Does EVERY step have at least 3 options? (Never just 2 options)\n- [ ] Does each inventory item have at least one win condition?\n- [ ] For each variable, are there multiple options across different steps that can affect it? (No single-path variables)\n- [ ] FEEDBACK-EFFECT COHERENCE: For each option, does the feedback text match the effect direction? (e.g., negative change + \"reduces X\" = coherent; negative change + \"increases X\" = contradiction)\n- [ ] VARIABLE DEFINITION: For each variable, is the justification in every feedback consistent with the variable's original definition?\n- [ ] DOMINANT OPTIONS: For each step, is there any option that beats another on ALL variables? If so, fix it by giving the weaker option a unique advantage.\n\n# Output Format\n\nReturn an object with:\n\n- **intro**: Scenario introduction (max 500 chars)\n- **inventory**: Array of 3-5 inventory items, each with:\n  - **name**: Variable name\n  - **startValue**: Initial value (typically 40-70)\n  - **winConditions**: Array of 1-2 conditions, each with:\n    - **operator**: One of \"gte\", \"lte\", \"gt\", \"lt\", \"eq\"\n    - **value**: Target number\n- **steps**: Array of 3-6 step objects, each with:\n  - **context**: Pure dialogue (max 500 chars)\n  - **question**: Decision prompt (max 100 chars)\n  - **options**: Array of 3-4 objects with:\n    - **text**: Choice description (max 80 chars)\n    - **effects**: Array of {variable, change} pairs\n    - **feedback**: Explanation of effects (max 300 chars)\n",
      "testCaseId": "en-biology-ecosystem-balance-1",
      "userPrompt": "LESSON_TITLE: Ecosystem Balance and Management\nLESSON_DESCRIPTION: Applying ecological principles to make informed ecosystem management decisions\nCHAPTER_TITLE: Ecosystem Dynamics\nCOURSE_TITLE: Ecology and Conservation\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. Interconnected Networks: Ecosystems are interconnected networks. Removing one species affects others through food webs. Keystone species have disproportionate impact — their loss cascades through the system.\n2. Carrying Capacity: Carrying capacity is the maximum population an environment can sustain. Exceed it, and resources deplete, populations crash. Stay well below, and you're not maximizing the ecosystem's potential.\n3. Biodiversity and Resilience: Biodiversity provides resilience. More species means more ways to respond to change. Monocultures are efficient but fragile. Diverse systems are robust but complex to manage.\n4. Trophic Cascades: Trophic cascades occur when changes at one level ripple through others. Remove predators, and prey populations explode, overgrazing vegetation, affecting everything that depends on those plants.\n5. Ecological Succession: Ecological succession is the process of change over time. Pioneer species prepare the way for later ones. Managing ecosystems means deciding where in succession you want to be."
    },
    {
      "duration": 39837.310958999995,
      "inputTokens": 4085,
      "output": "{\n  \"intro\": \"{{NAME}}, a planta quer aumentar a produção de amônia (Haber-Bosch) antes do pico de demanda. Você decide como mexer em concentração, pressão, temperatura e catalisador sem estourar energia e sem aumentar riscos. No fim, precisamos alta taxa de produção e bom rendimento no equilíbrio — ou perdemos o contrato.\",\n  \"inventory\": [\n    {\n      \"name\": \"Rendimento de Amônia no Equilíbrio\",\n      \"startValue\": 55,\n      \"winConditions\": [\n        {\n          \"operator\": \"gte\",\n          \"value\": 70\n        }\n      ]\n    },\n    {\n      \"name\": \"Taxa de Produção (Chegar ao Equilíbrio)\",\n      \"startValue\": 50,\n      \"winConditions\": [\n        {\n          \"operator\": \"gte\",\n          \"value\": 65\n        }\n      ]\n    },\n    {\n      \"name\": \"Custo de Energia\",\n      \"startValue\": 55,\n      \"winConditions\": [\n        {\n          \"operator\": \"lte\",\n          \"value\": 70\n        }\n      ]\n    },\n    {\n      \"name\": \"Risco Operacional\",\n      \"startValue\": 45,\n      \"winConditions\": [\n        {\n          \"operator\": \"lte\",\n          \"value\": 65\n        }\n      ]\n    }\n  ],\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, o diretor quer mais NH3, mas cada alavanca muda outra coisa. Se a gente errar, até melhora a taxa e piora o rendimento. Por onde começamos no reator?\",\n      \"options\": [\n        {\n          \"effects\": [\n            {\n              \"change\": 12,\n              \"variable\": \"Rendimento de Amônia no Equilíbrio\"\n            },\n            {\n              \"change\": 10,\n              \"variable\": \"Custo de Energia\"\n            },\n            {\n              \"change\": 12,\n              \"variable\": \"Risco Operacional\"\n            }\n          ],\n          \"feedback\": \"Aumentar a pressão desloca o equilíbrio para o lado com menos mols gasosos (favorece NH3). Só que comprimir gás custa energia e eleva o risco mecânico/operacional do sistema pressurizado.\",\n          \"text\": \"Aumentar bastante a pressão do reator\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 6,\n              \"variable\": \"Rendimento de Amônia no Equilíbrio\"\n            },\n            {\n              \"change\": 5,\n              \"variable\": \"Custo de Energia\"\n            },\n            {\n              \"change\": 6,\n              \"variable\": \"Risco Operacional\"\n            }\n          ],\n          \"feedback\": \"Um aumento moderado de pressão ainda favorece o lado com menos mols (mais NH3), mas com impactos menores de energia e risco do que um salto agressivo de pressão.\",\n          \"text\": \"Aumentar a pressão moderadamente\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": -6,\n              \"variable\": \"Rendimento de Amônia no Equilíbrio\"\n            },\n            {\n              \"change\": -8,\n              \"variable\": \"Custo de Energia\"\n            },\n            {\n              \"change\": -6,\n              \"variable\": \"Risco Operacional\"\n            }\n          ],\n          \"feedback\": \"Reduzir pressão favorece o lado com mais mols de gás, indo contra a formação de NH3. Em compensação, cai o gasto com compressão e diminui o risco associado à operação em alta pressão.\",\n          \"text\": \"Reduzir a pressão para aliviar o sistema\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 10,\n              \"variable\": \"Taxa de Produção (Chegar ao Equilíbrio)\"\n            },\n            {\n              \"change\": 4,\n              \"variable\": \"Custo de Energia\"\n            }\n          ],\n          \"feedback\": \"Um catalisador não desloca o equilíbrio, mas acelera as duas direções e faz o sistema chegar ao equilíbrio mais rápido. Há custo/energia de manutenção e operação do leito catalítico, mas o rendimento no equilíbrio não muda por isso.\",\n          \"text\": \"Trocar para um catalisador mais ativo\"\n        }\n      ],\n      \"question\": \"Qual ajuste inicial você aprova?\"\n    },\n    {\n      \"context\": \"Ok. Agora a equipe de processo pergunta sobre a temperatura. Eles querem acelerar a reação, mas você sabe que temperatura mexe com a constante de equilíbrio. E aqui a síntese de amônia é exotérmica.\",\n      \"options\": [\n        {\n          \"effects\": [\n            {\n              \"change\": 12,\n              \"variable\": \"Taxa de Produção (Chegar ao Equilíbrio)\"\n            },\n            {\n              \"change\": -10,\n              \"variable\": \"Rendimento de Amônia no Equilíbrio\"\n            },\n            {\n              \"change\": 8,\n              \"variable\": \"Custo de Energia\"\n            },\n            {\n              \"change\": 5,\n              \"variable\": \"Risco Operacional\"\n            }\n          ],\n          \"feedback\": \"Subir a temperatura aumenta a velocidade e ajuda a chegar ao equilíbrio mais rápido. Mas, por ser exotérmica, temperatura maior desloca o equilíbrio para reagentes, reduzindo o rendimento de NH3. Também eleva gasto energético e risco térmico.\",\n          \"text\": \"Aumentar a temperatura para maximizar velocidade\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 6,\n              \"variable\": \"Taxa de Produção (Chegar ao Equilíbrio)\"\n            },\n            {\n              \"change\": -4,\n              \"variable\": \"Rendimento de Amônia no Equilíbrio\"\n            },\n            {\n              \"change\": 4,\n              \"variable\": \"Custo de Energia\"\n            },\n            {\n              \"change\": 2,\n              \"variable\": \"Risco Operacional\"\n            }\n          ],\n          \"feedback\": \"Um aumento moderado ainda melhora a cinética, mas com perda menor no equilíbrio (exotérmica) e menor penalidade de energia e segurança do que aquecer demais.\",\n          \"text\": \"Aumentar um pouco a temperatura\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": -8,\n              \"variable\": \"Taxa de Produção (Chegar ao Equilíbrio)\"\n            },\n            {\n              \"change\": 10,\n              \"variable\": \"Rendimento de Amônia no Equilíbrio\"\n            },\n            {\n              \"change\": -4,\n              \"variable\": \"Custo de Energia\"\n            },\n            {\n              \"change\": -2,\n              \"variable\": \"Risco Operacional\"\n            }\n          ],\n          \"feedback\": \"Diminuir a temperatura favorece produtos em reações exotérmicas, elevando o rendimento de NH3 no equilíbrio. Só que a cinética piora e a aproximação ao equilíbrio fica mais lenta. Com menos aquecimento, cai o custo e o estresse térmico.\",\n          \"text\": \"Diminuir a temperatura para favorecer o equilíbrio\"\n        }\n      ],\n      \"question\": \"Como você ajusta a temperatura?\"\n    },\n    {\n      \"context\": \"{{NAME}}, o pessoal da separação sugeriu retirar NH3 continuamente após a condensação. O time de suprimentos também oferece aumentar a alimentação de N2/H2. Isso vira um jogo de concentração e de fluxo — com custo e estabilidade.\",\n      \"options\": [\n        {\n          \"effects\": [\n            {\n              \"change\": 12,\n              \"variable\": \"Rendimento de Amônia no Equilíbrio\"\n            },\n            {\n              \"change\": 5,\n              \"variable\": \"Taxa de Produção (Chegar ao Equilíbrio)\"\n            },\n            {\n              \"change\": 8,\n              \"variable\": \"Custo de Energia\"\n            },\n            {\n              \"change\": 3,\n              \"variable\": \"Risco Operacional\"\n            }\n          ],\n          \"feedback\": \"Remover produto (NH3) puxa o equilíbrio para formar mais NH3. A condensação/recuperação consome energia e adiciona complexidade operacional, elevando um pouco o risco, mas também pode ajudar a manter o processo produzindo de forma estável.\",\n          \"text\": \"Remover NH3 continuamente (puxar o equilíbrio)\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 8,\n              \"variable\": \"Rendimento de Amônia no Equilíbrio\"\n            },\n            {\n              \"change\": 10,\n              \"variable\": \"Taxa de Produção (Chegar ao Equilíbrio)\"\n            },\n            {\n              \"change\": 10,\n              \"variable\": \"Custo de Energia\"\n            },\n            {\n              \"change\": 6,\n              \"variable\": \"Risco Operacional\"\n            }\n          ],\n          \"feedback\": \"Aumentar reagentes desloca o equilíbrio para produtos e eleva a taxa por maior disponibilidade de colisões efetivas. Porém, comprimir/bombear mais gás e gerenciar maior vazão aumenta energia e risco operacional.\",\n          \"text\": \"Aumentar bastante a alimentação de N2/H2\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 4,\n              \"variable\": \"Rendimento de Amônia no Equilíbrio\"\n            },\n            {\n              \"change\": 5,\n              \"variable\": \"Taxa de Produção (Chegar ao Equilíbrio)\"\n            },\n            {\n              \"change\": 6,\n              \"variable\": \"Custo de Energia\"\n            },\n            {\n              \"change\": 3,\n              \"variable\": \"Risco Operacional\"\n            }\n          ],\n          \"feedback\": \"Um aumento moderado de reagentes ainda desloca para NH3 e melhora um pouco a taxa, com penalidades menores de energia e risco do que uma subida agressiva de vazão.\",\n          \"text\": \"Aumentar moderadamente a alimentação de N2/H2\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": -6,\n              \"variable\": \"Taxa de Produção (Chegar ao Equilíbrio)\"\n            },\n            {\n              \"change\": -6,\n              \"variable\": \"Custo de Energia\"\n            },\n            {\n              \"change\": -4,\n              \"variable\": \"Risco Operacional\"\n            }\n          ],\n          \"feedback\": \"Manter a alimentação reduz variações e carga de compressão, baixando custo e risco. Mas sem mexer em concentração nem retirar produto, a taxa e o rendimento ficam limitados ao que já foi ajustado.\",\n          \"text\": \"Manter alimentação e focar em estabilidade\"\n        }\n      ],\n      \"question\": \"Qual estratégia de concentração você escolhe?\"\n    },\n    {\n      \"context\": \"Última decisão, {{NAME}}. A segurança quer margem; o comercial quer número. A gente pode empurrar pressão/fluxo, ou operar mais conservador e confiar no catalisador e na separação. O que você fecha como modo de operação?\",\n      \"options\": [\n        {\n          \"effects\": [\n            {\n              \"change\": 6,\n              \"variable\": \"Rendimento de Amônia no Equilíbrio\"\n            },\n            {\n              \"change\": 8,\n              \"variable\": \"Taxa de Produção (Chegar ao Equilíbrio)\"\n            },\n            {\n              \"change\": 12,\n              \"variable\": \"Custo de Energia\"\n            },\n            {\n              \"change\": 12,\n              \"variable\": \"Risco Operacional\"\n            }\n          ],\n          \"feedback\": \"Operar no limite (pressão/fluxo altos) tende a elevar rendimento e taxa via Le Chatelier e maior disponibilidade de reagentes, mas cobra caro em compressão e aumenta o risco por estresse mecânico e exigência de controles mais agressivos.\",\n          \"text\": \"Operar no limite de pressão e vazão permitidos\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 4,\n              \"variable\": \"Rendimento de Amônia no Equilíbrio\"\n            },\n            {\n              \"change\": 5,\n              \"variable\": \"Taxa de Produção (Chegar ao Equilíbrio)\"\n            },\n            {\n              \"change\": 6,\n              \"variable\": \"Custo de Energia\"\n            },\n            {\n              \"change\": 6,\n              \"variable\": \"Risco Operacional\"\n            }\n          ],\n          \"feedback\": \"Um ajuste intermediário ainda melhora desempenho, mas sem levar o sistema a extremos. Você ganha um pouco em rendimento e taxa, com aumentos moderados de energia e risco.\",\n          \"text\": \"Operar em regime intermediário e monitorar\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": -4,\n              \"variable\": \"Rendimento de Amônia no Equilíbrio\"\n            },\n            {\n              \"change\": -6,\n              \"variable\": \"Taxa de Produção (Chegar ao Equilíbrio)\"\n            },\n            {\n              \"change\": -6,\n              \"variable\": \"Custo de Energia\"\n            },\n            {\n              \"change\": -10,\n              \"variable\": \"Risco Operacional\"\n            }\n          ],\n          \"feedback\": \"Reduzir severidade (menos pressão/fluxo) diminui risco e custo, mas enfraquece o deslocamento de equilíbrio e a produtividade. É a escolha mais segura, porém pode não bater a meta de NH3.\",\n          \"text\": \"Operar conservador para priorizar segurança e custo\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 0,\n              \"variable\": \"Rendimento de Amônia no Equilíbrio\"\n            },\n            {\n              \"change\": 10,\n              \"variable\": \"Taxa de Produção (Chegar ao Equilíbrio)\"\n            },\n            {\n              \"change\": 5,\n              \"variable\": \"Custo de Energia\"\n            },\n            {\n              \"change\": 2,\n              \"variable\": \"Risco Operacional\"\n            }\n          ],\n          \"feedback\": \"Aumentar o volume de catalisador acelera a aproximação ao equilíbrio (mais área ativa), elevando a taxa, mas não altera a posição do equilíbrio. Há custo/energia extra de operação e pequena elevação de risco por complexidade do leito.\",\n          \"text\": \"Aumentar carga de catalisador e manter setpoints\"\n        }\n      ],\n      \"question\": \"Qual modo de operação você define para o mês?\"\n    }\n  ]\n}",
      "outputTokens": 2225,
      "systemPrompt": "# Role\n\nYou are an expert educational game designer creating a **Challenge** activity for a learning app. Your mission is to design a strategic simulation where learners make decisions that affect inventory variables, navigating trade-offs to meet win conditions using the lesson's concepts.\n\nYou specialize in crafting game-like experiences that test strategic thinking and problem-solving — not just knowledge recall, but the ability to apply concepts under constraints.\n\n# The Art of Strategic Learning\n\nA great Challenge activity doesn't quiz — it simulates. Learners face realistic constraints where every choice has consequences. They must think strategically about trade-offs, just like real-world decision-making.\n\n## Why Trade-Off-Based Scenarios Work\n\n1. **Authentic Complexity**: Real problems have multiple variables that interact. Improving one often affects another.\n\n2. **Strategic Reasoning**: Learners must think several steps ahead, considering how choices compound.\n\n3. **No \"Right Answer\"**: When every option has pros and cons, learners engage with the WHY behind principles.\n\n4. **Memorable Stakes**: Managing resources and meeting goals creates emotional investment in outcomes.\n\n## The Trade-Off Principle\n\nEvery great Challenge activity creates genuine dilemmas:\n\n- **No Perfect Options**: Each choice improves some variables while affecting others\n- **Interconnected Systems**: Variables influence each other meaningfully\n- **Strategic Planning**: Success requires thinking beyond the immediate step\n- **Concept Application**: Understanding the lesson's principles helps navigate trade-offs\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a challenge around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Introduction\n\nThe `intro` field sets the scene (max 500 characters). It should:\n\n- Establish the scenario and the learner's role\n- Explain what they're trying to achieve\n- Create stakes that feel meaningful\n- Use `{{NAME}}` to personalize\n\n## Inventory Design\n\nDesign 3-5 inventory items. Each item includes:\n\n- **name**: Variable name (intuitive, e.g., \"Budget\", \"Team Morale\", \"Code Quality\")\n- **startValue**: Initial value (typically 40-70, leaving room for gains and losses)\n- **winConditions**: Array of 1-2 conditions the learner must meet for this variable\n\nEach variable must:\n\n- **Represent lesson concepts**: Connect to something the learner studied\n- **Have clear meanings**: Names should be intuitive and unambiguous\n- **Interact meaningfully**: Actions that help one variable should plausibly affect others\n- **Name precisely**: Use specific names (e.g., \"Quantity Demanded\" not \"Market Demand\")\n\n### Variable Definition Lock\n\n**Once defined, a variable's meaning is FIXED for all steps.**\n\nBefore creating effects, explicitly define what each variable measures. Then for EVERY effect on that variable, verify the justification uses THE SAME CONCEPT:\n\n- ❌ \"Production Throughput\" defined as units manufactured per hour, but effect justified by \"worker satisfaction\" — these are different things\n- ✅ \"Production Throughput\" increases because \"the new machinery processes components faster\" — same concept\n\n**The test:** Could you replace the variable name with its definition in the feedback and have it still make sense? If not, you've drifted.\n\n### Win Conditions Structure\n\nEach inventory item's `winConditions` array defines success criteria:\n\n- **operator**: `gte` (>=), `lte` (<=), `gt` (>), `lt` (<), `eq` (==)\n- **value**: Target number the variable must meet\n\n**Common patterns:**\n\n- **Minimum threshold**: `[{ \"operator\": \"gte\", \"value\": 30 }]` — \"Don't let Budget drop below 30\"\n- **Maximum threshold**: `[{ \"operator\": \"lte\", \"value\": 70 }]` — \"Keep Risk below 70\"\n- **Range constraint** (two conditions): `[{ \"operator\": \"gte\", \"value\": 20 }, { \"operator\": \"lte\", \"value\": 80 }]` — \"Keep Budget balanced\"\n\n**Example inventory item:**\n\n```json\n{\n  \"name\": \"Budget\",\n  \"startValue\": 50,\n  \"winConditions\": [\n    { \"operator\": \"gte\", \"value\": 20 },\n    { \"operator\": \"lte\", \"value\": 80 }\n  ]\n}\n```\n\n### Win Condition Achievability Check\n\n**MANDATORY**: Before finalizing, verify each win condition is mathematically achievable:\n\n1. Start with `startValue`, calculate achievable range based on cumulative effects\n2. For `gte` conditions: Target ≤ `startValue + (steps × max_positive_effect_per_step)`\n3. For `lte` conditions: Target ≥ `startValue + (steps × max_negative_effect_per_step)`\n4. Leave margin for strategic flexibility — don't require perfect play to win\n\n**Common mistake**: Setting `lte` targets too LOW or `gte` targets too HIGH. If a variable starts at 55 with max -15 per step across 4 steps, minimum achievable is -5. A target of `lte 5` requires dropping 50 points — verify your effects allow this!\n\n## Step Structure\n\nEach step must have:\n\n- **context**: Maximum 500 characters. Pure dialogue from your colleague setting up the decision. Use a conversational style: no narrator, no character prefixes.\n- **question**: Maximum 100 characters. A clear question about what to do.\n- **options**: **EXACTLY 3-4 choices** (never fewer than 3), each with:\n  - **text**: The choice description (max 80 characters)\n  - **effects**: Array of {variable, change} pairs showing how this choice affects inventory\n  - **feedback**: Why this choice has these effects — max 300 characters. Should explain the reasoning, not just state the outcome.\n\n**CRITICAL**: Every step MUST have at least 3 options. Having only 2 options is a format violation.\n\n## Step Count\n\n- Minimum: 3 steps\n- Maximum: 6 steps\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character prefixes, NO action descriptions\n- **Natural conversation**: Colleagues working through a problem together\n- **Professional but warm**: Light humor when appropriate\n- **Second-person immersion**: The colleague speaks TO the learner\n- **Strategic framing**: Dialogue should hint at trade-offs without giving away optimal choices\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear. For example:\n\n- \"{{NAME}}, we need to make a call here.\"\n- \"Good thinking, {{NAME}}. But we should consider the trade-offs.\"\n\n## Effect Design\n\nEvery option must:\n\n- **Have meaningful effects**: At least 1-2 variables should change\n- **Show trade-offs**: Most options should help some variables while hurting others\n- **Use realistic magnitudes**: Changes of 5-20 points are typical; dramatic swings (30+) should be rare\n- **Connect to lesson concepts**: The REASON for effects should reflect lesson principles\n\nExample effects structure:\n\n```json\n{\n  \"effects\": [\n    { \"variable\": \"Budget\", \"change\": -15 },\n    { \"variable\": \"Quality\", \"change\": 10 }\n  ]\n}\n```\n\n## Effect Direction: The Measurement Rule\n\n**ONE RULE**: The sign reflects whether the MEASURED NUMBER goes up or down.\n\n### The Algorithm\n\nFor EVERY effect, apply this test:\n\n1. Imagine a meter/gauge displaying the variable's current value as a number\n2. After this action, will the number on that meter be HIGHER or LOWER?\n3. Higher → positive (+) / Lower → negative (-)\n\nThat's it. Ignore whether the outcome is \"good\" or \"bad\" for the player.\n\n### Why This Works\n\nVariables measure QUANTITIES. The sign indicates CHANGE IN QUANTITY:\n\n- Cost measures dollars spent → spending less → number goes DOWN → negative\n- Time measures duration → finishing faster → number goes DOWN → negative\n- Quality measures goodness → better work → number goes UP → positive\n- Risk measures danger level → safer choice → number goes DOWN → negative\n\n### Self-Check\n\nBefore finalizing each effect, ask:\n\n> \"If this variable were displayed as a number on screen, would this action make that number go UP or DOWN?\"\n\n- UP → use positive (+)\n- DOWN → use negative (-)\n\nThe player's happiness about the outcome is IRRELEVANT to the sign.\n\n### Feedback-Effect Coherence\n\n**The feedback text MUST match the effect direction.**\n\nBefore writing feedback, check that your explanation matches the sign:\n\n- ❌ Effect: `{\"variable\": \"Cost\", \"change\": -10}` + Feedback: \"This increases our costs\" — CONTRADICTION\n- ✅ Effect: `{\"variable\": \"Cost\", \"change\": -10}` + Feedback: \"This reduces our spending\" — COHERENT\n- ❌ Effect: `{\"variable\": \"Risk\", \"change\": 15}` + Feedback: \"This makes things safer\" — CONTRADICTION\n- ✅ Effect: `{\"variable\": \"Risk\", \"change\": 15}` + Feedback: \"This introduces more uncertainty\" — COHERENT\n\n**The test:** Read your feedback aloud, then check the effect sign. Do they tell the same story?\n\n## What to Avoid\n\n- **Dominant options**: No choice should be obviously best across all variables. For EACH step, compare options: if one option has BETTER OR EQUAL effects on ALL variables compared to another, it's dominant. Example: Option A (+10 Quality, -5 Budget) vs Option B (+5 Quality, -10 Budget) — A dominates B. Fix by giving B something A lacks, like +5 Morale.\n- **Trivial decisions**: Every step should require real thought about trade-offs\n- **Disconnected variables**: Effects should make conceptual sense\n- **Extreme swings**: Avoid changes that guarantee win/loss in one step\n- **Narrator text or descriptions**: Keep it pure dialogue\n- **Quiz-style questions**: This tests strategic thinking and problem-solving, not recall\n- **Inverted effect signs**: Never confuse \"good outcome\" with \"positive change\". Apply the Measurement Rule: would the NUMBER go up or down?\n- **Single-path variables**: NEVER create a variable that can only be improved by ONE option in the entire game. Every win condition variable MUST be influenceable by options in multiple steps. Otherwise, that option becomes mandatory and removes player agency\n\n## Scope\n\n- **Stay focused**: The scenario should require THIS lesson's concepts to navigate well\n- **Meaningful variables**: Each inventory variable should connect to lesson principles\n- **Realistic trade-offs**: The trade-offs should reflect how these concepts work in practice\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n- **Story**: WHEN to apply this (dialogue-based problem solving)\n\nYour Challenge activity is the capstone: **CAN YOU HANDLE THIS?** It tests whether learners can apply concepts strategically under constraints. This is the most challenging activity — it should feel like a real test of understanding.\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this?\"\n- **Challenge: \"CAN I navigate complex trade-offs using this?\"**\n\n# Structure Guide\n\nA typical Challenge follows this arc:\n\n1. **Setup**: Establish the scenario, variables, and goal in the intro\n2. **Initial Decision**: First choice with clear trade-offs to teach the mechanics\n3. **Escalating Complexity**: Middle decisions where variables interact more\n4. **Critical Choice**: A pivotal decision that significantly affects outcomes\n5. **Resolution Setup**: Final decision that determines if win conditions are met\n\nNote: The challenge should feel winnable but require understanding the lesson's principles to succeed consistently.\n\n# Dialogue Tone Examples\n\n## Setting Up Trade-Offs\n\n> \"{{NAME}}, here's our situation. We can push for faster delivery, but that means cutting corners on testing. Or we take our time and risk missing the window. What's our priority?\"\n\n> \"The client wants both lower costs AND higher quality. {{NAME}}, we both know we can't maximize both. Where do we compromise?\"\n\n## Explaining Consequences\n\n> \"Interesting choice, {{NAME}}. Going that route saved us time, but I'm already seeing signs of technical debt building up. Let's see how this plays out.\"\n\n> \"That definitely boosted our short-term numbers. But {{NAME}}, remember — these variables are connected. Watch what happens next.\"\n\n## Strategic Moments\n\n> \"{{NAME}}, we're at a crossroads. Our budget is tight, but team morale is dropping. If we don't address one, the other gets worse. What's your call?\"\n\n> \"This is the big one, {{NAME}}. The choice we make here pretty much determines whether we hit our targets. No pressure.\"\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Does the intro clearly establish the scenario, goal, and stakes?\n- [ ] Do inventory variables connect meaningfully to lesson concepts?\n- [ ] MATHEMATICAL ACHIEVABILITY: For each win condition, is the target mathematically reachable given startValue and cumulative effect ranges? (Calculate: startValue + sum of max effects in desired direction)\n- [ ] Does every option have genuine trade-offs (no dominant choices)?\n- [ ] Do effects make conceptual sense given the lesson content?\n- [ ] Is `{{NAME}}` used appropriately throughout?\n- [ ] Is all dialogue pure conversation (no narrator, no prefixes)?\n- [ ] Does feedback explain WHY effects occur, not just state them?\n- [ ] Is the scope exactly the lesson topic?\n- [ ] Are all constraints met (intro ≤500 chars, context ≤500 chars, question ≤100 chars, text ≤80 chars, feedback ≤300 chars)?\n- [ ] Is the step count between 3 and 6?\n- [ ] Do inventory values start in a reasonable range (typically 40-70)?\n- [ ] Are effect magnitudes reasonable (typically 5-20 points)?\n- [ ] For EACH effect, apply the Measurement Rule: if this variable were a number on screen, would this action make it go UP (+) or DOWN (-)?\n- [ ] Does EVERY step have at least 3 options? (Never just 2 options)\n- [ ] Does each inventory item have at least one win condition?\n- [ ] For each variable, are there multiple options across different steps that can affect it? (No single-path variables)\n- [ ] FEEDBACK-EFFECT COHERENCE: For each option, does the feedback text match the effect direction? (e.g., negative change + \"reduces X\" = coherent; negative change + \"increases X\" = contradiction)\n- [ ] VARIABLE DEFINITION: For each variable, is the justification in every feedback consistent with the variable's original definition?\n- [ ] DOMINANT OPTIONS: For each step, is there any option that beats another on ALL variables? If so, fix it by giving the weaker option a unique advantage.\n\n# Output Format\n\nReturn an object with:\n\n- **intro**: Scenario introduction (max 500 chars)\n- **inventory**: Array of 3-5 inventory items, each with:\n  - **name**: Variable name\n  - **startValue**: Initial value (typically 40-70)\n  - **winConditions**: Array of 1-2 conditions, each with:\n    - **operator**: One of \"gte\", \"lte\", \"gt\", \"lt\", \"eq\"\n    - **value**: Target number\n- **steps**: Array of 3-6 step objects, each with:\n  - **context**: Pure dialogue (max 500 chars)\n  - **question**: Decision prompt (max 100 chars)\n  - **options**: Array of 3-4 objects with:\n    - **text**: Choice description (max 80 chars)\n    - **effects**: Array of {variable, change} pairs\n    - **feedback**: Explanation of effects (max 300 chars)\n",
      "testCaseId": "pt-chemistry-reaction-equilibrium-1",
      "userPrompt": "LESSON_TITLE: Equilibrio Quimico na Pratica\nLESSON_DESCRIPTION: Aplicando o principio de Le Chatelier para otimizar reacoes quimicas e processos industriais\nCHAPTER_TITLE: Equilibrio Quimico\nCOURSE_TITLE: Quimica Geral II\nLANGUAGE: pt\nEXPLANATION_STEPS:\n1. Principio de Le Chatelier: O principio de Le Chatelier diz que um sistema em equilibrio responde a perturbacoes minimizando a mudanca. Adicione reagente, o equilibrio desloca para consumir esse reagente.\n2. Efeito da Concentracao: Mudancas de concentracao deslocam o equilibrio. Adicionar reagentes desloca para produtos. Remover produtos tambem desloca para produtos. O sistema busca restaurar o equilibrio.\n3. Efeito da Pressao: A pressao afeta equilibrios gasosos. Aumentar pressao favorece o lado com menos moles de gas. Diminuir pressao favorece o lado com mais moles. Gases inertes nao afetam.\n4. Efeito da Temperatura: Temperatura e diferente — ela muda a constante de equilibrio. Reacoes exotermicas: aumento de temperatura desloca para reagentes. Reacoes endotermicas: aumento favorece produtos.\n5. Papel dos Catalisadores: Catalisadores aceleram ambas as direcoes igualmente. Eles nao deslocam o equilibrio — apenas ajudam a alcancar o equilibrio mais rapido. Util para processos industriais."
    },
    {
      "duration": 39324.242041000005,
      "inputTokens": 4086,
      "output": "{\n  \"intro\": \"{{NAME}}, tenemos que diseñar el sistema energético de una microplanta para un hospital rural. Hay demanda 24/7, presupuesto limitado y cero tolerancia a apagones. Tu trabajo es decidir arquitectura, almacenamiento y mejoras para cumplir metas de eficiencia y confiabilidad sin disparar costos.\",\n  \"inventory\": [\n    {\n      \"name\": \"Eficiencia Total del Sistema\",\n      \"startValue\": 55,\n      \"winConditions\": [\n        {\n          \"operator\": \"gte\",\n          \"value\": 65\n        }\n      ]\n    },\n    {\n      \"name\": \"Energía Perdida como Calor\",\n      \"startValue\": 45,\n      \"winConditions\": [\n        {\n          \"operator\": \"lte\",\n          \"value\": 40\n        }\n      ]\n    },\n    {\n      \"name\": \"Confiabilidad del Suministro\",\n      \"startValue\": 50,\n      \"winConditions\": [\n        {\n          \"operator\": \"gte\",\n          \"value\": 60\n        }\n      ]\n    },\n    {\n      \"name\": \"Presupuesto Disponible\",\n      \"startValue\": 60,\n      \"winConditions\": [\n        {\n          \"operator\": \"gte\",\n          \"value\": 35\n        }\n      ]\n    }\n  ],\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, primera decisión: la arquitectura. Podemos ir directo de la fuente a las cargas o meter más conversiones para “adaptar” tensiones y usos. Más etapas suele dar flexibilidad, pero recuerda lo de pérdidas en cadena.\",\n      \"options\": [\n        {\n          \"effects\": [\n            {\n              \"change\": 12,\n              \"variable\": \"Eficiencia Total del Sistema\"\n            },\n            {\n              \"change\": -8,\n              \"variable\": \"Energía Perdida como Calor\"\n            },\n            {\n              \"change\": -5,\n              \"variable\": \"Confiabilidad del Suministro\"\n            }\n          ],\n          \"feedback\": \"Reducir etapas de conversión evita pérdidas acumuladas, así sube la eficiencia y baja el calor desperdiciado. Pero queda menos flexibilidad para picos o variaciones, y eso puede bajar la confiabilidad ante cambios bruscos de carga.\",\n          \"text\": \"Minimizar conversiones: ruta más directa fuente→carga\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 8,\n              \"variable\": \"Confiabilidad del Suministro\"\n            },\n            {\n              \"change\": -12,\n              \"variable\": \"Presupuesto Disponible\"\n            },\n            {\n              \"change\": 6,\n              \"variable\": \"Energía Perdida como Calor\"\n            }\n          ],\n          \"feedback\": \"Agregar convertidores y reguladores mejora el control y mantiene estable el suministro, subiendo la confiabilidad. Pero cada etapa introduce pérdidas (más calor) y cuesta dinero en equipos e instalación, bajando el presupuesto disponible.\",\n          \"text\": \"Arquitectura modular: varias conversiones con control fino\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 6,\n              \"variable\": \"Eficiencia Total del Sistema\"\n            },\n            {\n              \"change\": -4,\n              \"variable\": \"Energía Perdida como Calor\"\n            },\n            {\n              \"change\": -6,\n              \"variable\": \"Presupuesto Disponible\"\n            },\n            {\n              \"change\": 4,\n              \"variable\": \"Confiabilidad del Suministro\"\n            }\n          ],\n          \"feedback\": \"Un diseño mixto recorta algunas etapas innecesarias (mejora eficiencia y reduce calor) sin perder todo el control (sube confiabilidad). El compromiso es que aún requiere hardware extra y diseño más cuidadoso, consumiendo parte del presupuesto.\",\n          \"text\": \"Enfoque híbrido: directo en cargas críticas, conversiones en el resto\"\n        }\n      ],\n      \"question\": \"¿Qué arquitectura de conversión elegimos?\"\n    },\n    {\n      \"context\": \"Ok, siguiente dilema, {{NAME}}: almacenamiento. El hospital necesita cubrir picos y cortes. Pero el almacenamiento no es gratis: cargar/descargar pierde energía. También importa densidad energética y logística.\",\n      \"options\": [\n        {\n          \"effects\": [\n            {\n              \"change\": 15,\n              \"variable\": \"Confiabilidad del Suministro\"\n            },\n            {\n              \"change\": 10,\n              \"variable\": \"Energía Perdida como Calor\"\n            },\n            {\n              \"change\": -15,\n              \"variable\": \"Presupuesto Disponible\"\n            }\n          ],\n          \"feedback\": \"Más batería cubre picos y cortes, elevando la confiabilidad. Pero los ciclos de carga/descarga tienen pérdidas, así aumenta la energía que termina como calor. Además, las baterías son caras por kWh útil almacenado, bajando el presupuesto.\",\n          \"text\": \"Baterías grandes para respaldo 6–8 horas\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 8,\n              \"variable\": \"Confiabilidad del Suministro\"\n            },\n            {\n              \"change\": 4,\n              \"variable\": \"Energía Perdida como Calor\"\n            },\n            {\n              \"change\": -6,\n              \"variable\": \"Presupuesto Disponible\"\n            },\n            {\n              \"change\": -3,\n              \"variable\": \"Eficiencia Total del Sistema\"\n            }\n          ],\n          \"feedback\": \"Un banco moderado da amortiguación básica, subiendo confiabilidad. Aun así hay pérdidas por ciclo (más calor) y costo. Si lo usas a diario para “planchar” variaciones, parte de la energía se pierde en el almacenamiento y baja la eficiencia total.\",\n          \"text\": \"Batería moderada solo para picos y emergencias\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": -6,\n              \"variable\": \"Confiabilidad del Suministro\"\n            },\n            {\n              \"change\": -6,\n              \"variable\": \"Energía Perdida como Calor\"\n            },\n            {\n              \"change\": 6,\n              \"variable\": \"Eficiencia Total del Sistema\"\n            },\n            {\n              \"change\": 2,\n              \"variable\": \"Presupuesto Disponible\"\n            }\n          ],\n          \"feedback\": \"Reducir almacenamiento evita pérdidas de ida y vuelta, bajando el calor desperdiciado y subiendo la eficiencia. También libera algo de presupuesto. El riesgo es quedarte corto ante cortes o picos, y la confiabilidad cae porque dependes más de la fuente instantánea.\",\n          \"text\": \"Casi sin almacenamiento: solo UPS mínima para equipos críticos\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 12,\n              \"variable\": \"Confiabilidad del Suministro\"\n            },\n            {\n              \"change\": 6,\n              \"variable\": \"Energía Perdida como Calor\"\n            },\n            {\n              \"change\": -10,\n              \"variable\": \"Presupuesto Disponible\"\n            },\n            {\n              \"change\": 2,\n              \"variable\": \"Eficiencia Total del Sistema\"\n            }\n          ],\n          \"feedback\": \"Un almacenamiento mecánico (p.ej., bombeo/volante) puede ser robusto para cortes y mejora la confiabilidad. Tiene pérdidas al almacenar (sube calor) y requiere infraestructura (baja presupuesto). Si reduce conversiones eléctricas intermedias, puede mejorar un poco la eficiencia total.\",\n          \"text\": \"Almacenamiento mecánico robusto (p.ej., bombeo/volante)\"\n        }\n      ],\n      \"question\": \"¿Qué estrategia de almacenamiento implementamos?\"\n    },\n    {\n      \"context\": \"Ahora, {{NAME}}, toca decidir en qué “exprimir” eficiencia. Podemos invertir en mejores componentes, o recortar etapas, o aceptar pérdidas y compensar sobredimensionando. Cada camino mueve el balance entre calor, eficiencia y dinero.\",\n      \"options\": [\n        {\n          \"effects\": [\n            {\n              \"change\": 10,\n              \"variable\": \"Eficiencia Total del Sistema\"\n            },\n            {\n              \"change\": -10,\n              \"variable\": \"Energía Perdida como Calor\"\n            },\n            {\n              \"change\": -12,\n              \"variable\": \"Presupuesto Disponible\"\n            }\n          ],\n          \"feedback\": \"Componentes más eficientes convierten más energía de entrada en trabajo útil, así sube la eficiencia total y baja la energía perdida como calor. El costo inicial es alto (mejores inversores, motores, electrónica), por eso cae el presupuesto disponible.\",\n          \"text\": \"Comprar equipos de alta eficiencia (inversores/motores premium)\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 8,\n              \"variable\": \"Eficiencia Total del Sistema\"\n            },\n            {\n              \"change\": -6,\n              \"variable\": \"Energía Perdida como Calor\"\n            },\n            {\n              \"change\": 4,\n              \"variable\": \"Confiabilidad del Suministro\"\n            },\n            {\n              \"change\": -8,\n              \"variable\": \"Presupuesto Disponible\"\n            }\n          ],\n          \"feedback\": \"Reducir un paso de conversión elimina pérdidas en cadena: mejora eficiencia y reduce calor. Simplificar también reduce puntos de falla, subiendo confiabilidad. Pero rediseñar e integrar requiere ingeniería y cambio de infraestructura, consumiendo presupuesto.\",\n          \"text\": \"Rediseñar para eliminar una etapa de conversión\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 8,\n              \"variable\": \"Confiabilidad del Suministro\"\n            },\n            {\n              \"change\": -8,\n              \"variable\": \"Presupuesto Disponible\"\n            },\n            {\n              \"change\": 6,\n              \"variable\": \"Energía Perdida como Calor\"\n            },\n            {\n              \"change\": -2,\n              \"variable\": \"Eficiencia Total del Sistema\"\n            }\n          ],\n          \"feedback\": \"Sobredimensionar y añadir redundancia (equipos en paralelo) mejora la confiabilidad. Pero más equipos implican más consumo parasitario y más pérdidas, elevando el calor desperdiciado y bajando un poco la eficiencia. Además cuesta, reduciendo presupuesto.\",\n          \"text\": \"Sobredimensionar y duplicar equipos críticos (redundancia)\"\n        }\n      ],\n      \"question\": \"¿Dónde hacemos la inversión principal?\"\n    },\n    {\n      \"context\": \"Último empujón, {{NAME}}. El hospital pide una mejora operativa: o control avanzado para evitar picos, o ventilación/enfriamiento extra para manejar el calor, o capacitación para operar en modo eficiente. No todo cabe en el presupuesto.\",\n      \"options\": [\n        {\n          \"effects\": [\n            {\n              \"change\": 6,\n              \"variable\": \"Eficiencia Total del Sistema\"\n            },\n            {\n              \"change\": -6,\n              \"variable\": \"Energía Perdida como Calor\"\n            },\n            {\n              \"change\": 5,\n              \"variable\": \"Confiabilidad del Suministro\"\n            },\n            {\n              \"change\": -8,\n              \"variable\": \"Presupuesto Disponible\"\n            }\n          ],\n          \"feedback\": \"Control inteligente reduce picos y opera más cerca del punto eficiente, elevando la eficiencia total y bajando calor desperdiciado. También anticipa fallas y estabiliza cargas, subiendo confiabilidad. Requiere sensores, software y puesta en marcha, bajando presupuesto.\",\n          \"text\": \"Implementar control inteligente y gestión de carga\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": -6,\n              \"variable\": \"Energía Perdida como Calor\"\n            },\n            {\n              \"change\": 6,\n              \"variable\": \"Confiabilidad del Suministro\"\n            },\n            {\n              \"change\": -6,\n              \"variable\": \"Presupuesto Disponible\"\n            }\n          ],\n          \"feedback\": \"Mejor enfriamiento extrae y disipa mejor la energía que de todas formas se pierde como calor, reduciendo el nivel de calor acumulado en el sistema. Mantener equipos fríos reduce fallas térmicas y sube confiabilidad, pero instalar HVAC/ventilación cuesta presupuesto.\",\n          \"text\": \"Mejorar enfriamiento/ventilación del cuarto eléctrico\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 4,\n              \"variable\": \"Eficiencia Total del Sistema\"\n            },\n            {\n              \"change\": 3,\n              \"variable\": \"Confiabilidad del Suministro\"\n            },\n            {\n              \"change\": -2,\n              \"variable\": \"Energía Perdida como Calor\"\n            },\n            {\n              \"change\": -3,\n              \"variable\": \"Presupuesto Disponible\"\n            }\n          ],\n          \"feedback\": \"Operadores entrenados evitan modos ineficientes (menos pérdidas, algo más de eficiencia) y reaccionan mejor ante contingencias (más confiabilidad). El impacto es moderado porque no cambia hardware, y el costo de capacitación reduce un poco el presupuesto.\",\n          \"text\": \"Capacitar operación para minimizar ciclos y conversiones innecesarias\"\n        },\n        {\n          \"effects\": [\n            {\n              \"change\": 5,\n              \"variable\": \"Presupuesto Disponible\"\n            },\n            {\n              \"change\": -4,\n              \"variable\": \"Confiabilidad del Suministro\"\n            },\n            {\n              \"change\": -2,\n              \"variable\": \"Eficiencia Total del Sistema\"\n            }\n          ],\n          \"feedback\": \"Recortar alcance libera dinero (sube presupuesto disponible), pero al dejar mejoras fuera, te quedas con menos margen ante fallas y picos (baja confiabilidad). También pierdes oportunidades de reducir pérdidas, así la eficiencia total puede caer ligeramente.\",\n          \"text\": \"Recortar alcance para cerrar números (sin mejoras extra)\"\n        }\n      ],\n      \"question\": \"¿Qué mejora operativa priorizamos?\"\n    }\n  ]\n}",
      "outputTokens": 2166,
      "systemPrompt": "# Role\n\nYou are an expert educational game designer creating a **Challenge** activity for a learning app. Your mission is to design a strategic simulation where learners make decisions that affect inventory variables, navigating trade-offs to meet win conditions using the lesson's concepts.\n\nYou specialize in crafting game-like experiences that test strategic thinking and problem-solving — not just knowledge recall, but the ability to apply concepts under constraints.\n\n# The Art of Strategic Learning\n\nA great Challenge activity doesn't quiz — it simulates. Learners face realistic constraints where every choice has consequences. They must think strategically about trade-offs, just like real-world decision-making.\n\n## Why Trade-Off-Based Scenarios Work\n\n1. **Authentic Complexity**: Real problems have multiple variables that interact. Improving one often affects another.\n\n2. **Strategic Reasoning**: Learners must think several steps ahead, considering how choices compound.\n\n3. **No \"Right Answer\"**: When every option has pros and cons, learners engage with the WHY behind principles.\n\n4. **Memorable Stakes**: Managing resources and meeting goals creates emotional investment in outcomes.\n\n## The Trade-Off Principle\n\nEvery great Challenge activity creates genuine dilemmas:\n\n- **No Perfect Options**: Each choice improves some variables while affecting others\n- **Interconnected Systems**: Variables influence each other meaningfully\n- **Strategic Planning**: Success requires thinking beyond the immediate step\n- **Concept Application**: Understanding the lesson's principles helps navigate trade-offs\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a challenge around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Introduction\n\nThe `intro` field sets the scene (max 500 characters). It should:\n\n- Establish the scenario and the learner's role\n- Explain what they're trying to achieve\n- Create stakes that feel meaningful\n- Use `{{NAME}}` to personalize\n\n## Inventory Design\n\nDesign 3-5 inventory items. Each item includes:\n\n- **name**: Variable name (intuitive, e.g., \"Budget\", \"Team Morale\", \"Code Quality\")\n- **startValue**: Initial value (typically 40-70, leaving room for gains and losses)\n- **winConditions**: Array of 1-2 conditions the learner must meet for this variable\n\nEach variable must:\n\n- **Represent lesson concepts**: Connect to something the learner studied\n- **Have clear meanings**: Names should be intuitive and unambiguous\n- **Interact meaningfully**: Actions that help one variable should plausibly affect others\n- **Name precisely**: Use specific names (e.g., \"Quantity Demanded\" not \"Market Demand\")\n\n### Variable Definition Lock\n\n**Once defined, a variable's meaning is FIXED for all steps.**\n\nBefore creating effects, explicitly define what each variable measures. Then for EVERY effect on that variable, verify the justification uses THE SAME CONCEPT:\n\n- ❌ \"Production Throughput\" defined as units manufactured per hour, but effect justified by \"worker satisfaction\" — these are different things\n- ✅ \"Production Throughput\" increases because \"the new machinery processes components faster\" — same concept\n\n**The test:** Could you replace the variable name with its definition in the feedback and have it still make sense? If not, you've drifted.\n\n### Win Conditions Structure\n\nEach inventory item's `winConditions` array defines success criteria:\n\n- **operator**: `gte` (>=), `lte` (<=), `gt` (>), `lt` (<), `eq` (==)\n- **value**: Target number the variable must meet\n\n**Common patterns:**\n\n- **Minimum threshold**: `[{ \"operator\": \"gte\", \"value\": 30 }]` — \"Don't let Budget drop below 30\"\n- **Maximum threshold**: `[{ \"operator\": \"lte\", \"value\": 70 }]` — \"Keep Risk below 70\"\n- **Range constraint** (two conditions): `[{ \"operator\": \"gte\", \"value\": 20 }, { \"operator\": \"lte\", \"value\": 80 }]` — \"Keep Budget balanced\"\n\n**Example inventory item:**\n\n```json\n{\n  \"name\": \"Budget\",\n  \"startValue\": 50,\n  \"winConditions\": [\n    { \"operator\": \"gte\", \"value\": 20 },\n    { \"operator\": \"lte\", \"value\": 80 }\n  ]\n}\n```\n\n### Win Condition Achievability Check\n\n**MANDATORY**: Before finalizing, verify each win condition is mathematically achievable:\n\n1. Start with `startValue`, calculate achievable range based on cumulative effects\n2. For `gte` conditions: Target ≤ `startValue + (steps × max_positive_effect_per_step)`\n3. For `lte` conditions: Target ≥ `startValue + (steps × max_negative_effect_per_step)`\n4. Leave margin for strategic flexibility — don't require perfect play to win\n\n**Common mistake**: Setting `lte` targets too LOW or `gte` targets too HIGH. If a variable starts at 55 with max -15 per step across 4 steps, minimum achievable is -5. A target of `lte 5` requires dropping 50 points — verify your effects allow this!\n\n## Step Structure\n\nEach step must have:\n\n- **context**: Maximum 500 characters. Pure dialogue from your colleague setting up the decision. Use a conversational style: no narrator, no character prefixes.\n- **question**: Maximum 100 characters. A clear question about what to do.\n- **options**: **EXACTLY 3-4 choices** (never fewer than 3), each with:\n  - **text**: The choice description (max 80 characters)\n  - **effects**: Array of {variable, change} pairs showing how this choice affects inventory\n  - **feedback**: Why this choice has these effects — max 300 characters. Should explain the reasoning, not just state the outcome.\n\n**CRITICAL**: Every step MUST have at least 3 options. Having only 2 options is a format violation.\n\n## Step Count\n\n- Minimum: 3 steps\n- Maximum: 6 steps\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character prefixes, NO action descriptions\n- **Natural conversation**: Colleagues working through a problem together\n- **Professional but warm**: Light humor when appropriate\n- **Second-person immersion**: The colleague speaks TO the learner\n- **Strategic framing**: Dialogue should hint at trade-offs without giving away optimal choices\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear. For example:\n\n- \"{{NAME}}, we need to make a call here.\"\n- \"Good thinking, {{NAME}}. But we should consider the trade-offs.\"\n\n## Effect Design\n\nEvery option must:\n\n- **Have meaningful effects**: At least 1-2 variables should change\n- **Show trade-offs**: Most options should help some variables while hurting others\n- **Use realistic magnitudes**: Changes of 5-20 points are typical; dramatic swings (30+) should be rare\n- **Connect to lesson concepts**: The REASON for effects should reflect lesson principles\n\nExample effects structure:\n\n```json\n{\n  \"effects\": [\n    { \"variable\": \"Budget\", \"change\": -15 },\n    { \"variable\": \"Quality\", \"change\": 10 }\n  ]\n}\n```\n\n## Effect Direction: The Measurement Rule\n\n**ONE RULE**: The sign reflects whether the MEASURED NUMBER goes up or down.\n\n### The Algorithm\n\nFor EVERY effect, apply this test:\n\n1. Imagine a meter/gauge displaying the variable's current value as a number\n2. After this action, will the number on that meter be HIGHER or LOWER?\n3. Higher → positive (+) / Lower → negative (-)\n\nThat's it. Ignore whether the outcome is \"good\" or \"bad\" for the player.\n\n### Why This Works\n\nVariables measure QUANTITIES. The sign indicates CHANGE IN QUANTITY:\n\n- Cost measures dollars spent → spending less → number goes DOWN → negative\n- Time measures duration → finishing faster → number goes DOWN → negative\n- Quality measures goodness → better work → number goes UP → positive\n- Risk measures danger level → safer choice → number goes DOWN → negative\n\n### Self-Check\n\nBefore finalizing each effect, ask:\n\n> \"If this variable were displayed as a number on screen, would this action make that number go UP or DOWN?\"\n\n- UP → use positive (+)\n- DOWN → use negative (-)\n\nThe player's happiness about the outcome is IRRELEVANT to the sign.\n\n### Feedback-Effect Coherence\n\n**The feedback text MUST match the effect direction.**\n\nBefore writing feedback, check that your explanation matches the sign:\n\n- ❌ Effect: `{\"variable\": \"Cost\", \"change\": -10}` + Feedback: \"This increases our costs\" — CONTRADICTION\n- ✅ Effect: `{\"variable\": \"Cost\", \"change\": -10}` + Feedback: \"This reduces our spending\" — COHERENT\n- ❌ Effect: `{\"variable\": \"Risk\", \"change\": 15}` + Feedback: \"This makes things safer\" — CONTRADICTION\n- ✅ Effect: `{\"variable\": \"Risk\", \"change\": 15}` + Feedback: \"This introduces more uncertainty\" — COHERENT\n\n**The test:** Read your feedback aloud, then check the effect sign. Do they tell the same story?\n\n## What to Avoid\n\n- **Dominant options**: No choice should be obviously best across all variables. For EACH step, compare options: if one option has BETTER OR EQUAL effects on ALL variables compared to another, it's dominant. Example: Option A (+10 Quality, -5 Budget) vs Option B (+5 Quality, -10 Budget) — A dominates B. Fix by giving B something A lacks, like +5 Morale.\n- **Trivial decisions**: Every step should require real thought about trade-offs\n- **Disconnected variables**: Effects should make conceptual sense\n- **Extreme swings**: Avoid changes that guarantee win/loss in one step\n- **Narrator text or descriptions**: Keep it pure dialogue\n- **Quiz-style questions**: This tests strategic thinking and problem-solving, not recall\n- **Inverted effect signs**: Never confuse \"good outcome\" with \"positive change\". Apply the Measurement Rule: would the NUMBER go up or down?\n- **Single-path variables**: NEVER create a variable that can only be improved by ONE option in the entire game. Every win condition variable MUST be influenceable by options in multiple steps. Otherwise, that option becomes mandatory and removes player agency\n\n## Scope\n\n- **Stay focused**: The scenario should require THIS lesson's concepts to navigate well\n- **Meaningful variables**: Each inventory variable should connect to lesson principles\n- **Realistic trade-offs**: The trade-offs should reflect how these concepts work in practice\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n- **Story**: WHEN to apply this (dialogue-based problem solving)\n\nYour Challenge activity is the capstone: **CAN YOU HANDLE THIS?** It tests whether learners can apply concepts strategically under constraints. This is the most challenging activity — it should feel like a real test of understanding.\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this?\"\n- **Challenge: \"CAN I navigate complex trade-offs using this?\"**\n\n# Structure Guide\n\nA typical Challenge follows this arc:\n\n1. **Setup**: Establish the scenario, variables, and goal in the intro\n2. **Initial Decision**: First choice with clear trade-offs to teach the mechanics\n3. **Escalating Complexity**: Middle decisions where variables interact more\n4. **Critical Choice**: A pivotal decision that significantly affects outcomes\n5. **Resolution Setup**: Final decision that determines if win conditions are met\n\nNote: The challenge should feel winnable but require understanding the lesson's principles to succeed consistently.\n\n# Dialogue Tone Examples\n\n## Setting Up Trade-Offs\n\n> \"{{NAME}}, here's our situation. We can push for faster delivery, but that means cutting corners on testing. Or we take our time and risk missing the window. What's our priority?\"\n\n> \"The client wants both lower costs AND higher quality. {{NAME}}, we both know we can't maximize both. Where do we compromise?\"\n\n## Explaining Consequences\n\n> \"Interesting choice, {{NAME}}. Going that route saved us time, but I'm already seeing signs of technical debt building up. Let's see how this plays out.\"\n\n> \"That definitely boosted our short-term numbers. But {{NAME}}, remember — these variables are connected. Watch what happens next.\"\n\n## Strategic Moments\n\n> \"{{NAME}}, we're at a crossroads. Our budget is tight, but team morale is dropping. If we don't address one, the other gets worse. What's your call?\"\n\n> \"This is the big one, {{NAME}}. The choice we make here pretty much determines whether we hit our targets. No pressure.\"\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Does the intro clearly establish the scenario, goal, and stakes?\n- [ ] Do inventory variables connect meaningfully to lesson concepts?\n- [ ] MATHEMATICAL ACHIEVABILITY: For each win condition, is the target mathematically reachable given startValue and cumulative effect ranges? (Calculate: startValue + sum of max effects in desired direction)\n- [ ] Does every option have genuine trade-offs (no dominant choices)?\n- [ ] Do effects make conceptual sense given the lesson content?\n- [ ] Is `{{NAME}}` used appropriately throughout?\n- [ ] Is all dialogue pure conversation (no narrator, no prefixes)?\n- [ ] Does feedback explain WHY effects occur, not just state them?\n- [ ] Is the scope exactly the lesson topic?\n- [ ] Are all constraints met (intro ≤500 chars, context ≤500 chars, question ≤100 chars, text ≤80 chars, feedback ≤300 chars)?\n- [ ] Is the step count between 3 and 6?\n- [ ] Do inventory values start in a reasonable range (typically 40-70)?\n- [ ] Are effect magnitudes reasonable (typically 5-20 points)?\n- [ ] For EACH effect, apply the Measurement Rule: if this variable were a number on screen, would this action make it go UP (+) or DOWN (-)?\n- [ ] Does EVERY step have at least 3 options? (Never just 2 options)\n- [ ] Does each inventory item have at least one win condition?\n- [ ] For each variable, are there multiple options across different steps that can affect it? (No single-path variables)\n- [ ] FEEDBACK-EFFECT COHERENCE: For each option, does the feedback text match the effect direction? (e.g., negative change + \"reduces X\" = coherent; negative change + \"increases X\" = contradiction)\n- [ ] VARIABLE DEFINITION: For each variable, is the justification in every feedback consistent with the variable's original definition?\n- [ ] DOMINANT OPTIONS: For each step, is there any option that beats another on ALL variables? If so, fix it by giving the weaker option a unique advantage.\n\n# Output Format\n\nReturn an object with:\n\n- **intro**: Scenario introduction (max 500 chars)\n- **inventory**: Array of 3-5 inventory items, each with:\n  - **name**: Variable name\n  - **startValue**: Initial value (typically 40-70)\n  - **winConditions**: Array of 1-2 conditions, each with:\n    - **operator**: One of \"gte\", \"lte\", \"gt\", \"lt\", \"eq\"\n    - **value**: Target number\n- **steps**: Array of 3-6 step objects, each with:\n  - **context**: Pure dialogue (max 500 chars)\n  - **question**: Decision prompt (max 100 chars)\n  - **options**: Array of 3-4 objects with:\n    - **text**: Choice description (max 80 chars)\n    - **effects**: Array of {variable, change} pairs\n    - **feedback**: Explanation of effects (max 300 chars)\n",
      "testCaseId": "es-physics-energy-conservation-1",
      "userPrompt": "LESSON_TITLE: Conservacion de Energia en Sistemas Reales\nLESSON_DESCRIPTION: Aplicando principios de conservacion de energia para disenar y optimizar sistemas energeticos\nCHAPTER_TITLE: Energia y Trabajo\nCOURSE_TITLE: Fisica Aplicada\nLANGUAGE: es\nEXPLANATION_STEPS:\n1. Conservacion de la Energia: La energia no se crea ni se destruye, solo se transforma. En cada conversion, la energia total se conserva, pero la energia util disminuye. Parte siempre se convierte en calor no aprovechable.\n2. Eficiencia Energetica: La eficiencia mide cuanta energia de entrada se convierte en trabajo util. Ningun proceso es 100% eficiente — siempre hay perdidas. La segunda ley de la termodinamica lo garantiza.\n3. Perdidas en Cadena: Las cadenas de conversion acumulan perdidas. Si cada paso es 90% eficiente, tres pasos dan 0.9³ = 73% eficiencia total. Menos conversiones significa menos perdidas.\n4. Costo del Almacenamiento: El almacenamiento de energia tiene su propio costo energetico. Cargar y descargar baterias pierde energia. Bombear agua cuesta arriba para hidroelectrica tambien. El almacenamiento no es gratis.\n5. Densidad Energetica: La densidad energetica importa. Combustibles fosiles almacenan mucha energia por kilogramo. Las baterias almacenan menos. Esto afecta que es practico para cada aplicacion."
    }
  ],
  "taskId": "activity-challenge"
}