{
  "generatedAt": "2026-01-17T15:45:55.050Z",
  "modelId": "openai/gpt-5-mini",
  "outputs": [
    {
      "duration": 43421.45075000002,
      "inputTokens": 3143,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, the UI just crashed: .length on undefined when rendering the user bio. The DB looks fine. I think types let us catch this earlier—what do you want to try first?\",\n      \"options\": [\n        {\n          \"feedback\": \"Right. Adding precise type annotations surfaces wrong assumptions at compile time so many runtime errors never happen. Start with function and API return types.\",\n          \"isCorrect\": true,\n          \"text\": \"Add precise type annotations\"\n        },\n        {\n          \"feedback\": \"Wrapping in try/catch hides the symptom but doesn't prevent future mistakes. We want to catch errors before runtime using types.\",\n          \"isCorrect\": false,\n          \"text\": \"Wrap the render in try/catch\"\n        },\n        {\n          \"feedback\": \"Runtime null checks help but are noisy and scatter fixes. Better to encode expectations in types so checks are targeted.\",\n          \"isCorrect\": false,\n          \"text\": \"Add null checks everywhere at runtime\"\n        },\n        {\n          \"feedback\": \"Delaying fixes is risky; shipping without investigating lets the bug spread. Types are faster prevention than hotfixes.\",\n          \"isCorrect\": false,\n          \"text\": \"Log it and ship a quick fix later\"\n        }\n      ],\n      \"question\": \"What's our first move?\"\n    },\n    {\n      \"context\": \"The API response has extra fields and sometimes missing ones. We don't need class methods—just the shape used by UI. How should we type the response?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correct. Define an interface describing the required properties (shape). TypeScript is structural: compatibility is about matching shape, not class names.\",\n          \"isCorrect\": true,\n          \"text\": \"Define an interface for the needed fields\"\n        },\n        {\n          \"feedback\": \"Using a class for shape implies identity and runtime behavior; it doesn't help structural typing and is heavier than needed.\",\n          \"isCorrect\": false,\n          \"text\": \"Create a class mirroring the API objects\"\n        },\n        {\n          \"feedback\": \"Typing the response as any disables checks and lets shape problems slip through. That defeats type safety.\",\n          \"isCorrect\": false,\n          \"text\": \"Type response as any to be flexible\"\n        },\n        {\n          \"feedback\": \"Asserting types everywhere hides mismatches. Better to type the response once and rely on the compiler.\",\n          \"isCorrect\": false,\n          \"text\": \"Assert the expected type at every access\"\n        }\n      ],\n      \"question\": \"How should we type the API response?\"\n    },\n    {\n      \"context\": \"Some fields are optional—bio may be undefined and .length blows up. We need a safe way to use optional props in render logic.\",\n      \"options\": [\n        {\n          \"feedback\": \"Yes. Checking the value before using narrows its type and lets TypeScript know it's safe to access properties like length.\",\n          \"isCorrect\": true,\n          \"text\": \"Check existence before using the property\"\n        },\n        {\n          \"feedback\": \"The non-null (!) operator silences the compiler but doesn't guard at runtime; it risks the same crash if data is actually missing.\",\n          \"isCorrect\": false,\n          \"text\": \"Use the non-null assertion (!) everywhere\"\n        },\n        {\n          \"feedback\": \"Casting to any removes all type checking and masks problems rather than fixing them with safe handling.\",\n          \"isCorrect\": false,\n          \"text\": \"Cast the value to any then use it freely\"\n        },\n        {\n          \"feedback\": \"Assuming the property exists is fragile. The bug came from that assumption; we should narrow first.\",\n          \"isCorrect\": false,\n          \"text\": \"Assume property is present and proceed\"\n        }\n      ],\n      \"question\": \"How should we access optional fields?\"\n    },\n    {\n      \"context\": \"We're parsing JSON from a third-party endpoint. Right now we do JSON.parse(...) as any and pass it around. That feels dangerous. Thoughts?\",\n      \"options\": [\n        {\n          \"feedback\": \"Parsing into unknown and validating before treating as your typed model prevents unsafe assumptions. unknown forces you to prove the shape first.\",\n          \"isCorrect\": true,\n          \"text\": \"Parse to unknown, then validate with checks\"\n        },\n        {\n          \"feedback\": \"Keeping any keeps the compiler blind to shape problems and lets runtime errors slip through. Not safe.\",\n          \"isCorrect\": false,\n          \"text\": \"Keep parsing to any for convenience\"\n        },\n        {\n          \"feedback\": \"Casting JSON.parse result directly to the type skips validation; if the API changed we'll still crash at runtime.\",\n          \"isCorrect\": false,\n          \"text\": \"Cast the parsed value directly to the type\"\n        },\n        {\n          \"feedback\": \"Relying only on tests is brittle; tests may miss edge cases from real API changes. Prefer validation at boundaries.\",\n          \"isCorrect\": false,\n          \"text\": \"Rely on integration tests to catch changes\"\n        }\n      ],\n      \"question\": \"How should we handle parsed JSON?\"\n    },\n    {\n      \"context\": \"Okay, let's write a type guard to validate parsed objects before we use them. What signature actually tells TypeScript the type is narrowed?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correct. Accept unknown (so callers can't pass any without thinking) and return a type predicate so TypeScript narrows to User when it returns true.\",\n          \"isCorrect\": true,\n          \"text\": \"function isUser(x: unknown): x is User\"\n        },\n        {\n          \"feedback\": \"Returns boolean but doesn't inform TypeScript of the narrowed type, so you'll still need manual assertions after checks.\",\n          \"isCorrect\": false,\n          \"text\": \"function isUser(x: any): boolean\"\n        },\n        {\n          \"feedback\": \"Boolean return with unknown parameter doesn't give TypeScript the predicate info needed to narrow the type.\",\n          \"isCorrect\": false,\n          \"text\": \"function isUser(x: unknown): boolean\"\n        },\n        {\n          \"feedback\": \"Using any for the parameter allows callers to pass anything without compile-time discipline; also x is any is pointless.\",\n          \"isCorrect\": false,\n          \"text\": \"function isUser(x: any): x is User\"\n        }\n      ],\n      \"question\": \"Which type guard signature should we write?\"\n    },\n    {\n      \"context\": \"The endpoint can return lists of different resource types. Our fetch helper now always returns any[]. How should we type fetchItems to keep item types intact?\",\n      \"options\": [\n        {\n          \"feedback\": \"Yes. A generic function preserves the concrete item type across calls, keeping strong typing for consumers of fetchItems.\",\n          \"isCorrect\": true,\n          \"text\": \"Make fetchItems generic: fetchItems<T>(): Promise<T[]>\"\n        },\n        {\n          \"feedback\": \"any[] loses all item information. Callers won't get compile-time help about item properties.\",\n          \"isCorrect\": false,\n          \"text\": \"Return any[] for flexibility\"\n        },\n        {\n          \"feedback\": \"unknown[] is safer than any but forces callers to validate every item; generics preserve type info while staying safe.\",\n          \"isCorrect\": false,\n          \"text\": \"Return unknown[] and let callers cast\"\n        },\n        {\n          \"feedback\": \"Overloads add complexity and still require explicit types per case; generics are cleaner for reusable fetches.\",\n          \"isCorrect\": false,\n          \"text\": \"Add overloads for each resource type\"\n        }\n      ],\n      \"question\": \"How should we type the fetch helper?\"\n    },\n    {\n      \"context\": \"Great. One more problem: the third-party library we're using exposes its data as any in its types, and that any is leaking into our codebase. What's the cleanest way to stop that?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correct. Wrap the library calls: accept unknown, run validators/type guards, and return properly typed objects. That contains the any and enforces safety at the boundary.\",\n          \"isCorrect\": true,\n          \"text\": \"Write a wrapper that validates unknown and returns typed objects\"\n        },\n        {\n          \"feedback\": \"Asserting types at each call site is tedious and error-prone; better to centralize validation at the boundary.\",\n          \"isCorrect\": false,\n          \"text\": \"Add type assertions where we call the lib\"\n        },\n        {\n          \"feedback\": \"Skipping lib checks (skipLibCheck) only affects compilation checks, not the fact that runtime values may be wrong. It doesn't contain any.\",\n          \"isCorrect\": false,\n          \"text\": \"Enable skipLibCheck to ignore lib typings\"\n        },\n        {\n          \"feedback\": \"Ignoring the problem and relying on runtime checks keeps any leaking; central validation is safer.\",\n          \"isCorrect\": false,\n          \"text\": \"Leave it as is and add runtime checks ad hoc\"\n        }\n      ],\n      \"question\": \"How do we stop the library's any from spreading?\"\n    },\n    {\n      \"context\": \"Plot twist: I just checked production logs—sometimes the API returns the string \\\"error\\\" instead of an object. The types we've written don't cover that. How should we model this API now?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correct. Model the response as a discriminated union (e.g., {status:'ok',data:...} | {status:'error',message:string}) and handle both cases with narrowing. It keeps compile-time safety and forces handling of errors.\",\n          \"isCorrect\": true,\n          \"text\": \"Use a discriminated union and narrow at runtime\"\n        },\n        {\n          \"feedback\": \"Keeping the old type will let crashes slip through when the API returns an unexpected string. You must model all cases.\",\n          \"isCorrect\": false,\n          \"text\": \"Keep the previous single-type model\"\n        },\n        {\n          \"feedback\": \"Widening to any accepts both shapes but removes compile-time guarantees; you'll lose the benefits of TypeScript.\",\n          \"isCorrect\": false,\n          \"text\": \"Widen the return type to any to accept both\"\n        },\n        {\n          \"feedback\": \"Stopping use of the API isn't practical; we need robust typing and handling rather than abandoning it.\",\n          \"isCorrect\": false,\n          \"text\": \"Stop calling the API until it’s fixed\"\n        }\n      ],\n      \"question\": \"How should we update the types for the API?\"\n    },\n    {\n      \"context\": \"The fixes are in and CI passes. Everything's stable now. Quick: what's the main lesson we should apply across the codebase so this doesn't repeat?\",\n      \"options\": [\n        {\n          \"feedback\": \"Exactly. Enforce type safety at external boundaries: parse as unknown, validate with type guards, use generics, and avoid any. That prevents many runtime bugs and maintains developer ergonomics.\",\n          \"isCorrect\": true,\n          \"text\": \"Validate inputs and enforce types at boundaries\"\n        },\n        {\n          \"feedback\": \"Relying mainly on any plus tests loses compile-time guarantees and invites regressions; types are faster and safer.\",\n          \"isCorrect\": false,\n          \"text\": \"Lean on any and increase tests instead\"\n        },\n        {\n          \"feedback\": \"Types are useful; saying they're optional misses the point. We want stronger, enforced typing at edges.\",\n          \"isCorrect\": false,\n          \"text\": \"Types are optional—focus on runtime checks\"\n        },\n        {\n          \"feedback\": \"Only runtime tests can't catch all data-shape regressions; types plus validation is the stronger approach.\",\n          \"isCorrect\": false,\n          \"text\": \"Rely solely on runtime integration tests\"\n        }\n      ],\n      \"question\": \"What's the core takeaway?\"\n    }\n  ]\n}",
      "outputTokens": 3814,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "en-cs-typescript-type-safety-1",
      "userPrompt": "LESSON_TITLE: Type Safety in Practice\nLESSON_DESCRIPTION: Applying TypeScript's type system to catch bugs early and write more maintainable code\nCHAPTER_TITLE: Type Systems\nCOURSE_TITLE: Advanced TypeScript\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. Compile-Time Safety: Type safety catches errors at compile time instead of runtime. When TypeScript knows a variable's type, it can prevent operations that would fail — like calling .length on undefined.\n2. Structural Typing: TypeScript uses structural typing — it cares about shape, not names. Two types are compatible if they have the same structure, even if defined separately.\n3. Type Narrowing: Type narrowing lets TypeScript understand more specific types after checks. Inside an if-block that checks for null, TypeScript knows the value isn't null.\n4. Generics: Generic types let you write reusable code that works with multiple types while preserving type information. Array<T> knows what's inside, unlike just 'Array'.\n5. Any vs Unknown: The 'any' type disables type checking entirely. It's an escape hatch but defeats the purpose of TypeScript. Use 'unknown' when the type truly isn't known.\n6. Type Guards: Type guards are functions that narrow types. They return a type predicate that tells TypeScript what the type is after the check passes."
    },
    {
      "duration": 40878.214958,
      "inputTokens": 3109,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, our rival just slashed prices a week before our launch and marketing wants to retaliate immediately. The product team is panicked and the CEO is asking for a recommendation now.\",\n      \"options\": [\n        {\n          \"feedback\": \"Reacting immediately risks locking us into a price war. First, map the strategic interdependence: what each action yields given the other's choice.\",\n          \"isCorrect\": true,\n          \"text\": \"Pause and map payoffs/strategic interdependence\"\n        },\n        {\n          \"feedback\": \"Matching instantly is tempting but may be the wrong move if the rival expects retaliation or if mutual matching lowers profits. We need analysis first.\",\n          \"isCorrect\": false,\n          \"text\": \"Match their price immediately\"\n        },\n        {\n          \"feedback\": \"Ignoring them could be reasonable, but without knowing payoffs you risk ceding market share. Analysis should come before ignoring.\",\n          \"isCorrect\": false,\n          \"text\": \"Ignore it and keep our premium\"\n        },\n        {\n          \"feedback\": \"Preannouncing a counteroffer looks like commitment but without payoff understanding it can backfire and is risky legally and strategically.\",\n          \"isCorrect\": false,\n          \"text\": \"Preannounce a counteroffer publicly\"\n        }\n      ],\n      \"question\": \"What's our first move?\"\n    },\n    {\n      \"context\": \"Good. Here's a quick payoff sketch: if both keep premium we each earn 100; if both match prices we each earn 60; if one matches while the other keeps premium the matcher earns 120 and the premium-keeper earns 40.\",\n      \"options\": [\n        {\n          \"feedback\": \"Look for a Nash equilibrium: a strategy pair where neither can improve by changing unilaterally. That tells us which outcomes are stable given incentives.\",\n          \"isCorrect\": true,\n          \"text\": \"Identify the Nash equilibrium in the matrix\"\n        },\n        {\n          \"feedback\": \"A dominant strategy would be best if it exists, but here each firm's best move depends on the other's choice so dominance likely doesn't exist.\",\n          \"isCorrect\": false,\n          \"text\": \"Pick a dominant strategy for us\"\n        },\n        {\n          \"feedback\": \"Randomizing without first understanding equilibria wastes the information the matrix gives you. Use expected values only after modeling strategies.\",\n          \"isCorrect\": false,\n          \"text\": \"Randomize our response to confuse them\"\n        },\n        {\n          \"feedback\": \"Trying to collude is illegal and not an analytic next step. We should analyze, then choose legal strategic tools.\",\n          \"isCorrect\": false,\n          \"text\": \"Openly propose collusion to stabilize prices\"\n        }\n      ],\n      \"question\": \"What do we look for in this matrix?\"\n    },\n    {\n      \"context\": \"Exactly — that payoff pattern is the classic prisoner's dilemma: mutual premium (100,100) is better than mutual matching (60,60), yet each firm has an incentive to match if the other keeps premium.\",\n      \"options\": [\n        {\n          \"feedback\": \"Signaling or commitment devices (legal ones) can help sustain cooperation when both prefer the cooperative outcome but have incentives to defect.\",\n          \"isCorrect\": true,\n          \"text\": \"Find legal commitment or signaling to sustain cooperation\"\n        },\n        {\n          \"feedback\": \"Accepting mutual defection avoids strategic thinking and likely lowers long-run profits. We should try to change incentives instead.\",\n          \"isCorrect\": false,\n          \"text\": \"Accept mutual matching and move on\"\n        },\n        {\n          \"feedback\": \"Assuming the competitor won't defect is wishful thinking; the matrix shows they have a clear incentive to undercut.\",\n          \"isCorrect\": false,\n          \"text\": \"Assume competitor will cooperate voluntarily\"\n        },\n        {\n          \"feedback\": \"Cutting price deeper escalates the problem and still leaves us worse off if they match. It's not a solution to the prisoner's dilemma.\",\n          \"isCorrect\": false,\n          \"text\": \"Cut prices deeper to scare them off\"\n        }\n      ],\n      \"question\": \"So what does the prisoner's dilemma imply we should try?\"\n    },\n    {\n      \"context\": \"We can't collude, but we're going to face this rival repeatedly. Marketing suggests some kind of deterrent. Which repeated-game approach helps sustain cooperation without being illegal?\",\n      \"options\": [\n        {\n          \"feedback\": \"Tit-for-tat cooperates initially, punishes defection by mirroring, and forgives if cooperation returns. It's effective in repeated settings to sustain cooperation.\",\n          \"isCorrect\": true,\n          \"text\": \"Use a tit‑for‑tat style strategy\"\n        },\n        {\n          \"feedback\": \"A grim trigger (permanent punishment after one defection) can deter but is brittle and often costly; tit‑for‑tat is more forgiving and practical.\",\n          \"isCorrect\": false,\n          \"text\": \"Adopt a grim trigger: punish forever after one defection\"\n        },\n        {\n          \"feedback\": \"Always cooperating would be exploited. Repeated interaction helps because punishment is possible, so always cooperate isn't strategic.\",\n          \"isCorrect\": false,\n          \"text\": \"Always cooperate and hope for the best\"\n        },\n        {\n          \"feedback\": \"Randomizing ignores history and loses the leverage of future encounters to enforce cooperation.\",\n          \"isCorrect\": false,\n          \"text\": \"Randomize moves to stay unpredictable\"\n        }\n      ],\n      \"question\": \"Which repeated-game tactic should we use?\"\n    },\n    {\n      \"context\": \"Marketing wants to match prices company‑wide to test responses. That could start a price war. Is there a less risky experiment to learn the rival's incentives?\",\n      \"options\": [\n        {\n          \"feedback\": \"A localized price trial limits exposure, reveals competitor responsiveness in a controlled market, and preserves broader pricing if things go wrong.\",\n          \"isCorrect\": true,\n          \"text\": \"Run a small, localized price test\"\n        },\n        {\n          \"feedback\": \"Dropping quality to test responses harms brand and confounds price effects with product changes—bad idea.\",\n          \"isCorrect\": false,\n          \"text\": \"Reduce product quality briefly to cut costs\"\n        },\n        {\n          \"feedback\": \"Public threats escalate the situation and are risky legally and reputationally; testing quietly is safer.\",\n          \"isCorrect\": false,\n          \"text\": \"Publicly threaten an aggressive price war\"\n        },\n        {\n          \"feedback\": \"Offering loyalty perks might be useful later, but it doesn't directly test the rival's price sensitivity like a localized price trial does.\",\n          \"isCorrect\": false,\n          \"text\": \"Offer broad loyalty discounts immediately\"\n        }\n      ],\n      \"question\": \"How should we test their reaction safely?\"\n    },\n    {\n      \"context\": \"Plot twist: the localized test showed the rival didn't match prices — they improved product bundles instead. Also, we learned they have a preferred supplier giving them faster supply. This makes the game asymmetric and adds a third player.\",\n      \"options\": [\n        {\n          \"feedback\": \"Now that payoffs are asymmetric and a supplier affects costs, we must expand the model to include asymmetry and the supplier's strategic role.\",\n          \"isCorrect\": true,\n          \"text\": \"Model asymmetry and include the supplier as a strategic player\"\n        },\n        {\n          \"feedback\": \"Treating the game as symmetric ignores crucial differences and will produce wrong recommendations.\",\n          \"isCorrect\": false,\n          \"text\": \"Keep using the symmetric payoff model\"\n        },\n        {\n          \"feedback\": \"Escalating prices or war ignores the new information about bundles and supply advantages; a blind escalation is risky.\",\n          \"isCorrect\": false,\n          \"text\": \"Immediately escalate price competition\"\n        },\n        {\n          \"feedback\": \"Ignoring the supplier means missing an important source of the rival's advantage; that's not strategic analysis.\",\n          \"isCorrect\": false,\n          \"text\": \"Ignore the supplier; focus only on prices\"\n        }\n      ],\n      \"question\": \"Given this new information, what's our next analytical step?\"\n    },\n    {\n      \"context\": \"Alright, with asymmetry, repeated play, and legal limits, we need a policy that raises our long‑run payoff without risky price wars. The CEO wants a single clear recommendation.\",\n      \"options\": [\n        {\n          \"feedback\": \"Differentiating through quality, bundling, targeted loyalty, and maintaining stable prices leverages strategic interdependence and repeated interactions; use tit‑for‑tat if needed to deter undercutting.\",\n          \"isCorrect\": true,\n          \"text\": \"Differentiate + keep stable prices + use tit‑for‑tat deterrence\"\n        },\n        {\n          \"feedback\": \"Deep immediate price cuts destroy margins and likely trigger mutual matching, leading to the worse equilibrium shown in the prisoner's dilemma.\",\n          \"isCorrect\": false,\n          \"text\": \"Slash prices aggressively now\"\n        },\n        {\n          \"feedback\": \"Filing a complaint might be necessary in extreme cases but doesn't by itself improve our strategic position or exploit repeated interactions.\",\n          \"isCorrect\": false,\n          \"text\": \"File an antitrust complaint immediately\"\n        },\n        {\n          \"feedback\": \"Exiting the market avoids competition but surrenders long‑term value; we should try strategic options first.\",\n          \"isCorrect\": false,\n          \"text\": \"Exit the market to avoid the fight\"\n        }\n      ],\n      \"question\": \"What single strategy do we recommend to the CEO?\"\n    }\n  ]\n}",
      "outputTokens": 3610,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "en-economics-game-theory-strategy-1",
      "userPrompt": "LESSON_TITLE: Strategic Thinking with Game Theory\nLESSON_DESCRIPTION: Using game theory to analyze competitive situations and make better strategic decisions\nCHAPTER_TITLE: Strategic Decision Making\nCOURSE_TITLE: Microeconomics\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. Strategic Interdependence: Game theory studies strategic interactions where your outcome depends on others' choices too. It's not about games — it's about any situation where what you should do depends on what others do.\n2. Nash Equilibrium: A Nash equilibrium is a stable state where no player can improve by changing only their own strategy. Everyone is doing their best given what everyone else is doing.\n3. Dominant Strategies: A dominant strategy is best regardless of what others do. If you have one, use it. But most real situations don't have dominant strategies — you must anticipate others.\n4. The Prisoner's Dilemma: The prisoner's dilemma shows how individual rationality can lead to collective irrationality. Both players choosing their dominant strategy leaves both worse off.\n5. Repeated Interactions: Repeated games change the calculus. When you'll interact again, cooperation becomes rational because future punishment makes defection costly."
    },
    {
      "duration": 62692.682709000015,
      "inputTokens": 3137,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, we've got a client asking us to disrupt GeneX in mice to study drug response. I pulled the sequence but we haven't done anything yet.\",\n      \"options\": [\n        {\n          \"feedback\": \"Designing a guide is important later, but jumping straight to design risks missing polymorphisms or nearby repeats that change specificity.\",\n          \"isCorrect\": false,\n          \"text\": \"Design a guide RNA immediately\"\n        },\n        {\n          \"feedback\": \"Correct — first confirm the exact target sequence and genomic context so you avoid polymorphisms, paralogs, or repetitive elements that create off-target risk.\",\n          \"isCorrect\": true,\n          \"text\": \"Confirm the target DNA sequence and context\"\n        },\n        {\n          \"feedback\": \"Picking delivery before you know the target constraints or repair strategy is premature; delivery depends on edit type and cell type.\",\n          \"isCorrect\": false,\n          \"text\": \"Pick a delivery vector now\"\n        },\n        {\n          \"feedback\": \"Deciding HDR vs NHEJ depends on the edit and cell type; that's for after you confirm the target and constraints.\",\n          \"isCorrect\": false,\n          \"text\": \"Choose HDR versus NHEJ repair\"\n        }\n      ],\n      \"question\": \"What's the very first step?\"\n    },\n    {\n      \"context\": \"Okay, {{NAME}}, the locus sits next to a paralog with a very similar sequence. I'm worried our guide will hit both. How should we reduce off-target cuts?\",\n      \"options\": [\n        {\n          \"feedback\": \"Shortened guides (tru-gRNAs) can reduce off-targets but often lower on-target activity; it's a trade-off and not the most reliable first choice here.\",\n          \"isCorrect\": false,\n          \"text\": \"Shorten the guide to 17–18 nt\"\n        },\n        {\n          \"feedback\": \"Right — switching to a high-fidelity Cas9 variant reduces off-target cleavage while preserving on-target activity; combine this with careful gRNA design and validation.\",\n          \"isCorrect\": true,\n          \"text\": \"Use a high-fidelity Cas9 variant\"\n        },\n        {\n          \"feedback\": \"Increasing concentration typically raises both on- and off-target cuts; it won't selectively fix paralog cross-reactivity.\",\n          \"isCorrect\": false,\n          \"text\": \"Increase Cas9 concentration\"\n        },\n        {\n          \"feedback\": \"Relying on in vivo selection is risky and unethical; you must minimize off-targets proactively rather than hope selection removes them.\",\n          \"isCorrect\": false,\n          \"text\": \"Rely on in vivo selection to weed out edits\"\n        }\n      ],\n      \"question\": \"Which change best reduces off-target risk?\"\n    },\n    {\n      \"context\": \"The client wants a precise reporter cassette inserted, so a simple knockout won't do. We need a repair strategy that gives a specific insertion.\",\n      \"options\": [\n        {\n          \"feedback\": \"NHEJ is fast and efficient for knockouts but typically creates indels, not precise cassette insertions.\",\n          \"isCorrect\": false,\n          \"text\": \"Use NHEJ for speed\"\n        },\n        {\n          \"feedback\": \"Correct — HDR with a donor template enables precise insertion of a cassette, but it requires donor design and is most efficient in dividing cells.\",\n          \"isCorrect\": true,\n          \"text\": \"Use HDR with a donor template\"\n        },\n        {\n          \"feedback\": \"Base editing changes single nucleotides and cannot insert a multi-kb reporter cassette.\",\n          \"isCorrect\": false,\n          \"text\": \"Use base editing to insert the cassette\"\n        },\n        {\n          \"feedback\": \"Letting the cell repair randomly won't produce the precise insertion the client requested; you'd end up screening huge numbers.\",\n          \"isCorrect\": false,\n          \"text\": \"Let the cell repair naturally and screen\"\n        }\n      ],\n      \"question\": \"Which repair pathway enables a precise insertion?\"\n    },\n    {\n      \"context\": \"Bad timing: these are adult hepatocytes — largely non-dividing, so HDR efficiency will be very low. We need an alternative to get the cassette integrated.\",\n      \"options\": [\n        {\n          \"feedback\": \"Proceeding with HDR in non-dividing cells typically yields negligible insertion and wastes time and animals.\",\n          \"isCorrect\": false,\n          \"text\": \"Proceed with HDR despite low efficiency\"\n        },\n        {\n          \"feedback\": \"Correct — NHEJ-based knock-in strategies (e.g., HITI or homology-independent approaches) can enable integration in non-dividing cells; still validate carefully.\",\n          \"isCorrect\": true,\n          \"text\": \"Use NHEJ-based knock-in methods\"\n        },\n        {\n          \"feedback\": \"Base editors can't insert a multi-kb cassette; they're unsuitable for reporter integration.\",\n          \"isCorrect\": false,\n          \"text\": \"Switch to base editing for the cassette\"\n        },\n        {\n          \"feedback\": \"Labeling the target impossible is premature — there are alternative methods to HDR for non-dividing cells.\",\n          \"isCorrect\": false,\n          \"text\": \"Abort — this target is impossible\"\n        }\n      ],\n      \"question\": \"What's the best alternative approach here?\"\n    },\n    {\n      \"context\": \"Delivery decision time. For liver targeting and transient nuclease activity to limit off-targets, our options are AAV with donor or lipid nanoparticles (LNPs) with RNPs. Thoughts?\",\n      \"options\": [\n        {\n          \"feedback\": \"AAV can deliver donors but causes long-term expression and immune responses; that increases off-target risk and complicates safety.\",\n          \"isCorrect\": false,\n          \"text\": \"Use AAV with donor and Cas9 plasmid\"\n        },\n        {\n          \"feedback\": \"Correct — LNPs carrying Cas9 RNP provide transient activity, reduce off-target exposure, and can be formulated for liver delivery, fitting our safety goals.\",\n          \"isCorrect\": true,\n          \"text\": \"Use lipid nanoparticles carrying Cas9 RNP\"\n        },\n        {\n          \"feedback\": \"In vivo electroporation of the liver is invasive, inefficient at scale, and not a practical systemic delivery method.\",\n          \"isCorrect\": false,\n          \"text\": \"Electroporate the liver in vivo\"\n        },\n        {\n          \"feedback\": \"Injecting naked plasmid systemically gives poor uptake and prolonged expression, increasing variability and risk.\",\n          \"isCorrect\": false,\n          \"text\": \"Inject naked plasmid DNA systemically\"\n        }\n      ],\n      \"question\": \"Which delivery method best fits transient, liver-targeted editing?\"\n    },\n    {\n      \"context\": \"Before dosing animals, we must validate off-target profiles. We can run in silico predictions, in vitro assays, or sequence animals after editing. What's the right validation strategy?\",\n      \"options\": [\n        {\n          \"feedback\": \"In silico prediction is a useful first pass but alone misses biochemical susceptibilities and chromatin effects; it's insufficient as the sole test.\",\n          \"isCorrect\": false,\n          \"text\": \"Rely on in silico predictions only\"\n        },\n        {\n          \"feedback\": \"Correct — combine biochemical/in vitro cleavage assays with targeted deep sequencing of treated cells/animals to quantify real off-target activity before in vivo escalation.\",\n          \"isCorrect\": true,\n          \"text\": \"Run in vitro cleavage assays plus targeted deep sequencing\"\n        },\n        {\n          \"feedback\": \"WGS of a single mouse can miss low-frequency off-targets and is expensive; targeted assays after enrichment are more sensitive for site-specific detection.\",\n          \"isCorrect\": false,\n          \"text\": \"Do whole-genome sequencing on one edited mouse\"\n        },\n        {\n          \"feedback\": \"Skipping molecular testing and relying only on phenotypes is unsafe; many off-targets cause subtle or delayed effects.\",\n          \"isCorrect\": false,\n          \"text\": \"Skip testing and monitor phenotypes only\"\n        }\n      ],\n      \"question\": \"What validation plan should we run preclinically?\"\n    },\n    {\n      \"context\": \"{{NAME}}, urgent — the sequencing lab reported unexpected edits in an unrelated metabolic gene in several mice. This could be a real off-target with functional consequences.\",\n      \"options\": [\n        {\n          \"feedback\": \"Recalling the entire cohort before confirmation may be necessary later, but first you must confirm the finding to avoid unnecessary harm and panic.\",\n          \"isCorrect\": false,\n          \"text\": \"Recall the whole animal cohort immediately\"\n        },\n        {\n          \"feedback\": \"Correct — confirm with orthogonal sequencing (different method or independent lab) and re-test original DNA to rule out lab error or sample mix-up before drastic steps.\",\n          \"isCorrect\": true,\n          \"text\": \"Confirm with orthogonal sequencing and re-test samples\"\n        },\n        {\n          \"feedback\": \"Assuming contamination or ignoring it risks patient and animal safety; this can't be dismissed without verification.\",\n          \"isCorrect\": false,\n          \"text\": \"Assume contamination and ignore it\"\n        },\n        {\n          \"feedback\": \"Publishing before independent confirmation is irresponsible and could cause unwarranted alarm; validate first, then report appropriately.\",\n          \"isCorrect\": false,\n          \"text\": \"Publish the finding immediately\"\n        }\n      ],\n      \"question\": \"What's the immediate next action?\"\n    },\n    {\n      \"context\": \"Confirmation came back: a subset of animals had an off-target in a metabolism gene with measurable effects. The client asks whether to continue development — they want your recommendation.\",\n      \"options\": [\n        {\n          \"feedback\": \"Proceeding to clinical trials with known harmful off-targets is unsafe and unethical; you must mitigate or redesign first.\",\n          \"isCorrect\": false,\n          \"text\": \"Proceed to clinical trials with warnings\"\n        },\n        {\n          \"feedback\": \"Correct — optimize the gRNA, consider alternative high-fidelity enzymes and transient delivery, then revalidate off-targets before any clinical steps.\",\n          \"isCorrect\": true,\n          \"text\": \"Optimize gRNA and delivery to eliminate off-targets\"\n        },\n        {\n          \"feedback\": \"Abandoning gene editing altogether may be premature; iterative optimization could make the approach safe and effective.\",\n          \"isCorrect\": false,\n          \"text\": \"Switch to a non-editing therapeutic approach\"\n        },\n        {\n          \"feedback\": \"Excluding based on sex without scientific justification is unethical and irrelevant to the off-target issue.\",\n          \"isCorrect\": false,\n          \"text\": \"Continue but only treat one sex\"\n        }\n      ],\n      \"question\": \"What should we recommend doing next?\"\n    },\n    {\n      \"context\": \"Great news: after redesigning guides, using high-fidelity Cas9 and LNP-delivered RNPs, deeper sequencing shows off-targets below detection and efficacy is maintained. Ethics wants our takeaway.\",\n      \"options\": [\n        {\n          \"feedback\": \"Speed at the expense of safety is the wrong lesson — regulatory and ethical obligations prioritize minimizing harm.\",\n          \"isCorrect\": false,\n          \"text\": \"Prioritize speed over safety\"\n        },\n        {\n          \"feedback\": \"Correct — the core lesson: validate and design guides carefully, prefer transient delivery to limit exposure, and run rigorous off-target testing throughout development.\",\n          \"isCorrect\": true,\n          \"text\": \"Validated guides, transient delivery, and rigorous off-target testing\"\n        },\n        {\n          \"feedback\": \"Relying on a single test is inadequate; multiple orthogonal assays are required to build confidence in safety.\",\n          \"isCorrect\": false,\n          \"text\": \"One test is sufficient\"\n        },\n        {\n          \"feedback\": \"Even solid preclinical results don't remove clinical risks; assume ongoing vigilance and phased trials with monitoring.\",\n          \"isCorrect\": false,\n          \"text\": \"Preclinical success means clinical risks are minimal\"\n        }\n      ],\n      \"question\": \"Which core message should we present to the board?\"\n    }\n  ]\n}",
      "outputTokens": 5257,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "en-biology-crispr-applications-1",
      "userPrompt": "LESSON_TITLE: CRISPR Gene Editing in Practice\nLESSON_DESCRIPTION: Understanding how to apply CRISPR gene editing technology effectively and responsibly\nCHAPTER_TITLE: Genetic Engineering\nCOURSE_TITLE: Modern Biotechnology\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. The Molecular Scissors: CRISPR-Cas9 is a molecular scissors that cuts DNA at specific locations. The Cas9 protein does the cutting; a guide RNA tells it exactly where to cut.\n2. Guide RNA Targeting: Guide RNA is a short sequence that matches the target DNA. It base-pairs with the DNA sequence you want to edit, bringing Cas9 to the exact spot.\n3. Cellular Repair Pathways: After CRISPR cuts, the cell's repair machinery fixes the break. Non-homologous end joining often introduces errors (knockouts). Homology-directed repair can insert new sequences (knock-ins).\n4. Off-Target Effects: Off-target effects occur when CRISPR cuts unintended locations. Guide RNA design and delivery methods affect specificity. This is a major safety concern for therapeutic applications.\n5. Delivery Challenges: Delivery is a key challenge. Getting CRISPR components into the right cells in a living organism is harder than in a lab dish. Viral vectors and lipid nanoparticles are common approaches."
    },
    {
      "duration": 36884.673499999975,
      "inputTokens": 3148,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, o módulo novo está com baixa taxa de conclusão e notas ruins — os usuários param na segunda aula. As telas estão cheias, os quizzes falham e o suporte reclama. Por onde começamos?\",\n      \"options\": [\n        {\n          \"feedback\": \"Certo. Avaliar a tarefa e a carga cognitiva identifica o que é intrínseco versus extrínseco e orienta mudanças priorizadas.\",\n          \"isCorrect\": true,\n          \"text\": \"Analisar as tarefas e a carga cognitiva\"\n        },\n        {\n          \"feedback\": \"Cortar conteúdo sem avaliar pode tirar conhecimentos essenciais ou apenas esconder o problema.\",\n          \"isCorrect\": false,\n          \"text\": \"Cortar o conteúdo para simplificar\"\n        },\n        {\n          \"feedback\": \"Melhorar visuais ajuda, mas sem diagnóstico pode focar no sintoma errado.\",\n          \"isCorrect\": false,\n          \"text\": \"Redesenhar só os slides visuais\"\n        },\n        {\n          \"feedback\": \"Encurtar vídeos pode ajudar tempo, mas não resolve se a carga cognitiva for alta.\",\n          \"isCorrect\": false,\n          \"text\": \"Apenas reduzir a duração dos vídeos\"\n        }\n      ],\n      \"question\": \"Qual é o primeiro passo?\"\n    },\n    {\n      \"context\": \"Temos uma lista de conceitos complexos interdependentes. Se a complexidade é intrínseca, como podemos gerenciá‑la sem diluir o aprendizado?\",\n      \"options\": [\n        {\n          \"feedback\": \"Certo. Dividir em passos e usar exemplos modelados reduz carga intrínseca aparente e facilita integração gradual.\",\n          \"isCorrect\": true,\n          \"text\": \"Fragmentar em sub‑tarefas com exemplos guiados\"\n        },\n        {\n          \"feedback\": \"Linguagem mais simples ajuda, mas não resolve a complexidade conceitual em si.\",\n          \"isCorrect\": false,\n          \"text\": \"Reescrever só com linguagem mais simples\"\n        },\n        {\n          \"feedback\": \"Eliminar tópicos pode prejudicar objetivos de aprendizagem essenciais.\",\n          \"isCorrect\": false,\n          \"text\": \"Apagar os tópicos mais difíceis\"\n        },\n        {\n          \"feedback\": \"Prática sem suporte aumenta frustração; precisa de scaffolding primeiro.\",\n          \"isCorrect\": false,\n          \"text\": \"Adicionar prática extensa imediatamente\"\n        }\n      ],\n      \"question\": \"Como gerenciar a carga intrínseca?\"\n    },\n    {\n      \"context\": \"Uma tela mostra um diagrama grande à esquerda e um parágrafo explicativo à direita. Usuários alternam o olhar e se perdem. O que fazemos para reduzir essa confusão?\",\n      \"options\": [\n        {\n          \"feedback\": \"Certo. Integrar rótulos e alinhar texto ao diagrama reduz a atenção dividida (split‑attention) e a carga extrínseca.\",\n          \"isCorrect\": true,\n          \"text\": \"Integrar texto ao diagrama e destacar partes\"\n        },\n        {\n          \"feedback\": \"Narrar pode criar redundância se o texto permanecer igual — pode aumentar carga extrínseca.\",\n          \"isCorrect\": false,\n          \"text\": \"Adicionar narração contando o parágrafo\"\n        },\n        {\n          \"feedback\": \"Transformar em bullets sem integrar continua a dividir atenção entre fontes.\",\n          \"isCorrect\": false,\n          \"text\": \"Converter o parágrafo em bullets separados\"\n        },\n        {\n          \"feedback\": \"Aumentar a fonte melhora legibilidade, mas não resolve a divisão de fontes de informação.\",\n          \"isCorrect\": false,\n          \"text\": \"Só aumentar o tamanho da fonte\"\n        }\n      ],\n      \"question\": \"Como reduzir a carga extrínseca nessa tela?\"\n    },\n    {\n      \"context\": \"Temos 12 conceitos numa única aula — os usuários se perdem. Qual estratégia de chunking ajuda mais a memória de trabalho?\",\n      \"options\": [\n        {\n          \"feedback\": \"Certo. Agrupar por objetivo de tarefa cria unidades significativas (schemata) que a memória de trabalho processa melhor.\",\n          \"isCorrect\": true,\n          \"text\": \"Agrupar por objetivo/ação prática\"\n        },\n        {\n          \"feedback\": \"Agrupar por tipo de mídia (vídeo/slide) cria fragmentos artificiais que não ajudam compreensão.\",\n          \"isCorrect\": false,\n          \"text\": \"Agrupar por tipo de mídia\"\n        },\n        {\n          \"feedback\": \"Fragmentar só pelo tempo pode criar blocos desconexos sem sentido cognitivo.\",\n          \"isCorrect\": false,\n          \"text\": \"Quebrar em blocos de tempo iguais\"\n        },\n        {\n          \"feedback\": \"Separar apenas por dificuldade pode misturar tarefas que não formam uma unidade útil.\",\n          \"isCorrect\": false,\n          \"text\": \"Organizar só por nível de dificuldade\"\n        }\n      ],\n      \"question\": \"Como aplicar chunking aqui?\"\n    },\n    {\n      \"context\": \"Queremos que o esforço do aluno seja produtivo — mais carga germânica. Qual intervenção favorece isso?\",\n      \"options\": [\n        {\n          \"feedback\": \"Certo. Prática com reflexão e feedback dirige esforço cognitivo para elaboração e integração — aumenta carga germânica.\",\n          \"isCorrect\": true,\n          \"text\": \"Prática guiada com prompts de reflexão\"\n        },\n        {\n          \"feedback\": \"Mais leituras passivas tendem a aumentar carga sem garantir elaboração ativa.\",\n          \"isCorrect\": false,\n          \"text\": \"Adicionar mais leituras e links\"\n        },\n        {\n          \"feedback\": \"Avaliações mais difíceis sem suporte aumentam frustração e não o aprendizado profundo.\",\n          \"isCorrect\": false,\n          \"text\": \"Tornar avaliações bem mais difíceis\"\n        },\n        {\n          \"feedback\": \"Eliminar prática reduz oportunidade de elaboração — baixa carga germânica.\",\n          \"isCorrect\": false,\n          \"text\": \"Remover atividades práticas\"\n        }\n      ],\n      \"question\": \"Como aumentar carga germânica?\"\n    },\n    {\n      \"context\": \"Analytics mostram 60% dos acessos via mobile e sessões curtas. Nossos módulos longos não estão funcionando. Como adaptamos o design?\",\n      \"options\": [\n        {\n          \"feedback\": \"Certo. Microlearning (5–7 minutos) com objetivo claro e prática rápida respeita memória de trabalho e uso móvel.\",\n          \"isCorrect\": true,\n          \"text\": \"Transformar em micro‑módulos curtos\"\n        },\n        {\n          \"feedback\": \"Páginas longas dificultam leitura móvel e aumentam extraneous load por rolagem e distração.\",\n          \"isCorrect\": false,\n          \"text\": \"Manter páginas longas e só otimizar layout\"\n        },\n        {\n          \"feedback\": \"PDFs são de difícil leitura mobile e não promovem interação ou scaffolding eficaz.\",\n          \"isCorrect\": false,\n          \"text\": \"Converter tudo em PDFs para baixar\"\n        },\n        {\n          \"feedback\": \"Um vídeo por tópico pode ser útil, mas se for longo não resolve sessões curtas nem chunking por tarefas.\",\n          \"isCorrect\": false,\n          \"text\": \"Fazer um vídeo único por tópico\"\n        }\n      ],\n      \"question\": \"Qual é a melhor adaptação para mobile?\"\n    },\n    {\n      \"context\": \"O cliente insiste que todo o conteúdo técnico do spec fique dentro da aula — não quer tirar nada. Como negociamos sem perder rigidez do escopo?\",\n      \"options\": [\n        {\n          \"feedback\": \"Certo. Colocar o spec completo como recurso opcional mantém integridade do conteúdo sem sobrecarregar a aula principal.\",\n          \"isCorrect\": true,\n          \"text\": \"Deixar o spec como recurso opcional/anexo\"\n        },\n        {\n          \"feedback\": \"Recusar o cliente pode quebrar relação e não resolve o problema prático de carga cognitiva.\",\n          \"isCorrect\": false,\n          \"text\": \"Recusar a alteração imposta pelo cliente\"\n        },\n        {\n          \"feedback\": \"Esconder conteúdo atrás de login não resolve a sobrecarga de quem precisa aprender agora.\",\n          \"isCorrect\": false,\n          \"text\": \"Manter tudo e esconder em abas complicadas\"\n        },\n        {\n          \"feedback\": \"Deixar tudo inline continua a sobrecarregar a memória de trabalho dos alunos.\",\n          \"isCorrect\": false,\n          \"text\": \"Enviar todo o spec dentro da aula principal\"\n        }\n      ],\n      \"question\": \"Como acomodar o cliente sem sobrecarregar alunos?\"\n    },\n    {\n      \"context\": \"Implementamos chunking, micro‑módulos e removemos redundâncias, mas os alunos ainda falham em tarefas aplicadas. Rodei análises: eles completam as leituras, mas não transferem. O que provavelmente falta?\",\n      \"options\": [\n        {\n          \"feedback\": \"Certo. Trabalhar com exemplos modelados que vão sendo ‘desfocados’ (faded) e depois prática apoiada facilita a transferência para tarefas novas.\",\n          \"isCorrect\": true,\n          \"text\": \"Sequência de exemplos modelados e prática graduada\"\n        },\n        {\n          \"feedback\": \"Mais questões de quiz isoladas melhoram recall, mas não necessariamente a aplicação real em contexto.\",\n          \"isCorrect\": false,\n          \"text\": \"Aumentar o número de quizzes de memorização\"\n        },\n        {\n          \"feedback\": \"Vídeos mais longos tendem a sobrecarregar e não aumentam transferência sozinhos.\",\n          \"isCorrect\": false,\n          \"text\": \"Fazer vídeos mais longos e detalhados\"\n        },\n        {\n          \"feedback\": \"Só adicionar visuais bonitos não garante elaboração ou transferência de conhecimento.\",\n          \"isCorrect\": false,\n          \"text\": \"Adicionar mais ilustrações e infográficos\"\n        }\n      ],\n      \"question\": \"Por que a transferência ainda falha?\"\n    },\n    {\n      \"context\": \"{{NAME}}, agora que ajustamos: micro‑módulos, integração de diagramas, recursos opcionais e prática com exemplos graduados — os resultados melhoraram bastante. Qual é a lição principal que devemos aplicar aos próximos cursos?\",\n      \"options\": [\n        {\n          \"feedback\": \"Certo. O equilíbrio: gerenciar carga intrínseca, eliminar extrínseca e cultivar carga germânica é a abordagem que maximiza aprendizagem sustentável.\",\n          \"isCorrect\": true,\n          \"text\": \"Gerenciar intrínseca, reduzir extrínseca e aumentar germânica\"\n        },\n        {\n          \"feedback\": \"Reduzir só a carga extrínseca ajuda, mas ignorar intrínseca e germânica deixa lacunas na aprendizagem.\",\n          \"isCorrect\": false,\n          \"text\": \"Focar só em reduzir carga extrínseca\"\n        },\n        {\n          \"feedback\": \"Chunking é parte da solução, mas sozinho não garante transferência ou esforço produtivo.\",\n          \"isCorrect\": false,\n          \"text\": \"Aplicar chunking em todos os conteúdos somente\"\n        },\n        {\n          \"feedback\": \"Encurtar sempre o conteúdo pode perder objetivos essenciais; nem sempre é a melhor regra.\",\n          \"isCorrect\": false,\n          \"text\": \"Sempre resumir e encurtar o conteúdo\"\n        }\n      ],\n      \"question\": \"Qual é a principal conclusão?\"\n    }\n  ]\n}",
      "outputTokens": 3232,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "pt-psychology-cognitive-load-1",
      "userPrompt": "LESSON_TITLE: Carga Cognitiva na Pratica\nLESSON_DESCRIPTION: Aplicando a teoria da carga cognitiva para criar materiais de aprendizagem mais eficazes\nCHAPTER_TITLE: Psicologia da Aprendizagem\nCOURSE_TITLE: Design Instrucional\nLANGUAGE: pt\nEXPLANATION_STEPS:\n1. Limites da Memoria: A memoria de trabalho tem capacidade limitada — cerca de 4 itens simultaneamente. Quando sobrecarregada, a aprendizagem para. O cerebro nao consegue processar mais.\n2. Carga Intrinseca: Carga intrinseca vem da complexidade inerente do conteudo. Algumas coisas sao simplesmente dificeis. Nao da para eliminar, mas da para gerenciar.\n3. Carga Extrinseca: Carga extrinseca vem do design ruim — instrucoes confusas, distracao visual, navegacao complicada. Essa carga pode e deve ser eliminada.\n4. Carga Germanica: Carga germanica e o esforco produtivo de aprender — criar conexoes, elaborar, integrar. Queremos maximizar essa carga enquanto minimizamos a extrinseca.\n5. Chunking: Chunking agrupa informacoes em unidades significativas. Um numero de telefone e mais facil de lembrar como blocos (99-8765-4321) do que como 10 digitos soltos."
    },
    {
      "duration": 47505.066541999986,
      "inputTokens": 3151,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, la cámara de vacunas no baja de -20 °C. El compresor va a tope y la factura eléctrica subió. Las lecturas del SCADA parecen coherentes, pero seguimos fuera de punto.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto. Antes de actuar hay que validar instrumentos y aplicar la primera ley: comprobar entradas de calor y trabajo para entender el desequilibrio.\",\n          \"isCorrect\": true,\n          \"text\": \"Verificar sensores y balance energético\"\n        },\n        {\n          \"feedback\": \"No es lo mejor todavía. Aumentar potencia sin diagnosticar puede ocultar la causa y aumentar consumo innecesario.\",\n          \"isCorrect\": false,\n          \"text\": \"Aumentar potencia del compresor\"\n        },\n        {\n          \"feedback\": \"Recalibrar sin confirmar lecturas podría enmascarar un problema real con el sistema térmico.\",\n          \"isCorrect\": false,\n          \"text\": \"Recalibrar termostato ahora\"\n        },\n        {\n          \"feedback\": \"Reiniciar puede dar un alivio momentáneo, pero no sustituye un diagnóstico basado en balance energético.\",\n          \"isCorrect\": false,\n          \"text\": \"Reiniciar el sistema completo\"\n        }\n      ],\n      \"question\": \"¿Qué comprobamos primero?\"\n    },\n    {\n      \"context\": \"He vuelto a comparar sensores: presión alta fuera de rango y la temperatura del condensador está 15 °C por encima de lo normal.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto. Un condensador sucio o con flujo de aire restringido eleva la temperatura y la presión del lado de alta, reduciendo eficiencia.\",\n          \"isCorrect\": true,\n          \"text\": \"Condenador sucio u obstruido\"\n        },\n        {\n          \"feedback\": \"Carga baja normalmente reduce presiones, no las eleva; es plausible pero menos consistente con presiones altas.\",\n          \"isCorrect\": false,\n          \"text\": \"Carga de refrigerante baja\"\n        },\n        {\n          \"feedback\": \"Una válvula de expansión abierta afectaría evaporador y presiones bajas; no explica presiones altas en el condensador.\",\n          \"isCorrect\": false,\n          \"text\": \"Válvula de expansión abierta\"\n        },\n        {\n          \"feedback\": \"Si el ambiente estuviera más frío bajarían las temperaturas, no subirlas; esta opción contradice las lecturas.\",\n          \"isCorrect\": false,\n          \"text\": \"Ambiente demasiado frío\"\n        }\n      ],\n      \"question\": \"¿Cuál es la sospecha principal?\"\n    },\n    {\n      \"context\": \"Inspección rápida: el condensador tiene suciedad y el flujo de aire está parcialmente bloqueado por acumulación de polvo. Además entra aire caliente desde la sala de máquinas.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto. Limpiar el condensador y volver a medir reducirá la temperatura del lado alto y restablecerá condiciones para evaluar más.\",\n          \"isCorrect\": true,\n          \"text\": \"Limpiar condensador y medir temperaturas\"\n        },\n        {\n          \"feedback\": \"Aumentar compresor sin arreglar la disipación agravará la alta presión y el consumo.\",\n          \"isCorrect\": false,\n          \"text\": \"Aumentar velocidad del compresor\"\n        },\n        {\n          \"feedback\": \"Bajar setpoint ahora no soluciona el problema físico de intercambio térmico y puede forzar el compresor.\",\n          \"isCorrect\": false,\n          \"text\": \"Bajar setpoint del evaporador\"\n        },\n        {\n          \"feedback\": \"Instalar un intercambiador nuevo es prematuro: primero probar la limpieza y medidas correctivas menos costosas.\",\n          \"isCorrect\": false,\n          \"text\": \"Instalar intercambiador nuevo\"\n        }\n      ],\n      \"question\": \"¿Qué hacemos ahora?\"\n    },\n    {\n      \"context\": \"Después de limpiar, mejoró pero no llega a -20 °C. El evaporador muestra sobrecalentamiento y el subenfriamiento es bajo; el compresor trabaja mucho. Sospecho pérdida de refrigerante.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto. Verificar carga y buscar fugas aplica conservación de energía: falta de refrigerante disminuye transferencia de calor en evaporador.\",\n          \"isCorrect\": true,\n          \"text\": \"Comprobar carga y buscar fugas de refrigerante\"\n        },\n        {\n          \"feedback\": \"Cambiar el compresor sin analizar la carga y fugas puede ser innecesario y caro.\",\n          \"isCorrect\": false,\n          \"text\": \"Reemplazar compresor de inmediato\"\n        },\n        {\n          \"feedback\": \"Aislar puede ayudar, pero primero hay que asegurar la cantidad de fluido y el ciclo correcto.\",\n          \"isCorrect\": false,\n          \"text\": \"Añadir aislamiento a las líneas\"\n        },\n        {\n          \"feedback\": \"Reducir setpoint sin arreglar la causa solo forzará el sistema y no solucionará la pérdida de refrigerante.\",\n          \"isCorrect\": false,\n          \"text\": \"Reducir setpoint temporalmente\"\n        }\n      ],\n      \"question\": \"Siguiente paso diagnóstico?\"\n    },\n    {\n      \"context\": \"Encontramos una pequeña fuga y repusimos refrigerante. Temperaturas mejoraron algo, pero el COP medido sigue lejos del límite teórico de Carnot calculado con las temperaturas reales.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto. Comparar COP medido con el límite de Carnot nos dice cuánto margen hay por irreversibilidades y pérdidas reales.\",\n          \"isCorrect\": true,\n          \"text\": \"Comparar COP real con el límite de Carnot\"\n        },\n        {\n          \"feedback\": \"Imposible: ningún sistema real puede superar el límite de Carnot; intentar superarlo es una falsa premisa.\",\n          \"isCorrect\": false,\n          \"text\": \"Intentar optimizar para superar Carnot\"\n        },\n        {\n          \"feedback\": \"Dimensionar compresor solo con COP de Carnot ignora irreversibilidades y pérdidas reales; se usa como referencia, no diseño directo.\",\n          \"isCorrect\": false,\n          \"text\": \"Dimensionar compresor según Carnot\"\n        },\n        {\n          \"feedback\": \"Ignorar el cálculo y ajustar controles no identifica las fuentes de ineficiencia que bajan el COP.\",\n          \"isCorrect\": false,\n          \"text\": \"Ignorar el límite y ajustar control\"\n        }\n      ],\n      \"question\": \"¿Por qué calcular Carnot ahora?\"\n    },\n    {\n      \"context\": \"El cálculo muestra que el COP real está muy por debajo del límite; las irreversibilidades mayores están en el evaporador y en las diferencias de temperatura del intercambio.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto. Reducir ΔT en el evaporador (mejor transferencia de calor) reduce irreversibilidades y mejora COP más que forzar temperatura del condensador.\",\n          \"isCorrect\": true,\n          \"text\": \"Reducir ΔT en el evaporador (mejor intercambiador)\"\n        },\n        {\n          \"feedback\": \"Bajar la temperatura del condensador exige más trabajo del compresor y no siempre mejora el COP neto; no es la primera opción.\",\n          \"isCorrect\": false,\n          \"text\": \"Bajar aún más la temperatura del condensador\"\n        },\n        {\n          \"feedback\": \"Aumentar ventilador ayuda al condensador, pero hemos atacado ya esa zona; ahora el cuello de botella es el evaporador.\",\n          \"isCorrect\": false,\n          \"text\": \"Subir velocidad del ventilador del condensador\"\n        },\n        {\n          \"feedback\": \"Agregar refrigerante puede ser útil solo si falta; ahora la carga está correcta, la ineficiencia es por irreversibilidades térmicas.\",\n          \"isCorrect\": false,\n          \"text\": \"Añadir más refrigerante\"\n        }\n      ],\n      \"question\": \"¿Qué mejora tiene mayor impacto?\"\n    },\n    {\n      \"context\": \"{{NAME}}, plot twist: los logs muestran que a medianoche la válvula de bypass se abre 10 min y envía gas caliente directo al retorno, saltándose el evaporador. Es un bug del controlador y explica las subidas de entropía.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto. Poner la válvula en manual detiene el bypass inmediato, evita pérdidas y nos da tiempo para parchear el software con seguridad.\",\n          \"isCorrect\": true,\n          \"text\": \"Poner la válvula en modo manual para detener el bypass\"\n        },\n        {\n          \"feedback\": \"Parar el compresor abruptamente podría comprometer la cadena de frío; primero aislemos la causa que provoca la pérdida.\",\n          \"isCorrect\": false,\n          \"text\": \"Parar el compresor ya mismo\"\n        },\n        {\n          \"feedback\": \"Esperar al parche mañana permite más ciclos de bypass y pérdidas; necesitamos una acción inmediata de mitigación.\",\n          \"isCorrect\": false,\n          \"text\": \"Esperar y aplicar el parche mañana\"\n        },\n        {\n          \"feedback\": \"Bajar setpoint no detiene el bypass y puede forzar más el sistema mientras ocurre la fuga de rendimiento.\",\n          \"isCorrect\": false,\n          \"text\": \"Reducir setpoint temporalmente\"\n        }\n      ],\n      \"question\": \"¿Qué hacemos de inmediato?\"\n    },\n    {\n      \"context\": \"Todo en manual, parche aplicado y mediciones estables: la cámara llegó a -20 °C y el COP quedó cerca del estimado. Tenemos que evitar repetir esto.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto. Institucionalizar monitoreo de balances energéticos, alarmas y revisión de logs detecta patrones (como el bypass) y previene fallos.\",\n          \"isCorrect\": true,\n          \"text\": \"Implementar monitoreo de balances y alarmas\"\n        },\n        {\n          \"feedback\": \"Confiar solo en límites de fabricante no detecta errores operativos ni bugs de control que causan irreversibilidades.\",\n          \"isCorrect\": false,\n          \"text\": \"Confiar solo en límites del fabricante\"\n        },\n        {\n          \"feedback\": \"Aumentar potencia sin atacar causas causa más consumo y puede dañar equipos; no es solución preventiva.\",\n          \"isCorrect\": false,\n          \"text\": \"Aumentar potencia del compresor como norma\"\n        },\n        {\n          \"feedback\": \"Ignorar variaciones pequeñas lleva a acumulación de problemas; las pequeñas anomalías revelan degradación.\",\n          \"isCorrect\": false,\n          \"text\": \"Ignorar pequeñas variaciones\"\n        }\n      ],\n      \"question\": \"¿Cuál lección institucionalizamos?\"\n    }\n  ]\n}",
      "outputTokens": 4215,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "es-physics-thermodynamics-applications-1",
      "userPrompt": "LESSON_TITLE: Termodinamica Aplicada\nLESSON_DESCRIPTION: Aplicando las leyes de la termodinamica para entender y disenar sistemas energeticos\nCHAPTER_TITLE: Termodinamica\nCOURSE_TITLE: Fisica para Ingenieros\nLANGUAGE: es\nEXPLANATION_STEPS:\n1. Conservacion de Energia: La primera ley dice que la energia se conserva — no se crea ni destruye, solo se transforma. El calor que entra menos el trabajo que sale iguala el cambio de energia interna.\n2. Direccion del Calor: La segunda ley establece una direccion: el calor fluye espontaneamente de caliente a frio, nunca al reves. Esto limita la eficiencia de cualquier motor termico.\n3. Entropia: La entropia mide la dispersion de energia. Cuando la energia se dispersa (calor fluyendo a lo frio), la entropia aumenta. Concentrar energia requiere trabajo externo.\n4. Limite de Carnot: El ciclo de Carnot define la eficiencia maxima teorica. Ningun motor real puede ser mas eficiente. La eficiencia depende de las temperaturas de las fuentes caliente y fria.\n5. Refrigeracion: Los refrigeradores y bombas de calor mueven calor de frio a caliente usando trabajo. No violan la segunda ley — el trabajo compensa el flujo 'antinatural' de calor."
    },
    {
      "duration": 51118.081458,
      "inputTokens": 3143,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, Black Friday just started and EU vs US DC show different stock for SKU-123 — EU says 5, US says 18. Orders are coming in from both regions. We need a quick decision before we oversell. What should we do first?\",\n      \"options\": [\n        {\n          \"feedback\": \"Pausing all orders avoids oversell but kills availability for all customers. It's safe but extreme and hurts revenue; we should try targeted measures first.\",\n          \"isCorrect\": false,\n          \"text\": \"Pause all orders globally until fixed\"\n        },\n        {\n          \"feedback\": \"Routing reads to the US DC ignores the partition problem and may still let conflicting writes occur in EU. It doesn't guarantee consistency across replicas.\",\n          \"isCorrect\": false,\n          \"text\": \"Route all traffic to the US DC\"\n        },\n        {\n          \"feedback\": \"Making one DC the master mid-sale requires fast leader election and migrates load — possible but slow to put in place during a spike. We need faster, safer controls.\",\n          \"isCorrect\": false,\n          \"text\": \"Promote one DC as single writable master\"\n        },\n        {\n          \"feedback\": \"Rejecting inventory-modifying requests during the partition preserves consistency (CP choice) and prevents oversell while we diagnose. It accepts temporary unavailability for safety.\",\n          \"isCorrect\": true,\n          \"text\": \"Reject writes that modify inventory until we assess\"\n        }\n      ],\n      \"question\": \"First move to avoid oversell?\"\n    },\n    {\n      \"context\": \"Okay, we rejected writes, but orders queued up and users are seeing errors. We can change replication/write policy quickly. What's the fastest way to ensure new successful writes are visible to readers?\",\n      \"options\": [\n        {\n          \"feedback\": \"Making reads strongly consistent only at the client doesn't ensure writes were replicated; you need the write acknowledgement policy to guarantee up-to-date reads.\",\n          \"isCorrect\": false,\n          \"text\": \"Force all clients to re-fetch after every write\"\n        },\n        {\n          \"feedback\": \"Increasing write quorum so W > N/2 ensures a majority must acknowledge writes. Combined with read quorum choices this gives strong consistency across partitions if quorums overlap.\",\n          \"isCorrect\": true,\n          \"text\": \"Raise write quorum to require majority acknowledgements\"\n        },\n        {\n          \"feedback\": \"Last-write-wins is a conflict resolution strategy, not a replication guarantee. It won't stop stale reads or oversells while partitions persist.\",\n          \"isCorrect\": false,\n          \"text\": \"Switch to last-write-wins mode system-wide\"\n        },\n        {\n          \"feedback\": \"Shifting writes to a single region is similar to promoting a master—slow and risky mid-incident. Quorum change is faster and principled for consistency.\",\n          \"isCorrect\": false,\n          \"text\": \"Failover all writes to a single region immediately\"\n        }\n      ],\n      \"question\": \"How to ensure new writes are reliably visible?\"\n    },\n    {\n      \"context\": \"Write quorum reduces oversell but latency spikes. Exec wants throughput back. We can relax guarantees selectively. How should we balance latency vs consistency?\",\n      \"options\": [\n        {\n          \"feedback\": \"Making everything eventual restores throughput but again risks oversell for hot SKUs. We need nuance based on business risk.\",\n          \"isCorrect\": false,\n          \"text\": \"Make the whole system eventually consistent\"\n        },\n        {\n          \"feedback\": \"Per-item consistency lets us pick CP for high-risk checkout ops and AP for catalog reads. This targets latency improvements without sacrificing safety where it matters.\",\n          \"isCorrect\": true,\n          \"text\": \"Apply per-item/per-operation consistency levels\"\n        },\n        {\n          \"feedback\": \"Randomly sampling requests doesn't tie consistency to business needs and leaves hot items vulnerable. Not a good compromise.\",\n          \"isCorrect\": false,\n          \"text\": \"Use sampling to reduce strong-consistency load\"\n        },\n        {\n          \"feedback\": \"Cascading to caches only hides the problem; caches can serve stale data and worsen oversells if we don't control write semantics.\",\n          \"isCorrect\": false,\n          \"text\": \"Serve everything from edge caches to lower latency\"\n        }\n      ],\n      \"question\": \"Best way to reduce latency without risking oversell?\"\n    },\n    {\n      \"context\": \"Good — we’ll keep strong consistency for checkout SKUs and eventual for browsing. But the backlog has conflicting reservations for several items. How should we resolve those divergences?\",\n      \"options\": [\n        {\n          \"feedback\": \"LWW may lose legitimate orders: inventory arithmetic requires semantic merging, not a blind timestamp-based winner.\",\n          \"isCorrect\": false,\n          \"text\": \"Resolve by last-write-wins timestamps\"\n        },\n        {\n          \"feedback\": \"Vector clocks help detect concurrency but don't encode business intent. They need application-level reconciliation to pick winners or merge counts.\",\n          \"isCorrect\": false,\n          \"text\": \"Use vector clocks and auto-merge them\"\n        },\n        {\n          \"feedback\": \"Application-specific merge logic (e.g., reservation ledger, sum adjustments, and compensations) preserves semantics: inventory counts must be reconciled with orders and refunds handled explicitly.\",\n          \"isCorrect\": true,\n          \"text\": \"Reconcile using application-specific merge & reservations\"\n        },\n        {\n          \"feedback\": \"Rejecting all conflicting orders is customer-hostile and unnecessary; we can use reconciliation to preserve valid purchases and compensate when needed.\",\n          \"isCorrect\": false,\n          \"text\": \"Cancel all conflicting orders and refund\"\n        }\n      ],\n      \"question\": \"How to reconcile divergent reservations?\"\n    },\n    {\n      \"context\": \"Reconciliation plan needs an operational guard to stop new conflicts during checkout. Payments sometimes time out and clients retry. How should we protect inventory reservations from duplicate orders?\",\n      \"options\": [\n        {\n          \"feedback\": \"Distributed locks can be brittle and add latency; they can help but are hard to scale for millions of SKUs during a sale.\",\n          \"isCorrect\": false,\n          \"text\": \"Acquire distributed locks on every SKU at checkout\"\n        },\n        {\n          \"feedback\": \"Reserve-then-charge: make a quorum-backed reservation before charging. This creates a clear, semantic intent and prevents oversell even with retries.\",\n          \"isCorrect\": true,\n          \"text\": \"Reserve stock with strong-consistency quorum before charging\"\n        },\n        {\n          \"feedback\": \"Optimistic accept and reconcile later accepts oversells and relies on refunds; for checkouts this damages customer experience and increases ops work.\",\n          \"isCorrect\": false,\n          \"text\": \"Optimistically accept orders and reconcile afterward\"\n        },\n        {\n          \"feedback\": \"Compare-and-swap on a remote leader is similar to reservations but assumes immediate leader availability across partitions. The reservation approach with quorum is more flexible.\",\n          \"isCorrect\": false,\n          \"text\": \"Use CAS against a single leader counter\"\n        }\n      ],\n      \"question\": \"How to prevent duplicates and oversells during checkout?\"\n    },\n    {\n      \"context\": \"Payments timed out earlier; some clients retried and created duplicate confirmations before reservations completed. We need an idempotency plan for orders. What's the right approach?\",\n      \"options\": [\n        {\n          \"feedback\": \"Relying on timestamps for idempotency is fragile (clock skew) and may still treat retries as new orders.\",\n          \"isCorrect\": false,\n          \"text\": \"Use timestamps to deduplicate order attempts\"\n        },\n        {\n          \"feedback\": \"Idempotency keys tied to client-generated or payment transaction IDs let the service detect retries and reuse the original outcome safely. This avoids duplicate reservations or charges.\",\n          \"isCorrect\": true,\n          \"text\": \"Require idempotency keys for order attempts\"\n        },\n        {\n          \"feedback\": \"Letting payments be retried and reconciling later risks duplicate charges and oversells. Not a safe strategy for checkout.\",\n          \"isCorrect\": false,\n          \"text\": \"Allow retries and reconcile duplicates downstream\"\n        },\n        {\n          \"feedback\": \"Blocking all retries prevents legitimate retries across flaky networks and degrades UX. Idempotency is better than blunt blocking.\",\n          \"isCorrect\": false,\n          \"text\": \"Block all clients from retrying requests\"\n        }\n      ],\n      \"question\": \"Best idempotency strategy for orders?\"\n    },\n    {\n      \"context\": \"{{NAME}}, new info: an edge cache was serving stale inventory during the partition, so users placed orders before reservation step kicked in. We now have confirmed orders in multiple DCs that exceed stock. What immediate reconciliation strategy do you pick?\",\n      \"options\": [\n        {\n          \"feedback\": \"Cancelling orders arbitrarily harms customers. We should reconcile using business rules and compensations rather than blunt cancels.\",\n          \"isCorrect\": false,\n          \"text\": \"Cancel the newest orders until stock matches\"\n        },\n        {\n          \"feedback\": \"Reconciling by customer priority only is unfair and complex. Better to use a deterministic, auditable reconciliation tied to reservations and payment states.\",\n          \"isCorrect\": false,\n          \"text\": \"Prioritize reconciling by customer loyalty tier\"\n        },\n        {\n          \"feedback\": \"Replaying a reservation ledger with deterministic rules, honoring reservations that completed quorum-backed steps, and issuing compensating refunds where needed preserves correctness and auditability.\",\n          \"isCorrect\": true,\n          \"text\": \"Replay reservations, honor quorum-backed ones, compensate others\"\n        },\n        {\n          \"feedback\": \"Manual reconciliation doesn't scale or work under time pressure. Automated, deterministic reconcile with compensations is the right immediate step.\",\n          \"isCorrect\": false,\n          \"text\": \"Do manual, case-by-case reconciliation\"\n        }\n      ],\n      \"question\": \"How to reconcile confirmed overbooked orders now?\"\n    },\n    {\n      \"context\": \"Management asked for a single policy: \\\"Make system always available globally.\\\" They're not technical experts. How do we explain the right long-term fix?\",\n      \"options\": [\n        {\n          \"feedback\": \"Always preferring availability ignores the realities of partitions and business needs; it can cause incorrect state for critical operations like checkout.\",\n          \"isCorrect\": false,\n          \"text\": \"Agree and make system fully available everywhere\"\n        },\n        {\n          \"feedback\": \"Always preferring consistency is too restrictive and hurts user experience for non-critical operations. The right answer is balanced.\",\n          \"isCorrect\": false,\n          \"text\": \"Agree and enforce strong consistency everywhere\"\n        },\n        {\n          \"feedback\": \"Explain and propose a hybrid model: choose consistency per operation (CP for checkout/reservations; AP for browsing), use quorums, idempotency, and application-level conflict resolution. This maps requirements to guarantees.\",\n          \"isCorrect\": true,\n          \"text\": \"Propose hybrid per-operation consistency with quorums\"\n        },\n        {\n          \"feedback\": \"Refusing to engage philosophically won't help. We need an actionable, principled proposal that ties to business risk.\",\n          \"isCorrect\": false,\n          \"text\": \"Refuse and say it's the architects' problem\"\n        }\n      ],\n      \"question\": \"Best way to answer management's request?\"\n    },\n    {\n      \"context\": \"Implementation complete: per-operation consistency, quorum-backed reservations, idempotency keys, and automated reconciliation for edge-cache incidents. Quick check: what's the core rule to remember when designing this system?\",\n      \"options\": [\n        {\n          \"feedback\": \"Always preferring availability is a one-size-fits-all answer and ignores the CAP trade-offs; not the correct design rule here.\",\n          \"isCorrect\": false,\n          \"text\": \"Always design for maximum availability\"\n        },\n        {\n          \"feedback\": \"Always preferring consistency ignores latency and UX trade-offs; it's not a universal rule either.\",\n          \"isCorrect\": false,\n          \"text\": \"Always design for strict consistency\"\n        },\n        {\n          \"feedback\": \"Exactly: pick the right consistency level for each operation, use quorum and partition-aware choices, and add app-level conflict resolution where semantics matter.\",\n          \"isCorrect\": true,\n          \"text\": \"Choose consistency per operation and use quorums + app logic\"\n        },\n        {\n          \"feedback\": \"Saying 'avoid distributed systems' is flippant and impractical. The takeaway should be principled trade-offs, not avoidance.\",\n          \"isCorrect\": false,\n          \"text\": \"Avoid distributed systems whenever possible\"\n        }\n      ],\n      \"question\": \"What's the key design takeaway?\"\n    }\n  ]\n}",
      "outputTokens": 4374,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "en-cs-distributed-systems-consistency-1",
      "userPrompt": "LESSON_TITLE: Consistency in Distributed Systems\nLESSON_DESCRIPTION: Navigating consistency and availability trade-offs in distributed systems\nCHAPTER_TITLE: Distributed Data\nCOURSE_TITLE: System Design\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. CAP Theorem: The CAP theorem states you can only have two of three: Consistency, Availability, and Partition tolerance. Since network partitions happen, you're really choosing between C and A.\n2. Strong Consistency: Strong consistency means all nodes see the same data at the same time. Every read returns the most recent write. This requires coordination that can slow things down.\n3. Eventual Consistency: Eventual consistency means replicas will converge given enough time without new writes. Reads might return stale data temporarily, but the system stays available.\n4. Partition Handling: Network partitions occur when nodes can't communicate. The system must decide: reject requests (maintain consistency) or accept requests that might conflict (maintain availability).\n5. Quorum Systems: Quorum-based systems use voting. A write succeeds if enough replicas acknowledge it. Read quorum + write quorum > total nodes ensures reading at least one up-to-date copy.\n6. Conflict Resolution: Conflict resolution strategies handle divergent writes: last-write-wins, vector clocks, or application-specific merge logic. The right choice depends on your data semantics."
    },
    {
      "duration": 45433.51237499999,
      "inputTokens": 3113,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, our RoundUp save pilot only has 8% activation. Marketing blames copy, but I want us to inspect the choice architecture first before rewriting text.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correct. Defaults and friction shape behavior; start by checking whether opt-in/opt-out and toggle visibility are set up to favor uptake.\",\n          \"isCorrect\": true,\n          \"text\": \"Check the current default and opt-in friction\"\n        },\n        {\n          \"feedback\": \"Unhelpful as a first step. Messaging matters, but if the default is blocking people, new copy won't fix structural friction.\",\n          \"isCorrect\": false,\n          \"text\": \"Rewrite the onboarding copy immediately\"\n        },\n        {\n          \"feedback\": \"Possible later, but social proof is a downstream lever. First audit the decision architecture that's currently in front of users.\",\n          \"isCorrect\": false,\n          \"text\": \"Add social proof banners on the flow\"\n        },\n        {\n          \"feedback\": \"Immediate rewards can help present-biased users, but we should first confirm whether the baseline choice defaults are the real blocker.\",\n          \"isCorrect\": false,\n          \"text\": \"Offer a signup bonus right away\"\n        }\n      ],\n      \"question\": \"What's the first thing to check?\"\n    },\n    {\n      \"context\": \"Good. I pulled the flow: it's opt-in with the toggle on the second screen and small copy. Uptake's low—what change should we propose to the PM?\",\n      \"options\": [\n        {\n          \"feedback\": \"Right. Making it an opt-out default leverages default effects to raise activation while preserving choice — ethically strong if opt-out is easy.\",\n          \"isCorrect\": true,\n          \"text\": \"Make enrollment the default (opt-out)\"\n        },\n        {\n          \"feedback\": \"Better than buried toggle, but still weaker than changing the default. Visibility alone often can't overcome inertia as well as defaults can.\",\n          \"isCorrect\": false,\n          \"text\": \"Keep opt-in but highlight the toggle\"\n        },\n        {\n          \"feedback\": \"Forcing consent is risky legally and user-hostile. Explicit forced modal reduces autonomy and may increase churn and complaints.\",\n          \"isCorrect\": false,\n          \"text\": \"Require explicit modal consent to continue\"\n        },\n        {\n          \"feedback\": \"This targets present bias, but without changing defaults it won't address the main path problem. Bonuses can be expensive too.\",\n          \"isCorrect\": false,\n          \"text\": \"Add a small cash reward for signing up\"\n        }\n      ],\n      \"question\": \"Which change should we propose?\"\n    },\n    {\n      \"context\": \"We flipped it to opt-out and activation doubled — nice. But retention's bad: lots enroll then cancel after a few weeks. Any idea why?\",\n      \"options\": [\n        {\n          \"feedback\": \"Yes. Present bias makes immediate spending feel more valuable, so users opt out of recurring saves when short-term needs arise.\",\n          \"isCorrect\": true,\n          \"text\": \"Present bias: short-term needs beat future savings\"\n        },\n        {\n          \"feedback\": \"Unlikely the main cause. Bugs would show different signals (errors, crashes). Analytics show voluntary cancellations, not failures.\",\n          \"isCorrect\": false,\n          \"text\": \"Product bugs are causing withdrawals\"\n        },\n        {\n          \"feedback\": \"Social proof affects sign-up norms but doesn't explain mid-term cancellations triggered by immediate temptations.\",\n          \"isCorrect\": false,\n          \"text\": \"Lack of social proof is driving churn\"\n        },\n        {\n          \"feedback\": \"Loss aversion usually deters people from giving up gains, but here users are willingly withdrawing — that fits present bias more closely.\",\n          \"isCorrect\": false,\n          \"text\": \"Loss aversion is making them avoid saving\"\n        }\n      ],\n      \"question\": \"What's the likely driver of cancellations?\"\n    },\n    {\n      \"context\": \"Okay, so present bias. We need to design to keep people committed despite short-term temptations. Which intervention best counters present bias here?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correct. A commitment device (e.g., lock-in with clear rules or higher match if funds are kept) aligns present actions with future goals.\",\n          \"isCorrect\": true,\n          \"text\": \"Offer an optional commitment device with penalties\"\n        },\n        {\n          \"feedback\": \"Immediate rewards help, but they can be costly and may not create durable habit formation like commitment devices do.\",\n          \"isCorrect\": false,\n          \"text\": \"Give instant cash rewards for each transfer\"\n        },\n        {\n          \"feedback\": \"Framing alone isn't enough to overcome present bias — it helps, but users still need structural help to stick with the plan.\",\n          \"isCorrect\": false,\n          \"text\": \"Reframe savings as a bright future benefit\"\n        },\n        {\n          \"feedback\": \"Social proof nudges enrollment but doesn't prevent withdrawals driven by immediate needs; commitment devices are stronger here.\",\n          \"isCorrect\": false,\n          \"text\": \"Show peers who kept their commitments\"\n        }\n      ],\n      \"question\": \"Which intervention should we build?\"\n    },\n    {\n      \"context\": \"We built an optional 3-month lock with a higher match if you don't withdraw. Now support is getting complaints: people say it makes them feel trapped and worried about overdrafts. How can we address safety concerns while keeping commitment power?\",\n      \"options\": [\n        {\n          \"feedback\": \"Yes. Make the match forfeitable on early withdrawal and highlight that explicitly: loss framing increases incentive to stay while keeping choice.\",\n          \"isCorrect\": true,\n          \"text\": \"Use a forfeitable match and highlight forfeiture\"\n        },\n        {\n          \"feedback\": \"Automatically liquidating funds into checking could harm trust and cause overdrafts. Better to provide gentle safeguards and warnings.\",\n          \"isCorrect\": false,\n          \"text\": \"Automatically transfer funds to checking on need\"\n        },\n        {\n          \"feedback\": \"Removing the higher match removes the behavioral lever that made commitments stick. Safety concerns can be addressed without removing incentives.\",\n          \"isCorrect\": false,\n          \"text\": \"Remove penalties and keep the lock only\"\n        },\n        {\n          \"feedback\": \"Offering loans or overdraft credit solves the symptom but doesn't preserve commitment effectiveness and could create moral hazard.\",\n          \"isCorrect\": false,\n          \"text\": \"Offer optional short-term loans to cover withdrawals\"\n        }\n      ],\n      \"question\": \"Which design balances safety and commitment?\"\n    },\n    {\n      \"context\": \"{{NAME}}, legal flagged another issue: some users feel tricked by the forfeiture language. We can't hide it in fine print. How should we communicate the rules to be transparent yet behaviorally effective?\",\n      \"options\": [\n        {\n          \"feedback\": \"Right. Use clear, prominent language that frames the penalty as a loss (loss aversion) but is upfront and easy to understand to avoid deception.\",\n          \"isCorrect\": true,\n          \"text\": \"Explain forfeiture clearly using loss-frame copy\"\n        },\n        {\n          \"feedback\": \"Burying it in the TOS is deceptive and will create backlash and regulatory risk — not acceptable ethically or legally.\",\n          \"isCorrect\": false,\n          \"text\": \"Put the rule in the terms of service only\"\n        },\n        {\n          \"feedback\": \"A neutral technical description may be transparent but won't leverage loss aversion to motivate behavior as effectively as loss-frame clarity.\",\n          \"isCorrect\": false,\n          \"text\": \"Use neutral, detailed legal language only\"\n        },\n        {\n          \"feedback\": \"Overloading users with long legal text makes consent meaningless and undermines trust; keep it short and clear instead.\",\n          \"isCorrect\": false,\n          \"text\": \"Show a long, detailed consent document\"\n        }\n      ],\n      \"question\": \"How should we present the forfeiture terms?\"\n    },\n    {\n      \"context\": \"We're still short of target. Analytics show many users join when they see others saving. I think social proof could tip fence-sitters. What social proof is most persuasive and ethical here?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correct. Specific, relatable stats (e.g., % of similar customers in your city) are persuasive and less intrusive than named lists or public leaderboards.\",\n          \"isCorrect\": true,\n          \"text\": \"Show relatable, specific peer statistics\"\n        },\n        {\n          \"feedback\": \"Celebrity testimonials are less relatable and may be perceived as marketing, not social proof from peers like the user.\",\n          \"isCorrect\": false,\n          \"text\": \"Add celebrity endorsements on the page\"\n        },\n        {\n          \"feedback\": \"Public leaderboards invade privacy and can shame users; they also risk discouraging lower savers.\",\n          \"isCorrect\": false,\n          \"text\": \"Publish a public savings leaderboard\"\n        },\n        {\n          \"feedback\": \"Vague labels like 'popular' are weak persuasive signals. Specific numbers and relatable cohorts work better.\",\n          \"isCorrect\": false,\n          \"text\": \"Tag the option as 'popular choice' only\"\n        }\n      ],\n      \"question\": \"Which social proof should we add?\"\n    },\n    {\n      \"context\": \"Plot twist: compliance just warned that regulators will audit nudges for manipulation. They want clear consent and easy exit. Our opt-out default and forfeitable match look risky. How do we respond to balance effectiveness and regulation?\",\n      \"options\": [\n        {\n          \"feedback\": \"Yes. Keep the effective default but add a highly visible, one-tap opt-out and clear consent language — this preserves outcomes while respecting autonomy.\",\n          \"isCorrect\": true,\n          \"text\": \"Keep opt-out but add obvious, easy opt-out & consent\"\n        },\n        {\n          \"feedback\": \"Reverting to opt-in reduces effectiveness a lot. Good for safety but unnecessary if we can increase transparency and easy exit instead.\",\n          \"isCorrect\": false,\n          \"text\": \"Revert everything to opt-in immediately\"\n        },\n        {\n          \"feedback\": \"Dark patterns are unethical and illegal in many jurisdictions. They may boost metrics short-term but create legal and reputational risk.\",\n          \"isCorrect\": false,\n          \"text\": \"Double down with subtle nudges users can't notice\"\n        },\n        {\n          \"feedback\": \"Heavy-handed, lengthy disclosures frustrate users and don't solve manipulation concerns. Simpler, prominent transparency is better.\",\n          \"isCorrect\": false,\n          \"text\": \"Add long legal disclosures before signup\"\n        }\n      ],\n      \"question\": \"What's the best regulatory-safe approach?\"\n    },\n    {\n      \"context\": \"{{NAME}}, regulators accepted our changes after we added easy opt-out, clear loss-framed terms, and peer stats. Uptake and satisfaction rose. If we need to sum this up for the team, what's the key lesson?\",\n      \"options\": [\n        {\n          \"feedback\": \"Exactly. Behavioral design works best when it leverages human biases but preserves choice and transparency — ethical nudges beat manipulation.\",\n          \"isCorrect\": true,\n          \"text\": \"Use behavioral levers while preserving choice and transparency\"\n        },\n        {\n          \"feedback\": \"Not quite. Manipulation might boost short-term metrics but damages trust and risks regulation — we avoided that path intentionally.\",\n          \"isCorrect\": false,\n          \"text\": \"Prioritize conversion above all else\"\n        },\n        {\n          \"feedback\": \"Too narrow. While defaults are powerful, the main lesson is balancing multiple levers ethically, not just choosing defaults.\",\n          \"isCorrect\": false,\n          \"text\": \"Defaults are the only lever that matters\"\n        },\n        {\n          \"feedback\": \"Also incorrect. Technical fixes matter sometimes, but this was primarily a behavioral design challenge that needed ethical choices.\",\n          \"isCorrect\": false,\n          \"text\": \"Focus on backend reliability as the main fix\"\n        }\n      ],\n      \"question\": \"What's the main takeaway for the product team?\"\n    }\n  ]\n}",
      "outputTokens": 4058,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "en-economics-behavioral-design-1",
      "userPrompt": "LESSON_TITLE: Behavioral Design in Practice\nLESSON_DESCRIPTION: Applying behavioral economics principles to design products and systems that work with human psychology\nCHAPTER_TITLE: Applied Behavioral Economics\nCOURSE_TITLE: Product Psychology\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. Loss Aversion: Loss aversion means losses hurt more than equivalent gains feel good — roughly twice as much. People will take irrational risks to avoid losses they wouldn't take to achieve gains.\n2. Framing Effects: Framing effects show that how you present options matters as much as what the options are. '90% survival rate' and '10% mortality rate' are logically identical but feel different.\n3. Default Effects: Default effects are powerful because people tend to stick with pre-selected options. Changing the default can dramatically change outcomes without restricting choice.\n4. Present Bias: Present bias makes us overvalue immediate rewards over future ones. We know we should save for retirement, but the money feels more valuable now. Commitment devices help.\n5. Social Proof: Social proof drives behavior — we look to others to decide what's appropriate. Showing that 'most people do X' is often more effective than explaining why X is good."
    },
    {
      "duration": 68321.152458,
      "inputTokens": 3204,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, a azidação do nosso (S)-2-bromobutano saiu mal: 40% rendimento, produto racêmico e muito alceno. Fizemos a reação com NaN3 em água a 60°C.\",\n      \"options\": [\n        {\n          \"feedback\": \"Errado. SN2 gera inversão estereoespecífica, não racemização nem muita eliminação sob aquecimento em meio prótico.\",\n          \"isCorrect\": false,\n          \"text\": \"Foi SN2 concertado\"\n        },\n        {\n          \"feedback\": \"Certo. Meio prótico e calor favorecem ionização do brometo formando um carbocátion; isso causa racemização e também facilita eliminação.\",\n          \"isCorrect\": true,\n          \"text\": \"Saiu via SN1 (carbocátion)\"\n        },\n        {\n          \"feedback\": \"Parcialmente plausível, mas a presença de produto racêmico indica formação de carbocátion/solvolise, não só E2.\",\n          \"isCorrect\": false,\n          \"text\": \"Eliminação E2 predominante\"\n        },\n        {\n          \"feedback\": \"Improvável: homólise radicalar exigiria condições diferentes (luz forte, peróxidos). Não explica racemização seletiva.\",\n          \"isCorrect\": false,\n          \"text\": \"Reação por radicais (homólise)\"\n        }\n      ],\n      \"question\": \"Qual é a causa mais provável?\"\n    },\n    {\n      \"context\": \"Certo. Queremos virar a reação para SN2 e evitar racemização/eliminação. Qual mudança inicial você faria?\",\n      \"options\": [\n        {\n          \"feedback\": \"Certo. Solventes apróticos polares (DMSO, DMF) aumentam nucleofilicidade em relação à solvatação; baixar a T reduz ionização e E2.\",\n          \"isCorrect\": true,\n          \"text\": \"Trocar para DMSO/DMF e reduzir temperatura\"\n        },\n        {\n          \"feedback\": \"Errado — aumentar temperatura normalmente favorece eliminação e SN1, piorando racemização.\",\n          \"isCorrect\": false,\n          \"text\": \"Aumentar a temperatura\"\n        },\n        {\n          \"feedback\": \"Errado — solventes próticos favorecem SN1/solvolise e solvatação do nucleófilo, reduzindo SN2.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar etanol como solvente\"\n        },\n        {\n          \"feedback\": \"Errado — acidificar para protonar o brometo não ajudaria; pode gerar mais solvolise e subprodutos.\",\n          \"isCorrect\": false,\n          \"text\": \"Adicionar HCl para protonar o substrato\"\n        }\n      ],\n      \"question\": \"Qual ajuste priorizar?\"\n    },\n    {\n      \"context\": \"Ok, testamos DMSO frio. Melhorou, mas ainda aparece eliminação. Que nucleófilo/condição minimiza E2?\",\n      \"options\": [\n        {\n          \"feedback\": \"Certo. N3‑ é um bom nucleófilo e é pouco básico; favorece substituição sobre eliminação quando em solvente aprótico e T baixa.\",\n          \"isCorrect\": true,\n          \"text\": \"Usar NaN3 (azida) em DMSO a baixa T\"\n        },\n        {\n          \"feedback\": \"Errado — NaOH é uma base forte; aumenta E2 em substratos secundários.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar NaOH concentrado\"\n        },\n        {\n          \"feedback\": \"Errado — t‑BuOK é uma base volumosa fortíssima; favorece eliminação E2.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar t‑BuOK como nucleófilo\"\n        },\n        {\n          \"feedback\": \"Errado — NaOMe é nucleófilo e base forte; em secundários tende a dar mistura com eliminação.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar NaOMe/MeOH\"\n        }\n      ],\n      \"question\": \"Qual escolher para reduzir E2?\"\n    },\n    {\n      \"context\": \"Analisando a estereoquímica, vemos 85% produto com inversão e 15% com retenção. Isso te surpreende?\",\n      \"options\": [\n        {\n          \"feedback\": \"Certo. Em secundários, mesmo com condições de SN2, pode haver pequena ionização (SN1 parcial) gerando ataque pelos dois lados — explica retenção/mescla.\",\n          \"isCorrect\": true,\n          \"text\": \"Principal mecanismo SN2 com pequena contribuição SN1\"\n        },\n        {\n          \"feedback\": \"Errado — radicalar não combina com nossas condições (DMSO, NaN3, baixa T) e não explicaria a proporção observada.\",\n          \"isCorrect\": false,\n          \"text\": \"É via radical com recombinação\"\n        },\n        {\n          \"feedback\": \"Improvável neste substrato simples; participação vizinha (anchimeric) é rara aqui e geralmente dá produtos diferentes.\",\n          \"isCorrect\": false,\n          \"text\": \"Há participação vizinha do grupo adjacente\"\n        },\n        {\n          \"feedback\": \"Possível, mas menos provável: impureza poderia causar produtos diferentes — porém padrão 85:15 sugere competição mecanística.\",\n          \"isCorrect\": false,\n          \"text\": \"Substrato estaba impuro\"\n        }\n      ],\n      \"question\": \"Como interpretar essa mistura estereoquímica?\"\n    },\n    {\n      \"context\": \"Queremos eliminar totalmente a contribuição SN1. Qual ação reduziria mais esse 'rascunho' de SN1?\",\n      \"options\": [\n        {\n          \"feedback\": \"Certo. Diminuir T reduz ionização; aumentar a concentração do nucleófilo desloca o equilíbrio para o ataque bimolecular (SN2).\",\n          \"isCorrect\": true,\n          \"text\": \"Diminuir T e aumentar [Nucleófilo]\"\n        },\n        {\n          \"feedback\": \"Errado — aquecer favorece SN1 e E2, aumentando a contribuição indesejada.\",\n          \"isCorrect\": false,\n          \"text\": \"Aumentar T para acelerar tudo\"\n        },\n        {\n          \"feedback\": \"Errado — trocar para solvente prótico só facilitaria ionização e SN1.\",\n          \"isCorrect\": false,\n          \"text\": \"Mudar para solvente prótico\"\n        },\n        {\n          \"feedback\": \"Errado — usar base volumosa tende a favorecer eliminação, não reduzir SN1.\",\n          \"isCorrect\": false,\n          \"text\": \"Adicionar base volumosa\"\n        }\n      ],\n      \"question\": \"Qual estratégia aplicar agora?\"\n    },\n    {\n      \"context\": \"Escalamos 10× e o rendimento caiu: mais alceno e subproduto. O que devemos checar primeiro no escala?\",\n      \"options\": [\n        {\n          \"feedback\": \"Certo. Traços de água/protícolas em solvente favorecem solvolise (SN1) e eliminação; a secagem do solvente é crítica.\",\n          \"isCorrect\": true,\n          \"text\": \"Se o solvente está totalmente seco\"\n        },\n        {\n          \"feedback\": \"Errado — embora agitação importe, a causa mais comum de SN1/E2 em escala é impureza protica, não mistura lenta.\",\n          \"isCorrect\": false,\n          \"text\": \"A velocidade de agitação\"\n        },\n        {\n          \"feedback\": \"Errado — a concentração do nucleófilo é relevante; dizer que é irrelevante não é correto nem útil aqui.\",\n          \"isCorrect\": false,\n          \"text\": \"Que a concentração do nucleófilo não importa\"\n        },\n        {\n          \"feedback\": \"Errado — não usamos catalisador; adicionar um 'catalisador' não resolve ionização por água ou impurezas.\",\n          \"isCorrect\": false,\n          \"text\": \"Adicionar um catalisador ácido\"\n        }\n      ],\n      \"question\": \"Primeiro passo na investigação de escala?\"\n    },\n    {\n      \"context\": \"Fizemos análise e apareceu um pico extra no GC: um brometo terciário como impureza — isso explica os subprodutos. O que fazemos antes de escalar de novo?\",\n      \"options\": [\n        {\n          \"feedback\": \"Certo. Purificar o substrato (destilação/coluna) remove a fração terciária muito reativa que causa SN1/eliminações descontroladas.\",\n          \"isCorrect\": true,\n          \"text\": \"Purificar o substrato antes de prosseguir\"\n        },\n        {\n          \"feedback\": \"Errado — continuar aceitando perda não é solução em escala; a impureza causará mais problemas econômicos e de segurança.\",\n          \"isCorrect\": false,\n          \"text\": \"Prosseguir mesmo com perda\"\n        },\n        {\n          \"feedback\": \"Errado — mudar intencionalmente para SN1 não resolve o objetivo sintetizar o produto com controle estereo.\",\n          \"isCorrect\": false,\n          \"text\": \"Mudar para rota SN1 deliberadamente\"\n        },\n        {\n          \"feedback\": \"Errado — converter tudo em tosilatos sem purificar só espalharia o problema; impurezas ainda reagiriam mais rápido.\",\n          \"isCorrect\": false,\n          \"text\": \"Transformar a mistura em tosilatos direto\"\n        }\n      ],\n      \"question\": \"Como lidar com a impureza detectada?\"\n    },\n    {\n      \"context\": \"{{NAME}}, plot twist: após purificar, a reação ainda falha. Conferimos o reagente e o NaN3 do fornecedor era NaNO3 — azida ausente. Qual é a ação certa?\",\n      \"options\": [\n        {\n          \"feedback\": \"Certo. Parar, verificar identidade e pureza dos reagentes antes de continuar evita perda de tempo e riscos — peça reposição correta.\",\n          \"isCorrect\": true,\n          \"text\": \"Verificar reagentes e repor NaN3 correto\"\n        },\n        {\n          \"feedback\": \"Errado — improvisar com outro sal sem checar compatibilidade pode introduzir novas reações indesejadas.\",\n          \"isCorrect\": false,\n          \"text\": \"Substituir por NaNO2 e prosseguir\"\n        },\n        {\n          \"feedback\": \"Errado — forçar a reação com mais T ou tempo só acumulará subprodutos se o nucleófilo estiver ausente.\",\n          \"isCorrect\": false,\n          \"text\": \"Aumentar temperatura e tempo\"\n        },\n        {\n          \"feedback\": \"Errado — escolher outro nucleófilo sem validar o passo seguinte pode alterar toda a rota sintética planejada.\",\n          \"isCorrect\": false,\n          \"text\": \"Trocar por KI sem testes\"\n        }\n      ],\n      \"question\": \"O que fazemos diante do reagente errado?\"\n    },\n    {\n      \"context\": \"Agora sim: substrato purificado, NaN3 real, DMSO seco, baixa T — rendimento 92% com inversão estereoespecífica. Qual é a lição principal daqui?\",\n      \"options\": [\n        {\n          \"feedback\": \"Certo. Para favorecer SN2 e controlar estereoquímica: solvente aprótico polar, nucleófilo forte/pouco básico, baixa T e solvente seco são essenciais.\",\n          \"isCorrect\": true,\n          \"text\": \"Favorizar SN2: solvente aprótico, nucleófilo forte e seco\"\n        },\n        {\n          \"feedback\": \"Errado — converter sempre para tosilato não é necessário nem vantajoso para todos os casos; aqui solucionamos sem essa etapa.\",\n          \"isCorrect\": false,\n          \"text\": \"Converter sempre em tosilato\"\n        },\n        {\n          \"feedback\": \"Errado — substratos terciários raramente seguem SN2; essa afirmação é falsa e levaria a decisões ruins.\",\n          \"isCorrect\": false,\n          \"text\": \"Substratos terciários preferem SN2\"\n        },\n        {\n          \"feedback\": \"Errado — grupos de saída importam muito; dizer que são irrelevantes ignora um fator crítico do mecanismo.\",\n          \"isCorrect\": false,\n          \"text\": \"Grupos de saída não são relevantes\"\n        }\n      ],\n      \"question\": \"Qual é o principal takeaway?\"\n    }\n  ]\n}",
      "outputTokens": 5753,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "pt-chemistry-organic-reactions-1",
      "userPrompt": "LESSON_TITLE: Mecanismos de Substituicao\nLESSON_DESCRIPTION: Aplicando mecanismos de reacao organica para prever e otimizar sinteses quimicas\nCHAPTER_TITLE: Reacoes Organicas\nCOURSE_TITLE: Quimica Organica II\nLANGUAGE: pt\nEXPLANATION_STEPS:\n1. Nucleofilos e Eletrofilos: Nucleofilos sao especies ricas em eletrons que doam pares de eletrons. Eletrofilos sao especies pobres em eletrons que aceitam. Reacoes organicas sao geralmente nucleofilos atacando eletrofilos.\n2. Mecanismo SN2: SN2 e um mecanismo concertado — o nucleofilo ataca enquanto o grupo de saida sai, em um unico passo. Funciona melhor com substratos primarios e nucleofilos fortes.\n3. Mecanismo SN1: SN1 ocorre em dois passos: primeiro o grupo de saida sai formando um carbocation, depois o nucleofilo ataca. Favorecido por substratos terciarios e solventes polares proticos.\n4. Estereoquimica: A estereoquimica revela o mecanismo. SN2 inverte a configuracao (ataque por tras). SN1 pode dar mistura racemicacon (carbocation planar atacado de ambos os lados).\n5. Grupos de Saida: Grupos de saida precisam ser estaveis apos sair. Bons grupos de saida sao bases fracas — haletos, tosilatos, agua protonada. Grupos de saida ruins sao bases fortes."
    },
    {
      "duration": 61448.63179099996,
      "inputTokens": 3183,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, el cliente nos pasó 500 imágenes médicas anotadas y quiere un modelo preciso pero no tenemos datos suficientes para entrenar desde cero.\",\n      \"options\": [\n        {\n          \"feedback\": \"Entrenar desde cero con pocos datos suele sobreajustar; es costoso en tiempo y parámetros.\",\n          \"isCorrect\": false,\n          \"text\": \"Diseñar y entrenar una red profunda desde cero\"\n        },\n        {\n          \"feedback\": \"Correcto: con pocos datos usar una base preentrenada aprovecha filtros generales y reduce sobreajuste; permite adaptar la cabeza a la tarea.\",\n          \"isCorrect\": true,\n          \"text\": \"Usar transfer learning con una base preentrenada\"\n        },\n        {\n          \"feedback\": \"Una CNN pequeña puede funcionar, pero perderás la ventaja de características preentrenadas que capturan texturas y bordes útiles.\",\n          \"isCorrect\": false,\n          \"text\": \"Crear una CNN pequeña a medida y entrenarla\"\n        },\n        {\n          \"feedback\": \"Modelos clásicos requieren buen feature engineering; menos probable que superen una CNN preentrenada en imágenes complejas.\",\n          \"isCorrect\": false,\n          \"text\": \"Extraer features manuales y entrenar un SVM\"\n        }\n      ],\n      \"question\": \"¿Cómo empezamos el diseño de la arquitectura?\"\n    },\n    {\n      \"context\": \"Bien, cargué una CNN preentrenada. {{NAME}}, ahora hay que decidir si congelamos la base, entrenamos la cabeza o afinamos capas específicas.\",\n      \"options\": [\n        {\n          \"feedback\": \"Congelar todo limita la adaptación a peculiaridades del dominio médico; útil como primer paso pero puede quedarse corto.\",\n          \"isCorrect\": false,\n          \"text\": \"Congelar toda la base y entrenar solo la cabeza\"\n        },\n        {\n          \"feedback\": \"Correcto: descongelar los últimos bloques permite que las capas tardías se adapten a la tarea mientras las primeras mantienen patrones generales.\",\n          \"isCorrect\": true,\n          \"text\": \"Descongelar solo los últimos bloques para fine-tuning\"\n        },\n        {\n          \"feedback\": \"Descongelar todo aumenta riesgo de overfitting y requiere más datos y cómputo; evita hacerlo de entrada con pocos datos.\",\n          \"isCorrect\": false,\n          \"text\": \"Descongelar toda la red y ajustar todo\"\n        },\n        {\n          \"feedback\": \"No hacer fine-tune tras usar la base preentrenada desperdicia la oportunidad de adaptar características relevantes a este dominio.\",\n          \"isCorrect\": false,\n          \"text\": \"No hacer fine-tuning, usar la red tal cual\"\n        }\n      ],\n      \"question\": \"¿Qué estrategia de fine-tuning eliges?\"\n    },\n    {\n      \"context\": \"{{NAME}}, probamos descongelar últimos bloques y la validación empieza a separarse: entrenamiento sube pero validación cae, indicio de overfitting.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto: dropout en la cabeza reduce co-adaptación y es una solución directa para overfitting en la capa final.\",\n          \"isCorrect\": true,\n          \"text\": \"Agregar dropout en las capas totalmente conectadas\"\n        },\n        {\n          \"feedback\": \"BatchNorm estabiliza y regulariza algo, pero no es la primera herramienta para sobreajuste cuando la cabeza es la culpable.\",\n          \"isCorrect\": false,\n          \"text\": \"Agregar Batch Normalization en cada capa\"\n        },\n        {\n          \"feedback\": \"Reducir profundidad puede ayudar, pero sería un cambio mayor; primero prueba regularización menos disruptiva.\",\n          \"isCorrect\": false,\n          \"text\": \"Reducir la profundidad de la red\"\n        },\n        {\n          \"feedback\": \"Subir la tasa de aprendizaje suele empeorar el overfitting y desestabilizar el entrenamiento.\",\n          \"isCorrect\": false,\n          \"text\": \"Aumentar la tasa de aprendizaje para converger rápido\"\n        }\n      ],\n      \"question\": \"¿Qué regularización aplicas primero?\"\n    },\n    {\n      \"context\": \"Con dropout agregado la generalización mejora, pero la convergencia es lenta y la curva de entrenamiento está oscilante. {{NAME}}, necesitamos acelerar sin romper estabilidad.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto: Batch Normalization normaliza activaciones, estabiliza gradientes y permite usar tasas de aprendizaje más altas con menos oscilaciones.\",\n          \"isCorrect\": true,\n          \"text\": \"Aplicar Batch Normalization donde sea apropiado\"\n        },\n        {\n          \"feedback\": \"Subir LR sin más suele causar diver gencia; BN es la forma correcta para permitir LR mayores de forma segura.\",\n          \"isCorrect\": false,\n          \"text\": \"Incrementar drásticamente la tasa de aprendizaje\"\n        },\n        {\n          \"feedback\": \"Aumentar demasiado el tamaño del batch puede no ser viable en GPU limitadas y cambia la dinámica de generalización; no es la solución inmediata.\",\n          \"isCorrect\": false,\n          \"text\": \"Aumentar mucho el tamaño del batch\"\n        },\n        {\n          \"feedback\": \"Quitar dropout puede acelerar, pero probablemente aumentará overfitting; mejor estabilizar con BN y mantener regularización.\",\n          \"isCorrect\": false,\n          \"text\": \"Quitar dropout para acelerar entrenamiento\"\n        }\n      ],\n      \"question\": \"¿Cómo aceleramos la convergencia establemente?\"\n    },\n    {\n      \"context\": \"Lo entrenamos y valida bien en servidor, pero la versión para el dispositivo edge tarda demasiado en inferir. {{NAME}}, tenemos límite de latencia y memoria.\",\n      \"options\": [\n        {\n          \"feedback\": \"Podar filtros puede ayudar, pero es delicado y requiere herramientas de pruning; hay opciones más sencillas primero.\",\n          \"isCorrect\": false,\n          \"text\": \"Podar filtros y capas para reducir parámetros\"\n        },\n        {\n          \"feedback\": \"Correcto: reemplazar las capas fully-connected por Global Average Pool reduce drásticamente parámetros manteniendo información espacial y invariancia.\",\n          \"isCorrect\": true,\n          \"text\": \"Reemplazar la cabeza FC por Global Average Pool\"\n        },\n        {\n          \"feedback\": \"Bajar resolución reduce cómputo pero puede perder detalles clínicamente relevantes; usar con cuidado.\",\n          \"isCorrect\": false,\n          \"text\": \"Reducir resoluciones de entrada drásticamente\"\n        },\n        {\n          \"feedback\": \"La cuantización reduce tamaño y latencia pero está fuera del foco de arquitectura; útil pero no aborda diseño de capas y pooling.\",\n          \"isCorrect\": false,\n          \"text\": \"Cuantizar pesos a 8 bits inmediatamente\"\n        }\n      ],\n      \"question\": \"¿Qué cambio reduce el tamaño sin perder mucha precisión?\"\n    },\n    {\n      \"context\": \"En pruebas finales el cliente pide recall muy alto en una clase crítica; estamos confundiendo positivos y eso es inaceptable. {{NAME}}, necesitamos priorizar recall.\",\n      \"options\": [\n        {\n          \"feedback\": \"Más capas aumentan capacidad pero también riesgo de overfitting; no garantiza mejorar recall por sí solo.\",\n          \"isCorrect\": false,\n          \"text\": \"Agregar más capas convolucionales profundas\"\n        },\n        {\n          \"feedback\": \"Correcto: descongelar más capas permite que representaciones tempranas se adapten y extraigan características útiles para detectar esa clase rara.\",\n          \"isCorrect\": true,\n          \"text\": \"Descongelar más bloques para fine-tune específico\"\n        },\n        {\n          \"feedback\": \"Aumentar pooling reduce resolución espacial y puede eliminar señales finas necesarias para detectar casos positivos.\",\n          \"isCorrect\": false,\n          \"text\": \"Aumentar pooling para hacer la red más invariante\"\n        },\n        {\n          \"feedback\": \"Incrementar dropout suele reducir overfitting pero no es la medida directa para mejorar recall en una clase desbalanceada.\",\n          \"isCorrect\": false,\n          \"text\": \"Subir el dropout para regularizar más\"\n        }\n      ],\n      \"question\": \"¿Qué ajustas para aumentar recall de la clase crítica?\"\n    },\n    {\n      \"context\": \"{{NAME}}, hicimos fine-tuning más profundo, pero ahora el entrenamiento es inestable: pérdidas explotan y las métricas fluctúan. Sospecho que las estadísticas de BatchNorm con batch pequeño están distorsionando.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto: con batches pequeños actualizar las estadísticas de BatchNorm puede introducir ruido; congelarlas (usando las estadísticas preentrenadas) estabiliza el ajuste.\",\n          \"isCorrect\": true,\n          \"text\": \"Congelar parámetros y estadísticas de BatchNorm\"\n        },\n        {\n          \"feedback\": \"Eliminar todas las BN rompería la estabilidad que aportan; hay alternativas, pero borrar BN no es la primera opción.\",\n          \"isCorrect\": false,\n          \"text\": \"Eliminar todas las capas BatchNorm\"\n        },\n        {\n          \"feedback\": \"Reducir LR puede ayudar temporalmente, pero no corrige el ruido que generan estadísticos de BN con batches pequeños.\",\n          \"isCorrect\": false,\n          \"text\": \"Reducir mucho la tasa de aprendizaje\"\n        },\n        {\n          \"feedback\": \"Aumentar dropout alrededor de BN no soluciona el problema de estadísticas ruidosas de BatchNorm en batches pequeños.\",\n          \"isCorrect\": false,\n          \"text\": \"Aumentar dropout alrededor de las BN\"\n        }\n      ],\n      \"question\": \"¿Cómo solucionas la inestabilidad por BN con batch pequeño?\"\n    },\n    {\n      \"context\": \"Congelamos BN, la validación se estabiliza, pero ahora el modelo falla en casos con variaciones de iluminación y pequeñas traslaciones espaciales.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto: añadir pooling reduce dimensiones espaciales y aumenta invariancia local a traslaciones, ayudando a robustez sin añadir muchos parámetros.\",\n          \"isCorrect\": true,\n          \"text\": \"Añadir pooling adicional para más invariancia\"\n        },\n        {\n          \"feedback\": \"Aumentar número de filtros incrementa parámetros y latencia; no es la forma más eficiente de ganar invariancia.\",\n          \"isCorrect\": false,\n          \"text\": \"Aumentar el número de filtros por capa\"\n        },\n        {\n          \"feedback\": \"Quitar ReLU eliminaría la no linealidad esencial; empeoraría el rendimiento.\",\n          \"isCorrect\": false,\n          \"text\": \"Quitar las activaciones ReLU\"\n        },\n        {\n          \"feedback\": \"Insertar FC profundas incrementa parámetros y tiende a perder la estructura espacial útil para imágenes.\",\n          \"isCorrect\": false,\n          \"text\": \"Agregar capas fully-connected profundas\"\n        }\n      ],\n      \"question\": \"¿Qué ajuste arquitectónico mejoras sin subir parámetros?\"\n    },\n    {\n      \"context\": \"Listo, entregamos el modelo: cumple recall y latencia. {{NAME}}, el cliente está contento. Antes de cerrar, quiero que resumas la lección clave del diseño de esta arquitectura.\",\n      \"options\": [\n        {\n          \"feedback\": \"Profundizar sin control no garantiza mejores resultados y suele aumentar overfitting; es una mala regla general.\",\n          \"isCorrect\": false,\n          \"text\": \"Siempre prefiero redes extremadamente profundas\"\n        },\n        {\n          \"feedback\": \"Correcto: el diseño fue un balance: usar transfer learning, fine-tuning selectivo, y regularización (dropout, BN) según constraints y datos.\",\n          \"isCorrect\": true,\n          \"text\": \"Equilibrar transfer learning, fine-tuning y regularización\"\n        },\n        {\n          \"feedback\": \"Evitar pooling y BN no tiene sentido: ambos son herramientas útiles; la clave es usarlas según el problema.\",\n          \"isCorrect\": false,\n          \"text\": \"Evitar pooling y BatchNorm por defecto\"\n        },\n        {\n          \"feedback\": \"Tener más datos ayuda, pero no siempre es posible; el enfoque arquitectónico correcto aplica cuando los datos son limitados.\",\n          \"isCorrect\": false,\n          \"text\": \"Siempre la solución es reunir más datos primero\"\n        }\n      ],\n      \"question\": \"¿Cuál es el principio central del diseño que usamos?\"\n    }\n  ]\n}",
      "outputTokens": 5182,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "es-cs-neural-network-architecture-1",
      "userPrompt": "LESSON_TITLE: Arquitecturas de Deep Learning\nLESSON_DESCRIPTION: Disenando y optimizando arquitecturas de redes neuronales para problemas reales\nCHAPTER_TITLE: Arquitecturas de Redes Neuronales\nCOURSE_TITLE: Deep Learning Aplicado\nLANGUAGE: es\nEXPLANATION_STEPS:\n1. Capas Convolucionales: Las capas convolucionales detectan patrones locales usando filtros que se deslizan sobre la entrada. El mismo filtro se aplica en todas partes, lo que reduce parametros y captura patrones sin importar su posicion.\n2. Pooling: El pooling reduce la dimension espacial tomando el maximo o promedio de regiones. Esto hace la representacion mas compacta y algo invariante a pequenas traslaciones.\n3. Activaciones: Las funciones de activacion introducen no-linealidad. ReLU (max(0,x)) es popular por ser simple y evitar el problema del gradiente desvaneciente en capas profundas.\n4. Dropout: El dropout desactiva neuronas aleatoriamente durante el entrenamiento. Esto fuerza redundancia y reduce el sobreajuste — la red no puede depender de ninguna neurona especifica.\n5. Transfer Learning: El transfer learning usa redes pre-entrenadas en grandes datasets. Las capas tempranas aprenden patrones generales; las tardias se ajustan a tu tarea especifica.\n6. Batch Normalization: El batch normalization normaliza activaciones entre capas. Estabiliza el entrenamiento, permite tasas de aprendizaje mas altas, y actua como regularizador."
    },
    {
      "duration": 79687.41616700002,
      "inputTokens": 3162,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, the client is celebrating: clicks are up and p=0.04. I’m uneasy — we ran several metrics last week.\",\n      \"options\": [\n        {\n          \"feedback\": \"Too early — don't act on a p-value until you confirm the hypothesis, test scope, and multiplicity. Decisions need study context.\",\n          \"isCorrect\": false,\n          \"text\": \"Accept result and update product\"\n        },\n        {\n          \"feedback\": \"Right — clarifying the null and the exact hypothesis ensures the p-value was computed against the right H0 and avoids misinterpretation.\",\n          \"isCorrect\": true,\n          \"text\": \"Ask what the null hypothesis was\"\n        },\n        {\n          \"feedback\": \"Helpful later, but first confirm the hypothesis, metrics, and multiplicity; logs don't fix interpretive errors.\",\n          \"isCorrect\": false,\n          \"text\": \"Check server logs for errors\"\n        },\n        {\n          \"feedback\": \"Announcing now risks promoting a false positive if the study design or multiplicity wasn't checked.\",\n          \"isCorrect\": false,\n          \"text\": \"Announce the win to stakeholders\"\n        }\n      ],\n      \"question\": \"What should we ask first?\"\n    },\n    {\n      \"context\": \"{{NAME}}, turns out we tracked five metrics: clicks, conversions, revenue, time on page, bounce. That 0.04 was only for clicks.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correct — testing multiple metrics inflates Type I error. Apply FDR or a suitable correction before claiming significance.\",\n          \"isCorrect\": true,\n          \"text\": \"Apply a multiple-comparisons correction\"\n        },\n        {\n          \"feedback\": \"Cherry-picking one metric ignores multiplicity; you can get false positives that way.\",\n          \"isCorrect\": false,\n          \"text\": \"Keep clicks only and ignore others\"\n        },\n        {\n          \"feedback\": \"Rerunning the same test doesn't address multiplicity and risks p-hacking; adjust or pre-specify instead.\",\n          \"isCorrect\": false,\n          \"text\": \"Run the same t-test again on clicks\"\n        },\n        {\n          \"feedback\": \"A single p<0.05 across many tests isn't reliable without correction for multiple comparisons.\",\n          \"isCorrect\": false,\n          \"text\": \"Ignore others since p<0.05 for clicks\"\n        }\n      ],\n      \"question\": \"Statistically, what's our next step?\"\n    },\n    {\n      \"context\": \"{{NAME}}, after applying FDR the click p-value is 0.20 — much higher than before.\",\n      \"options\": [\n        {\n          \"feedback\": \"You can’t prove the null true. A large p-value means you fail to reject H0, not that the effect is absent for sure.\",\n          \"isCorrect\": false,\n          \"text\": \"The null is true; there is no effect\"\n        },\n        {\n          \"feedback\": \"Right — failing to reject H0 suggests we should examine whether the study had enough power and sample size to detect a meaningful effect.\",\n          \"isCorrect\": true,\n          \"text\": \"Fail to reject H0; examine power and sample size\"\n        },\n        {\n          \"feedback\": \"Lowering alpha to 0.01 makes Type I error stricter but reduces power; it won't help detect an underpowered effect.\",\n          \"isCorrect\": false,\n          \"text\": \"Lower alpha to 0.01 and retest\"\n        },\n        {\n          \"feedback\": \"Don't bluntly report 'no effect.' You should report uncertainty and whether the test could detect meaningful effects.\",\n          \"isCorrect\": false,\n          \"text\": \"Report 'no effect' to the client\"\n        }\n      ],\n      \"question\": \"How should we interpret the corrected p-value?\"\n    },\n    {\n      \"context\": \"{{NAME}}, the observed lift is only 0.5% while product says their MDE is 1.5%.\",\n      \"options\": [\n        {\n          \"feedback\": \"Treating 0.5% as meaningful ignores business thresholds. Small lifts may be statistically detectable but not practically useful.\",\n          \"isCorrect\": false,\n          \"text\": \"Treat 0.5% as business-significant\"\n        },\n        {\n          \"feedback\": \"Correct — compare the estimated effect and its confidence interval to the MDE to judge practical relevance, not just p-values.\",\n          \"isCorrect\": true,\n          \"text\": \"Compare effect and its CI to the MDE\"\n        },\n        {\n          \"feedback\": \"P-values don't tell you practical impact. You must evaluate effect size versus the MDE and CI.\",\n          \"isCorrect\": false,\n          \"text\": \"Ignore MDE; significance is all that matters\"\n        },\n        {\n          \"feedback\": \"Changing alpha to force significance misuses testing and increases false positives; it's not a valid fix.\",\n          \"isCorrect\": false,\n          \"text\": \"Increase alpha so 0.5% becomes significant\"\n        }\n      ],\n      \"question\": \"What now about practical significance?\"\n    },\n    {\n      \"context\": \"{{NAME}}, to detect 1.5% at 80% power we'd need ~100k users per arm. Stakeholders say that's unrealistic.\",\n      \"options\": [\n        {\n          \"feedback\": \"Raising alpha reduces required N but increases false positives — a risky shortcut that undermines error control.\",\n          \"isCorrect\": false,\n          \"text\": \"Increase alpha to 0.1 to reduce N\"\n        },\n        {\n          \"feedback\": \"Right — targeting a subgroup with higher expected lift increases effect size, which lowers required N and raises power.\",\n          \"isCorrect\": true,\n          \"text\": \"Target a segment likely to have bigger effect\"\n        },\n        {\n          \"feedback\": \"Abandoning testing forfeits evidence-based choices; often there are smarter experiment design options.\",\n          \"isCorrect\": false,\n          \"text\": \"Abandon testing; keep current UX\"\n        },\n        {\n          \"feedback\": \"Merging unrelated metrics can introduce bias and invalid inferences; it’s not a principled way to boost power.\",\n          \"isCorrect\": false,\n          \"text\": \"Merge metrics to artificially boost signal\"\n        }\n      ],\n      \"question\": \"A reasonable compromise?\"\n    },\n    {\n      \"context\": \"{{NAME}}, we targeted high-intent users. After a month one segment shows p=0.03, but we actually tested 10 segments.\",\n      \"options\": [\n        {\n          \"feedback\": \"Declaring a win after many segments ignores multiplicity; likely a false positive from multiple looks.\",\n          \"isCorrect\": false,\n          \"text\": \"Declare the segment a win\"\n        },\n        {\n          \"feedback\": \"Right — this is exploratory. We should plan a pre-registered confirmatory replication in that segment before action.\",\n          \"isCorrect\": true,\n          \"text\": \"Treat as exploratory and plan confirmatory replication\"\n        },\n        {\n          \"feedback\": \"Applying Bonferroni retroactively reduces power and doesn't replace a planned replication on clean data.\",\n          \"isCorrect\": false,\n          \"text\": \"Apply Bonferroni now and claim significance\"\n        },\n        {\n          \"feedback\": \"Raising alpha increases false positives; it doesn't fix multiplicity or exploratory testing issues.\",\n          \"isCorrect\": false,\n          \"text\": \"Raise alpha across all tests to 0.1\"\n        }\n      ],\n      \"question\": \"What's the responsible interpretation?\"\n    },\n    {\n      \"context\": \"{{NAME}}, product agreed to a confirmatory run. How should we design it to avoid the earlier pitfalls?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correct — pre-registering hypothesis, primary metric, alpha, and analysis reduces p-hacking and preserves error rates in confirmatory tests.\",\n          \"isCorrect\": true,\n          \"text\": \"Pre-register hypothesis, alpha, and analysis plan\"\n        },\n        {\n          \"feedback\": \"Peeking at p-values during a short rerun risks stopping rules and inflates Type I error unless pre-specified.\",\n          \"isCorrect\": false,\n          \"text\": \"Run a short rerun and check p-values often\"\n        },\n        {\n          \"feedback\": \"Pooling old data reintroduces previous biases and the original multiplicity concerns; a fresh, pre-specified replication is better.\",\n          \"isCorrect\": false,\n          \"text\": \"Pool old and new data to increase N\"\n        },\n        {\n          \"feedback\": \"Changing the metric midstream is cherry-picking; pick a pre-specified primary metric instead.\",\n          \"isCorrect\": false,\n          \"text\": \"Change the metric to clicks-per-minute\"\n        }\n      ],\n      \"question\": \"What's the best design choice?\"\n    },\n    {\n      \"context\": \"{{NAME}}, plot twist: QA found a tracking bug that double-counted clicks only in the variant. The significant segment had inflated data.\",\n      \"options\": [\n        {\n          \"feedback\": \"Right — compromised data invalidate the test. Discard the tainted data, fix the tracking, then rerun the pre-registered replication.\",\n          \"isCorrect\": true,\n          \"text\": \"Discard flawed data, fix tracking, rerun replication\"\n        },\n        {\n          \"feedback\": \"Statistically adjusting for a known systematic measurement error is risky; it's better to fix the source and rerun.\",\n          \"isCorrect\": false,\n          \"text\": \"Statistically adjust the inflated counts\"\n        },\n        {\n          \"feedback\": \"Assuming the effect survives a known measurement error is unjustified; don't proceed on shaky evidence.\",\n          \"isCorrect\": false,\n          \"text\": \"Blame the tracker but assume effect remains\"\n        },\n        {\n          \"feedback\": \"Reporting results that you know are based on corrupted data will mislead decisions; don't present them as valid.\",\n          \"isCorrect\": false,\n          \"text\": \"Report the bug but keep the results\"\n        }\n      ],\n      \"question\": \"How should we proceed?\"\n    },\n    {\n      \"context\": \"{{NAME}}, after fixing the tracker and rerunning the pre-registered test we get a 1.6% lift, p=0.01 — just above the MDE. Product wants full rollout.\",\n      \"options\": [\n        {\n          \"feedback\": \"Rolling out everywhere ignores uncertainty, monitoring, and whether the effect is practically stable; that’s premature.\",\n          \"isCorrect\": false,\n          \"text\": \"Announce success and rollout everywhere\"\n        },\n        {\n          \"feedback\": \"Correct — report the lift and CI, discuss power and MDE, and recommend a monitored staged rollout so business risk matches evidence.\",\n          \"isCorrect\": true,\n          \"text\": \"Report lift with CI, note power/MDE, propose monitored rollout\"\n        },\n        {\n          \"feedback\": \"Leaving it to a PM with only 'significant' is risky; decision-makers need effect size, CI, and context.\",\n          \"isCorrect\": false,\n          \"text\": \"Say 'statistically significant' and let PM decide\"\n        },\n        {\n          \"feedback\": \"Waiting indefinitely trades off value; if evidence meets MDE and risks are managed, monitored rollout is often preferable.\",\n          \"isCorrect\": false,\n          \"text\": \"Delay action until more experiments accumulate\"\n        }\n      ],\n      \"question\": \"How should we present the final result?\"\n    }\n  ]\n}",
      "outputTokens": 6539,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "en-statistics-hypothesis-testing-1",
      "userPrompt": "LESSON_TITLE: Hypothesis Testing in Practice\nLESSON_DESCRIPTION: Applying statistical hypothesis testing correctly to make sound data-driven decisions\nCHAPTER_TITLE: Statistical Inference\nCOURSE_TITLE: Applied Statistics\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. Null Hypothesis: The null hypothesis (H0) is the default assumption of no effect. We try to reject it. The p-value measures how surprising the data would be IF the null were true.\n2. P-Value Meaning: A p-value is NOT the probability the null is true. It's the probability of seeing data this extreme (or more) if the null IS true. A common and dangerous misinterpretation.\n3. Error Types: Type I error (false positive) is rejecting a true null. Type II error (false negative) is failing to reject a false null. You can't minimize both — there's a trade-off.\n4. Statistical Power: Statistical power is the probability of detecting a real effect. It depends on sample size, effect size, and significance level. Low-powered studies miss real effects.\n5. Practical Significance: Statistical significance doesn't mean practical significance. A huge sample can detect tiny effects that don't matter in practice. Always consider effect size.\n6. Multiple Comparisons: Multiple comparisons inflate Type I errors. Testing 20 hypotheses at alpha=0.05 expects one false positive. Corrections like Bonferroni or FDR control this."
    },
    {
      "duration": 58388.278500000015,
      "inputTokens": 3131,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, the client just asked if quantum can speed up their logistics optimization — they want an answer now.\",\n      \"options\": [\n        {\n          \"feedback\": \"Dangerous. Saying yes without mapping the problem ignores whether it fits known quantum advantage categories (factoring, simulation, certain optimizations).\",\n          \"isCorrect\": false,\n          \"text\": \"Tell them yes and pick a quantum algorithm\"\n        },\n        {\n          \"feedback\": \"Right. First check whether the problem maps to problems where quantum advantage is plausible (QUBO, simulation, etc.) before committing resources.\",\n          \"isCorrect\": true,\n          \"text\": \"First check if the problem maps to quantum advantage\"\n        },\n        {\n          \"feedback\": \"Too conservative as the first step. Classical heuristics are valid but you should first evaluate whether quantum could provide an advantage.\",\n          \"isCorrect\": false,\n          \"text\": \"Recommend classical heuristics immediately\"\n        },\n        {\n          \"feedback\": \"Premature. Hardware benchmarks are useful later, but first determine whether the problem type and algorithmic mapping justify trying quantum at all.\",\n          \"isCorrect\": false,\n          \"text\": \"Run a full hardware benchmark now\"\n        }\n      ],\n      \"question\": \"What's our first step?\"\n    },\n    {\n      \"context\": \"Good call. It's a portfolio optimization framed as a QUBO. They have access to gate-based NISQ devices—no on-site annealer. They expect speedups.\",\n      \"options\": [\n        {\n          \"feedback\": \"Unrealistic for near-term. Fault-tolerant algorithms need logical qubits and error correction overhead that we don't have now.\",\n          \"isCorrect\": false,\n          \"text\": \"Design a fault-tolerant algorithm now\"\n        },\n        {\n          \"feedback\": \"Possible for some QUBOs, but client only has gate-based NISQ hardware. Also annealers map differently; mismatch with available devices makes this risky.\",\n          \"isCorrect\": false,\n          \"text\": \"Use a quantum annealer approach\"\n        },\n        {\n          \"feedback\": \"Right. A hybrid variational approach (e.g., QAOA) works well on NISQ: combines quantum parallelism and classical optimization while keeping circuits shallow.\",\n          \"isCorrect\": true,\n          \"text\": \"Propose a hybrid variational (QAOA) proof‑of‑concept\"\n        },\n        {\n          \"feedback\": \"Conservative and plausible, but skips evaluating potential quantum gains. We should test a hybrid approach before abandoning quantum entirely.\",\n          \"isCorrect\": false,\n          \"text\": \"Stick with classical simulated annealing\"\n        }\n      ],\n      \"question\": \"Which approach do we propose?\"\n    },\n    {\n      \"context\": \"Okay, we agreed on a hybrid variational POC. Now the product manager asks: how many qubits and what about error correction?\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrect. Ignoring physical noise underestimates decoherence and gate error—logical qubit counts without overhead are misleading for planning.\",\n          \"isCorrect\": false,\n          \"text\": \"Estimate logical qubits only\"\n        },\n        {\n          \"feedback\": \"Correct. For a NISQ POC plan with available physical qubits, focus on shallow circuits and noise-aware design; full error correction isn't feasible now.\",\n          \"isCorrect\": true,\n          \"text\": \"Plan for NISQ—shallow circuits, expect noise\"\n        },\n        {\n          \"feedback\": \"Too optimistic for the short term. Error correction needs massive overhead (thousands of physical qubits per logical qubit) and isn't realistic now.\",\n          \"isCorrect\": false,\n          \"text\": \"Design now for fully error‑corrected logical qubits\"\n        },\n        {\n          \"feedback\": \"Incorrect. Decoherence is a major limiting factor; assuming it's negligible will make the POC fail on real hardware.\",\n          \"isCorrect\": false,\n          \"text\": \"Assume decoherence is negligible\"\n        }\n      ],\n      \"question\": \"How should we size resources?\"\n    },\n    {\n      \"context\": \"{{NAME}}, our simulator runs are noisy and inconsistent across seeds—sometimes good, sometimes junk. The client will ask why results vary.\",\n      \"options\": [\n        {\n          \"feedback\": \"Deeper circuits amplify interference but also raise decoherence and gate error exposure. On NISQ this often worsens results rather than fixes variance.\",\n          \"isCorrect\": false,\n          \"text\": \"Increase circuit depth to boost interference\"\n        },\n        {\n          \"feedback\": \"Correct. Shortening circuits, compiling to fewer gates, and reducing depth reduces decoherence exposure and usually yields more consistent NISQ outputs.\",\n          \"isCorrect\": true,\n          \"text\": \"Shorten and optimize circuits to reduce decoherence\"\n        },\n        {\n          \"feedback\": \"Adding more entanglement can improve expressivity but also increases gate count and noise. It's not the first fix for inconsistent results.\",\n          \"isCorrect\": false,\n          \"text\": \"Add extra entanglement layers\"\n        },\n        {\n          \"feedback\": \"Reducing shots lowers statistical confidence. You need enough samples to estimate outputs reliably; fewer shots increase variance, not reduce it.\",\n          \"isCorrect\": false,\n          \"text\": \"Reduce measurement shots to speed up runs\"\n        }\n      ],\n      \"question\": \"What should we try first to stabilize results?\"\n    },\n    {\n      \"context\": \"The client believes entanglement is the secret sauce. They want us to 'entangle everything' to win this competition.\",\n      \"options\": [\n        {\n          \"feedback\": \"Maximal entanglement every layer creates deep circuits and lots of gates—great for fault-tolerant machines, terrible for NISQ due to decoherence.\",\n          \"isCorrect\": false,\n          \"text\": \"Maximally entangle all qubits every layer\"\n        },\n        {\n          \"feedback\": \"Right. Use shallow, problem-structured entanglement that matches the QUBO graph. Entanglement is a resource but must be balanced against noise.\",\n          \"isCorrect\": true,\n          \"text\": \"Use shallow entanglement tailored to the problem\"\n        },\n        {\n          \"feedback\": \"Avoiding entanglement removes a key quantum resource (correlations). For many optimization problems you need some entanglement to reach good solutions.\",\n          \"isCorrect\": false,\n          \"text\": \"Avoid entanglement entirely\"\n        },\n        {\n          \"feedback\": \"Random entangling can explore state space but tends to be inefficient and noisy on NISQ devices. We should be deliberate, not random.\",\n          \"isCorrect\": false,\n          \"text\": \"Use random entangling patterns each run\"\n        }\n      ],\n      \"question\": \"How should we incorporate entanglement?\"\n    },\n    {\n      \"context\": \"Our outputs are probabilistic. The analyst asks how we should measure and report results so they're meaningful to stakeholders.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correct. On NISQ, take many shots and use classical post-processing/statistics to identify consistent solutions. Amplitude estimation needs deep, coherent circuits.\",\n          \"isCorrect\": true,\n          \"text\": \"Collect many shots and apply classical post‑processing\"\n        },\n        {\n          \"feedback\": \"Amplitude estimation lowers sample needs but requires deep circuits and ancilla—not practical on current noisy hardware.\",\n          \"isCorrect\": false,\n          \"text\": \"Use amplitude estimation to cut sampling\"\n        },\n        {\n          \"feedback\": \"Full state tomography is exponentially costly and unnecessary for optimizations; it won't scale for practical problem sizes.\",\n          \"isCorrect\": false,\n          \"text\": \"Perform state tomography for accuracy\"\n        },\n        {\n          \"feedback\": \"A single shot is noisy and unrepresentative. Optimization outputs need statistical sampling to find high-quality solutions reliably.\",\n          \"isCorrect\": false,\n          \"text\": \"Use a single high‑confidence measurement\"\n        }\n      ],\n      \"question\": \"Which measurement strategy do we pick?\"\n    },\n    {\n      \"context\": \"Performance improved slightly but still unstable. The team asks: do we invest in error correction or some other fix now?\",\n      \"options\": [\n        {\n          \"feedback\": \"Immediate full error correction is impractical—the overhead is enormous. It’s not the right short-term investment for a NISQ POC.\",\n          \"isCorrect\": false,\n          \"text\": \"Implement full quantum error correction now\"\n        },\n        {\n          \"feedback\": \"Right. Error mitigation (zero‑noise extrapolation, readout calibration) reduces bias on NISQ devices without full error correction overhead.\",\n          \"isCorrect\": true,\n          \"text\": \"Apply error mitigation techniques\"\n        },\n        {\n          \"feedback\": \"Adding qubits without mitigation leaves you with more noisy operations and likely worse results. Quality over raw qubit count matters now.\",\n          \"isCorrect\": false,\n          \"text\": \"Increase qubit count to improve results\"\n        },\n        {\n          \"feedback\": \"Abandoning quantum prematurely loses learning value. Better to try mitigation and quantify improvements before switching completely to classical.\",\n          \"isCorrect\": false,\n          \"text\": \"Switch entirely to classical solvers now\"\n        }\n      ],\n      \"question\": \"Best next step to improve stability?\"\n    },\n    {\n      \"context\": \"Plot twist: compliance says raw client data cannot leave their site, but available quantum hardware is cloud‑only. They won't relax this.\",\n      \"options\": [\n        {\n          \"feedback\": \"Building on-site hardware is possible long-term but unrealistic for a POC—costly and slow compared to cloud options.\",\n          \"isCorrect\": false,\n          \"text\": \"Advocate building on‑site quantum hardware\"\n        },\n        {\n          \"feedback\": \"Correct. Preprocess locally to anonymize/aggregate and map to a reduced QUBO so only obfuscated coefficients leave site—preserves privacy and enables cloud runs.\",\n          \"isCorrect\": true,\n          \"text\": \"Preprocess locally and send an anonymized QUBO to the cloud\"\n        },\n        {\n          \"feedback\": \"Blind quantum computing exists in theory but requires advanced protocols and coordination; it's not a practical short‑term POC solution.\",\n          \"isCorrect\": false,\n          \"text\": \"Use encrypted/blind quantum computing protocols\"\n        },\n        {\n          \"feedback\": \"Refusing to comply damages the relationship. Better to find engineering workarounds (preprocessing, aggregation) that meet constraints.\",\n          \"isCorrect\": false,\n          \"text\": \"Refuse and demand they relax compliance\"\n        }\n      ],\n      \"question\": \"How do we handle the compliance constraint?\"\n    },\n    {\n      \"context\": \"{{NAME}}, we've got a path: hybrid NISQ QAOA POC, shallow entanglement, error mitigation, many shots, and local preprocessing for privacy. Time to present.\",\n      \"options\": [\n        {\n          \"feedback\": \"Too strong. Claiming immediate superiority is unrealistic and risks losing credibility. Quantum advantage is problem-dependent and not guaranteed now.\",\n          \"isCorrect\": false,\n          \"text\": \"Tell them quantum will beat classical now\"\n        },\n        {\n          \"feedback\": \"Correct. Recommend a hybrid NISQ proof‑of‑concept with measurable metrics, privacy preprocessing, error mitigation, and a clear classical fallback.\",\n          \"isCorrect\": true,\n          \"text\": \"Recommend a hybrid NISQ POC with metrics and fallbacks\"\n        },\n        {\n          \"feedback\": \"Waiting for fault‑tolerant hardware ignores near‑term value. We can learn, test, and possibly gain advantage with hybrid NISQ approaches now.\",\n          \"isCorrect\": false,\n          \"text\": \"Recommend waiting for fault‑tolerant hardware\"\n        },\n        {\n          \"feedback\": \"Giving up on quantum may be overly conservative. A measured POC preserves options while controlling risk and cost.\",\n          \"isCorrect\": false,\n          \"text\": \"Recommend switching to classical methods only\"\n        }\n      ],\n      \"question\": \"How do we pitch our recommendation?\"\n    }\n  ]\n}",
      "outputTokens": 4928,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "en-physics-quantum-computing-basics-1",
      "userPrompt": "LESSON_TITLE: Quantum Computing Fundamentals\nLESSON_DESCRIPTION: Understanding quantum computing capabilities and limitations for practical problem-solving\nCHAPTER_TITLE: Quantum Information\nCOURSE_TITLE: Quantum Computing Fundamentals\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. Superposition: Qubits can exist in superposition — a weighted combination of 0 and 1 states. This isn't 'both at once' — it's a probability amplitude that interferes before measurement.\n2. Entanglement: Entanglement links qubits so measuring one instantly determines the other, regardless of distance. This correlation is a resource for quantum algorithms.\n3. Quantum Parallelism: Quantum parallelism lets algorithms evaluate functions on all inputs simultaneously. But you can only read one result — the art is using interference to amplify the right answer.\n4. Decoherence: Decoherence destroys quantum information when qubits interact with their environment. Real qubits are noisy and maintain coherence only briefly.\n5. Error Correction: Quantum error correction encodes logical qubits in many physical qubits. The overhead is huge — thousands of physical qubits per logical qubit for fault tolerance.\n6. Where Quantum Helps: Quantum advantage requires the right problem type. Factoring, simulation, and certain optimization problems benefit. Most classical algorithms won't be replaced."
    },
    {
      "duration": 46792.73879100004,
      "inputTokens": 3181,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, o cliente está reclamando: checkout lento e 504s na produção. Não vemos erro claro. Por onde começamos?\",\n      \"options\": [\n        {\n          \"feedback\": \"Reiniciar pode mascarar o problema e não ajuda a identificar causa raiz; só útil em emergência extrema.\",\n          \"isCorrect\": false,\n          \"text\": \"Reiniciar o serviço de checkout\"\n        },\n        {\n          \"feedback\": \"Escalar pode mitigar sintomas, mas sem entender a causa pode aumentar custo e não resolver falhas em cascata.\",\n          \"isCorrect\": false,\n          \"text\": \"Subir mais réplicas agora\"\n        },\n        {\n          \"feedback\": \"Correto. Observabilidade é a primeira linha: traces e logs centralizados mostram onde o tempo está sendo gasto e indicam dependências com problemas.\",\n          \"isCorrect\": true,\n          \"text\": \"Checar logs, métricas e tracing\"\n        },\n        {\n          \"feedback\": \"Checar esquema de BD pode ser necessário depois, mas primeiro precisamos dados observáveis para saber qual componente falha.\",\n          \"isCorrect\": false,\n          \"text\": \"Revisar esquema do banco de dados\"\n        }\n      ],\n      \"question\": \"Qual é o primeiro passo?\"\n    },\n    {\n      \"context\": \"Os traces mostram muitos timeouts chamando Inventory service. As chamadas bloqueiam o checkout. Como mitigamos rapidamente?\",\n      \"options\": [\n        {\n          \"feedback\": \"Aumentar timeout só adia o problema e pode piorar latência acumulada e falhas em cascata.\",\n          \"isCorrect\": false,\n          \"text\": \"Aumentar os timeouts\"\n        },\n        {\n          \"feedback\": \"Retries sem backoff podem agravar a sobrecarga no Inventory. Retries precisam ser combinados com circuit breakers e backoff.\",\n          \"isCorrect\": false,\n          \"text\": \"Adicionar retries imediatos\"\n        },\n        {\n          \"feedback\": \"Correto. Circuit breaker + fallback evita cascata e dá tempo para o Inventory se recuperar; fallback mantém UX degradada mas estável.\",\n          \"isCorrect\": true,\n          \"text\": \"Adicionar circuit breaker e fallback\"\n        },\n        {\n          \"feedback\": \"Mudar para async pode ser solução a médio prazo, mas não é uma mitigação rápida para parar timeouts agora.\",\n          \"isCorrect\": false,\n          \"text\": \"Converter a chamada para async agora\"\n        }\n      ],\n      \"question\": \"Qual mitigação implementar primeiro?\"\n    },\n    {\n      \"context\": \"Inventory mudou índice do banco esta manhã; a equipe deles tem deploy separado. Estamos muito dependentes das respostas síncronas deles. O que fazemos arquitetura-wise?\",\n      \"options\": [\n        {\n          \"feedback\": \"Banco central compartilhado quebra isolamento e cria acoplamento forte — contra o princípio de dados descentralizados.\",\n          \"isCorrect\": false,\n          \"text\": \"Unificar bancos em um DB central\"\n        },\n        {\n          \"feedback\": \"Fazer merge de serviços aumenta acoplamento e perde benefícios dos microserviços; evita a escalabilidade independente.\",\n          \"isCorrect\": false,\n          \"text\": \"Fundir Checkout e Inventory num serviço só\"\n        },\n        {\n          \"feedback\": \"Correto. Criar cache local ou materialized view atualizada por eventos desacopla dependência síncrona e respeita dados descentralizados com consistência eventual.\",\n          \"isCorrect\": true,\n          \"text\": \"Criar cache local atualizado por eventos\"\n        },\n        {\n          \"feedback\": \"Sincronização remota constante mantém acoplamento e complexidade; preferimos eventos e cópias locais para resiliencia.\",\n          \"isCorrect\": false,\n          \"text\": \"Sincronizar o DB do Inventory remotamente\"\n        }\n      ],\n      \"question\": \"Como reduzir acoplamento a Inventory?\"\n    },\n    {\n      \"context\": \"Cache local resolve latência, mas agora temos risco de oversell se várias compras ocorrerem simultaneamente. Como garantir integridade de estoque?\",\n      \"options\": [\n        {\n          \"feedback\": \"Two-phase commit gera complexidade e reduz disponibilidade; distribuídas 2PC são geralmente evitadas em microserviços.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar transação distribuída 2PC\"\n        },\n        {\n          \"feedback\": \"Bloqueios de DB remotos criam latência e pontos de contenção; isso reintroduz acoplamento problemático.\",\n          \"isCorrect\": false,\n          \"text\": \"Aplicar locks no DB remoto por pedido\"\n        },\n        {\n          \"feedback\": \"Correto. Padrão saga (reservar estoque, confirmar/compensar) permite consistência eventual sem transações distribuídas pesadas.\",\n          \"isCorrect\": true,\n          \"text\": \"Implementar um saga de reserva/compensação\"\n        },\n        {\n          \"feedback\": \"Checar sincronamente a cada pedido elimina ganhos de desempenho e resiliencia do cache; cria latência novamente.\",\n          \"isCorrect\": false,\n          \"text\": \"Fazer checagem síncrona para cada pedido\"\n        }\n      ],\n      \"question\": \"Qual abordagem protege contra oversell?\"\n    },\n    {\n      \"context\": \"Mesmo com circuit breaker e saga, picos de latência no Inventory estão degradando threads compartilhadas e causando falhas em outros fluxos. Como isolamos isso?\",\n      \"options\": [\n        {\n          \"feedback\": \"Retries com backoff ajudam, mas não isolam recursos entre fluxos distintos; não evitam contaminação global.\",\n          \"isCorrect\": false,\n          \"text\": \"Adicionar retries com backoff\"\n        },\n        {\n          \"feedback\": \"Remover retries pode reduzir overload, mas não resolve que um fluxo consome recursos críticos de todo o serviço.\",\n          \"isCorrect\": false,\n          \"text\": \"Remover todos os retries\"\n        },\n        {\n          \"feedback\": \"Correto. Bulkheads isolam recursos (threads, pools) por funcionalidade, evitando que um fluxo esgote recursos do sistema inteiro.\",\n          \"isCorrect\": true,\n          \"text\": \"Aplicar bulkheads para isolar recursos\"\n        },\n        {\n          \"feedback\": \"Aumentar um pool global pode adiar a sobrecarga e mascarar o problema; bulkheads são a prática recomendada aqui.\",\n          \"isCorrect\": false,\n          \"text\": \"Aumentar pool de threads global\"\n        }\n      ],\n      \"question\": \"Como evitar falhas em cascata por picos?\"\n    },\n    {\n      \"context\": \"Operações continua sendo difícil de debugar: logs espalhados e nada correlacionado. O time pede prioridade em observabilidade. O que instrumentamos?\",\n      \"options\": [\n        {\n          \"feedback\": \"Só logs não dão visão de latência distribuída nem correlação entre serviços; insuficiente para microservices.\",\n          \"isCorrect\": false,\n          \"text\": \"Só centralizar logs\"\n        },\n        {\n          \"feedback\": \"Somente métricas dão tendência, mas sem traces não conseguimos seguir uma requisição entre serviços.\",\n          \"isCorrect\": false,\n          \"text\": \"Só expor métricas\"\n        },\n        {\n          \"feedback\": \"Correto. Logs, métricas e tracing distribuído correlacionados permitem localizar latência, falhas e entender comportamento em produção.\",\n          \"isCorrect\": true,\n          \"text\": \"Logs + métricas + tracing correlacionados\"\n        },\n        {\n          \"feedback\": \"Alertas são úteis, mas sem dados observáveis você não sabe onde ou por que algo quebrou.\",\n          \"isCorrect\": false,\n          \"text\": \"Apenas melhorar alertas\"\n        }\n      ],\n      \"question\": \"Qual stack de observabilidade implementar?\"\n    },\n    {\n      \"context\": \"{{NAME}}, plot twist: depois das mudanças, eventos de estoque chegaram duplicados por reenvios da fila e vários pedidos foram reservados duas vezes. O que implementamos para corrigir?\",\n      \"options\": [\n        {\n          \"feedback\": \"Idempotência no consumidor combinada com outbox evita duplicados e garante que publicação de eventos seja consistente com a transação local.\",\n          \"isCorrect\": true,\n          \"text\": \"Idempotência + padrão outbox\"\n        },\n        {\n          \"feedback\": \"Exactly-once é atraente teoricamente, mas raramente alcançável em sistemas distribuídos; geralmente não é prático.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar entrega exactly-once da fila\"\n        },\n        {\n          \"feedback\": \"Desabilitar retries pode evitar duplicação mas reduz resiliencia e aumenta chance de perda de eventos legítimos.\",\n          \"isCorrect\": false,\n          \"text\": \"Desligar retries da fila\"\n        },\n        {\n          \"feedback\": \"Deduplication store é uma alternativa, mas sem outbox e idempotência ainda é vulnerável a condições de concorrência e perda de atomicidade.\",\n          \"isCorrect\": false,\n          \"text\": \"Adicionar tabela de deduplicação central\"\n        }\n      ],\n      \"question\": \"Como prevenir eventos duplicados?\"\n    },\n    {\n      \"context\": \"O time de billing diz que os valores finais ficaram inconsistentes por eventual consistency e o cliente ameaça ação. Precisamos de solução que gere confiança para cobrança. O que propõe?\",\n      \"options\": [\n        {\n          \"feedback\": \"Aceitar eventual consistency sem medidas não resolve um problema legal; precisa-se garantir consistência nos pontos críticos.\",\n          \"isCorrect\": false,\n          \"text\": \"Aceitar inconsistência e explicar ao cliente\"\n        },\n        {\n          \"feedback\": \"Reconstruir para monolito é custo elevado e não necessário; podemos isolar o problema com fronteiras claras de consistência.\",\n          \"isCorrect\": false,\n          \"text\": \"Reescrever como monólito rapidamente\"\n        },\n        {\n          \"feedback\": \"Correto. Criar um serviço de Billing com seu próprio DB e operações síncronas para cobrar garante um limite transacional responsável para dinheiro.\",\n          \"isCorrect\": true,\n          \"text\": \"Criar Billing service com DB próprio e API síncrona\"\n        },\n        {\n          \"feedback\": \"Compensações são úteis, mas cobranças financeiras geralmente exigem garantias de consistência mais fortes; saga sozinho pode não ser suficiente.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar apenas transações compensatórias\"\n        }\n      ],\n      \"question\": \"Como garantir confiança na cobrança?\"\n    },\n    {\n      \"context\": \"Ok, sistema estabilizado, eventos deduplicados, bulkheads e observability no lugar. Qual é a principal lição prática que vamos documentar para o time?\",\n      \"options\": [\n        {\n          \"feedback\": \"Monolito pode ser adequado em alguns casos, mas não é a lição principal desta experiência com microserviços.\",\n          \"isCorrect\": false,\n          \"text\": \"Preferir sempre um monólito\"\n        },\n        {\n          \"feedback\": \"Distribuir tudo de forma síncrona reintroduz acoplamento e fragilidade; não é a melhor prática geral.\",\n          \"isCorrect\": false,\n          \"text\": \"Fazer chamadas síncronas entre todos os serviços\"\n        },\n        {\n          \"feedback\": \"Correto. Definir limites por domínio, descentralizar dados, usar sagas/eventos para consistência eventual e investir em observabilidade e resiliência é o resumo prático.\",\n          \"isCorrect\": true,\n          \"text\": \"Domínio + dados descentralizados + observabilidade\"\n        },\n        {\n          \"feedback\": \"Só aumentar retries não resolve raiz dos problemas; é uma solução superficial.\",\n          \"isCorrect\": false,\n          \"text\": \"Confiar em mais retries e timeouts\"\n        }\n      ],\n      \"question\": \"Qual takeaway documentamos?\"\n    }\n  ]\n}",
      "outputTokens": 4127,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "pt-cs-microservices-architecture-1",
      "userPrompt": "LESSON_TITLE: Microservicos na Pratica\nLESSON_DESCRIPTION: Projetando e implementando arquiteturas de microservicos com consciencia dos trade-offs\nCHAPTER_TITLE: Arquitetura de Software\nCOURSE_TITLE: Engenharia de Software Avancada\nLANGUAGE: pt\nEXPLANATION_STEPS:\n1. Definicao de Microservicos: Microservicos sao servicos pequenos e independentes que fazem uma coisa bem. Cada um pode ser desenvolvido, implantado e escalado separadamente.\n2. Limites de Servico: Limites de servico devem seguir dominios de negocio, nao camadas tecnicas. Um servico de 'Pedidos' faz sentido; um servico de 'Banco de Dados' nao.\n3. Comunicacao: A comunicacao entre servicos pode ser sincrona (REST, gRPC) ou assincrona (filas, eventos). Assincrona e mais resiliente mas mais complexa de debugar.\n4. Dados Descentralizados: Dados descentralizados significam que cada servico tem seu banco. Consistencia eventual e a realidade — transacoes distribuidas sao dificeis e devem ser evitadas.\n5. Resiliencia: Falhas em cascata acontecem quando um servico lento trava outros. Circuit breakers, timeouts e fallbacks sao essenciais para resiliencia.\n6. Observabilidade: Observabilidade requer logs centralizados, metricas e tracing distribuido. Sem isso, debugar problemas em producao e quase impossivel."
    },
    {
      "duration": 66816.22487500001,
      "inputTokens": 3171,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, tenemos que diseñar un tanque cilíndrico con tapa: volumen fijo V. Ya estamos en ello, ¿qué variables tomas para modelar el problema?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto. Usar r y h y escribir la restricción V=πr^2h te permite expresar la altura o el radio y reducir la función objetivo, que es la forma estándar para cilindros.\",\n          \"isCorrect\": true,\n          \"text\": \"Usar r y h; imponer V=πr^2h\"\n        },\n        {\n          \"feedback\": \"Equivalente en contenido pero menos directo: usar diámetro es posible, pero la fórmula del volumen y área queda menos simple. Preferible r y h.\",\n          \"isCorrect\": false,\n          \"text\": \"Diámetro y altura en vez de r\"\n        },\n        {\n          \"feedback\": \"El volumen V no es una variable libre: es la restricción. No puedes optimizar dejando sólo V como variable.\",\n          \"isCorrect\": false,\n          \"text\": \"Tomar sólo V como variable\"\n        },\n        {\n          \"feedback\": \"El área es la cantidad que minimizamos, no una variable independiente. Primero defines r y h y luego escribes el área.\",\n          \"isCorrect\": false,\n          \"text\": \"Tomar el área como variable independiente\"\n        }\n      ],\n      \"question\": \"¿Qué variables defines?\"\n    },\n    {\n      \"context\": \"Perfecto. El cliente quiere minimizar el material (coste proporcional al área). ¿Cómo escribes el área total de un cilindro cerrado (tapa y base)?\",\n      \"options\": [\n        {\n          \"feedback\": \"Exacto: área total de un cilindro cerrado = áreas de dos círculos + área lateral, 2πr^2+2πrh.\",\n          \"isCorrect\": true,\n          \"text\": \"2πr^2 + 2πrh\"\n        },\n        {\n          \"feedback\": \"Eso sería sólo un círculo más lateral; falta el segundo círculo (base o tapa).\",\n          \"isCorrect\": false,\n          \"text\": \"πr^2 + 2πrh\"\n        },\n        {\n          \"feedback\": \"Ese término  πrh no corresponde a la lateral completa; la lateral es 2πrh.\",\n          \"isCorrect\": false,\n          \"text\": \"2πr^2 + πrh\"\n        },\n        {\n          \"feedback\": \"4πr^2 corresponde a dos esferas o cuatro círculos; no es la fórmula del cilindro cerrado.\",\n          \"isCorrect\": false,\n          \"text\": \"4πr^2 + 2πrh\"\n        }\n      ],\n      \"question\": \"¿Cuál es el área total?\"\n    },\n    {\n      \"context\": \"Bien. Tenemos la restricción de volumen V = πr^2 h. Para eliminar una variable, ¿cómo despejas h en función de r y V?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto: despejar h facilita reducir a una variable. h = V/(πr^2) es la forma estándar para un cilindro.\",\n          \"isCorrect\": true,\n          \"text\": \"h = V/(π r^2)\"\n        },\n        {\n          \"feedback\": \"Invertiste π y r^2: esa expresión no satisface V = πr^2 h.\",\n          \"isCorrect\": false,\n          \"text\": \"h = π r^2 / V\"\n        },\n        {\n          \"feedback\": \"Eso sería h multiplicado por πr^2; no despeja h.\",\n          \"isCorrect\": false,\n          \"text\": \"h = V·π r^2\"\n        },\n        {\n          \"feedback\": \"No puedes dejar h en función de r sin el volumen; V es la constante de la restricción necesaria.\",\n          \"isCorrect\": false,\n          \"text\": \"h = (V r)/π\"\n        }\n      ],\n      \"question\": \"¿Cómo despejas h?\"\n    },\n    {\n      \"context\": \"Sustituyamos h en la expresión del área para obtener S(r). La forma simplificada es S(r)=2πr^2 + 2V/r. ¿Cuál es S'(r)?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto: derivando 2πr^2 da 4πr, y de 2V r^{-1} da -2V r^{-2}, por eso S'(r)=4πr - 2V/r^2.\",\n          \"isCorrect\": true,\n          \"text\": \"S'(r) = 4π r - 2V / r^2\"\n        },\n        {\n          \"feedback\": \"Signo incorrecto: el término con V al derivar debe ser negativo porque es 2V·r^{-1}.\",\n          \"isCorrect\": false,\n          \"text\": \"S'(r) = 4π r + 2V / r^2\"\n        },\n        {\n          \"feedback\": \"Exponentes incorrectos: 2V/r deriva a -2V/r^2, no a -2V/r.\",\n          \"isCorrect\": false,\n          \"text\": \"S'(r) = 4π r - 2V / r\"\n        },\n        {\n          \"feedback\": \"Eso sería la derivada de πr^2+2V/r, no de nuestra S(r). Revisa la potencia al derivar r^{-1}.\",\n          \"isCorrect\": false,\n          \"text\": \"S'(r) = 2π r - 2V / r^2\"\n        }\n      ],\n      \"question\": \"¿Cuál es la derivada S'(r)?\"\n    },\n    {\n      \"context\": \"Para encontrar críticos igualamos S'(r)=0. Resolviendo 4πr - 2V/r^2 = 0, ¿qué expresión obtienes para r crítico?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto: 4πr = 2V/r^2 ⇒ r^3 = V/(2π) ⇒ r = (V/(2π))^{1/3}.\",\n          \"isCorrect\": true,\n          \"text\": \"r = (V / (2π))^{1/3}\"\n        },\n        {\n          \"feedback\": \"Ese valor sería si 4πr = 4V/r^2 (factor equivocado). Falla el 2 vs 4.\",\n          \"isCorrect\": false,\n          \"text\": \"r = (V / (4π))^{1/3}\"\n        },\n        {\n          \"feedback\": \"Ese resultado omite el factor 2 del denominador; no satisface la ecuación original.\",\n          \"isCorrect\": false,\n          \"text\": \"r = (2V / π)^{1/3}\"\n        },\n        {\n          \"feedback\": \"Ese sería r = (V/π)^{1/3}, omitiendo el 2 en el denominador que aparece al resolver la ecuación.\",\n          \"isCorrect\": false,\n          \"text\": \"r = (V / π)^{1/3}\"\n        }\n      ],\n      \"question\": \"¿Cuál es r crítico?\"\n    },\n    {\n      \"context\": \"Aplicamos la prueba de la segunda derivada: S''(r)=4π + 4V/r^3. ¿Qué concluyes para el punto crítico r>0?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto. S''(r)>0 porque V>0 y r>0, así el punto crítico es un mínimo local. Esto confirma que minimizamos material.\",\n          \"isCorrect\": true,\n          \"text\": \"S''(r)>0 → mínimo local\"\n        },\n        {\n          \"feedback\": \"Incorrecto: S''(r) no es negativo. Comprueba los signos: ambas sumas son positivas.\",\n          \"isCorrect\": false,\n          \"text\": \"S''(r)<0 → máximo local\"\n        },\n        {\n          \"feedback\": \"No: S''(r) no se anula en r>0 salvo casos degenerados; aquí es estrictamente positivo.\",\n          \"isCorrect\": false,\n          \"text\": \"S''(r)=0 → inconcluso\"\n        },\n        {\n          \"feedback\": \"Aunque puedes hacer pruebas numéricas, la expresión simbólica ya muestra el signo sin valores numéricos.\",\n          \"isCorrect\": false,\n          \"text\": \"No se puede concluir sin números concretos\"\n        }\n      ],\n      \"question\": \"¿Qué dice la prueba de la segunda derivada?\"\n    },\n    {\n      \"context\": \"Perfecto. El cliente ahora pide la altura h correspondiente al radio óptimo que hallamos. ¿Qué expresión es correcta para h en función de V?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto: sustituyendo r=(V/(2π))^{1/3} en h=V/(πr^2) da h = 2^{2/3} (V/π)^{1/3}.\",\n          \"isCorrect\": true,\n          \"text\": \"h = 2^{2/3}·(V/π)^{1/3}\"\n        },\n        {\n          \"feedback\": \"Ese exponente 1/3 en 2 no es correcto; la potencia debe ser 2/3 en la base 2 por la sustitución.\",\n          \"isCorrect\": false,\n          \"text\": \"h = 2^{1/3}·(V/π)^{1/3}\"\n        },\n        {\n          \"feedback\": \"Ese resultado omite π en el denominador al simplificar; no coincide con la sustitución correcta.\",\n          \"isCorrect\": false,\n          \"text\": \"h = (V/π)^{1/3}\"\n        },\n        {\n          \"feedback\": \"Ese sería un valor numérico sólo si asumes π=1; no es la expresión algebraica correcta.\",\n          \"isCorrect\": false,\n          \"text\": \"h = 2·(V/π)^{1/3}\"\n        }\n      ],\n      \"question\": \"¿Cuál h corresponde al r óptimo?\"\n    },\n    {\n      \"context\": \"{{NAME}}, plot twist: transporte exige diámetro ≤ Dmax (r ≤ r_max = Dmax/2). Nuestro r óptimo puede superar r_max. ¿Cuál es el paso correcto ahora?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto. Para extremos globales con restricción de dominio, compara el candidato crítico válido y el borde r_max evaluando la función objetivo; el menor da el óptimo global factible.\",\n          \"isCorrect\": true,\n          \"text\": \"Evaluar S en r_crítico y en r_max y escoger el menor factible\"\n        },\n        {\n          \"feedback\": \"No puedes ignorar la restricción: si r_crítico > r_max, no es factible. Debes comparar o ajustar según el borde.\",\n          \"isCorrect\": false,\n          \"text\": \"Ignorar la restricción y usar r_crítico igual\"\n        },\n        {\n          \"feedback\": \"Ajustar r sin verificar el efecto en S puede producir un diseño subóptimo; hay que comparar valores concretos.\",\n          \"isCorrect\": false,\n          \"text\": \"Escalar r_crítico hasta r_max y aceptar sin comparar\"\n        },\n        {\n          \"feedback\": \"Lagrange con desigualdades requiere KKT; no es la respuesta más directa aquí. Primero compara el crítico y el borde.\",\n          \"isCorrect\": false,\n          \"text\": \"Aplicar multiplicadores de Lagrange con desigualdad ahora\"\n        }\n      ],\n      \"question\": \"¿Qué haces ante esta nueva restricción?\"\n    },\n    {\n      \"context\": \"Lo calculaste: r_crítico > r_max, así que usamos r_max y recalculamos h por V=πr_max^2 h. {{NAME}}, ¿qué le dirás al cliente como lección clave del diseño?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto. La lección: siempre modelar restricciones físicas y evaluar extremos del dominio; un candidato interior no es válido si viola límites reales.\",\n          \"isCorrect\": true,\n          \"text\": \"Verificar restricciones y evaluar extremos del dominio\"\n        },\n        {\n          \"feedback\": \"Aunque importante, modelar correctamente no sustituye la verificación de límites; la frase es incompleta como lección principal aquí.\",\n          \"isCorrect\": false,\n          \"text\": \"Optimizar sólo el coste sin preocuparse por límites\"\n        },\n        {\n          \"feedback\": \"No es la mejor lección: derivadas y pruebas son útiles, pero el punto práctico fue considerar límites del mundo real.\",\n          \"isCorrect\": false,\n          \"text\": \"Siempre confiar en el punto crítico sin más comprobaciones\"\n        },\n        {\n          \"feedback\": \"Eso es útil para complejidad teórica, pero aquí la prioridad fue comprobar restricciones físicas y comparar bordes.\",\n          \"isCorrect\": false,\n          \"text\": \"Preferir métodos numéricos avanzados siempre\"\n        }\n      ],\n      \"question\": \"¿Cuál es la lección principal para el cliente?\"\n    }\n  ]\n}",
      "outputTokens": 5574,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "es-math-calculus-optimization-1",
      "userPrompt": "LESSON_TITLE: Optimizacion con Calculo\nLESSON_DESCRIPTION: Aplicando tecnicas de calculo para encontrar optimos en problemas de ingenieria y negocios\nCHAPTER_TITLE: Aplicaciones del Calculo\nCOURSE_TITLE: Calculo para Ingenieria\nLANGUAGE: es\nEXPLANATION_STEPS:\n1. Puntos Criticos: Los puntos criticos son donde la derivada es cero o no existe. Son CANDIDATOS a extremos — no todos los puntos criticos son maximos o minimos.\n2. Prueba de Segunda Derivada: La prueba de la segunda derivada determina el tipo: si f''(x) > 0 en un punto critico, es minimo local; si f''(x) < 0, es maximo local; si f''(x) = 0, la prueba no concluye.\n3. Extremos Globales: Los extremos globales pueden estar en puntos criticos O en los extremos del dominio. Siempre evalua tambien los bordes del intervalo.\n4. Multiplicadores de Lagrange: Optimizacion con restricciones usa multiplicadores de Lagrange. Maximizar f(x,y) sujeto a g(x,y)=0 requiere que los gradientes sean paralelos.\n5. Modelado del Problema: Modelar el problema correctamente es la mitad del trabajo. Define la funcion objetivo, identifica las restricciones, y expresa todo en terminos de las variables relevantes."
    }
  ],
  "taskId": "activity-story"
}
