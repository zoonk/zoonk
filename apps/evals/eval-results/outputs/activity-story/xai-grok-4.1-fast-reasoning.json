{
  "generatedAt": "2026-01-17T15:49:46.067Z",
  "modelId": "xai/grok-4.1-fast-reasoning",
  "outputs": [
    {
      "duration": 40596.99091599998,
      "inputTokens": 3303,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, disaster on the analytics dashboard. Users report crashes computing metrics. Error: 'Cannot read properties of undefined (reading map)' on user.stats.posts.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. any[] bypasses type checking, missing runtime issues like undefined. Use union type for safety.\",\n          \"isCorrect\": false,\n          \"text\": \"Type stats.posts as any[]\"\n        },\n        {\n          \"feedback\": \"Wrong. Post[] assumes always defined, TS won't catch undefined access.\",\n          \"isCorrect\": false,\n          \"text\": \"Type it as Post[]\"\n        },\n        {\n          \"feedback\": \"Correct! Typing as Post[] | undefined catches the undefined case at compile time, preventing runtime errors per compile-time safety.\",\n          \"isCorrect\": true,\n          \"text\": \"Type as Post[] | undefined\"\n        },\n        {\n          \"feedback\": \"Wrong. ? optional chaining hides errors without narrowing, issues persist at runtime.\",\n          \"isCorrect\": false,\n          \"text\": \"Use posts?.map()\"\n        }\n      ],\n      \"question\": \"How do we type user.stats.posts first?\"\n    },\n    {\n      \"context\": \"Nice, TS now flags posts.map() outside checks. We need to narrow the type so TS knows it's Post[] inside the block.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Non-null assertion ! lies to TS; if wrong, runtime crash.\",\n          \"isCorrect\": false,\n          \"text\": \"Use posts!.map()\"\n        },\n        {\n          \"feedback\": \"Wrong. Typeof doesn't narrow to Post[].\",\n          \"isCorrect\": false,\n          \"text\": \"if (typeof posts === 'object')\"\n        },\n        {\n          \"feedback\": \"Correct! if (posts) narrows to Post[] since empty array is truthy but defined.\",\n          \"isCorrect\": true,\n          \"text\": \"Wrap in if (posts)\"\n        },\n        {\n          \"feedback\": \"Wrong. Casting forces type without check, unsafe.\",\n          \"isCorrect\": false,\n          \"text\": \"(posts as Post[]).map()\"\n        }\n      ],\n      \"question\": \"How to safely access posts.map()?\"\n    },\n    {\n      \"context\": \"Perfect narrowing. But this logic repeats everywhere. Let's genericize a safeMap function for any array.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. any[] loses type info, defeats generics.\",\n          \"isCorrect\": false,\n          \"text\": \"safeMap(items: any[])\"\n        },\n        {\n          \"feedback\": \"Wrong. unknown[] requires checks inside anyway.\",\n          \"isCorrect\": false,\n          \"text\": \"safeMap(items: unknown[])\"\n        },\n        {\n          \"feedback\": \"Correct! <T>(items: T[] | undefined): T[] uses generics to preserve type info across calls.\",\n          \"isCorrect\": true,\n          \"text\": \"Make it generic <T>(items: T[] | undefined)\"\n        },\n        {\n          \"feedback\": \"Wrong. No generics needed? But loses reusability.\",\n          \"isCorrect\": false,\n          \"text\": \"Hardcode for Post[]\"\n        }\n      ],\n      \"question\": \"How to make reusable safe mapper?\"\n    },\n    {\n      \"context\": \"Great, safeMap<T>(items: T[] | undefined). But callers infer T wrong sometimes. Our UserStats and ReportData have similar shapes.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Names matter? No, TS uses structural typing.\",\n          \"isCorrect\": false,\n          \"text\": \"Rename one interface\"\n        },\n        {\n          \"feedback\": \"Correct! Structural typing checks shape compatibility, not names. Assignable if structures match.\",\n          \"isCorrect\": true,\n          \"text\": \"That's structural typing\"\n        },\n        {\n          \"feedback\": \"Wrong. Generics broken? No, inference from shape.\",\n          \"isCorrect\": false,\n          \"text\": \"Fix generic constraint\"\n        },\n        {\n          \"feedback\": \"Wrong. Not narrowing issue.\",\n          \"isCorrect\": false,\n          \"text\": \"Add type guard\"\n        }\n      ],\n      \"question\": \"Why wrong T inference?\"\n    },\n    {\n      \"context\": \"Ah, structural typing got us. UserStats {posts: Post[]} compatible with ReportData {items: Post[]}. TS allows bad assign.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Partial hides required fields.\",\n          \"isCorrect\": false,\n          \"text\": \"Use Partial<ReportData>\"\n        },\n        {\n          \"feedback\": \"Correct! Explicit generics like safeMap<Post>(stats.posts) pins exact type, avoids shape confusion.\",\n          \"isCorrect\": true,\n          \"text\": \"Call with explicit <Post>\"\n        },\n        {\n          \"feedback\": \"Wrong. any again bad.\",\n          \"isCorrect\": false,\n          \"text\": \"Cast to any\"\n        },\n        {\n          \"feedback\": \"Wrong. Doesn't address shape match.\",\n          \"isCorrect\": false,\n          \"text\": \"Add unique field\"\n        }\n      ],\n      \"question\": \"How to ensure correct type?\"\n    },\n    {\n      \"context\": \"Fixed with explicit types. Now the root: API fetch. response.json() returns any. That's our any nightmare source.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. any disables all checks.\",\n          \"isCorrect\": false,\n          \"text\": \"Keep as any\"\n        },\n        {\n          \"feedback\": \"Correct! unknown forces type checks before use, safer than any.\",\n          \"isCorrect\": true,\n          \"text\": \"Type as unknown\"\n        },\n        {\n          \"feedback\": \"Wrong. Can't cast json() directly.\",\n          \"isCorrect\": false,\n          \"text\": \"As UserData\"\n        },\n        {\n          \"feedback\": \"Wrong. Still disables safety.\",\n          \"isCorrect\": false,\n          \"text\": \"Leave untyped\"\n        }\n      ],\n      \"question\": \"What to type fetch.json()?\"\n    },\n    {\n      \"context\": \"Good, data: unknown. But now TS blocks everything on it. We need a way to validate and narrow safely.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Assertion skips validation.\",\n          \"isCorrect\": false,\n          \"text\": \"as UserData\"\n        },\n        {\n          \"feedback\": \"Wrong. Discriminated? Not yet.\",\n          \"isCorrect\": false,\n          \"text\": \"Check discriminant\"\n        },\n        {\n          \"feedback\": \"Correct! Type guard function isUserData(data): data is UserData narrows after check.\",\n          \"isCorrect\": true,\n          \"text\": \"Write type guard\"\n        },\n        {\n          \"feedback\": \"Wrong. Still unsafe.\",\n          \"isCorrect\": false,\n          \"text\": \"Use !\"\n        }\n      ],\n      \"question\": \"How to narrow unknown to UserData?\"\n    },\n    {\n      \"context\": \"Type guard in place: if (isUserData(data)) { const userData = data; ... }. Dashboard compiles clean.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Would fail runtime on bad shapes.\",\n          \"isCorrect\": false,\n          \"text\": \"Deploy as-is\"\n        },\n        {\n          \"feedback\": \"Correct! Test with real API payloads, including edge cases.\",\n          \"isCorrect\": true,\n          \"text\": \"Test runtime payloads\"\n        },\n        {\n          \"feedback\": \"Wrong. TS already strict.\",\n          \"isCorrect\": false,\n          \"text\": \"Loosen types\"\n        },\n        {\n          \"feedback\": \"Wrong. No need.\",\n          \"isCorrect\": false,\n          \"text\": \"Add more anys\"\n        }\n      ],\n      \"question\": \"Next step before deploy?\"\n    },\n    {\n      \"context\": \"{{NAME}}, plot twist! Test data from admin API worked in JS but TS blocks now. AdminStats has extra 'permissions' field, but structurally matches UserStats!\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Extra fields ok in structural typing.\",\n          \"isCorrect\": false,\n          \"text\": \"Reject extra fields\"\n        },\n        {\n          \"feedback\": \"Correct! Guard checks exact shape or discriminant, catches mismatch despite structural compat.\",\n          \"isCorrect\": true,\n          \"text\": \"Tighten guard for exact match\"\n        },\n        {\n          \"feedback\": \"Wrong. Makes it worse.\",\n          \"isCorrect\": false,\n          \"text\": \"Use any for admin\"\n        },\n        {\n          \"feedback\": \"Wrong. ? hides it.\",\n          \"isCorrect\": false,\n          \"text\": \"Make fields optional\"\n        }\n      ],\n      \"question\": \"Why TS catches admin data?\"\n    },\n    {\n      \"context\": \"Guard now distinguishes UserStats vs AdminStats with type predicate. No more silent shape slips.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Still vulnerable.\",\n          \"isCorrect\": false,\n          \"text\": \"Skip admin path\"\n        },\n        {\n          \"feedback\": \"Correct! Full stack: unions, narrowing, generics, unknown + guards = bulletproof type safety.\",\n          \"isCorrect\": true,\n          \"text\": \"Merge and deploy\"\n        },\n        {\n          \"feedback\": \"Wrong. JS would fail anyway.\",\n          \"isCorrect\": false,\n          \"text\": \"Disable TS for admin\"\n        },\n        {\n          \"feedback\": \"Wrong. Partial defeats purpose.\",\n          \"isCorrect\": false,\n          \"text\": \"Use Partial everywhere\"\n        }\n      ],\n      \"question\": \"Ready to ship?\"\n    },\n    {\n      \"context\": \"Deployed! Zero crashes in staging. {{NAME}}, users happy. We caught all those runtime bugs at compile time thanks to proper typing.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Not main takeaway.\",\n          \"isCorrect\": false,\n          \"text\": \"Generics only\"\n        },\n        {\n          \"feedback\": \"Correct! Type safety stack (unions, narrowing, guards, generics, unknown over any) prevents bugs early.\",\n          \"isCorrect\": true,\n          \"text\": \"Lesson: full type system in practice\"\n        },\n        {\n          \"feedback\": \"Wrong. Structural helped.\",\n          \"isCorrect\": false,\n          \"text\": \"Avoid structural typing\"\n        },\n        {\n          \"feedback\": \"Wrong. any quick.\",\n          \"isCorrect\": false,\n          \"text\": \"Stick to any for speed\"\n        }\n      ],\n      \"question\": \"Key insight here?\"\n    }\n  ]\n}",
      "outputTokens": 3534,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "en-cs-typescript-type-safety-1",
      "userPrompt": "LESSON_TITLE: Type Safety in Practice\nLESSON_DESCRIPTION: Applying TypeScript's type system to catch bugs early and write more maintainable code\nCHAPTER_TITLE: Type Systems\nCOURSE_TITLE: Advanced TypeScript\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. Compile-Time Safety: Type safety catches errors at compile time instead of runtime. When TypeScript knows a variable's type, it can prevent operations that would fail — like calling .length on undefined.\n2. Structural Typing: TypeScript uses structural typing — it cares about shape, not names. Two types are compatible if they have the same structure, even if defined separately.\n3. Type Narrowing: Type narrowing lets TypeScript understand more specific types after checks. Inside an if-block that checks for null, TypeScript knows the value isn't null.\n4. Generics: Generic types let you write reusable code that works with multiple types while preserving type information. Array<T> knows what's inside, unlike just 'Array'.\n5. Any vs Unknown: The 'any' type disables type checking entirely. It's an escape hatch but defeats the purpose of TypeScript. Use 'unknown' when the type truly isn't known.\n6. Type Guards: Type guards are functions that narrow types. They return a type predicate that tells TypeScript what the type is after the check passes."
    },
    {
      "duration": 47062.98837499996,
      "inputTokens": 3260,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, AlertCo just slashed fares 20% on our Boston-DC shuttle. Our bookings tanked 15% overnight. Can't lose this route.\",\n      \"options\": [\n        {\n          \"feedback\": \"Matching impulsively ignores strategic interdependence — our best move depends on anticipating theirs. Model first.\",\n          \"isCorrect\": false,\n          \"text\": \"Match the cut immediately.\"\n        },\n        {\n          \"feedback\": \"Spot on. Game theory analyzes competitive interdependence where payoffs depend on both choices. Let's build the matrix.\",\n          \"isCorrect\": true,\n          \"text\": \"Model it with game theory.\"\n        },\n        {\n          \"feedback\": \"Service matters long-term, but right now it's a price war. We need to analyze payoffs before pivoting.\",\n          \"isCorrect\": false,\n          \"text\": \"Improve onboard service.\"\n        },\n        {\n          \"feedback\": \"Raising prices now would hand them the market. We must consider mutual best responses.\",\n          \"isCorrect\": false,\n          \"text\": \"Raise to premium levels.\"\n        }\n      ],\n      \"question\": \"How do we strategically respond?\"\n    },\n    {\n      \"context\": \"Perfect. Payoff matrix: Both high ($300): $10M each. Both low ($200): $4M each. One low/one high: Low gets $12M, high $2M.\",\n      \"options\": [\n        {\n          \"feedback\": \"High isn't dominant — if they low, you'd get $2M vs $4M by lowering too.\",\n          \"isCorrect\": false,\n          \"text\": \"Charge high fares always.\"\n        },\n        {\n          \"feedback\": \"Correct. Low fares dominate: $12M > $10M if they high; $4M > $2M if they low.\",\n          \"isCorrect\": true,\n          \"text\": \"Low fares regardless.\"\n        },\n        {\n          \"feedback\": \"Dominant means best no matter what they do. Here it depends, but low is better either way.\",\n          \"isCorrect\": false,\n          \"text\": \"It depends on them.\"\n        },\n        {\n          \"feedback\": \"No — low beats high in both columns, so it's dominant.\",\n          \"isCorrect\": false,\n          \"text\": \"High if they low.\"\n        }\n      ],\n      \"question\": \"Dominant strategy for us?\"\n    },\n    {\n      \"context\": \"Dominant for both: low fares. If we both play it, what outcome?\",\n      \"options\": [\n        {\n          \"feedback\": \"Both high is Pareto better but unstable — each deviates for gain.\",\n          \"isCorrect\": false,\n          \"text\": \"Both charge high.\"\n        },\n        {\n          \"feedback\": \"No pure Nash there; low dominates.\",\n          \"isCorrect\": false,\n          \"text\": \"Mixed high/low.\"\n        },\n        {\n          \"feedback\": \"Yes, Nash equilibrium: both low. Neither improves by solo changing (high would get $2M < $4M).\",\n          \"isCorrect\": true,\n          \"text\": \"Both low fares.\"\n        },\n        {\n          \"feedback\": \"There is a Nash; dominant strategies converge to it.\",\n          \"isCorrect\": false,\n          \"text\": \"No equilibrium.\"\n        }\n      ],\n      \"question\": \"Nash equilibrium here?\"\n    },\n    {\n      \"context\": \"Nash is both low — $4M each. But both high gives $10M! Individual rationality traps us.\",\n      \"options\": [\n        {\n          \"feedback\": \"Communication isn't required; it's about dominant leading to suboptimal Nash.\",\n          \"isCorrect\": false,\n          \"text\": \"Not PD, we can talk.\"\n        },\n        {\n          \"feedback\": \"Exactly prisoner's dilemma: dominant strategies yield Nash worse than mutual cooperation.\",\n          \"isCorrect\": true,\n          \"text\": \"Classic PD example.\"\n        },\n        {\n          \"feedback\": \"High isn't dominant; low is.\",\n          \"isCorrect\": false,\n          \"text\": \"No, high dominates.\"\n        },\n        {\n          \"feedback\": \"PD structure holds even in one-shot without talk.\",\n          \"isCorrect\": false,\n          \"text\": \"Only if repeated.\"\n        }\n      ],\n      \"question\": \"Is this PD?\"\n    },\n    {\n      \"context\": \"Total PD. But this isn't one-shot — we've flown this route competitively for 5 years. Repeated game.\",\n      \"options\": [\n        {\n          \"feedback\": \"Opposite: repetition allows strategies punishing defection.\",\n          \"isCorrect\": false,\n          \"text\": \"Defection easier.\"\n        },\n        {\n          \"feedback\": \"Right. Repeated interactions enable cooperation — future retaliation deters cutting.\",\n          \"isCorrect\": true,\n          \"text\": \"Cooperation viable.\"\n        },\n        {\n          \"feedback\": \"No, repetition weakens dominance by adding future costs.\",\n          \"isCorrect\": false,\n          \"text\": \"Dominant still rules.\"\n        },\n        {\n          \"feedback\": \"Nash shifts with repetition, but via strategies, not magically.\",\n          \"isCorrect\": false,\n          \"text\": \"Nash now both high.\"\n        }\n      ],\n      \"question\": \"Repetition's impact?\"\n    },\n    {\n      \"context\": \"In repeated PD, strategies like tit-for-tat sustain cooperation: cooperate first, then mirror opponent's last move.\",\n      \"options\": [\n        {\n          \"feedback\": \"Always cut fails long-term; invites endless war.\",\n          \"isCorrect\": false,\n          \"text\": \"Always cut low.\"\n        },\n        {\n          \"feedback\": \"Tit-for-tat is robust: forgiving yet retaliatory, promotes cooperation.\",\n          \"isCorrect\": true,\n          \"text\": \"Use tit-for-tat.\"\n        },\n        {\n          \"feedback\": \"Grim trigger works but is harsh; one slip ends cooperation forever.\",\n          \"isCorrect\": false,\n          \"text\": \"Grim trigger punish.\"\n        },\n        {\n          \"feedback\": \"Always cooperate gets exploited by defectors.\",\n          \"isCorrect\": false,\n          \"text\": \"Cooperate forever.\"\n        }\n      ],\n      \"question\": \"Best repeated strategy?\"\n    },\n    {\n      \"context\": \"Tit-for-tat it is. Last period both high (cooperate). They cut now (defect), so we cut next period.\",\n      \"options\": [\n        {\n          \"feedback\": \"Forgiving too much risks exploitation.\",\n          \"isCorrect\": false,\n          \"text\": \"Hold high anyway.\"\n        },\n        {\n          \"feedback\": \"Yes — mirror their cut this period to signal we won't tolerate defection.\",\n          \"isCorrect\": true,\n          \"text\": \"Cut low this period.\"\n        },\n        {\n          \"feedback\": \"Deeper cut escalates; tit-for-tat matches exactly.\",\n          \"isCorrect\": false,\n          \"text\": \"Cut even lower.\"\n        },\n        {\n          \"feedback\": \"Signaling raise invites more cuts.\",\n          \"isCorrect\": false,\n          \"text\": \"Raise to signal.\"\n        }\n      ],\n      \"question\": \"Our move this period?\"\n    },\n    {\n      \"context\": \"Whoa, {{NAME}} — twist! AlertCo's low-fare flights are 60% empty. Their CFO just tweeted about 'fares stabilizing soon.' They're signaling!\",\n      \"options\": [\n        {\n          \"feedback\": \"Bluff unlikely with empty planes.\",\n          \"isCorrect\": false,\n          \"text\": \"Bluff — cut harder.\"\n        },\n        {\n          \"feedback\": \"Yes, classic signal in repeated game: hinting return to cooperation (high fares).\",\n          \"isCorrect\": true,\n          \"text\": \"Signaling cooperation.\"\n        },\n        {\n          \"feedback\": \"Trouble means cut more? No, weak rival might fold to our high.\",\n          \"isCorrect\": false,\n          \"text\": \"They're failing — cut.\"\n        },\n        {\n          \"feedback\": \"Dominant ignores signals; repetition relies on them.\",\n          \"isCorrect\": false,\n          \"text\": \"Stick to dominant.\"\n        }\n      ],\n      \"question\": \"What does this signal?\"\n    },\n    {\n      \"context\": \"Brilliant read. They're backing off. We hold high this period — forgive and cooperate. Tit-for-tat allows return to mutual high. Profits await!\",\n      \"options\": [\n        {\n          \"feedback\": \"Cutting now undoes the signal.\",\n          \"isCorrect\": false,\n          \"text\": \"Cut to match.\"\n        },\n        {\n          \"feedback\": \"Wrong — deep cut punishes too hard after signal.\",\n          \"isCorrect\": false,\n          \"text\": \"Slash deeper.\"\n        },\n        {\n          \"feedback\": \"Yes! Recognize repeated game, respond to signal: hold high for cooperative Nash path.\",\n          \"isCorrect\": true,\n          \"text\": \"Hold high fares.\"\n        },\n        {\n          \"feedback\": \"Service nice, but strategy wins the war.\",\n          \"isCorrect\": false,\n          \"text\": \"Boost service only.\"\n        }\n      ],\n      \"question\": \"Final strategy?\"\n    }\n  ]\n}",
      "outputTokens": 3827,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "en-economics-game-theory-strategy-1",
      "userPrompt": "LESSON_TITLE: Strategic Thinking with Game Theory\nLESSON_DESCRIPTION: Using game theory to analyze competitive situations and make better strategic decisions\nCHAPTER_TITLE: Strategic Decision Making\nCOURSE_TITLE: Microeconomics\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. Strategic Interdependence: Game theory studies strategic interactions where your outcome depends on others' choices too. It's not about games — it's about any situation where what you should do depends on what others do.\n2. Nash Equilibrium: A Nash equilibrium is a stable state where no player can improve by changing only their own strategy. Everyone is doing their best given what everyone else is doing.\n3. Dominant Strategies: A dominant strategy is best regardless of what others do. If you have one, use it. But most real situations don't have dominant strategies — you must anticipate others.\n4. The Prisoner's Dilemma: The prisoner's dilemma shows how individual rationality can lead to collective irrationality. Both players choosing their dominant strategy leaves both worse off.\n5. Repeated Interactions: Repeated games change the calculus. When you'll interact again, cooperation becomes rational because future punishment makes defection costly."
    },
    {
      "duration": 41310.19166699995,
      "inputTokens": 3280,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, our CRISPR knockout of the faulty CFTR gene in these airway epithelial cells looks promising on gel electrophoresis—clean cut at the deltaF508 site. But only 30% of cells show the knockout phenotype by functional assay. What's going on?\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. We need to confirm the edit happened before chasing other issues. Sequencing verifies indels from NHEJ.\",\n          \"isCorrect\": false,\n          \"text\": \"Check off-target sites first\"\n        },\n        {\n          \"feedback\": \"Wrong. Functional assay is downstream; the cut might not be precise or complete.\",\n          \"isCorrect\": false,\n          \"text\": \"Run the functional chloride channel assay again\"\n        },\n        {\n          \"feedback\": \"Correct! Sequencing the target locus confirms if the cut led to disruptive indels via NHEJ repair. This verifies editing before deeper analysis.\",\n          \"isCorrect\": true,\n          \"text\": \"Sequence the target DNA locus\"\n        },\n        {\n          \"feedback\": \"Wrong. Efficiency first—delivery might be fine, but repair incomplete.\",\n          \"isCorrect\": false,\n          \"text\": \"Measure transfection efficiency\"\n        }\n      ],\n      \"question\": \"What do we do next?\"\n    },\n    {\n      \"context\": \"Good call. Sequencing shows mostly small indels at the target—classic NHEJ knockouts. But efficiency's still low at 30%. The guide RNA matched perfectly in silico, Cas9 expression is high. Hmm.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Guide RNA is spot-on; issue elsewhere.\",\n          \"isCorrect\": false,\n          \"text\": \"Redesign the guide RNA\"\n        },\n        {\n          \"feedback\": \"Correct! Off-target analysis is crucial early—low on-target might mean Cas9 distracted elsewhere, reducing efficiency.\",\n          \"isCorrect\": true,\n          \"text\": \"Predict and check off-target sites\"\n        },\n        {\n          \"feedback\": \"Wrong. Cas9 worked; it's the repair outcome.\",\n          \"isCorrect\": false,\n          \"text\": \"Switch to HDR pathway\"\n        },\n        {\n          \"feedback\": \"Wrong. Delivery seems uniform by FACS.\",\n          \"isCorrect\": false,\n          \"text\": \"Optimize delivery method\"\n        }\n      ],\n      \"question\": \"Why low efficiency?\"\n    },\n    {\n      \"context\": \"You're right, {{NAME}}. In silico off-target prediction flagged three potential sites with 1-3 mismatches. We surveyed those by sequencing—two have minor cuts, 5-10%. That's diluting our Cas9 pool.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Minor cuts need addressing for safety.\",\n          \"isCorrect\": false,\n          \"text\": \"Ignore them, proceed\"\n        },\n        {\n          \"feedback\": \"Correct! Specificity is key for therapy—redesign gRNA to minimize mismatches while keeping on-target strength.\",\n          \"isCorrect\": true,\n          \"text\": \"Redesign guide RNA for higher specificity\"\n        },\n        {\n          \"feedback\": \"Wrong. Better Cas9 later; fix gRNA first.\",\n          \"isCorrect\": false,\n          \"text\": \"Switch to high-fidelity Cas9\"\n        },\n        {\n          \"feedback\": \"Wrong. Lower dose risks even less on-target.\",\n          \"isCorrect\": false,\n          \"text\": \"Reduce Cas9 concentration\"\n        }\n      ],\n      \"question\": \"How to improve?\"\n    },\n    {\n      \"context\": \"Smart move. New gRNA v2 has perfect on-target score, off-targets near zero. Retested in cells: boom, 65% knockout efficiency, no off-target cuts detected. Cells now pump chloride like wild-type.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Ex vivo editing is stable here; test in vivo next.\",\n          \"isCorrect\": false,\n          \"text\": \"Check long-term stability\"\n        },\n        {\n          \"feedback\": \"Correct! For therapy, validate no sneaky off-targets missed by prediction—use whole-genome sequencing or targeted deep seq.\",\n          \"isCorrect\": true,\n          \"text\": \"Experimentally validate off-targets broadly\"\n        },\n        {\n          \"feedback\": \"Wrong. Delivery next step.\",\n          \"isCorrect\": false,\n          \"text\": \"Test viral delivery\"\n        },\n        {\n          \"feedback\": \"Wrong. Repair is NHEJ knockout—confirmed.\",\n          \"isCorrect\": false,\n          \"text\": \"Confirm HDR insertion\"\n        }\n      ],\n      \"question\": \"Safety check?\"\n    },\n    {\n      \"context\": \"Spot on, {{NAME}}. Deep sequencing across top 100 predicted sites: clean. No off-targets above noise. We're ready for the next hurdle—patient-derived iPSCs differentiated to airway cells. Same protocol: 60% efficiency. Great.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. NHEJ knockouts suffice for this loss-of-function strategy.\",\n          \"isCorrect\": false,\n          \"text\": \"Attempt precise HDR correction\"\n        },\n        {\n          \"feedback\": \"Correct! For clinical translation, especially autologous therapy, efficient delivery into hard-to-transfect primary cells is key.\",\n          \"isCorrect\": true,\n          \"text\": \"Optimize delivery for stem/progenitor cells\"\n        },\n        {\n          \"feedback\": \"Wrong. gRNA already optimized.\",\n          \"isCorrect\": false,\n          \"text\": \"Tweak guide RNA again\"\n        },\n        {\n          \"feedback\": \"Wrong. Off-targets clear.\",\n          \"isCorrect\": false,\n          \"text\": \"Re-check off-targets\"\n        }\n      ],\n      \"question\": \"Scale up issue?\"\n    },\n    {\n      \"context\": \"Exactly. Electroporation works okay in iPSCs but trashes cell viability—only 40% survive editing. We need gentler delivery for these precious patient cells before transplant.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Viral integrates, risks insertional mutagenesis.\",\n          \"isCorrect\": false,\n          \"text\": \"Use lentiviral vector\"\n        },\n        {\n          \"feedback\": \"Wrong. Too toxic for primaries.\",\n          \"isCorrect\": false,\n          \"text\": \"Stick with electroporation\"\n        },\n        {\n          \"feedback\": \"Correct! Lipid nanoparticles excel for CRISPR RNP delivery—transient, non-integrating, high efficiency in hard cells.\",\n          \"isCorrect\": true,\n          \"text\": \"Try lipid nanoparticle delivery\"\n        },\n        {\n          \"feedback\": \"Wrong. AAV limited capacity for Cas9.\",\n          \"isCorrect\": false,\n          \"text\": \"Use AAV vector\"\n        }\n      ],\n      \"question\": \"Best delivery method?\"\n    },\n    {\n      \"context\": \"Nice! LNPs got us to 75% knockout in iPSC-airways, minimal toxicity. Functional rescue confirmed. Now the mouse model—inhaled LNP-CRISPR to lung epithelium for in vivo proof.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correct! In vivo, immune response to Cas9/gRNA can clear edited cells fast—monitor inflammation markers.\",\n          \"isCorrect\": true,\n          \"text\": \"Assess immune response post-delivery\"\n        },\n        {\n          \"feedback\": \"Wrong. Efficiency first.\",\n          \"isCorrect\": false,\n          \"text\": \"Check editing efficiency\"\n        },\n        {\n          \"feedback\": \"Wrong. Off-targets later.\",\n          \"isCorrect\": false,\n          \"text\": \"Scan for off-targets\"\n        },\n        {\n          \"feedback\": \"Wrong. Dose is set.\",\n          \"isCorrect\": false,\n          \"text\": \"Adjust dosing\"\n        }\n      ],\n      \"question\": \"What to watch in vivo?\"\n    },\n    {\n      \"context\": \"You're ahead of us, {{NAME}}. Bronchoalveolar lavage shows elevated neutrophils 48h post-dose—classic Cas9 immunogenicity. Editing efficiency only 15% in recovered epithelium. Immunity tanking it.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Cas9 dosing low already.\",\n          \"isCorrect\": false,\n          \"text\": \"Lower Cas9 dose\"\n        },\n        {\n          \"feedback\": \"Correct! Transient RNP delivery minimizes persistence, reducing immune exposure vs plasmid-expressed Cas9.\",\n          \"isCorrect\": true,\n          \"text\": \"Switch to pre-formed Cas9-gRNA RNP\"\n        },\n        {\n          \"feedback\": \"Wrong. LNPs are non-viral.\",\n          \"isCorrect\": false,\n          \"text\": \"Use viral capsid to shield\"\n        },\n        {\n          \"feedback\": \"Wrong. Immunosuppressants complicate therapy.\",\n          \"isCorrect\": false,\n          \"text\": \"Add immunosuppressants\"\n        }\n      ],\n      \"question\": \"Fix immune issue?\"\n    },\n    {\n      \"context\": \"Brilliant. RNP-LNPs in mice: immune response halved, editing jumps to 35%. Editing confirmed, function improved. But histology shows some fibrosis near edited sites. Weird.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Immune better.\",\n          \"isCorrect\": false,\n          \"text\": \"Re-check immune markers\"\n        },\n        {\n          \"feedback\": \"Wrong. Efficiency up.\",\n          \"isCorrect\": false,\n          \"text\": \"Boost delivery efficiency\"\n        },\n        {\n          \"feedback\": \"Correct! Even low off-targets can accumulate in vivo—re-validate with animal-specific genome.\",\n          \"isCorrect\": true,\n          \"text\": \"Validate off-targets in mouse genome\"\n        },\n        {\n          \"feedback\": \"Wrong. Repair standard.\",\n          \"isCorrect\": false,\n          \"text\": \"Check repair pathway errors\"\n        }\n      ],\n      \"question\": \"Source of fibrosis?\"\n    },\n    {\n      \"context\": \"{{NAME}}, plot twist—the mouse off-target scan hit paydirt. Our gRNA has a perfect match to a fibrosis-related gene in mice (not humans). Minor cuts there triggered scarring. Human gRNA was too generic!\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Too late.\",\n          \"isCorrect\": false,\n          \"text\": \"Use old gRNA\"\n        },\n        {\n          \"feedback\": \"Correct! Species-specific gRNA redesign ensures no cross-hits, balancing specificity and efficiency responsibly.\",\n          \"isCorrect\": true,\n          \"text\": \"Design mouse-specific guide RNA\"\n        },\n        {\n          \"feedback\": \"Wrong. Already optimized.\",\n          \"isCorrect\": false,\n          \"text\": \"Tweak delivery\"\n        },\n        {\n          \"feedback\": \"Wrong. Cas9 fine.\",\n          \"isCorrect\": false,\n          \"text\": \"Change Cas9 variant\"\n        }\n      ],\n      \"question\": \"How to resolve?\"\n    },\n    {\n      \"context\": \"Perfect, {{NAME}}. Mouse-optimized gRNA v3: zero off-targets, 50% in vivo editing, clean lungs, full functional rescue. No fibrosis. This underscores it—effective CRISPR demands precise gRNA design, off-target vigilance, smart delivery, and responsible validation at every step. Therapy greenlit!\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. That's advanced.\",\n          \"isCorrect\": false,\n          \"text\": \"Try base editing\"\n        },\n        {\n          \"feedback\": \"Wrong. NHEJ perfect here.\",\n          \"isCorrect\": false,\n          \"text\": \"Switch to HDR\"\n        },\n        {\n          \"feedback\": \"Wrong. In vivo success.\",\n          \"isCorrect\": false,\n          \"text\": \"Optimize further\"\n        },\n        {\n          \"feedback\": \"Correct! Celebrate and document—key lesson: apply CRISPR responsibly by iterating on specificity, repair paths, delivery, and context-specific checks.\",\n          \"isCorrect\": true,\n          \"text\": \"Document and proceed to IND\"\n        }\n      ],\n      \"question\": \"Final step?\"\n    }\n  ]\n}",
      "outputTokens": 3252,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "en-biology-crispr-applications-1",
      "userPrompt": "LESSON_TITLE: CRISPR Gene Editing in Practice\nLESSON_DESCRIPTION: Understanding how to apply CRISPR gene editing technology effectively and responsibly\nCHAPTER_TITLE: Genetic Engineering\nCOURSE_TITLE: Modern Biotechnology\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. The Molecular Scissors: CRISPR-Cas9 is a molecular scissors that cuts DNA at specific locations. The Cas9 protein does the cutting; a guide RNA tells it exactly where to cut.\n2. Guide RNA Targeting: Guide RNA is a short sequence that matches the target DNA. It base-pairs with the DNA sequence you want to edit, bringing Cas9 to the exact spot.\n3. Cellular Repair Pathways: After CRISPR cuts, the cell's repair machinery fixes the break. Non-homologous end joining often introduces errors (knockouts). Homology-directed repair can insert new sequences (knock-ins).\n4. Off-Target Effects: Off-target effects occur when CRISPR cuts unintended locations. Guide RNA design and delivery methods affect specificity. This is a major safety concern for therapeutic applications.\n5. Delivery Challenges: Delivery is a key challenge. Getting CRISPR components into the right cells in a living organism is harder than in a lab dish. Viral vectors and lipid nanoparticles are common approaches."
    },
    {
      "duration": 36244.693457999965,
      "inputTokens": 3310,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, olha esse feedback do módulo novo de Psicologia da Aprendizagem. Os alunos estão abandonando em massa na primeira tela. Dizem que é 'confuso demais'. O que você acha que tá acontecendo?\",\n      \"options\": [\n        {\n          \"feedback\": \"Errado. Não é só o conteúdo difícil; precisamos analisar a carga cognitiva total.\",\n          \"isCorrect\": false,\n          \"text\": \"O conteúdo é intrinsecamente complexo.\"\n        },\n        {\n          \"feedback\": \"Errado. Sem dados, é chute. Precisamos observar o material e feedback para identificar cargas.\",\n          \"isCorrect\": false,\n          \"text\": \"Culpa dos alunos, eles não estudam.\"\n        },\n        {\n          \"feedback\": \"Correto! Identificamos sinais de sobrecarga cognitiva, como abandono alto e reclamações de confusão. Isso indica memória de trabalho saturada.\",\n          \"isCorrect\": true,\n          \"text\": \"Sobrecarga cognitiva na memória de trabalho.\"\n        },\n        {\n          \"feedback\": \"Errado. Não é só visual; envolve processamento total. Vamos mergulhar nas cargas.\",\n          \"isCorrect\": false,\n          \"text\": \"Só problema de design visual.\"\n        }\n      ],\n      \"question\": \"Qual o primeiro passo para diagnosticar?\"\n    },\n    {\n      \"context\": \"Exato, {{NAME}}. A memória de trabalho só aguenta uns 4 itens de cada vez. Se passar disso, trava tudo. Vamos abrir o slide inicial e ver.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Carga intrínseca é da complexidade do tema; não muda, mas gerencia com sequência.\",\n          \"isCorrect\": true,\n          \"text\": \"É a carga intrínseca alta do tema.\"\n        },\n        {\n          \"feedback\": \"Errado. Carga intrínseca não explica abandono imediato; olhe elementos extras.\",\n          \"isCorrect\": false,\n          \"text\": \"Só a dificuldade natural do assunto.\"\n        },\n        {\n          \"feedback\": \"Parcial, mas errado. Tem texto denso + imagens sem relação; isso é extrínseca.\",\n          \"isCorrect\": false,\n          \"text\": \"Muito texto denso demais.\"\n        },\n        {\n          \"feedback\": \"Errado. Não é falta de motivação; é design sobrecarregando processamento.\",\n          \"isCorrect\": false,\n          \"text\": \"Alunos desmotivados.\"\n        }\n      ],\n      \"question\": \"Por que esse slide sobrecarrega?\"\n    },\n    {\n      \"context\": \"Bom olho, {{NAME}}. Esse slide tem definição de memória de trabalho, diagrama cerebral, estatística de Miller E mais 3 bullet points de exemplos. Tudo junto.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Carga extrínseca vem de design ruim: clutter visual, texto desnecessário.\",\n          \"isCorrect\": true,\n          \"text\": \"Carga extrínseca por elementos desnecessários.\"\n        },\n        {\n          \"feedback\": \"Errado. Intrínseca é inerente; aqui é evitável por mau design.\",\n          \"isCorrect\": false,\n          \"text\": \"Carga intrínseca inevitável.\"\n        },\n        {\n          \"feedback\": \"Errado. Germânica é boa; queremos mais dela, não menos.\",\n          \"isCorrect\": false,\n          \"text\": \"Baixa carga germânica.\"\n        },\n        {\n          \"feedback\": \"Correto, mas não o foco inicial. Primeiro, corte extrínseca para liberar espaço.\",\n          \"isCorrect\": false,\n          \"text\": \"Precisa mais chunking.\"\n        }\n      ],\n      \"question\": \"Qual carga principal identificar aqui?\"\n    },\n    {\n      \"context\": \"Perfeito, {{NAME}}. Olha: diagrama bonito mas texto explicando o mesmo por cima — distração dividida. Instruções no rodapé confusas. Vamos limpar isso.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Eliminar redundâncias e clutter reduz extrínseca, liberando memória para aprendizado.\",\n          \"isCorrect\": true,\n          \"text\": \"Remover texto redundante e clutter.\"\n        },\n        {\n          \"feedback\": \"Errado. Isso aumenta intrínseca se não sequenciar direito.\",\n          \"isCorrect\": false,\n          \"text\": \"Simplificar o diagrama.\"\n        },\n        {\n          \"feedback\": \"Errado. Foco primeiro em extrínseca; germânica vem depois.\",\n          \"isCorrect\": false,\n          \"text\": \"Adicionar exercícios interativos.\"\n        },\n        {\n          \"feedback\": \"Errado. Chunking ajuda, mas sem limpar extrínseca, não adianta.\",\n          \"isCorrect\": false,\n          \"text\": \"Agrupar tudo em chunks.\"\n        }\n      ],\n      \"question\": \"Como reduzir a carga extrínseca?\"\n    },\n    {\n      \"context\": \"Ótima sugestão, {{NAME}}. Tirei o texto sobreposto, limpei rodapé, ficou mais limpo. Agora, queremos maximizar a carga germânica — o esforço bom de conectar ideias.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Germânica é produtiva: esquemas, elaborações. Intrínseca gerencia com pré-requisitos.\",\n          \"isCorrect\": true,\n          \"text\": \"Aumentar carga germânica com conexões.\"\n        },\n        {\n          \"feedback\": \"Errado. Já limpamos extrínseca; agora foque germânica.\",\n          \"isCorrect\": false,\n          \"text\": \"Reduzir mais a intrínseca.\"\n        },\n        {\n          \"feedback\": \"Errado. Chunking ajuda germânica, mas especifique como.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar chunking imediatamente.\"\n        },\n        {\n          \"feedback\": \"Errado. Isso é distrator; queremos germânica alta.\",\n          \"isCorrect\": false,\n          \"text\": \"Minimizar todo esforço mental.\"\n        }\n      ],\n      \"question\": \"Próximo: como tornar produtivo?\"\n    },\n    {\n      \"context\": \"Exato, {{NAME}}. Adicionei uma pergunta guiada: 'Como isso afeta seu design?'. Isso faz eles elaborarem. Agora, sobre chunking pra não sobrecarregar a memória.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Chunking agrupa em unidades significativas, respeitando limite de 4 itens na memória.\",\n          \"isCorrect\": true,\n          \"text\": \"Agrupar info em blocos lógicos.\"\n        },\n        {\n          \"feedback\": \"Errado. Chunking reduz elementos processados, combatendo limite da memória.\",\n          \"isCorrect\": false,\n          \"text\": \"Listar todos itens separadamente.\"\n        },\n        {\n          \"feedback\": \"Errado. Chunks devem ser significativos, não só visuais.\",\n          \"isCorrect\": false,\n          \"text\": \"Fazer chunks visuais só.\"\n        },\n        {\n          \"feedback\": \"Errado. Chunking é pra gerenciar intrínseca também.\",\n          \"isCorrect\": false,\n          \"text\": \"Ignorar limites da memória.\"\n        }\n      ],\n      \"question\": \"Como aplicar chunking aqui?\"\n    },\n    {\n      \"context\": \"Boa, {{NAME}}. Transformei os 7 bullets em 3 chunks: 'Limites (4 itens)', 'Exemplos cotidianos', 'Implicações pro design'. Testei com um aluno beta — ele gostou mais.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Sequência gerencia intrínseca: básico primeiro, complexo depois.\",\n          \"isCorrect\": true,\n          \"text\": \"Sequenciar do simples pro complexo.\"\n        },\n        {\n          \"feedback\": \"Errado. Sequência essencial pra intrínseca alta.\",\n          \"isCorrect\": false,\n          \"text\": \"Misturar tudo de uma vez.\"\n        },\n        {\n          \"feedback\": \"Errado. Chunking + sequência juntos.\",\n          \"isCorrect\": false,\n          \"text\": \"Só confiar no chunking.\"\n        },\n        {\n          \"feedback\": \"Errado. Teste mostrou melhora, mas precisa finalizar.\",\n          \"isCorrect\": false,\n          \"text\": \"Parar por aqui.\"\n        }\n      ],\n      \"question\": \"E a carga intrínseca ainda alta?\"\n    },\n    {\n      \"context\": \"Perfeito, {{NAME}}. Slide 1: só limites memória. Slide 2: cargas. Slide 3: exemplos. Ficou fluido. Mas o beta voltou: 'Agora tá bom, mas no módulo todo ainda confuso'.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Revelação: chunking ruim nos exemplos criou nova extrínseca.\",\n          \"isCorrect\": true,\n          \"text\": \"Chunks nos exemplos não são significativos.\"\n        },\n        {\n          \"feedback\": \"Errado. Twist é que chunking malfeito adicionou carga ruim.\",\n          \"isCorrect\": false,\n          \"text\": \"Precisa mais germânica.\"\n        },\n        {\n          \"feedback\": \"Errado. Não é motivação; é design.\",\n          \"isCorrect\": false,\n          \"text\": \"Alunos preguiçosos.\"\n        },\n        {\n          \"feedback\": \"Errado. Sequência ok; problema nos chunks.\",\n          \"isCorrect\": false,\n          \"text\": \"Sequência errada.\"\n        }\n      ],\n      \"question\": \"Por que ainda confuso? (Twist!)\"\n    },\n    {\n      \"context\": \"Você acertou em cheio, {{NAME}}. Nos exemplos, agrupei 'telefone, placa carro, lista compras' mas sem conexão clara — virou 3 itens soltos de novo. Refaça chunks com tema 'números cotidianos'.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Chunks verdadeiramente significativos respeitam memória e promovem germânica.\",\n          \"isCorrect\": true,\n          \"text\": \"Criar chunks temáticos conectados.\"\n        },\n        {\n          \"feedback\": \"Errado. Chunks precisam de sentido inerente.\",\n          \"isCorrect\": false,\n          \"text\": \"Só numerar os chunks.\"\n        },\n        {\n          \"feedback\": \"Errado. Foco em chunking melhor.\",\n          \"isCorrect\": false,\n          \"text\": \"Adicionar mais imagens.\"\n        },\n        {\n          \"feedback\": \"Errado. Isso aumenta extrínseca.\",\n          \"isCorrect\": false,\n          \"text\": \"Expandir cada exemplo.\"\n        }\n      ],\n      \"question\": \"Como consertar os chunks ruins?\"\n    },\n    {\n      \"context\": \"Genial, {{NAME}}. Chunk 'Números do dia a dia: telefone (99-8765-4321), placa (ABC-1234), lista (leite, pão, ovos)'. Um bloco só! Teste final: aluno navegou todo módulo sorrindo.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Reduziu extrínseca, gerenciou intrínseca, maximizou germânica via chunking.\",\n          \"isCorrect\": true,\n          \"text\": \"Combinação perfeita das cargas.\"\n        },\n        {\n          \"feedback\": \"Errado. Tudo integrado.\",\n          \"isCorrect\": false,\n          \"text\": \"Só chunking salvou.\"\n        },\n        {\n          \"feedback\": \"Errado. Não só visual.\",\n          \"isCorrect\": false,\n          \"text\": \"Design gráfico melhor.\"\n        },\n        {\n          \"feedback\": \"Errado. Teste confirma sucesso total.\",\n          \"isCorrect\": false,\n          \"text\": \"Ainda precisa ajustes.\"\n        }\n      ],\n      \"question\": \"O que resolveu o problema?\"\n    },\n    {\n      \"context\": \"Incrível, {{NAME}}. Taxa de abandono caiu 70% no teste A/B. Lembre: sempre minimize extrínseca, gerencie intrínseca, maximize germânica com chunking bom. Salvamos o curso!\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Reforça: aplique teoria pra materiais eficazes, respeitando memória de trabalho.\",\n          \"isCorrect\": true,\n          \"text\": \"Aplicamos carga cognitiva na prática.\"\n        },\n        {\n          \"feedback\": \"Errado. Mas foi essencial.\",\n          \"isCorrect\": false,\n          \"text\": \"Só o teste A/B.\"\n        },\n        {\n          \"feedback\": \"Errado. Conceitos chave foram decisivos.\",\n          \"isCorrect\": false,\n          \"text\": \"Sorte nossa.\"\n        },\n        {\n          \"feedback\": \"Errado. Chunking foi parte, não tudo.\",\n          \"isCorrect\": false,\n          \"text\": \"Só chunking mágico.\"\n        }\n      ],\n      \"question\": \"Qual a grande lição?\"\n    }\n  ]\n}",
      "outputTokens": 2872,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "pt-psychology-cognitive-load-1",
      "userPrompt": "LESSON_TITLE: Carga Cognitiva na Pratica\nLESSON_DESCRIPTION: Aplicando a teoria da carga cognitiva para criar materiais de aprendizagem mais eficazes\nCHAPTER_TITLE: Psicologia da Aprendizagem\nCOURSE_TITLE: Design Instrucional\nLANGUAGE: pt\nEXPLANATION_STEPS:\n1. Limites da Memoria: A memoria de trabalho tem capacidade limitada — cerca de 4 itens simultaneamente. Quando sobrecarregada, a aprendizagem para. O cerebro nao consegue processar mais.\n2. Carga Intrinseca: Carga intrinseca vem da complexidade inerente do conteudo. Algumas coisas sao simplesmente dificeis. Nao da para eliminar, mas da para gerenciar.\n3. Carga Extrinseca: Carga extrinseca vem do design ruim — instrucoes confusas, distracao visual, navegacao complicada. Essa carga pode e deve ser eliminada.\n4. Carga Germanica: Carga germanica e o esforco produtivo de aprender — criar conexoes, elaborar, integrar. Queremos maximizar essa carga enquanto minimizamos a extrinseca.\n5. Chunking: Chunking agrupa informacoes em unidades significativas. Um numero de telefone e mais facil de lembrar como blocos (99-8765-4321) do que como 10 digitos soltos."
    },
    {
      "duration": 79402.70075000008,
      "inputTokens": 3308,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, ¡problema en la planta! El sistema de refrigeración industrial no baja la temperatura de la cámara a 10°C, está en 20°C. Compresor usa 200 kW, extrae solo 100 kW de frío (Q_c). COP=0.5. ¿Qué verificamos primero?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto. La primera ley dice que la energía se conserva: Q_c + W debe igualar Q_h rechazado. Confirmamos los números antes de teorías avanzadas.\",\n          \"isCorrect\": true,\n          \"text\": \"Verificar balance de la 1ª ley de termodinámica\"\n        },\n        {\n          \"feedback\": \"No aún. Primero confirma que la energía se conserve con la 1ª ley. Carnot viene después, cuando sepamos que los datos son confiables.\",\n          \"isCorrect\": false,\n          \"text\": \"Calcular el COP de Carnot inmediatamente\"\n        },\n        {\n          \"feedback\": \"La entropía es útil para irreversibilidades, pero primero basics: ¿se conserva la energía?\",\n          \"isCorrect\": false,\n          \"text\": \"Calcular el aumento de entropía\"\n        },\n        {\n          \"feedback\": \"El flujo lo chequearemos después. Inicia con la conservación de energía para validar mediciones.\",\n          \"isCorrect\": false,\n          \"text\": \"Inspeccionar el diagrama de tuberías\"\n        }\n      ],\n      \"question\": \"¿Qué verificamos primero?\"\n    },\n    {\n      \"context\": \"Excelente, {{NAME}}. Q_h al ambiente es 300 kW exacto: 100 + 200 = 300. Primera ley cumplida, energía se transforma pero no se pierde. Ahora el COP bajo indica ineficiencia. Sigamos con la segunda ley.\",\n      \"options\": [\n        {\n          \"feedback\": \"Sí. La segunda ley dicta que el calor fluye espontáneamente caliente a frío. En refrigerador, el trabajo permite mover calor al revés, pero confirmamos direcciones.\",\n          \"isCorrect\": true,\n          \"text\": \"Confirmar dirección del flujo de calor\"\n        },\n        {\n          \"feedback\": \"Bueno, pero primero asegúrate que las direcciones sean correctas según 2ª ley. Luego Carnot.\",\n          \"isCorrect\": false,\n          \"text\": \"Calcular COP máximo de Carnot\"\n        },\n        {\n          \"feedback\": \"La entropía mide dispersión, pero paso a paso: dirección primero.\",\n          \"isCorrect\": false,\n          \"text\": \"Evaluar generación de entropía\"\n        },\n        {\n          \"feedback\": \"Las temperaturas son clave para Carnot, pero verifica flujos primero.\",\n          \"isCorrect\": false,\n          \"text\": \"Medir temperaturas en evaporador y condensador\"\n        }\n      ],\n      \"question\": \"¿Próximo paso lógico?\"\n    },\n    {\n      \"context\": \"Bien visto, {{NAME}}. Calor sale del condensador (57°C) al ambiente (30°C), ok. En evaporador, refrigerante absorbe de cámara (20°C) porque está más frío (~5°C). Direcciones forzadas por trabajo, no viola 2ª ley. Ahora midamos temps precisas.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto. Con T_c ≈ 278 K (5°C evaporador), T_h = 330 K (57°C), COP_Carnot = 278 / (330-278) ≈ 11.9. Actual 0.5 << máximo, irreversibilidades altas.\",\n          \"isCorrect\": true,\n          \"text\": \"Calcular el COP límite de Carnot\"\n        },\n        {\n          \"feedback\": \"Ya confirmamos dirección. Ahora usa temps para límite teórico.\",\n          \"isCorrect\": false,\n          \"text\": \"Revisar dirección del calor otra vez\"\n        },\n        {\n          \"feedback\": \"Entropía después. Primero compara eficiencia real vs. máxima posible.\",\n          \"isCorrect\": false,\n          \"text\": \"Medir cambio de entropía del sistema\"\n        },\n        {\n          \"feedback\": \"Ya las tenemos aproximadas. Calcula Carnot para ver el gap.\",\n          \"isCorrect\": false,\n          \"text\": \"Medir todas las temperaturas de nuevo\"\n        }\n      ],\n      \"question\": \"¿Qué calculamos ahora?\"\n    },\n    {\n      \"context\": \"¡Exacto, {{NAME}}! COP_Carnot ≈12, pero real 0.5. Mucha pérdida por irreversibilidades: fricción, transferencias finitas, etc. La 2ª ley limita, pero ¿por qué tan bajo aquí? Veamos entropía.\",\n      \"options\": [\n        {\n          \"feedback\": \"Sí. ΔS_univ = ΔS_sist + ΔS_amb >0. Alto aumento indica irreversibilidades grandes, explica bajo COP.\",\n          \"isCorrect\": true,\n          \"text\": \"Analizar el aumento de entropía\"\n        },\n        {\n          \"feedback\": \"Ya lo hicimos. Ahora cuantifica las pérdidas con entropía.\",\n          \"isCorrect\": false,\n          \"text\": \"Recalcular COP_Carnot\"\n        },\n        {\n          \"feedback\": \"Dirección ok, enfócate en cuantificar dispersión energía.\",\n          \"isCorrect\": false,\n          \"text\": \"Verificar flujo de calor de nuevo\"\n        },\n        {\n          \"feedback\": \"Temps correctas, úsalas para entropía.\",\n          \"isCorrect\": false,\n          \"text\": \"Medir temperaturas con más precisión\"\n        }\n      ],\n      \"question\": \"¿Cómo cuantificamos ineficiencias?\"\n    },\n    {\n      \"context\": \"Buen punto, {{NAME}}. Calculé: ΔS_cámara = -Q_c/T_c ≈ -100/293 ≈ -0.34 kW/K. ΔS_amb = +300/303 ≈ +0.99 kW/K. ΔS_total ≈ +0.65 kW/K >0, pero alto para este tamaño. Mucha generación interna. ¿Qué sospechamos?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto. Procesos irreversibles como compresión no adiabática, expansión throttling (ΔP sin trabajo), ΔT en intercambiadores generan entropía extra.\",\n          \"isCorrect\": true,\n          \"text\": \"Irreversibilidades en componentes\"\n        },\n        {\n          \"feedback\": \"La 1ª ya ok. Busca causas de entropía alta.\",\n          \"isCorrect\": false,\n          \"text\": \"Revisar balance energético otra vez\"\n        },\n        {\n          \"feedback\": \"Dirección ok, pero throttling genera entropía.\",\n          \"isCorrect\": false,\n          \"text\": \"Confirmar flujo espontáneo\"\n        },\n        {\n          \"feedback\": \"Gap grande por irrevers, no solo Carnot.\",\n          \"isCorrect\": false,\n          \"text\": \"Comparar con Carnot de nuevo\"\n        }\n      ],\n      \"question\": \"¿Qué causa la alta entropía?\"\n    },\n    {\n      \"context\": \"Sí, {{NAME}}. Compresor ineficiente (calor fricción), válvula expansión genera entropía (throttling isentálpico no, irreversible). Para mejorar COP, minimizar eso. Pero sigamos datos: cámara no enfría más. Chequeemos operación.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto. Verificar si ciclo opera como refrigerador o al revés explicaría bajo COP y pobre enfriamiento.\",\n          \"isCorrect\": true,\n          \"text\": \"Inspeccionar configuración del ciclo\"\n        },\n        {\n          \"feedback\": \"Temps ya usadas. Mira la operación real.\",\n          \"isCorrect\": false,\n          \"text\": \"Remedir T_evap y T_cond\"\n        },\n        {\n          \"feedback\": \"Entropía alta sí, pero ¿por qué específicamente aquí?\",\n          \"isCorrect\": false,\n          \"text\": \"Calcular más ΔS\"\n        },\n        {\n          \"feedback\": \"Irrev ok, pero chequea si aplica correctamente.\",\n          \"isCorrect\": false,\n          \"text\": \"Analizar irreversibilidades más\"\n        }\n      ],\n      \"question\": \"¿Qué revisamos en sitio?\"\n    },\n    {\n      \"context\": \"{{NAME}}, en el cuarto de máquinas: compresor ok, pero... las líneas de refrigerante al evaporador y condensador parecen... ¿invertidas? No, el esquema dice evap en cámara fría, cond en ambiente. Pero midamos flujo real.\",\n      \"options\": [\n        {\n          \"feedback\": \"¡Twist! El flujo está invertido por válvulas mal programadas. 'Evaporador' rechaza calor a cámara (calentándola), 'condensador' absorbe de ambiente. Actúa como bomba de calor al revés. Viola eficiencia esperada.\",\n          \"isCorrect\": true,\n          \"text\": \"¡El ciclo está corriendo invertido! Corregir flujo.\"\n        },\n        {\n          \"feedback\": \"No, flujo correcto causa pobre perf? No, datos no cuadran.\",\n          \"isCorrect\": false,\n          \"text\": \"Todo parece normal, ajustar compresor\"\n        },\n        {\n          \"feedback\": \"Ya chequeado. El problema es configuración.\",\n          \"isCorrect\": false,\n          \"text\": \"Limpiar intercambiadores de calor\"\n        },\n        {\n          \"feedback\": \"Temps indican anomalía en operación.\",\n          \"isCorrect\": false,\n          \"text\": \"Ajustar temperaturas setpoint\"\n        }\n      ],\n      \"question\": \"¡Mira esto! ¿Qué ves? ¿Qué hacemos?\"\n    },\n    {\n      \"context\": \"¡Increíble, {{NAME}}! Sí, válvulas de control invertidas accidentalmente durante mantenimiento. El ciclo corría como bomba de calor calentando la cámara. Invertimos flujo: ahora evap absorbe correctamente de cámara, cond rechaza a ambiente.\",\n      \"options\": [\n        {\n          \"feedback\": \"Sí. Ahora COP sube a 3.5, cerca de Carnot ajustado. Lección: siempre valida operación con leyes termodinámicas - 1ª conserva energía, 2ª da dirección y límites.\",\n          \"isCorrect\": true,\n          \"text\": \"Monitorear nuevo COP y confirmar mejora\"\n        },\n        {\n          \"feedback\": \"Ya corregido. Verifica rendimiento.\",\n          \"isCorrect\": false,\n          \"text\": \"Recalcular balance 1ª ley\"\n        },\n        {\n          \"feedback\": \"Dirección ahora correcta.\",\n          \"isCorrect\": false,\n          \"text\": \"Confirmar flujo de calor\"\n        },\n        {\n          \"feedback\": \"Mejora grande.\",\n          \"isCorrect\": false,\n          \"text\": \"Recalcular Carnot con nuevas temps\"\n        }\n      ],\n      \"question\": \"¿Último paso para cerrar?\"\n    },\n    {\n      \"context\": \"¡Perfecto, {{NAME}}! COP ahora 3.5 con T_c=283K, T_h=323K (COP_Carnot~7). Entropía generada bajó a 0.2 kW/K. Cámara a 10°C, máquinas salvadas. Gran trabajo aplicando termodinámica.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto. Resumen: usa 1ª ley para validar datos, 2ª para dirección/límites, Carnot para benchmark, entropía para diagnosticar. Así diseñas/fixas sistemas energéticos reales.\",\n          \"isCorrect\": true,\n          \"text\": \"¡Listo! Lección aprendida.\"\n        },\n        {\n          \"feedback\": \"Ya ok.\",\n          \"isCorrect\": false,\n          \"text\": \"Verificar 1ª ley final\"\n        },\n        {\n          \"feedback\": \"Todo alineado.\",\n          \"isCorrect\": false,\n          \"text\": \"Chequear 2ª ley otra vez\"\n        },\n        {\n          \"feedback\": \"Cerca ahora.\",\n          \"isCorrect\": false,\n          \"text\": \"Comparar Carnot final\"\n        }\n      ],\n      \"question\": \"¿Resumen del caso?\"\n    }\n  ]\n}",
      "outputTokens": 6195,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "es-physics-thermodynamics-applications-1",
      "userPrompt": "LESSON_TITLE: Termodinamica Aplicada\nLESSON_DESCRIPTION: Aplicando las leyes de la termodinamica para entender y disenar sistemas energeticos\nCHAPTER_TITLE: Termodinamica\nCOURSE_TITLE: Fisica para Ingenieros\nLANGUAGE: es\nEXPLANATION_STEPS:\n1. Conservacion de Energia: La primera ley dice que la energia se conserva — no se crea ni destruye, solo se transforma. El calor que entra menos el trabajo que sale iguala el cambio de energia interna.\n2. Direccion del Calor: La segunda ley establece una direccion: el calor fluye espontaneamente de caliente a frio, nunca al reves. Esto limita la eficiencia de cualquier motor termico.\n3. Entropia: La entropia mide la dispersion de energia. Cuando la energia se dispersa (calor fluyendo a lo frio), la entropia aumenta. Concentrar energia requiere trabajo externo.\n4. Limite de Carnot: El ciclo de Carnot define la eficiencia maxima teorica. Ningun motor real puede ser mas eficiente. La eficiencia depende de las temperaturas de las fuentes caliente y fria.\n5. Refrigeracion: Los refrigeradores y bombas de calor mueven calor de frio a caliente usando trabajo. No violan la segunda ley — el trabajo compensa el flujo 'antinatural' de calor."
    },
    {
      "duration": 30660.006125000073,
      "inputTokens": 3296,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, Black Friday chaos. Orders flying in, but customers raging about oversold items. Inventory API shows stock available, warehouse confirms it's zero. What the hell?\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. It's not just caching; caches reflect replica states. The root is replicas not seeing latest writes immediately.\",\n          \"isCorrect\": false,\n          \"text\": \"Purge all caches immediately.\"\n        },\n        {\n          \"feedback\": \"Wrong. Load isn't the primary issue here; it's data divergence across nodes.\",\n          \"isCorrect\": false,\n          \"text\": \"Scale up more replicas.\"\n        },\n        {\n          \"feedback\": \"Correct. This screams eventual consistency: reads from replicas pulling stale inventory before writes propagate.\",\n          \"isCorrect\": true,\n          \"text\": \"Eventual consistency staleness.\"\n        },\n        {\n          \"feedback\": \"Wrong. Network is fine; it's not a full outage but data inconsistency.\",\n          \"isCorrect\": false,\n          \"text\": \"Network partition blocking all.\"\n        }\n      ],\n      \"question\": \"What's causing the oversells?\"\n    },\n    {\n      \"context\": \"Spot on, {{NAME}}. Logs confirm reads from replicas lagging behind the leader's write. We've got eventual consistency for availability, but inventory demands better. How do we tighten this without tanking perf?\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Strong consistency blocks on all replicas, killing availability during partitions.\",\n          \"isCorrect\": false,\n          \"text\": \"Switch to strong consistency.\"\n        },\n        {\n          \"feedback\": \"Correct. Use quorums: write to majority, read from majority to overlap on recent writes.\",\n          \"isCorrect\": true,\n          \"text\": \"Implement quorum reads/writes.\"\n        },\n        {\n          \"feedback\": \"Wrong. Vector clocks help conflicts, not basic staleness.\",\n          \"isCorrect\": false,\n          \"text\": \"Add vector clocks everywhere.\"\n        },\n        {\n          \"feedback\": \"Wrong. Last-write-wins assumes timestamps, but doesn't prevent stale reads.\",\n          \"isCorrect\": false,\n          \"text\": \"Use last-write-wins.\"\n        }\n      ],\n      \"question\": \"Best fix for stale reads?\"\n    },\n    {\n      \"context\": \"Quorums, yes! Let's say 5 replicas total. What quorums balance consistency and availability? Remember CAP—we're partition-tolerant.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. W=2+R=2=4 <5, reads might miss writes entirely.\",\n          \"isCorrect\": false,\n          \"text\": \"W=2, R=2.\"\n        },\n        {\n          \"feedback\": \"Correct. W=3 + R=3 >5 ensures read quorum overlaps write quorum.\",\n          \"isCorrect\": true,\n          \"text\": \"W=3, R=3.\"\n        },\n        {\n          \"feedback\": \"Wrong. W=4+R=2=6>5 but writes too slow, hurts availability.\",\n          \"isCorrect\": false,\n          \"text\": \"W=4, R=2.\"\n        },\n        {\n          \"feedback\": \"Wrong. W=1+R=5=6>5 but single write failure loses data.\",\n          \"isCorrect\": false,\n          \"text\": \"W=1, R=5.\"\n        }\n      ],\n      \"question\": \"Ideal quorums for N=5?\"\n    },\n    {\n      \"context\": \"Perfect, {{NAME}}. W=3, R=3 should catch most recent writes. Deploying now. Traffic's insane, but let's monitor. Hey, replica 3 and 4 just went dark—network partition! What happens to writes?\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Writes need full quorum; if only 2 ack, it fails.\",\n          \"isCorrect\": false,\n          \"text\": \"Writes still succeed.\"\n        },\n        {\n          \"feedback\": \"Correct. Partition splits nodes; writes to unreachable quorum fail, preserving consistency.\",\n          \"isCorrect\": true,\n          \"text\": \"Writes to minority fail.\"\n        },\n        {\n          \"feedback\": \"Wrong. System doesn't magically merge; it rejects to avoid conflicts.\",\n          \"isCorrect\": false,\n          \"text\": \"Auto-merge across partition.\"\n        },\n        {\n          \"feedback\": \"Wrong. Availability means serving, but consistency blocks divergent writes.\",\n          \"isCorrect\": false,\n          \"text\": \"Accept all writes anyway.\"\n        }\n      ],\n      \"question\": \"During partition?\"\n    },\n    {\n      \"context\": \"Good call. Writes failing on that side, customers see errors—pissing them off, but better than oversells. Partition healed, but now conflict alerts: two divergent inventory updates for item X. How resolve?\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Timestamps unreliable if clocks skew.\",\n          \"isCorrect\": false,\n          \"text\": \"Last-write-wins by timestamp.\"\n        },\n        {\n          \"feedback\": \"Correct. Use application merge: sum reserved quantities from both.\",\n          \"isCorrect\": true,\n          \"text\": \"Merge with app logic.\"\n        },\n        {\n          \"feedback\": \"Wrong. Vector clocks detect but don't auto-resolve without more.\",\n          \"isCorrect\": false,\n          \"text\": \"Just use vector clocks.\"\n        },\n        {\n          \"feedback\": \"Wrong. Pick one arbitrarily; loses data.\",\n          \"isCorrect\": false,\n          \"text\": \"Choose highest replica ID.\"\n        }\n      ],\n      \"question\": \"Resolve inventory conflict?\"\n    },\n    {\n      \"context\": \"Smart merge, {{NAME}}. Reserved 10 on one side, 15 on other—total deduct 25 from stock. System stabilizing. But wait, checking orders... some still oversold? Digging deeper.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Quorums were set right.\",\n          \"isCorrect\": false,\n          \"text\": \"Quorum misconfigured.\"\n        },\n        {\n          \"feedback\": \"Wrong. Merge handled it.\",\n          \"isCorrect\": false,\n          \"text\": \"Bad conflict resolution.\"\n        },\n        {\n          \"feedback\": \"Correct. Some reads happened during partition from minority, stale data led to bad orders.\",\n          \"isCorrect\": true,\n          \"text\": \"Stale reads in partition.\"\n        },\n        {\n          \"feedback\": \"Wrong. Writes were blocked.\",\n          \"isCorrect\": false,\n          \"text\": \"Lost writes.\"\n        }\n      ],\n      \"question\": \"Why lingering oversells?\"\n    },\n    {\n      \"context\": \"Exactly. Even with quorums, R=3 might read 2 majority +1 minority during healing, getting stale. Need stricter reads? Or accept for availability?\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Bumps R to 4, hurts availability more.\",\n          \"isCorrect\": false,\n          \"text\": \"Increase R to 4.\"\n        },\n        {\n          \"feedback\": \"Correct. Stick with eventual via quorums; tune anti-entropy faster.\",\n          \"isCorrect\": true,\n          \"text\": \"Tune gossip/anti-entropy.\"\n        },\n        {\n          \"feedback\": \"Wrong. Downgrades availability completely.\",\n          \"isCorrect\": false,\n          \"text\": \"Force strong consistency.\"\n        },\n        {\n          \"feedback\": \"Wrong. Doesn't address read anomalies.\",\n          \"isCorrect\": false,\n          \"text\": \"More replicas.\"\n        }\n      ],\n      \"question\": \"Handle read anomalies?\"\n    },\n    {\n      \"context\": \"Gossip protocol ramp-up, good. Now the twist, {{NAME}}: CEO just emailed. This isn't just inventory—it's tied to payments. Oversells caused chargebacks, legal risk. We needed banking-grade consistency!\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. For money, strong or quorum-strong is essential.\",\n          \"isCorrect\": false,\n          \"text\": \"Eventual was fine.\"\n        },\n        {\n          \"feedback\": \"Wrong. We can't ignore; redesign needed.\",\n          \"isCorrect\": false,\n          \"text\": \"Blame the warehouse.\"\n        },\n        {\n          \"feedback\": \"Correct. Pivot to strong consistency for payment/inventory txns via 2PC or sagas.\",\n          \"isCorrect\": true,\n          \"text\": \"Upgrade to strong for money.\"\n        },\n        {\n          \"feedback\": \"Wrong. Payments demand it now.\",\n          \"isCorrect\": false,\n          \"text\": \"Keep quorums, add alerts.\"\n        }\n      ],\n      \"question\": \"React to payment risk?\"\n    },\n    {\n      \"context\": \"Whoa, {{NAME}}, you're right—can't risk finances. Implementing linearizable consistency for critical paths: all reads/writes serialized. Sacrifices some A, but C+P for money. Testing... green! No more oversells, chargebacks halted.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. We prioritized C over A correctly here.\",\n          \"isCorrect\": false,\n          \"text\": \"Should've kept high availability.\"\n        },\n        {\n          \"feedback\": \"Wrong. Quorums were good but not enough for linearizability.\",\n          \"isCorrect\": false,\n          \"text\": \"Just tweak quorums more.\"\n        },\n        {\n          \"feedback\": \"Correct. CAP forces trade-offs; for inventory+pays, CP over AP.\",\n          \"isCorrect\": true,\n          \"text\": \"CP model validates lesson.\"\n        },\n        {\n          \"feedback\": \"Wrong. Eventual risks money.\",\n          \"isCorrect\": false,\n          \"text\": \"Eventual with better merges.\"\n        }\n      ],\n      \"question\": \"Key takeaway?\"\n    },\n    {\n      \"context\": \"Nailed it. CEO thrilled, crisis over. {{NAME}}, this Black Friday taught us: pick consistency model by stakes. Eventual for feeds, strong for money. Quorums bridge, but know when to go linearizable. Beers on me?\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Always possible with sagas/2PC.\",\n          \"isCorrect\": false,\n          \"text\": \"Strong consistency too costly.\"\n        },\n        {\n          \"feedback\": \"Wrong. CAP allows CP.\",\n          \"isCorrect\": false,\n          \"text\": \"Can't have C+P.\"\n        },\n        {\n          \"feedback\": \"Correct. Right: tune quorums, resolve conflicts semantically, escalate to strong for critical data.\",\n          \"isCorrect\": true,\n          \"text\": \"Apply trade-offs wisely.\"\n        },\n        {\n          \"feedback\": \"Wrong. Availability always secondary.\",\n          \"isCorrect\": false,\n          \"text\": \"Prioritize availability always.\"\n        }\n      ],\n      \"question\": \"Final lesson?\"\n    }\n  ]\n}",
      "outputTokens": 2626,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "en-cs-distributed-systems-consistency-1",
      "userPrompt": "LESSON_TITLE: Consistency in Distributed Systems\nLESSON_DESCRIPTION: Navigating consistency and availability trade-offs in distributed systems\nCHAPTER_TITLE: Distributed Data\nCOURSE_TITLE: System Design\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. CAP Theorem: The CAP theorem states you can only have two of three: Consistency, Availability, and Partition tolerance. Since network partitions happen, you're really choosing between C and A.\n2. Strong Consistency: Strong consistency means all nodes see the same data at the same time. Every read returns the most recent write. This requires coordination that can slow things down.\n3. Eventual Consistency: Eventual consistency means replicas will converge given enough time without new writes. Reads might return stale data temporarily, but the system stays available.\n4. Partition Handling: Network partitions occur when nodes can't communicate. The system must decide: reject requests (maintain consistency) or accept requests that might conflict (maintain availability).\n5. Quorum Systems: Quorum-based systems use voting. A write succeeds if enough replicas acknowledge it. Read quorum + write quorum > total nodes ensures reading at least one up-to-date copy.\n6. Conflict Resolution: Conflict resolution strategies handle divergent writes: last-write-wins, vector clocks, or application-specific merge logic. The right choice depends on your data semantics."
    },
    {
      "duration": 66826.10662500001,
      "inputTokens": 3271,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, our SaveSmart banking app is crushing it on sign-ups, but users park cash in checking—avg $1,500 balance, savings at $180. 4.5% interest wasted. Monthly transfers? Just 12%. What's the blocker?\",\n      \"options\": [\n        {\n          \"feedback\": \"Close, but loss aversion is more about avoiding losses than access fear. Primary issue is present bias making future interest feel worthless vs spending now.\",\n          \"isCorrect\": false,\n          \"text\": \"Loss aversion—fear losing spending power\"\n        },\n        {\n          \"feedback\": \"Present bias overvalues immediate rewards like spending over future gains like interest. Perfect diagnosis—users know they should save but can't resist now.\",\n          \"isCorrect\": true,\n          \"text\": \"Present bias—now beats future\"\n        },\n        {\n          \"feedback\": \"Social proof amplifies behaviors but won't overcome craving instant gratification without addressing the root discount of future rewards.\",\n          \"isCorrect\": false,\n          \"text\": \"Missing social proof cues\"\n        },\n        {\n          \"feedback\": \"Defaults matter hugely, but even good ones get ignored when present bias screams 'spend now!' It's not the main driver here.\",\n          \"isCorrect\": false,\n          \"text\": \"Weak default options\"\n        }\n      ],\n      \"question\": \"Core behavioral barrier?\"\n    },\n    {\n      \"context\": \"Boom, {{NAME}}—present bias it is. They crave now-spending over vague future interest. Commitment devices lock it in automatically. Round-ups on every purchase to savings? Genius low-friction win.\",\n      \"options\": [\n        {\n          \"feedback\": \"Yes! Round-ups automate tiny commitments, bypassing present bias willpower fails. Users save without feeling the immediate pinch.\",\n          \"isCorrect\": true,\n          \"text\": \"Yes, auto round-ups first\"\n        },\n        {\n          \"feedback\": \"Reminders fight present bias weakly—users dismiss them for instant gratification. Automation like round-ups is stronger.\",\n          \"isCorrect\": false,\n          \"text\": \"Push reminders to save\"\n        },\n        {\n          \"feedback\": \"Interest hikes are financial, not behavioral. Present bias ignores even better rates without nudges.\",\n          \"isCorrect\": false,\n          \"text\": \"Boost interest rates\"\n        },\n        {\n          \"feedback\": \"Streaks gamify but still require daily choice, vulnerable to present bias. Round-ups are passive.\",\n          \"isCorrect\": false,\n          \"text\": \"Add saving streaks\"\n        }\n      ],\n      \"question\": \"Best counter to present bias?\"\n    },\n    {\n      \"context\": \"Round-ups deployed, {{NAME}}! Active savers up to 22%—huge lift. But 78% still idle. Layer defaults next: auto-allocate 5% paycheck to savings, clear opt-out. Inertia loves it.\",\n      \"options\": [\n        {\n          \"feedback\": \"Defaults exploit status quo bias—most stick with pre-selected savings, massively boosting transfers without restricting choice.\",\n          \"isCorrect\": true,\n          \"text\": \"Yes, default paycheck split\"\n        },\n        {\n          \"feedback\": \"Manual prompts get ignored amid present bias. Defaults automate adherence.\",\n          \"isCorrect\": false,\n          \"text\": \"More manual transfer prompts\"\n        },\n        {\n          \"feedback\": \"Opt-in only requires effort, low uptake. Defaults reverse it to opt-out.\",\n          \"isCorrect\": false,\n          \"text\": \"Make savings opt-in\"\n        },\n        {\n          \"feedback\": \"Social proof later; defaults first for baseline inertia win.\",\n          \"isCorrect\": false,\n          \"text\": \"Skip to social proof\"\n        }\n      ],\n      \"question\": \"Add default auto-save?\"\n    },\n    {\n      \"context\": \"Defaults live, {{NAME}}. Paycheck savers now 38%—doubling again! Steady transfers growing. But plateauing. Time for framing: present savings nudge as 'Earn $15 extra this month' or 'Don't lose $15 interest'?\",\n      \"options\": [\n        {\n          \"feedback\": \"Loss aversion hits twice as hard—framing as loss avoidance motivates more than equivalent gains, driving action.\",\n          \"isCorrect\": true,\n          \"text\": \"Loss frame: 'Don't lose $15'\"\n        },\n        {\n          \"feedback\": \"Gain frames underperform; losses loom larger psychologically per prospect theory.\",\n          \"isCorrect\": false,\n          \"text\": \"Gain frame: 'Earn $15 extra'\"\n        },\n        {\n          \"feedback\": \"Neutral facts ignored; emotional framing needed via loss aversion.\",\n          \"isCorrect\": false,\n          \"text\": \"Just show interest rate\"\n        },\n        {\n          \"feedback\": \"Visuals help but framing words trigger the bias directly.\",\n          \"isCorrect\": false,\n          \"text\": \"Use progress charts\"\n        }\n      ],\n      \"question\": \"Best nudge frame?\"\n    },\n    {\n      \"context\": \"Loss frame crushing it, {{NAME}}! Click-through on savings prompts up 60%. Total savers at 52%. Users hate 'losing' that interest. One more layer: social proof. Show '1.2M users save weekly—join them'?\",\n      \"options\": [\n        {\n          \"feedback\": \"Social proof normalizes saving, leveraging our herd instinct to follow others, especially ambiguous decisions like this.\",\n          \"isCorrect\": true,\n          \"text\": \"Yes, add user stats banner\"\n        },\n        {\n          \"feedback\": \"Testimonials similar but aggregate proof scales better for broad behavior.\",\n          \"isCorrect\": false,\n          \"text\": \"User testimonial quotes\"\n        },\n        {\n          \"feedback\": \"Leaderboards competitive, not proof for average users.\",\n          \"isCorrect\": false,\n          \"text\": \"Savings leaderboards\"\n        },\n        {\n          \"feedback\": \"Expert advice rationalizes but we follow peers more in uncertainty.\",\n          \"isCorrect\": false,\n          \"text\": \"Financial expert tips\"\n        }\n      ],\n      \"question\": \"Layer social proof?\"\n    },\n    {\n      \"context\": \"Social proof banners rolled out, {{NAME}}. Savers hit 61%, transfers soaring. But opt-out complaints up 20%: 'Feels like forced loss, taking my money!' Metrics dip on retention. Clash?\",\n      \"options\": [\n        {\n          \"feedback\": \"Frames interact—loss frame + round-ups feel like immediate loss amid present bias, triggering panic opt-outs.\",\n          \"isCorrect\": true,\n          \"text\": \"Loss frame backfiring with bias\"\n        },\n        {\n          \"feedback\": \"No, defaults too aggressive; but opt-out easy, issue elsewhere.\",\n          \"isCorrect\": false,\n          \"text\": \"Defaults overwhelming users\"\n        },\n        {\n          \"feedback\": \"Social proof not authentic enough; but complaints focus on 'loss'.\",\n          \"isCorrect\": false,\n          \"text\": \"Fake social proof vibe\"\n        },\n        {\n          \"feedback\": \"Round-ups too small; but volume complaints say otherwise.\",\n          \"isCorrect\": false,\n          \"text\": \"Round-ups annoyingly tiny\"\n        }\n      ],\n      \"question\": \"Why the opt-out spike?\"\n    },\n    {\n      \"context\": \"Sharp eye, {{NAME}}. Analytics confirm: round-up 'losses' + loss frame amplify present bias panic—withdrawals spike post-save. Defaults hold but need buffer. Twist: social proof underused here.\",\n      \"options\": [\n        {\n          \"feedback\": \"Social proof reframes as normal, not loss—'Everyone does this tiny save'. Counters bias by making future normal.\",\n          \"isCorrect\": true,\n          \"text\": \"Boost social proof on round-ups\"\n        },\n        {\n          \"feedback\": \"Soften loss frame to gain; but loss still stronger, needs context.\",\n          \"isCorrect\": false,\n          \"text\": \"Switch to gain framing\"\n        },\n        {\n          \"feedback\": \"Lower default %; but proof normalizes current levels.\",\n          \"isCorrect\": false,\n          \"text\": \"Reduce default to 2%\"\n        },\n        {\n          \"feedback\": \"Disable round-ups; but they're core for bias, just reframe.\",\n          \"isCorrect\": false,\n          \"text\": \"Scrap round-ups\"\n        }\n      ],\n      \"question\": \"Fix the interaction clash?\"\n    },\n    {\n      \"context\": \"Ramped social proof on round-ups: '90% of round-up users stick—join 500k!' Opt-outs plummeting, {{NAME}}. Retention stabilizing. Check combined dashboard nudge?\",\n      \"options\": [\n        {\n          \"feedback\": \"Stacking wins: defaults + proof + loss frame (socialized) + round-ups counter all biases synergistically.\",\n          \"isCorrect\": true,\n          \"text\": \"Launch full combo dashboard\"\n        },\n        {\n          \"feedback\": \"Test one-by-one more; but real power in layers for complex behaviors.\",\n          \"isCorrect\": false,\n          \"text\": \"A/B test each solo\"\n        },\n        {\n          \"feedback\": \"Simplify to defaults only; but misses other principles' power.\",\n          \"isCorrect\": false,\n          \"text\": \"Defaults alone suffice\"\n        },\n        {\n          \"feedback\": \"User surveys first; but data already guiding.\",\n          \"isCorrect\": false,\n          \"text\": \"Survey users more\"\n        }\n      ],\n      \"question\": \"Go full behavioral stack?\"\n    },\n    {\n      \"context\": \"Full stack live, {{NAME}}! Savers 78%, avg balance doubled to $420. Opt-outs normalized. Users say 'feels easy and smart now'. Layers unlocked it—no single nudge enough.\",\n      \"options\": [\n        {\n          \"feedback\": \"Key insight: behavioral design stacks principles like loss aversion, defaults, etc., to work with psychology for real change.\",\n          \"isCorrect\": true,\n          \"text\": \"Emphasize principle layering\"\n        },\n        {\n          \"feedback\": \"Focus one principle; but story shows combos needed.\",\n          \"isCorrect\": false,\n          \"text\": \"Stick to present bias only\"\n        },\n        {\n          \"feedback\": \"Tech fixes next; but behavioral core.\",\n          \"isCorrect\": false,\n          \"text\": \"Improve app speed\"\n        },\n        {\n          \"feedback\": \"Marketing push; but in-app design drives sustained behavior.\",\n          \"isCorrect\": false,\n          \"text\": \"Email campaigns\"\n        }\n      ],\n      \"question\": \"Biggest lesson here?\"\n    },\n    {\n      \"context\": \"Nailed the takeaway, {{NAME}}. Plot twist was the synergies—present bias fought by commitments, amplified by defaults, framed via loss aversion, normalized by proof. Quarterly savings up 300%. High-five!\",\n      \"options\": [\n        {\n          \"feedback\": \"Perfect wrap. Applying behavioral econ in practice means diagnosing biases then layering nudges for products that truly guide users.\",\n          \"isCorrect\": true,\n          \"text\": \"Design nudges, test, iterate\"\n        },\n        {\n          \"feedback\": \"Done; but ongoing tweaks needed.\",\n          \"isCorrect\": false,\n          \"text\": \"Call it solved\"\n        },\n        {\n          \"feedback\": \"Scale to marketing; but app core first.\",\n          \"isCorrect\": false,\n          \"text\": \"Expand to emails\"\n        },\n        {\n          \"feedback\": \"Report to execs; yes, but iterate design.\",\n          \"isCorrect\": false,\n          \"text\": \"Prep exec summary\"\n        }\n      ],\n      \"question\": \"Next step for us?\"\n    }\n  ]\n}",
      "outputTokens": 4975,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "en-economics-behavioral-design-1",
      "userPrompt": "LESSON_TITLE: Behavioral Design in Practice\nLESSON_DESCRIPTION: Applying behavioral economics principles to design products and systems that work with human psychology\nCHAPTER_TITLE: Applied Behavioral Economics\nCOURSE_TITLE: Product Psychology\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. Loss Aversion: Loss aversion means losses hurt more than equivalent gains feel good — roughly twice as much. People will take irrational risks to avoid losses they wouldn't take to achieve gains.\n2. Framing Effects: Framing effects show that how you present options matters as much as what the options are. '90% survival rate' and '10% mortality rate' are logically identical but feel different.\n3. Default Effects: Default effects are powerful because people tend to stick with pre-selected options. Changing the default can dramatically change outcomes without restricting choice.\n4. Present Bias: Present bias makes us overvalue immediate rewards over future ones. We know we should save for retirement, but the money feels more valuable now. Commitment devices help.\n5. Social Proof: Social proof drives behavior — we look to others to decide what's appropriate. Showing that 'most people do X' is often more effective than explaining why X is good."
    },
    {
      "duration": 103057.34729099995,
      "inputTokens": 3358,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, pro primeiro passo da síntese desse intermediário pro novo fármaco, temos um álcool primário. Tentamos direto com NaN3 em H2SO4 pra azida, mas zero produto. Só álcool de volta.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! OH é base forte, mau grupo de saída. Bons LGs são bases fracas como tosylato ou haletos. Ative o OH convertendo em TsO- pra SN2.\",\n          \"isCorrect\": true,\n          \"text\": \"Grupo de saída ruim (OH)\"\n        },\n        {\n          \"feedback\": \"Errado. N3- é forte nucleófilo, mas não ataca OH estável.\",\n          \"isCorrect\": false,\n          \"text\": \"Nucleófilo fraco\"\n        },\n        {\n          \"feedback\": \"Errado. Primário é ideal pra SN2, mas LG impede.\",\n          \"isCorrect\": false,\n          \"text\": \"Substrato inadequado\"\n        },\n        {\n          \"feedback\": \"Errado. Ácido protona OH pra H2O (bom LG), mas condições ruins pra N3 ainda.\",\n          \"isCorrect\": false,\n          \"text\": \"Condições ácidas ruins\"\n        }\n      ],\n      \"question\": \"Qual o problema principal?\"\n    },\n    {\n      \"context\": \"Exato, {{NAME}}! OH péssimo LG. Fizemos o tosylato primário — top LG. Agora ROTs + NaN3 pra SN2. Qual solvente maximiza a velocidade?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Apróticos polares como DMF/DMSO não solvatam N3-, tornando-o super nucleofílico pra SN2 rápida em primário.\",\n          \"isCorrect\": true,\n          \"text\": \"DMF ou DMSO (apróticos)\"\n        },\n        {\n          \"feedback\": \"Errado. Próticos solvatam nucl forte, desaceleram SN2.\",\n          \"isCorrect\": false,\n          \"text\": \"Etanol (prótico)\"\n        },\n        {\n          \"feedback\": \"Errado. Não polar dissolve mal sais iônicos como NaN3.\",\n          \"isCorrect\": false,\n          \"text\": \"Hexano (não polar)\"\n        },\n        {\n          \"feedback\": \"Errado. Água solvatam nucl, e primary ainda OK mas mais lento.\",\n          \"isCorrect\": false,\n          \"text\": \"Água\"\n        }\n      ],\n      \"question\": \"Qual solvente ideal pro SN2?\"\n    },\n    {\n      \"context\": \"Perfeito, {{NAME}}! Em DMF rolou liso, 97% azida primária. Agora passo crítico: (S)-1-feniletil tosylato (sec benzylico quiral). Queremos (R)-azida via inversão. Qual mecanismo?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Com nucl forte em aprotico, secundário benzylico ainda faz SN2 dominante, invertendo config.\",\n          \"isCorrect\": true,\n          \"text\": \"SN2 (inversão)\"\n        },\n        {\n          \"feedback\": \"Errado. SN1 daria carbocátion planar benzylico estável, racemato.\",\n          \"isCorrect\": false,\n          \"text\": \"SN1 (racemização)\"\n        },\n        {\n          \"feedback\": \"Errado. E2 competiria se base forte, mas foco em sub com N3-.\",\n          \"isCorrect\": false,\n          \"text\": \"E2 (eliminação)\"\n        },\n        {\n          \"feedback\": \"Errado. Não há retenção aqui.\",\n          \"isCorrect\": false,\n          \"text\": \"Retenção de config\"\n        }\n      ],\n      \"question\": \"Qual mecanismo pra inversão?\"\n    },\n    {\n      \"context\": \"SN2 certo, {{NAME}}. Rodamos NaN3 em DMF 50°C. Bom yield produto. Pra confirmar mecanismo e pureza enantiomérica?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! HPLC quiral ou [α]D mostram inversão (SN2) vs racemato (SN1). Essencial pra fármacos.\",\n          \"isCorrect\": true,\n          \"text\": \"HPLC quiral ou rotação\"\n        },\n        {\n          \"feedback\": \"Errado. TLC vê produto total, não stereo.\",\n          \"isCorrect\": false,\n          \"text\": \"TLC ou RMN rotina\"\n        },\n        {\n          \"feedback\": \"Errado. Yield alto não diz stereo.\",\n          \"isCorrect\": false,\n          \"text\": \"Medir yield\"\n        },\n        {\n          \"feedback\": \"Errado. Velocidade não revela stereo.\",\n          \"isCorrect\": false,\n          \"text\": \"Medir cinética\"\n        }\n      ],\n      \"question\": \"Como checar estereoquímica?\"\n    },\n    {\n      \"context\": \"Boa, {{NAME}}! HPLC quiral: 35% (R) e 65% (S) — racemização parcial, não inversão limpa!\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Sec benzylico estabiliza cat+, competição SN1 mesmo em aprotico se temp alta.\",\n          \"isCorrect\": true,\n          \"text\": \"Compete SN1 (cat+ benzylico)\"\n        },\n        {\n          \"feedback\": \"Errado. Tosylato excelente LG.\",\n          \"isCorrect\": false,\n          \"text\": \"Mau grupo de saída\"\n        },\n        {\n          \"feedback\": \"Errado. Primário? Não, é sec.\",\n          \"isCorrect\": false,\n          \"text\": \"Substrato primário\"\n        },\n        {\n          \"feedback\": \"Errado. DMF ótimo pra SN2.\",\n          \"isCorrect\": false,\n          \"text\": \"Solvente errado\"\n        }\n      ],\n      \"question\": \"Por que racemização parcial?\"\n    },\n    {\n      \"context\": \"Pois é, {{NAME}}. SN1 parcial por cat+ estável. Pra suprimir SN1 e forçar SN2?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Baixa T favorece transição SN2 (concertada) vs ionização lenta SN1; aprotico puro evita prótons.\",\n          \"isCorrect\": true,\n          \"text\": \"Baixa T e aprotico puro\"\n        },\n        {\n          \"feedback\": \"Errado. Alta T acelera SN1 mais.\",\n          \"isCorrect\": false,\n          \"text\": \"Aumentar temperatura\"\n        },\n        {\n          \"feedback\": \"Errado. Próticos estabilizam cat+.\",\n          \"isCorrect\": false,\n          \"text\": \"Solvente prótico\"\n        },\n        {\n          \"feedback\": \"Errado. Nucl fraco piora SN2.\",\n          \"isCorrect\": false,\n          \"text\": \"Nucl mais fraco\"\n        }\n      ],\n      \"question\": \"Como favorecer SN2?\"\n    },\n    {\n      \"context\": \"Refizemos a 0°C em DMF fresco, {{NAME}}. Yield OK, HPLC melhor (90% ee), mas... NMR tem impureza 2%! Pico de CH移 — rearranjo hidreto, produto isômero!\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Rearranjo via cat+ planar (hidreto 1,2-shift) prova SN1 residual, mesmo otimizado. Twist fatal pra pureza fármaco.\",\n          \"isCorrect\": true,\n          \"text\": \"SN1 com rearranjo cat+\"\n        },\n        {\n          \"feedback\": \"Errado. Preparação limpa.\",\n          \"isCorrect\": false,\n          \"text\": \"Erro na síntese\"\n        },\n        {\n          \"feedback\": \"Errado. Não é eliminação.\",\n          \"isCorrect\": false,\n          \"text\": \"Produto E2\"\n        },\n        {\n          \"feedback\": \"Errado. N3 não causa isso.\",\n          \"isCorrect\": false,\n          \"text\": \"Nucl ambidente\"\n        }\n      ],\n      \"question\": \"O que explica rearranjo?\"\n    },\n    {\n      \"context\": \"Exato, {{NAME}}! Até traço SN1 rearranja. Pra SN2 100% nesse substrato tricky: alta [nucl] pra k[Nu][sub] >> k[sub].\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! SN2 2ª ordem depende de [Nu]; alta conc. acelera SN2 >> SN1 1ª ordem. Insight chave pra otimizar!\",\n          \"isCorrect\": true,\n          \"text\": \"Alta concentração Nu forte\"\n        },\n        {\n          \"feedback\": \"Errado. Baixa [Nu] favorece SN1.\",\n          \"isCorrect\": false,\n          \"text\": \"Diluir a reação\"\n        },\n        {\n          \"feedback\": \"Errado. Crown pra nucl nu acelera mas alta [Nu] essencial.\",\n          \"isCorrect\": false,\n          \"text\": \"Só crown ether\"\n        },\n        {\n          \"feedback\": \"Errado. Secundário sempre misto.\",\n          \"isCorrect\": false,\n          \"text\": \"Aceitar mistura\"\n        }\n      ],\n      \"question\": \"Estratégia final pra SN2 pura?\"\n    },\n    {\n      \"context\": \"Bora lá, {{NAME}}! 10x [NaN3] em DMF -10°C. HPLC: 99.5% ee (R), NMR limpo, sem rearranjo. Síntese salva! Lição pra sempre.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Escolha mecanismo por substrato (prim/sn2, tert/sn1), LG bom, aprotico/nucl forte pra SN2, estereq confirma. Otimizar condições controla!\",\n          \"isCorrect\": true,\n          \"text\": \"Cond. controlam SN1 vs SN2\"\n        },\n        {\n          \"feedback\": \"Errado. LG sempre decide.\",\n          \"isCorrect\": false,\n          \"text\": \"Só grupo de saída\"\n        },\n        {\n          \"feedback\": \"Errado. Primários só.\",\n          \"isCorrect\": false,\n          \"text\": \"Evitar secundários\"\n        },\n        {\n          \"feedback\": \"Errado. Stereo irrelevante.\",\n          \"isCorrect\": false,\n          \"text\": \"Só yield importa\"\n        }\n      ],\n      \"question\": \"Qual insight chave?\"\n    }\n  ]\n}",
      "outputTokens": 8329,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "pt-chemistry-organic-reactions-1",
      "userPrompt": "LESSON_TITLE: Mecanismos de Substituicao\nLESSON_DESCRIPTION: Aplicando mecanismos de reacao organica para prever e otimizar sinteses quimicas\nCHAPTER_TITLE: Reacoes Organicas\nCOURSE_TITLE: Quimica Organica II\nLANGUAGE: pt\nEXPLANATION_STEPS:\n1. Nucleofilos e Eletrofilos: Nucleofilos sao especies ricas em eletrons que doam pares de eletrons. Eletrofilos sao especies pobres em eletrons que aceitam. Reacoes organicas sao geralmente nucleofilos atacando eletrofilos.\n2. Mecanismo SN2: SN2 e um mecanismo concertado — o nucleofilo ataca enquanto o grupo de saida sai, em um unico passo. Funciona melhor com substratos primarios e nucleofilos fortes.\n3. Mecanismo SN1: SN1 ocorre em dois passos: primeiro o grupo de saida sai formando um carbocation, depois o nucleofilo ataca. Favorecido por substratos terciarios e solventes polares proticos.\n4. Estereoquimica: A estereoquimica revela o mecanismo. SN2 inverte a configuracao (ataque por tras). SN1 pode dar mistura racemicacon (carbocation planar atacado de ambos os lados).\n5. Grupos de Saida: Grupos de saida precisam ser estaveis apos sair. Bons grupos de saida sao bases fracas — haletos, tosilatos, agua protonada. Grupos de saida ruins sao bases fortes."
    },
    {
      "duration": 35961.508374999976,
      "inputTokens": 3341,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"¡{{NAME}}! Estamos jodidos con este modelo para detectar defectos en piezas de fábrica. El MLP simple da 45% de accuracy en validación, pero overfitting brutal. Las imágenes son 128x128 RGB. Necesitamos una arquitectura de CNN desde cero.\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrecto. Un MLP no captura patrones espaciales en imágenes; ignora la estructura 2D. Lo correcto es empezar con capas convolucionales para detectar features locales.\",\n          \"isCorrect\": false,\n          \"text\": \"Agrandar el MLP con más neuronas ocultas\"\n        },\n        {\n          \"feedback\": \"¡Exacto! Las capas convolucionales usan filtros para patrones locales como bordes o texturas, compartiendo pesos y reduciendo parámetros. Perfecto para imágenes.\",\n          \"isCorrect\": true,\n          \"text\": \"Implementar capas convolucionales\"\n        },\n        {\n          \"feedback\": \"Incorrecto. Skip connections ayudan en redes muy profundas, pero primero necesitamos conv layers para el problema base de imágenes.\",\n          \"isCorrect\": false,\n          \"text\": \"Agregar skip connections (ResNet)\"\n        },\n        {\n          \"feedback\": \"Parcial, pero prematuro. RNN es para secuencias, no imágenes estáticas. Empieza con CNN.\",\n          \"isCorrect\": false,\n          \"text\": \"Cambiar a RNN para secuencias\"\n        }\n      ],\n      \"question\": \"¿Qué hacemos primero para mejorar?\"\n    },\n    {\n      \"context\": \"Buena, {{NAME}}. Agregué dos capas conv: 32 filtros 3x3, luego 64. Con ReLU. Pero la salida es 32x32x64, muy grande para clasificar 5 defectos. Se entrena lento y memoria explota.\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrecto. Flatten directo aplasta todo, pierde estructura espacial y causa overfitting.\",\n          \"isCorrect\": false,\n          \"text\": \"Flatten y capas densas ya\"\n        },\n        {\n          \"feedback\": \"¡Sí! Pooling reduce dims espaciales (e.g., MaxPool 2x2 baja a 16x16), compacta features y da invariancia a traslaciones pequeñas.\",\n          \"isCorrect\": true,\n          \"text\": \"Agregar capas de pooling\"\n        },\n        {\n          \"feedback\": \"Bien pensado, pero activations van en conv ya; pooling primero para eficiencia.\",\n          \"isCorrect\": false,\n          \"text\": \"Cambiar a sigmoid en conv\"\n        },\n        {\n          \"feedback\": \"No aún. Dropout después; pooling reduce params antes.\",\n          \"isCorrect\": false,\n          \"text\": \"Aplicar dropout temprano\"\n        }\n      ],\n      \"question\": \"¿Siguiente paso para eficiencia?\"\n    },\n    {\n      \"context\": \"Genial, {{NAME}}. MaxPooling2D después de cada conv. Ahora features son 8x8x64 post dos pools. Flatten a densas: 512 neuronas, output 5 clases. Accuracy sube a 72%, pero gradientes inestables en epochs tardías.\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrecto. Sigmoid causa vanishing gradient en deep nets. Necesitas ReLU.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar sigmoid en todas las activaciones\"\n        },\n        {\n          \"feedback\": \"¡Correcto! ReLU (max(0,x)) es no-lineal, simple, evita vanishing gradient y acelera entrenamiento en capas profundas.\",\n          \"isCorrect\": true,\n          \"text\": \"Confirmar ReLU en conv y densas\"\n        },\n        {\n          \"feedback\": \"Tarde para eso; ya tenemos conv+pool. BatchNorm después.\",\n          \"isCorrect\": false,\n          \"text\": \"Agregar más conv layers\"\n        },\n        {\n          \"feedback\": \"Dropout ayuda overfitting más tarde; estabilidad primero con activaciones.\",\n          \"isCorrect\": false,\n          \"text\": \"Insertar dropout en densas\"\n        }\n      ],\n      \"question\": \"¿Qué revisamos en activaciones?\"\n    },\n    {\n      \"context\": \"ReLU everywhere, {{NAME}}. Entrena mejor, accuracy 78%. Pero pérdida oscila mucho entre batches. Learning rate 0.001 parece inestable.\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrecto. Dropout es para overfitting, no inestabilidad de gradientes.\",\n          \"isCorrect\": false,\n          \"text\": \"Agregar dropout 0.5\"\n        },\n        {\n          \"feedback\": \"¡Perfecto! BatchNorm normaliza activaciones por batch, estabiliza entrenamiento, permite LR alto y regulariza.\",\n          \"isCorrect\": true,\n          \"text\": \"Implementar BatchNormalization\"\n        },\n        {\n          \"feedback\": \"Reduce LR ayuda, pero BatchNorm soluciona la raíz: distribuciones cambian entre capas.\",\n          \"isCorrect\": false,\n          \"text\": \"Bajar learning rate a 0.0001\"\n        },\n        {\n          \"feedback\": \"Más datos ideal, pero BatchNorm acelera convergencia con dataset actual.\",\n          \"isCorrect\": false,\n          \"text\": \"Recolectar más datos de fábrica\"\n        }\n      ],\n      \"question\": \"¿Para estabilizar el entrenamiento?\"\n    },\n    {\n      \"context\": \"BatchNorm después de conv y densas, {{NAME}}. ¡Pérdida suave ahora! Accuracy 82% train, pero valid 75% — overfitting claro. Validación baja en epochs 10+.\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrecto. Early stopping detecta, pero no previene; usa dropout para regularizar.\",\n          \"isCorrect\": false,\n          \"text\": \"Activar early stopping\"\n        },\n        {\n          \"feedback\": \"¡Sí! Dropout desactiva neuronas aleatoriamente (e.g., 0.5 en densas), fuerza redundancia y evita dependencia de neuronas específicas.\",\n          \"isCorrect\": true,\n          \"text\": \"Agregar Dropout en capas densas\"\n        },\n        {\n          \"feedback\": \"Más conv ayuda features, pero overfitting es en densas finales.\",\n          \"isCorrect\": false,\n          \"text\": \"Aumentar conv layers\"\n        },\n        {\n          \"feedback\": \"Data aug buena, pero dropout es rápido y efectivo en arquitectura.\",\n          \"isCorrect\": false,\n          \"text\": \"Data augmentation básica\"\n        }\n      ],\n      \"question\": \"¿Combatir el sobreajuste?\"\n    },\n    {\n      \"context\": \"Dropout 0.5 en las dos densas, {{NAME}}. Ahora train 80%, valid 79% — estable. Pero accuracy plafona en 82%. Dataset pequeño (5000 imgs), ¿profundizamos o... espera, probé VGG16 preentrenada y da 85% de una!\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrecto. Entrenar desde cero con más params puede overfit más en dataset chico.\",\n          \"isCorrect\": false,\n          \"text\": \"Hacer la CNN más profunda desde cero\"\n        },\n        {\n          \"feedback\": \"¡Excelente! Transfer learning usa capas tempranas preentrenadas (patrones generales como bordes) y fine-tunea las tardías para defectos específicos.\",\n          \"isCorrect\": true,\n          \"text\": \"Usar transfer learning con modelo preentrenado\"\n        },\n        {\n          \"feedback\": \"BatchNorm ya está; no soluciona plafón.\",\n          \"isCorrect\": false,\n          \"text\": \"Más BatchNorm layers\"\n        },\n        {\n          \"feedback\": \"Pooling ya óptimo; transfer aprovecha conocimiento previo.\",\n          \"isCorrect\": false,\n          \"text\": \"Cambiar a AveragePooling\"\n        }\n      ],\n      \"question\": \"¿Por qué plafona y qué hacemos?\"\n    },\n    {\n      \"context\": \"{{NAME}}, con VGG16 base (conv+pool+ReLU+BatchNorm implícito), congelé base y agregué densas con dropout. Fine-tune top: 88% valid. Pero twist: en fábrica nueva, luces cambian — ¿ajustamos o detectamos data shift?\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrecto. Reentrenar todo arriesga olvidar features generales.\",\n          \"isCorrect\": false,\n          \"text\": \"Descongelar todas las capas\"\n        },\n        {\n          \"feedback\": \"¡Correcto! Capas tempranas (conv básicas) capturan bordes invariantes; fine-tunea solo tardías (patrones altos) con tu data.\",\n          \"isCorrect\": true,\n          \"text\": \"Fine-tunear solo capas superiores\"\n        },\n        {\n          \"feedback\": \"Nuevo modelo pierde ventaja de preentrenado.\",\n          \"isCorrect\": false,\n          \"text\": \"Cambiar a ResNet nuevo\"\n        },\n        {\n          \"feedback\": \"Data shift real, pero transfer + tune maneja variaciones.\",\n          \"isCorrect\": false,\n          \"text\": \"Ignorar y deployar ya\"\n        }\n      ],\n      \"question\": \"¿Cómo adaptar al nuevo entorno?\"\n    },\n    {\n      \"context\": \"Fine-tune top layers solo, {{NAME}}. Ahora maneja luces nuevas: 90% valid. Twist mayor: logs muestran que defectos raros (clase 1%) confunden con normales por ruido en imgs raw. ¿Ajustamos arquitectura o data?\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrecto. Más data ideal, pero optimiza arquitectura primero para imbalance.\",\n          \"isCorrect\": false,\n          \"text\": \"Recolectar más data de clases raras\"\n        },\n        {\n          \"feedback\": \"¡Sí! Aumenta conv profundas para features complejas en clases raras, con pooling para robustez.\",\n          \"isCorrect\": true,\n          \"text\": \"Agregar conv+pool extra en transfer\"\n        },\n        {\n          \"feedback\": \"Dropout ya; enfócate en features.\",\n          \"isCorrect\": false,\n          \"text\": \"Subir dropout a 0.7\"\n        },\n        {\n          \"feedback\": \"Clases balanceadas ayudan post-arquitectura.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar class weights en loss\"\n        }\n      ],\n      \"question\": \"¿Para clases raras confusas?\"\n    },\n    {\n      \"context\": \"Conv extra + pool en top de transfer, {{NAME}}. Features refinan defectos sutiles. Accuracy 92%, F1 para raras sube a 0.85. ¿Integramos todo: ReLU, BatchNorm, Dropout?\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrecto. Omitir BatchNorm desestabiliza fine-tune.\",\n          \"isCorrect\": false,\n          \"text\": \"Quitar BatchNorm para velocidad\"\n        },\n        {\n          \"feedback\": \"¡Perfecto! Todo junto: conv/pool/ReLU para features, BatchNorm estabilidad, Dropout anti-overfit, transfer para data chica.\",\n          \"isCorrect\": true,\n          \"text\": \"Confirmar arquitectura completa optimizada\"\n        },\n        {\n          \"feedback\": \"Más epochs lento sin ganancias.\",\n          \"isCorrect\": false,\n          \"text\": \"Entrenar 100 epochs más\"\n        },\n        {\n          \"feedback\": \"LR bajo ya óptimo.\",\n          \"isCorrect\": false,\n          \"text\": \"Subir learning rate\"\n        }\n      ],\n      \"question\": \"¿Último check de optimizaciones?\"\n    },\n    {\n      \"context\": \"¡Arquitectura lista, {{NAME}}! CNN con transfer: conv preentrenadas + pool/ReLU/BatchNorm/Dropout en top. 93% accuracy, F1 0.91 en fábrica. Lección clave: diseña iterando estos bloques para problemas reales — ¡no MLP en imgs nunca más! Desplegamos.\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrecto. Podrías iterar más, pero esta resuelve con conceptos clave.\",\n          \"isCorrect\": false,\n          \"text\": \"Probar otra arquitectura (RNN)\"\n        },\n        {\n          \"feedback\": \"¡Sí! Resuelve: optimizamos paso a paso con conv, pool, ReLU, BatchNorm, Dropout y transfer para data real limitada.\",\n          \"isCorrect\": true,\n          \"text\": \"¡Arquitectura optimizada, deploy!\"\n        },\n        {\n          \"feedback\": \"Ya incluido.\",\n          \"isCorrect\": false,\n          \"text\": \"Agregar más pooling\"\n        },\n        {\n          \"feedback\": \"Completo ya.\",\n          \"isCorrect\": false,\n          \"text\": \"Otro dropout layer\"\n        }\n      ],\n      \"question\": \"¿Listos para producción?\"\n    }\n  ]\n}",
      "outputTokens": 2839,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "es-cs-neural-network-architecture-1",
      "userPrompt": "LESSON_TITLE: Arquitecturas de Deep Learning\nLESSON_DESCRIPTION: Disenando y optimizando arquitecturas de redes neuronales para problemas reales\nCHAPTER_TITLE: Arquitecturas de Redes Neuronales\nCOURSE_TITLE: Deep Learning Aplicado\nLANGUAGE: es\nEXPLANATION_STEPS:\n1. Capas Convolucionales: Las capas convolucionales detectan patrones locales usando filtros que se deslizan sobre la entrada. El mismo filtro se aplica en todas partes, lo que reduce parametros y captura patrones sin importar su posicion.\n2. Pooling: El pooling reduce la dimension espacial tomando el maximo o promedio de regiones. Esto hace la representacion mas compacta y algo invariante a pequenas traslaciones.\n3. Activaciones: Las funciones de activacion introducen no-linealidad. ReLU (max(0,x)) es popular por ser simple y evitar el problema del gradiente desvaneciente en capas profundas.\n4. Dropout: El dropout desactiva neuronas aleatoriamente durante el entrenamiento. Esto fuerza redundancia y reduce el sobreajuste — la red no puede depender de ninguna neurona especifica.\n5. Transfer Learning: El transfer learning usa redes pre-entrenadas en grandes datasets. Las capas tempranas aprenden patrones generales; las tardias se ajustan a tu tarea especifica.\n6. Batch Normalization: El batch normalization normaliza activaciones entre capas. Estabiliza el entrenamiento, permite tasas de aprendizaje mas altas, y actua como regularizador."
    },
    {
      "duration": 53615.63749999995,
      "inputTokens": 3311,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, the A/B test on our new checkout button color is done. Variant B shows 4% higher click-through rate, p-value 0.042. That's under 0.05—statistically significant! We should tell the product team to roll it out wide.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. While p<0.05 is often the threshold, rushing to reject H0 without checking other factors like power, effect size, or multiple tests risks poor decisions. Dig deeper first.\",\n          \"isCorrect\": false,\n          \"text\": \"Agree, significant. Recommend rollout.\"\n        },\n        {\n          \"feedback\": \"Wrong. P-value is not the probability the null is true (common misinterpretation). It's the probability of data this extreme or more if H0 is true. This tempts overconfidence.\",\n          \"isCorrect\": false,\n          \"text\": \"Yes, low p means H0 is probably false.\"\n        },\n        {\n          \"feedback\": \"Correct. A p-value of 0.042 provides evidence against H0 (no difference in CTR), but we must consider context like power, practical importance, and if multiple tests were run before deciding.\",\n          \"isCorrect\": true,\n          \"text\": \"Evidence against null, but let's check more.\"\n        },\n        {\n          \"feedback\": \"Wrong. 0.042 < 0.05 is conventionally significant, but dismissing it ignores valid evidence. Always interpret in context.\",\n          \"isCorrect\": false,\n          \"text\": \"Not significant enough. Need lower p.\"\n        }\n      ],\n      \"question\": \"How do you reply?\"\n    },\n    {\n      \"context\": \"Good call. Null hypothesis was no difference in CTR between A and B. This p-value means the chance of seeing this result or more extreme if no real difference is only 4.2%. Pretty unlikely coincidence.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. That's a misinterpretation—p-value isn't Prob(H0 true). It's Prob(data | H0 true), not vice versa.\",\n          \"isCorrect\": false,\n          \"text\": \"Correct, proves null is unlikely.\"\n        },\n        {\n          \"feedback\": \"Wrong. It doesn't measure effect strength; small effects can get low p with big samples.\",\n          \"isCorrect\": false,\n          \"text\": \"Confirms big practical effect.\"\n        },\n        {\n          \"feedback\": \"Correct. Precisely: p-value is the probability of observing data at least this extreme assuming H0 true. Not proof, but evidence to weigh.\",\n          \"isCorrect\": true,\n          \"text\": \"Exactly: Prob(data or extreme | H0).\"\n        },\n        {\n          \"feedback\": \"Wrong. We don't 'accept' H0; we fail to reject or reject based on evidence.\",\n          \"isCorrect\": false,\n          \"text\": \"Still can't reject null.\"\n        }\n      ],\n      \"question\": \"Clarify the p-value meaning?\"\n    },\n    {\n      \"context\": \"One thing—we didn't just test CTR. Also checked conversion rate (p=0.067), average order value (p=0.11), and bounce rate (p=0.053). CTR is the only one under 0.05.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Independent tests ignore family-wise error rate inflation.\",\n          \"isCorrect\": false,\n          \"text\": \"No issue, only CTR matters.\"\n        },\n        {\n          \"feedback\": \"Correct. Running multiple tests without correction increases Type I error chance (false positives). At alpha=0.05, expect 1 in 20 by chance.\",\n          \"isCorrect\": true,\n          \"text\": \"Multiple comparisons problem.\"\n        },\n        {\n          \"feedback\": \"Wrong. Higher p's don't invalidate low one; but uncorrected multi-testing does.\",\n          \"isCorrect\": false,\n          \"text\": \"Others not sig, so fine.\"\n        },\n        {\n          \"feedback\": \"Wrong. Decisions need full picture, not cherry-picking.\",\n          \"isCorrect\": false,\n          \"text\": \"Ignore others, focus on CTR.\"\n        }\n      ],\n      \"question\": \"What's the concern here?\"\n    },\n    {\n      \"context\": \"You're right. With 4 tests, chance of at least one false positive is about 18% (1-(0.95)^4). Bonferroni correction: divide alpha by 4 to 0.0125. Now none are significant.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Too lenient; doesn't control family-wise error rate.\",\n          \"isCorrect\": false,\n          \"text\": \"Skip correction, low risk.\"\n        },\n        {\n          \"feedback\": \"Correct. Bonferroni controls the probability of any false positives across tests conservatively. Essential for sound inference.\",\n          \"isCorrect\": true,\n          \"text\": \"Apply Bonferroni. Conservative.\"\n        },\n        {\n          \"feedback\": \"Wrong. FDR allows more discoveries but still controls false positives proportion.\",\n          \"isCorrect\": false,\n          \"text\": \"Use FDR instead.\"\n        },\n        {\n          \"feedback\": \"Wrong. Power drops but error control matters more here.\",\n          \"isCorrect\": false,\n          \"text\": \"Don't correct, hurts power.\"\n        }\n      ],\n      \"question\": \"Should we correct for multiples?\"\n    },\n    {\n      \"context\": \"Ok, post-correction no sig results. But our sample was only 800 per variant. Effect size was small: 4% lift on baseline 10% CTR.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correct. Power = prob of detecting true effect. Low n + small effect = low power, high Type II risk (missing real effect). Check it.\",\n          \"isCorrect\": true,\n          \"text\": \"Calculate statistical power.\"\n        },\n        {\n          \"feedback\": \"Wrong. Sample ok for sig, but power assesses Type II risk.\",\n          \"isCorrect\": false,\n          \"text\": \"Sample size sufficient.\"\n        },\n        {\n          \"feedback\": \"Wrong. Focus on power for sensitivity.\",\n          \"isCorrect\": false,\n          \"text\": \"Effect size looks good.\"\n        },\n        {\n          \"feedback\": \"Wrong. Decisions need power eval.\",\n          \"isCorrect\": false,\n          \"text\": \"Enough data, move on.\"\n        }\n      ],\n      \"question\": \"Next step?\"\n    },\n    {\n      \"context\": \"Ran the power analysis: at alpha=0.05, n=800/group, 4% effect? Power is only 0.28. We'd miss a real effect 72% of the time.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Low power means high Type II risk, but here post-correction no sig anyway.\",\n          \"isCorrect\": false,\n          \"text\": \"Low power? Run longer test.\"\n        },\n        {\n          \"feedback\": \"Correct. Low power highlights Type II risk (failing to reject false H0). Trade-off with Type I; explains why no sig post-correction.\",\n          \"isCorrect\": true,\n          \"text\": \"Notes Type II error risk.\"\n        },\n        {\n          \"feedback\": \"Wrong. Power low confirms caution.\",\n          \"isCorrect\": false,\n          \"text\": \"Power ok, proceed.\"\n        },\n        {\n          \"feedback\": \"Wrong. Can't minimize both errors.\",\n          \"isCorrect\": false,\n          \"text\": \"Adjust to boost power.\"\n        }\n      ],\n      \"question\": \"What does this mean?\"\n    },\n    {\n      \"context\": \"So no sig after correction, low power. But that 4% lift— is it meaningful? Baseline CTR 10%, so absolute +0.4%. Annual revenue impact? Maybe $10k for our traffic.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Ignores business context.\",\n          \"isCorrect\": false,\n          \"text\": \"Stat sig trumps practical.\"\n        },\n        {\n          \"feedback\": \"Correct. Practical significance checks if effect matters in real world, beyond stats. Tiny effects sig with big n, but here small n/small effect.\",\n          \"isCorrect\": true,\n          \"text\": \"Check practical significance.\"\n        },\n        {\n          \"feedback\": \"Wrong. Cost matters.\",\n          \"isCorrect\": false,\n          \"text\": \"Any lift is good.\"\n        },\n        {\n          \"feedback\": \"Wrong. Not worthless, but weigh.\",\n          \"isCorrect\": false,\n          \"text\": \"Dismiss tiny effect.\"\n        }\n      ],\n      \"question\": \"Key point?\"\n    },\n    {\n      \"context\": \"Product manager is pushing: 'p was 0.04 uncorrected, close enough. Roll out, low risk.' But rollout costs $50k, potential backlash if no real gain.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correct. Type I: false positive (roll out null effect, waste). Type II: miss real (opportunity cost). Here, Type I costlier given low power/no sig.\",\n          \"isCorrect\": true,\n          \"text\": \"Weigh Type I vs Type II costs.\"\n        },\n        {\n          \"feedback\": \"Wrong. Risks symmetric.\",\n          \"isCorrect\": false,\n          \"text\": \"Type I and II equal.\"\n        },\n        {\n          \"feedback\": \"Wrong. Downplays Type I.\",\n          \"isCorrect\": false,\n          \"text\": \"Favor Type II risk.\"\n        },\n        {\n          \"feedback\": \"Wrong. Type II higher here.\",\n          \"isCorrect\": false,\n          \"text\": \"Worry more about Type II.\"\n        }\n      ],\n      \"question\": \"How to respond to PM?\"\n    },\n    {\n      \"context\": \"{{NAME}}, plot twist—I just pulled the raw logs. We actually peeked at the data at day 10, saw CTR trending up, and let it run to 14 days. That's optional stopping, inflating p even more! Uncorrected p already dubious.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Early stop ok if planned.\",\n          \"isCorrect\": false,\n          \"text\": \"No big deal.\"\n        },\n        {\n          \"feedback\": \"Correct. Optional peeking invalidates p-value assumption (fixed sample). Inflates Type I massively, like multi-testing continuously.\",\n          \"isCorrect\": true,\n          \"text\": \"Optional stopping bias!\"\n        },\n        {\n          \"feedback\": \"Wrong. Doesn't fix inflation.\",\n          \"isCorrect\": false,\n          \"text\": \"Adjust p for it.\"\n        },\n        {\n          \"feedback\": \"Wrong. Still sig.\",\n          \"isCorrect\": false,\n          \"text\": \"Ignore, focus on trend.\"\n        }\n      ],\n      \"question\": \"What's the issue?\"\n    },\n    {\n      \"context\": \"Yep, with peeking, effective Type I rate way higher. No wonder uncorrected p dipped under 0.05. Quick replication test with fresh 2000 users: p=0.23, effect gone. Classic false positive.\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Still launch.\",\n          \"isCorrect\": false,\n          \"text\": \"Original p counts.\"\n        },\n        {\n          \"feedback\": \"Wrong. One test.\",\n          \"isCorrect\": false,\n          \"text\": \"Run more tests.\"\n        },\n        {\n          \"feedback\": \"Correct. All factors—multi-tests, low power, small effect, peeking—scream caution. Don't roll out; learned key lessons on proper hypothesis testing.\",\n          \"isCorrect\": true,\n          \"text\": \"Don't roll out. Lessons learned.\"\n        },\n        {\n          \"feedback\": \"Wrong. Practical small.\",\n          \"isCorrect\": false,\n          \"text\": \"Roll out anyway.\"\n        }\n      ],\n      \"question\": \"Final recommendation?\"\n    },\n    {\n      \"context\": \"Smart move, {{NAME}}. PM understood—defer rollout, plan powered test with preregistered endpoints and corrections. Won't forget: p-values evidence under H0, control errors, mind multiples/power/practicality. Saved us a flop!\",\n      \"options\": [\n        {\n          \"feedback\": \"Wrong. Not main takeaway.\",\n          \"isCorrect\": false,\n          \"text\": \"Focus on sample size.\"\n        },\n        {\n          \"feedback\": \"Wrong. Partial.\",\n          \"isCorrect\": false,\n          \"text\": \"P-value key.\"\n        },\n        {\n          \"feedback\": \"Correct. Reinforces full practice: correct null/p interp, error trade-offs, power, practical sig, multiple corrections. Applied stats in action.\",\n          \"isCorrect\": true,\n          \"text\": \"Key: holistic hypothesis testing.\"\n        },\n        {\n          \"feedback\": \"Wrong. Not just sig.\",\n          \"isCorrect\": false,\n          \"text\": \"Practical over stats.\"\n        }\n      ],\n      \"question\": \"What stuck with you?\"\n    }\n  ]\n}",
      "outputTokens": 3997,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "en-statistics-hypothesis-testing-1",
      "userPrompt": "LESSON_TITLE: Hypothesis Testing in Practice\nLESSON_DESCRIPTION: Applying statistical hypothesis testing correctly to make sound data-driven decisions\nCHAPTER_TITLE: Statistical Inference\nCOURSE_TITLE: Applied Statistics\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. Null Hypothesis: The null hypothesis (H0) is the default assumption of no effect. We try to reject it. The p-value measures how surprising the data would be IF the null were true.\n2. P-Value Meaning: A p-value is NOT the probability the null is true. It's the probability of seeing data this extreme (or more) if the null IS true. A common and dangerous misinterpretation.\n3. Error Types: Type I error (false positive) is rejecting a true null. Type II error (false negative) is failing to reject a false null. You can't minimize both — there's a trade-off.\n4. Statistical Power: Statistical power is the probability of detecting a real effect. It depends on sample size, effect size, and significance level. Low-powered studies miss real effects.\n5. Practical Significance: Statistical significance doesn't mean practical significance. A huge sample can detect tiny effects that don't matter in practice. Always consider effect size.\n6. Multiple Comparisons: Multiple comparisons inflate Type I errors. Testing 20 hypotheses at alpha=0.05 expects one false positive. Corrections like Bonferroni or FDR control this."
    },
    {
      "duration": 35199.03833299992,
      "inputTokens": 3279,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, the pharma client is breathing down our necks for that quantum simulation of their drug candidate molecule. I just ran it on the 20-qubit NISQ device. Results are noisy garbage — probabilities don't sum right, and energies are off by 20%. What do you think's happening?\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrect. Superposition is key for representing the full wavefunction, but the issue here is noise destroying it before readout.\",\n          \"isCorrect\": false,\n          \"text\": \"Superposition failed to initialize\"\n        },\n        {\n          \"feedback\": \"Correct. Decoherence is the main killer in NISQ devices — qubits lose quantum info to the environment quickly, scrambling the simulation before measurement.\",\n          \"isCorrect\": true,\n          \"text\": \"Decoherence during the run\"\n        },\n        {\n          \"feedback\": \"Incorrect. Entanglement is used in the sim for correlations, but noise affects all qubits regardless.\",\n          \"isCorrect\": false,\n          \"text\": \"Entanglement links broke\"\n        },\n        {\n          \"feedback\": \"Incorrect. Classical processing is reliable; the quantum part is failing.\",\n          \"isCorrect\": false,\n          \"text\": \"Post-processing bug\"\n        }\n      ],\n      \"question\": \"What's the likely culprit?\"\n    },\n    {\n      \"context\": \"Spot on, {{NAME}}. Logs show coherence time around 50 microseconds, but our variational circuit has depth 30. Superposition lets us explore the Hilbert space fast, but it decoheres before we optimize. How do we push forward?\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrect. Shallower circuits help but ignore the parallelism from superposition needed for efficient sim.\",\n          \"isCorrect\": false,\n          \"text\": \"Simplify to depth 10\"\n        },\n        {\n          \"feedback\": \"Correct. Leverage quantum parallelism via superposition to evaluate energy expectation on many states at once, speeding variational search despite noise.\",\n          \"isCorrect\": true,\n          \"text\": \"Use superposition parallelism\"\n        },\n        {\n          \"feedback\": \"Incorrect. More qubits amplify decoherence without correction.\",\n          \"isCorrect\": false,\n          \"text\": \"Scale to 30 qubits\"\n        },\n        {\n          \"feedback\": \"Incorrect. That's for later; first exploit what's there.\",\n          \"isCorrect\": false,\n          \"text\": \"Add error correction now\"\n        }\n      ],\n      \"question\": \"How to proceed despite noise?\"\n    },\n    {\n      \"context\": \"Exactly, {{NAME}}. With superposition, we're evaluating the Hamiltonian on 2^n states in parallel — that's the magic for sims classical can't touch. But readout gives garbage. Let's entangle some ancillary qubits for better measurement. Thoughts?\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrect. Direct measurement collapses superposition randomly; we need interference.\",\n          \"isCorrect\": false,\n          \"text\": \"Measure main register directly\"\n        },\n        {\n          \"feedback\": \"Incorrect. Entanglement helps correlations, but readout still needs care.\",\n          \"isCorrect\": false,\n          \"text\": \"Just entangle more qubits\"\n        },\n        {\n          \"feedback\": \"Correct. Use entanglement with ancillas to extract expectation values without fully collapsing the superposition prematurely.\",\n          \"isCorrect\": true,\n          \"text\": \"Ancilla entanglement readout\"\n        },\n        {\n          \"feedback\": \"Incorrect. Too advanced for NISQ coherence.\",\n          \"isCorrect\": false,\n          \"text\": \"Full tomography\"\n        }\n      ],\n      \"question\": \"Best measurement strategy?\"\n    },\n    {\n      \"context\": \"Good call, {{NAME}}. Entangled readout cleaned it up a bit — now energies are within 10% but still drifting. Parallelism shines in the variational loop, but cumulative errors build. Time to think error correction?\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrect. Repetition alone doesn't fix phase errors in superposition.\",\n          \"isCorrect\": false,\n          \"text\": \"Run circuit many times\"\n        },\n        {\n          \"feedback\": \"Correct. Quantum error correction encodes logical qubits across physical ones to protect superposition and entanglement from decoherence.\",\n          \"isCorrect\": true,\n          \"text\": \"Implement basic QEC\"\n        },\n        {\n          \"feedback\": \"Incorrect. More parallelism without protection worsens noise accumulation.\",\n          \"isCorrect\": false,\n          \"text\": \"Deeper parallelism\"\n        },\n        {\n          \"feedback\": \"Incorrect. Hardware can't sustain it yet.\",\n          \"isCorrect\": false,\n          \"text\": \"Fault-tolerant threshold\"\n        }\n      ],\n      \"question\": \"How to fight accumulating errors?\"\n    },\n    {\n      \"context\": \"You're right, {{NAME}}. Surface code on 3x3 grid protects one logical qubit — preserves superposition state. Encoded our main qubit, but now circuit depth tripled, and we need 9 physical for one logical. Fidelity up to 5% error, but sim time exploded. Tradeoff?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correct. Huge overhead is real: thousands of physical qubits per logical for full fault-tolerance, limiting NISQ apps.\",\n          \"isCorrect\": true,\n          \"text\": \"Accept QEC overhead limit\"\n        },\n        {\n          \"feedback\": \"Incorrect. Overhead already high; more worsens it.\",\n          \"isCorrect\": false,\n          \"text\": \"Bigger code distance\"\n        },\n        {\n          \"feedback\": \"Incorrect. Decoherence still hits.\",\n          \"isCorrect\": false,\n          \"text\": \"Ignore and run noisy\"\n        },\n        {\n          \"feedback\": \"Incorrect. Classical sim scales better here.\",\n          \"isCorrect\": false,\n          \"text\": \"Switch to classical\"\n        }\n      ],\n      \"question\": \"What's the QEC reality check?\"\n    },\n    {\n      \"context\": \"Precisely, {{NAME}}. Error correction works in principle but NISQ hardware can't afford the overhead for our 20-logical-qubit sim. Energies converging slowly, but client wants production-scale. Where does quantum really win here?\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrect. Factoring irrelevant for sim.\",\n          \"isCorrect\": false,\n          \"text\": \"Use Shor's for energies\"\n        },\n        {\n          \"feedback\": \"Incorrect. Optimization not core for exact sim.\",\n          \"isCorrect\": false,\n          \"text\": \"QAOA optimization\"\n        },\n        {\n          \"feedback\": \"Correct. Quantum excels at simulating quantum systems like molecules via parallelism — classical exponential in system size.\",\n          \"isCorrect\": true,\n          \"text\": \"Stick to quantum sim advantage\"\n        },\n        {\n          \"feedback\": \"Incorrect. Most don't; wrong problem.\",\n          \"isCorrect\": false,\n          \"text\": \"Replace all classical\"\n        }\n      ],\n      \"question\": \"Quantum's sweet spot?\"\n    },\n    {\n      \"context\": \"Yeah, {{NAME}}, for this 10-atom molecule, quantum parallelism gives edge over classical diagonalization. But wait — I re-ran on exact classical simulator. Our 'quantum advantage' energies match it perfectly, but slower. Hmm.\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrect. Scales better long-term.\",\n          \"isCorrect\": false,\n          \"text\": \"Quantum still faster\"\n        },\n        {\n          \"feedback\": \"Correct. Small systems don't show speedup yet; quantum shines for larger, strongly-correlated systems classical can't handle.\",\n          \"isCorrect\": true,\n          \"text\": \"No advantage for small sims\"\n        },\n        {\n          \"feedback\": \"Incorrect. Classical exact for small.\",\n          \"isCorrect\": false,\n          \"text\": \"Classical wrong\"\n        },\n        {\n          \"feedback\": \"Incorrect. Overhead hides it.\",\n          \"isCorrect\": false,\n          \"text\": \"QEC will fix speed\"\n        }\n      ],\n      \"question\": \"Why no speedup?\"\n    },\n    {\n      \"context\": \"True, {{NAME}}. This toy molecule is too small — classical matrix methods nail it in minutes. Quantum overhead kills any parallelism gain. Let's scale to their real 50-atom protein fragment. But coherence drops hard.\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrect. Larger worsens decoherence without more qubits.\",\n          \"isCorrect\": false,\n          \"text\": \"Push NISQ harder\"\n        },\n        {\n          \"feedback\": \"Incorrect. Overhead explodes quadratically.\",\n          \"isCorrect\": false,\n          \"text\": \"Heavy QEC now\"\n        },\n        {\n          \"feedback\": \"Correct. Hybrid: quantum for hard subsystems (entangled electrons), classical for rest.\",\n          \"isCorrect\": true,\n          \"text\": \"Hybrid quantum-classical\"\n        },\n        {\n          \"feedback\": \"Incorrect. Full quantum impossible.\",\n          \"isCorrect\": false,\n          \"text\": \"Abandon quantum\"\n        }\n      ],\n      \"question\": \"Strategy for larger system?\"\n    },\n    {\n      \"context\": \"Smart, {{NAME}}. Variational quantum eigensolver: quantum parallelism for expectation, classical optimizer. But plot twist — client's 'drug candidate' data? It's fabricated benchmark from a paper. Real molecule is classically tractable! They wanted hype.\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrect. Still use where possible.\",\n          \"isCorrect\": false,\n          \"text\": \"Force quantum anyway\"\n        },\n        {\n          \"feedback\": \"Incorrect. Client issue, but proceed.\",\n          \"isCorrect\": false,\n          \"text\": \"Confront later\"\n        },\n        {\n          \"feedback\": \"Incorrect. Twist doesn't negate sim skill.\",\n          \"isCorrect\": false,\n          \"text\": \"Ignore and finish\"\n        },\n        {\n          \"feedback\": \"Correct. Reinforces: quantum for problems needing it (large sims), not hype — know limitations.\",\n          \"isCorrect\": true,\n          \"text\": \"Advise classical for this\"\n        }\n      ],\n      \"question\": \"How to handle the twist?\"\n    },\n    {\n      \"context\": \"Perfect advice, {{NAME}}. Told client: quantum for future large-molecule sims where superposition/entanglement shine, but this benchmark? Classical tensor networks in hours. They get accurate results fast, we save face. Lesson learned.\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrect. Hype over substance.\",\n          \"isCorrect\": false,\n          \"text\": \"Promise quantum next time\"\n        },\n        {\n          \"feedback\": \"Incorrect. Overpromise.\",\n          \"isCorrect\": false,\n          \"text\": \"Scale up anyway\"\n        },\n        {\n          \"feedback\": \"Correct. Practical: match tool to problem — quantum where parallelism beats classical exponentials, despite decoherence/QEC hurdles.\",\n          \"isCorrect\": true,\n          \"text\": \"Right tool for job\"\n        },\n        {\n          \"feedback\": \"Incorrect. Abandon field.\",\n          \"isCorrect\": false,\n          \"text\": \"Drop client\"\n        }\n      ],\n      \"question\": \"Final takeaway action?\"\n    }\n  ]\n}",
      "outputTokens": 2866,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "en-physics-quantum-computing-basics-1",
      "userPrompt": "LESSON_TITLE: Quantum Computing Fundamentals\nLESSON_DESCRIPTION: Understanding quantum computing capabilities and limitations for practical problem-solving\nCHAPTER_TITLE: Quantum Information\nCOURSE_TITLE: Quantum Computing Fundamentals\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. Superposition: Qubits can exist in superposition — a weighted combination of 0 and 1 states. This isn't 'both at once' — it's a probability amplitude that interferes before measurement.\n2. Entanglement: Entanglement links qubits so measuring one instantly determines the other, regardless of distance. This correlation is a resource for quantum algorithms.\n3. Quantum Parallelism: Quantum parallelism lets algorithms evaluate functions on all inputs simultaneously. But you can only read one result — the art is using interference to amplify the right answer.\n4. Decoherence: Decoherence destroys quantum information when qubits interact with their environment. Real qubits are noisy and maintain coherence only briefly.\n5. Error Correction: Quantum error correction encodes logical qubits in many physical qubits. The overhead is huge — thousands of physical qubits per logical qubit for fault tolerance.\n6. Where Quantum Helps: Quantum advantage requires the right problem type. Factoring, simulation, and certain optimization problems benefit. Most classical algorithms won't be replaced."
    },
    {
      "duration": 33734.198250000016,
      "inputTokens": 3338,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, olha só esse caos no monolito. O sistema de e-commerce tá caindo com o pico de Black Friday chegando. Pedidos demoram 10s pra processar porque tudo tá acoplado. Acho que hora de migrar pra microserviços.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Microserviços são ideais para decompor monolitos sobrecarregados, permitindo desenvolvimento, deploy e escala independentes, alinhado à definição do conceito.\",\n          \"isCorrect\": true,\n          \"text\": \"Sim, vamos quebrar em microserviços independentes.\"\n        },\n        {\n          \"feedback\": \"Errado. Manter monolito não resolve a escalabilidade; microserviços permitem escalar partes específicas.\",\n          \"isCorrect\": false,\n          \"text\": \"Melhor otimizar o monolito atual.\"\n        },\n        {\n          \"feedback\": \"Errado. Refatorar internamente não quebra acoplamentos profundos; precisamos de serviços independentes.\",\n          \"isCorrect\": false,\n          \"text\": \"Refatorar o código monolítico.\"\n        },\n        {\n          \"feedback\": \"Errado. Adicionar cache ajuda, mas não resolve acoplamento total; microserviços descentralizam.\",\n          \"isCorrect\": false,\n          \"text\": \"Implementar cache no monolito.\"\n        }\n      ],\n      \"question\": \"Qual o próximo passo?\"\n    },\n    {\n      \"context\": \"Beleza, {{NAME}}. Vamos definir os limites dos serviços. Pelo domínio de negócio: um pra Produtos, outro pra Usuários, Pedidos e Pagamentos. Nada de separar por camadas técnicas.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Limites devem seguir domínios de negócio, como Pedidos ou Pagamentos, não camadas como 'Banco de Dados'. Isso mantém coesão.\",\n          \"isCorrect\": true,\n          \"text\": \"Definir por domínios: Pedidos, Pagamentos etc.\"\n        },\n        {\n          \"feedback\": \"Errado. Separar por camadas técnicas viola o princípio de limites de serviço por domínio de negócio.\",\n          \"isCorrect\": false,\n          \"text\": \"Serviço de Controller separado.\"\n        },\n        {\n          \"feedback\": \"Errado. Um serviço gigante ainda tem acoplamento; precisamos de granulares por domínio.\",\n          \"isCorrect\": false,\n          \"text\": \"Manter tudo num serviço E-commerce.\"\n        },\n        {\n          \"feedback\": \"Errado. Focar só em API não define limites claros por negócio.\",\n          \"isCorrect\": false,\n          \"text\": \"Criar serviço só de API Gateway.\"\n        }\n      ],\n      \"question\": \"Como definimos os limites?\"\n    },\n    {\n      \"context\": \"Perfeito, {{NAME}}. Temos os serviços: Produtos gerencia estoque, Pedidos cuida de compras, Pagamentos processa cartões. Agora, como eles se comunicam? REST síncrono ou eventos assíncronos?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Assíncrono via eventos é mais resiliente para picos, evitando falhas em cascata, mas requer observabilidade para debug.\",\n          \"isCorrect\": true,\n          \"text\": \"Usar comunicação assíncrona com eventos.\"\n        },\n        {\n          \"feedback\": \"Errado. Síncrono REST pode causar lentidão e falhas em cascata se um serviço falhar.\",\n          \"isCorrect\": false,\n          \"text\": \"REST síncrono pra tudo.\"\n        },\n        {\n          \"feedback\": \"Errado. gRPC é síncrono, bom para performance, mas menos resiliente que assíncrono em cenários de alta carga.\",\n          \"isCorrect\": false,\n          \"text\": \"gRPC síncrono.\"\n        },\n        {\n          \"feedback\": \"Errado. Filas sozinhas sem eventos perdem a notificação em tempo real.\",\n          \"isCorrect\": false,\n          \"text\": \"Só filas sem eventos.\"\n        }\n      ],\n      \"question\": \"Qual comunicação escolher?\"\n    },\n    {\n      \"context\": \"Boa escolha, {{NAME}}. Eventos assíncronos via Kafka: Pedidos emite 'pedidoCriado', Pagamentos consome. Cada serviço tem seu próprio banco: Produtos no Mongo, Pedidos no Postgres. Sem transações distribuídas.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Dados descentralizados por serviço evitam acoplamento, usando consistência eventual.\",\n          \"isCorrect\": true,\n          \"text\": \"Cada serviço com seu banco próprio.\"\n        },\n        {\n          \"feedback\": \"Errado. Banco compartilhado cria acoplamento forte e viola descentralização de dados.\",\n          \"isCorrect\": false,\n          \"text\": \"Banco SQL compartilhado.\"\n        },\n        {\n          \"feedback\": \"Errado. Transações distribuídas são difíceis e frágeis; evitar com consistência eventual.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar transações ACID distribuídas.\"\n        },\n        {\n          \"feedback\": \"Errado. NoSQL centralizado ainda acopla dados.\",\n          \"isCorrect\": false,\n          \"text\": \"MongoDB pra todos.\"\n        }\n      ],\n      \"question\": \"Como gerenciamos dados?\"\n    },\n    {\n      \"context\": \"Tá rodando em dev, {{NAME}}. Mas olha os logs: Pedidos tá lento porque espera resposta síncrona de Produtos pra checar estoque. Mesmo com eventos, tem chamadas REST pra validações. Precisamos de resiliência.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Circuit breakers e timeouts previnem falhas em cascata quando um serviço é lento.\",\n          \"isCorrect\": true,\n          \"text\": \"Adicionar circuit breakers e timeouts.\"\n        },\n        {\n          \"feedback\": \"Errado. Aumentar timeout só mascara o problema de dependência síncrona.\",\n          \"isCorrect\": false,\n          \"text\": \"Aumentar timeouts.\"\n        },\n        {\n          \"feedback\": \"Errado. Retry pode piorar cascata em sobrecarga.\",\n          \"isCorrect\": false,\n          \"text\": \"Implementar retries infinitos.\"\n        },\n        {\n          \"feedback\": \"Errado. Fallback sem circuit breaker não isola falhas.\",\n          \"isCorrect\": false,\n          \"text\": \"Só adicionar fallback básico.\"\n        }\n      ],\n      \"question\": \"Como tornamos resiliente?\"\n    },\n    {\n      \"context\": \"Circuit breaker no Pedidos pra Produtos: se falhar 5x, abre e usa fallback com estoque aproximado. Funcionou no teste, {{NAME}}. Mas em staging, uma falha em Pagamentos travou tudo. Logs são um inferno, cada serviço no seu stdout.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Observabilidade com logs centralizados, métricas e tracing distribuído é essencial pra debug em produção.\",\n          \"isCorrect\": true,\n          \"text\": \"Implementar logs centralizados e tracing.\"\n        },\n        {\n          \"feedback\": \"Errado. Logs locais dificultam correlação em sistemas distribuídos.\",\n          \"isCorrect\": false,\n          \"text\": \"Manter logs por serviço local.\"\n        },\n        {\n          \"feedback\": \"Errado. Métricas sozinhas não rastreiam fluxos entre serviços.\",\n          \"isCorrect\": false,\n          \"text\": \"Só adicionar métricas Prometheus.\"\n        },\n        {\n          \"feedback\": \"Errado. Alertas reagem, mas não ajudam a debugar causas raiz.\",\n          \"isCorrect\": false,\n          \"text\": \"Configurar alertas de falhas.\"\n        }\n      ],\n      \"question\": \"O que falta pra debugar?\"\n    },\n    {\n      \"context\": \"ELK Stack pros logs e Jaeger pro tracing, {{NAME}}. Agora vemos o fluxo completo. Mas tem picos: 30% dos pedidos falham porque Produtos demora no estoque real-time. Tracing mostra Pedidos consultando DB de Produtos diretamente!\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Isso viola limites de serviço e dados descentralizados; cada serviço deve ter seu DB e usar eventos.\",\n          \"isCorrect\": true,\n          \"text\": \"Corrigir: remover consulta direta ao DB alheio.\"\n        },\n        {\n          \"feedback\": \"Errado. Otimizar consulta só mascara violação de descentralização.\",\n          \"isCorrect\": false,\n          \"text\": \"Otimizar a query no DB de Produtos.\"\n        },\n        {\n          \"feedback\": \"Errado. Cache local ajuda, mas não resolve acoplamento de dados.\",\n          \"isCorrect\": false,\n          \"text\": \"Adicionar cache no Pedidos.\"\n        },\n        {\n          \"feedback\": \"Errado. Isso piora o problema de dependência síncrona.\",\n          \"isCorrect\": false,\n          \"text\": \"Fazer a consulta síncrona mais rápida.\"\n        }\n      ],\n      \"question\": \"Qual o problema real?\"\n    },\n    {\n      \"context\": \"Exato, {{NAME}}. O limite de Pedidos tava invadindo domínio de Produtos via DB direto. Migramos estoque pra eventos assíncronos: Produtos publica 'estoqueAtualizado', Pedidos consome e mantém snapshot local. Consistência eventual.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Eventos garantem desacoplamento, com consistência eventual aceitando trade-off por resiliência.\",\n          \"isCorrect\": true,\n          \"text\": \"Usar eventos pra sincronizar dados.\"\n        },\n        {\n          \"feedback\": \"Errado. gRPC síncrono recria o problema original de cascata.\",\n          \"isCorrect\": false,\n          \"text\": \"Migrar pra gRPC rápido.\"\n        },\n        {\n          \"feedback\": \"Errado. DB compartilhado volta ao acoplamento.\",\n          \"isCorrect\": false,\n          \"text\": \"Compartilhar schema de estoque.\"\n        },\n        {\n          \"feedback\": \"Errado. Polling consome recursos e não é event-driven.\",\n          \"isCorrect\": false,\n          \"text\": \"Polling periódico de estoque.\"\n        }\n      ],\n      \"question\": \"Como sincronizar estoque?\"\n    },\n    {\n      \"context\": \"Funcionou, {{NAME}}! Mas o twist: no tracing, vemos que Pagamentos tava fazendo transação distribuída com Pedidos pra garantir atomicidade. Tá falhando 10% das vezes por rede. Trade-off clássico.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Evitar transações distribuídas; usar sagas ou eventos pra consistência eventual, priorizando resiliência.\",\n          \"isCorrect\": true,\n          \"text\": \"Substituir por saga com eventos compensatórios.\"\n        },\n        {\n          \"feedback\": \"Errado. 2PC é frágil em redes distribuídas e viola dados descentralizados.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar 2-phase commit.\"\n        },\n        {\n          \"feedback\": \"Errado. Rollback manual é propenso a erros humanos.\",\n          \"isCorrect\": false,\n          \"text\": \"Implementar rollback manual.\"\n        },\n        {\n          \"feedback\": \"Errado. Timeout maior só atrasa falhas inevitáveis.\",\n          \"isCorrect\": false,\n          \"text\": \"Aumentar timeout da transação.\"\n        }\n      ],\n      \"question\": \"Como lidar com Pagamentos? (Twist)\"\n    },\n    {\n      \"context\": \"Saga implementada: Pedidos emite 'pagarPedido', Pagamentos processa ou emite 'rejeitarPedido' pra compensar. Circuit breaker aberto durante pico salvou o dia. Load test passou!\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Resiliência com circuit breakers + observabilidade permitiu identificar e fixar trade-offs.\",\n          \"isCorrect\": true,\n          \"text\": \"Monitorar com tracing e celebrar.\"\n        },\n        {\n          \"feedback\": \"Errado. Sem observabilidade, problemas voltam em produção.\",\n          \"isCorrect\": false,\n          \"text\": \"Remover tracing pra economizar.\"\n        },\n        {\n          \"feedback\": \"Errado. Sync total perde benefícios de microserviços.\",\n          \"isCorrect\": false,\n          \"text\": \"Voltar pra sync completo.\"\n        },\n        {\n          \"feedback\": \"Errado. Mais serviços agravam complexidade sem resolver raiz.\",\n          \"isCorrect\": false,\n          \"text\": \"Dividir em mais serviços.\"\n        }\n      ],\n      \"question\": \"Próximo passo final?\"\n    },\n    {\n      \"context\": \"{{NAME}}, missão cumprida. O sistema aguentou 10x o load, sem cascata. Lição: microserviços trazem independência, mas trade-offs como complexidade de dados e debug exigem resiliência e observabilidade certas.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! Reforça prática: limites por domínio, async, dados descentralizados, circuit breakers e tracing.\",\n          \"isCorrect\": true,\n          \"text\": \"Aplicar isso em produção.\"\n        },\n        {\n          \"feedback\": \"Errado. Ignorar trade-offs leva a falhas.\",\n          \"isCorrect\": false,\n          \"text\": \"Pular observabilidade.\"\n        },\n        {\n          \"feedback\": \"Errado. Sync simples recria monolito distribuído.\",\n          \"isCorrect\": false,\n          \"text\": \"Simplificar pra sync.\"\n        },\n        {\n          \"feedback\": \"Errado. Centralizar dados anula descentralização.\",\n          \"isCorrect\": false,\n          \"text\": \"Centralizar todos os DBs.\"\n        }\n      ],\n      \"question\": \"O que levamos disso?\"\n    }\n  ]\n}",
      "outputTokens": 2997,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "pt-cs-microservices-architecture-1",
      "userPrompt": "LESSON_TITLE: Microservicos na Pratica\nLESSON_DESCRIPTION: Projetando e implementando arquiteturas de microservicos com consciencia dos trade-offs\nCHAPTER_TITLE: Arquitetura de Software\nCOURSE_TITLE: Engenharia de Software Avancada\nLANGUAGE: pt\nEXPLANATION_STEPS:\n1. Definicao de Microservicos: Microservicos sao servicos pequenos e independentes que fazem uma coisa bem. Cada um pode ser desenvolvido, implantado e escalado separadamente.\n2. Limites de Servico: Limites de servico devem seguir dominios de negocio, nao camadas tecnicas. Um servico de 'Pedidos' faz sentido; um servico de 'Banco de Dados' nao.\n3. Comunicacao: A comunicacao entre servicos pode ser sincrona (REST, gRPC) ou assincrona (filas, eventos). Assincrona e mais resiliente mas mais complexa de debugar.\n4. Dados Descentralizados: Dados descentralizados significam que cada servico tem seu banco. Consistencia eventual e a realidade — transacoes distribuidas sao dificeis e devem ser evitadas.\n5. Resiliencia: Falhas em cascata acontecem quando um servico lento trava outros. Circuit breakers, timeouts e fallbacks sao essenciais para resiliencia.\n6. Observabilidade: Observabilidade requer logs centralizados, metricas e tracing distribuido. Sem isso, debugar problemas em producao e quase impossivel."
    },
    {
      "duration": 121080.68224999995,
      "inputTokens": 3326,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, en el proyecto de la planta química necesitamos un tanque cilíndrico de volumen fijo 10 m³. Minimizamos el área superficial A = 2πrh + 2πr² con πr²h = 10. Sustituyamos h = 10/(πr²).\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrecto. La sustitución correcta es h = 10/(πr²), entonces 2πr h = 2πr · 10/(πr²) = 20/r, más 2πr². Así A(r) = 20/r + 2πr².\",\n          \"isCorrect\": false,\n          \"text\": \"A(r) = 10/r + πr²\"\n        },\n        {\n          \"feedback\": \"Incorrecto. No olvides ambos tapas y laterales correctamente.\",\n          \"isCorrect\": false,\n          \"text\": \"A(r) = 2πr² + 20/r²\"\n        },\n        {\n          \"feedback\": \"¡Correcto! Buen modelado del problema. Expresar en una variable usando la restricción es clave para encontrar puntos críticos.\",\n          \"isCorrect\": true,\n          \"text\": \"A(r) = 20/r + 2πr²\"\n        },\n        {\n          \"feedback\": \"Incorrecto. Eso ignora la sustitución de h.\",\n          \"isCorrect\": false,\n          \"text\": \"A(r) = 2πrh sin sustituir\"\n        }\n      ],\n      \"question\": \"¿Cuál es la expresión correcta de A(r)?\"\n    },\n    {\n      \"context\": \"Perfecto, {{NAME}}. Ahora derivamos: A'(r) = -20/r² + 4πr. Igualamos a cero: 4πr³ = 20, r³ = 5/π ≈ 1.59, r ≈ 1.17 m.\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrecto. Eso sería para volumen diferente.\",\n          \"isCorrect\": false,\n          \"text\": \"r³ = 10/π\"\n        },\n        {\n          \"feedback\": \"Correcto. Los puntos críticos se encuentran donde A'(r)=0. Aquí resolvemos correctamente.\",\n          \"isCorrect\": true,\n          \"text\": \"r³ = 5/π\"\n        },\n        {\n          \"feedback\": \"Incorrecto. Eso es para máximo de área o error.\",\n          \"isCorrect\": false,\n          \"text\": \"r³ = 20/π\"\n        },\n        {\n          \"feedback\": \"Incorrecto. No es raíz cuadrada aquí.\",\n          \"isCorrect\": false,\n          \"text\": \"r = √(5/π)\"\n        }\n      ],\n      \"question\": \"¿Cuál es el valor de r³ en el punto crítico?\"\n    },\n    {\n      \"context\": \"Genial, {{NAME}}. Ahora la segunda derivada A''(r) = 40/r³ + 4π. En r ≈ 1.17, A'' > 0, así que es un mínimo local. h ≈ 2.33 m.\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrecto. A'' > 0 confirma mínimo local.\",\n          \"isCorrect\": false,\n          \"text\": \"Es máximo local\"\n        },\n        {\n          \"feedback\": \"Correcto. La prueba de segunda derivada clasifica correctamente: f'' > 0 implica mínimo local.\",\n          \"isCorrect\": true,\n          \"text\": \"Es mínimo local\"\n        },\n        {\n          \"feedback\": \"Incorrecto. A'' ≠ 0 aquí.\",\n          \"isCorrect\": false,\n          \"text\": \"Prueba inconclusa\"\n        },\n        {\n          \"feedback\": \"Incorrecto. No aplica primera derivada aquí.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar primera derivada sign chart\"\n        }\n      ],\n      \"question\": \"¿Qué indica A''(r) en el punto crítico?\"\n    },\n    {\n      \"context\": \"Bien visto. Para extremos globales, nota que A(r) → ∞ cuando r → 0+ y r → ∞, así que este es el mínimo global sin restricciones.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto. Siempre evaluar comportamiento en bordes del dominio para extremos globales.\",\n          \"isCorrect\": true,\n          \"text\": \"Sí, mínimo global\"\n        },\n        {\n          \"feedback\": \"Incorrecto. No hay extremos finitos del intervalo.\",\n          \"isCorrect\": false,\n          \"text\": \"Evaluar en r=0 y r=∞ no, pero sí límites\"\n        },\n        {\n          \"feedback\": \"Incorrecto. Ya es local y global por asintotas.\",\n          \"isCorrect\": false,\n          \"text\": \"No, revisar más puntos\"\n        },\n        {\n          \"feedback\": \"Incorrecto. Lagrange no aplica aquí.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar Lagrange\"\n        }\n      ],\n      \"question\": \"¿Es este el óptimo global?\"\n    },\n    {\n      \"context\": \"¡Problema, {{NAME}}! El espacio en la planta limita h ≤ 2 m. Pero h ≈ 2.33 > 2, viola. Recordemos h = 10/(πr²) ≤ 2 implica r ≥ √(10/(2π)) ≈ 1.26 m.\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrecto. Debemos respetar restricciones del mundo real.\",\n          \"isCorrect\": false,\n          \"text\": \"Ignorar y usar 1.17 m\"\n        },\n        {\n          \"feedback\": \"Correcto. Modelar correctamente incluye restricciones; ahora optimizar en dominio restringido r ≥ 1.26 m.\",\n          \"isCorrect\": true,\n          \"text\": \"Minimizar A(r) para r ≥ 1.26 m\"\n        },\n        {\n          \"feedback\": \"Incorrecto. Cambiar volumen viola spec.\",\n          \"isCorrect\": false,\n          \"text\": \"Aumentar volumen\"\n        },\n        {\n          \"feedback\": \"Incorrecto. Eso complica innecesariamente.\",\n          \"isCorrect\": false,\n          \"text\": \"Cambiar a rectangular\"\n        }\n      ],\n      \"question\": \"¿Qué hacemos con la restricción h ≤ 2 m?\"\n    },\n    {\n      \"context\": \"Exacto, {{NAME}}. El mínimo sin restricción está a la izquierda (r=1.17 < 1.26), y como A'' > 0, A aumenta para r > 1.17. Así, mínimo en el borde r ≈ 1.26 m, h=2 m.\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrecto. Como convexa, min en frontera.\",\n          \"isCorrect\": false,\n          \"text\": \"Buscar otro crítico interior\"\n        },\n        {\n          \"feedback\": \"Correcto. Para extremos globales en dominio cerrado, evaluar críticos interiores y bordes.\",\n          \"isCorrect\": true,\n          \"text\": \"Sí, óptimo en la frontera\"\n        },\n        {\n          \"feedback\": \"Incorrecto. No hay más críticos.\",\n          \"isCorrect\": false,\n          \"text\": \"Hay otro punto crítico\"\n        },\n        {\n          \"feedback\": \"Incorrecto. No es inconcluso.\",\n          \"isCorrect\": false,\n          \"text\": \"Segunda derivada en frontera=0\"\n        }\n      ],\n      \"question\": \"¿Dónde está el nuevo óptimo?\"\n    },\n    {\n      \"context\": \"¡Twist, {{NAME}}! El cliente dice que debe ser tanque rectangular para encajar en el módulo de producción: l, w, h > 0, lwh = 10, minimizar A = 2(lw + lh + wh). Sustitución posible, pero usemos Lagrange para restricciones.\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrecto. Sin restricción no funciona, parciales no cero.\",\n          \"isCorrect\": false,\n          \"text\": \"Derivadas parciales directas en A\"\n        },\n        {\n          \"feedback\": \"Incorrecto. Sustitución también funciona, pero Lagrange es sistemático para este caso.\",\n          \"isCorrect\": false,\n          \"text\": \"Solo sustitución h=10/(lw)\"\n        },\n        {\n          \"feedback\": \"Correcto. Modelado correcto: Lagrange para optimización con restricciones igualdad.\",\n          \"isCorrect\": true,\n          \"text\": \"Multiplicadores de Lagrange\"\n        },\n        {\n          \"feedback\": \"Incorrecto. No aplica aquí.\",\n          \"isCorrect\": false,\n          \"text\": \"Prueba segunda derivada sola\"\n        }\n      ],\n      \"question\": \"¿Método correcto para optimizar?\"\n    },\n    {\n      \"context\": \"Configuramos: ∇A = λ ∇g, g = lwh - 10 = 0. Entonces 2(w + h) = λ wh, 2(l + h) = λ lh, 2(l + w) = λ lw.\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrecto. No simétrico así.\",\n          \"isCorrect\": false,\n          \"text\": \"l = w ≠ h\"\n        },\n        {\n          \"feedback\": \"Correcto. Por simetría y resolviendo el sistema, l = w = h = 10^{1/3} ≈ 2.15 m son los puntos críticos.\",\n          \"isCorrect\": true,\n          \"text\": \"l = w = h\"\n        },\n        {\n          \"feedback\": \"Incorrecto. Eso sería para otro problema.\",\n          \"isCorrect\": false,\n          \"text\": \"l = 2h, w = h\"\n        },\n        {\n          \"feedback\": \"Incorrecto. No hay solución.\",\n          \"isCorrect\": false,\n          \"text\": \"Sistema inconsistente\"\n        }\n      ],\n      \"question\": \"¿Solución del sistema de Lagrange?\"\n    },\n    {\n      \"context\": \"¡Otro twist, {{NAME}}! Es tanque abierto (sin tapa superior): ahora A = lw + 2lh + 2wh, con lwh = 10. El modelo cambia, ¡hay que remodelar!\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrecto. Debemos ajustar el objetivo al nuevo modelado.\",\n          \"isCorrect\": false,\n          \"text\": \"Mantener A cerrada\"\n        },\n        {\n          \"feedback\": \"Correcto. Modelado del problema es clave: identificar función objetivo y restricciones correctamente ante cambios.\",\n          \"isCorrect\": true,\n          \"text\": \"Reconfigurar Lagrange con nuevo A\"\n        },\n        {\n          \"feedback\": \"Incorrecto. Sustitución no resuelve solo.\",\n          \"isCorrect\": false,\n          \"text\": \"Solo derivadas parciales\"\n        },\n        {\n          \"feedback\": \"Incorrecto. Volumen cambia no.\",\n          \"isCorrect\": false,\n          \"text\": \"Cambiar restricción\"\n        }\n      ],\n      \"question\": \"¿Cómo manejar el cambio a abierto?\"\n    },\n    {\n      \"context\": \"Usando Lagrange de nuevo o sustituyendo, encontramos l = w ≈ 2.51 m, h ≈ 1.59 m (l = w = (2·10)^{1/3}, h = 10/(l²)). A ≈ 30.5 m², peor que cilíndrico pero cumple. Lección: modela bien, chequea restricciones, usa técnicas adecuadas. ¡Proyecto salvado!\",\n      \"options\": [\n        {\n          \"feedback\": \"Incorrecto. Todas las decisiones aplicaron conceptos: puntos críticos, segundas derivadas, globales, Lagrange, modelado.\",\n          \"isCorrect\": false,\n          \"text\": \"Sobrestimamos complejidad\"\n        },\n        {\n          \"feedback\": \"Incorrecto. El cilíndrico no cabía.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar cilíndrico unconstrained\"\n        },\n        {\n          \"feedback\": \"Correcto. Resolución: cambiamos modelo por restricciones reales, usamos herramientas de optimización para resolver.\",\n          \"isCorrect\": true,\n          \"text\": \"¡Solucionado con optimización correcta!\"\n        },\n        {\n          \"feedback\": \"Incorrecto. No ignorar.\",\n          \"isCorrect\": false,\n          \"text\": \"Ignorar abierto\"\n        }\n      ],\n      \"question\": \"¿Cómo resolvemos finalmente?\"\n    }\n  ]\n}",
      "outputTokens": 10664,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "es-math-calculus-optimization-1",
      "userPrompt": "LESSON_TITLE: Optimizacion con Calculo\nLESSON_DESCRIPTION: Aplicando tecnicas de calculo para encontrar optimos en problemas de ingenieria y negocios\nCHAPTER_TITLE: Aplicaciones del Calculo\nCOURSE_TITLE: Calculo para Ingenieria\nLANGUAGE: es\nEXPLANATION_STEPS:\n1. Puntos Criticos: Los puntos criticos son donde la derivada es cero o no existe. Son CANDIDATOS a extremos — no todos los puntos criticos son maximos o minimos.\n2. Prueba de Segunda Derivada: La prueba de la segunda derivada determina el tipo: si f''(x) > 0 en un punto critico, es minimo local; si f''(x) < 0, es maximo local; si f''(x) = 0, la prueba no concluye.\n3. Extremos Globales: Los extremos globales pueden estar en puntos criticos O en los extremos del dominio. Siempre evalua tambien los bordes del intervalo.\n4. Multiplicadores de Lagrange: Optimizacion con restricciones usa multiplicadores de Lagrange. Maximizar f(x,y) sujeto a g(x,y)=0 requiere que los gradientes sean paralelos.\n5. Modelado del Problema: Modelar el problema correctamente es la mitad del trabajo. Define la funcion objetivo, identifica las restricciones, y expresa todo en terminos de las variables relevantes."
    }
  ],
  "taskId": "activity-story"
}
