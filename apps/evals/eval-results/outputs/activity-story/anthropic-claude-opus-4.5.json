{
  "generatedAt": "2026-01-17T15:45:52.351Z",
  "modelId": "anthropic/claude-opus-4.5",
  "outputs": [
    {
      "duration": 106524.2255,
      "inputTokens": 4218,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, we've got a problem. The checkout API is throwing runtime errors in production — 'Cannot read property length of undefined' — and it's happening randomly. I've been looking at the order processing code and I think I see why. We're passing user data around without any type annotations. Should we add some type safety here?\",\n      \"options\": [\n        {\n          \"feedback\": \"Exactly right! Type safety catches errors at compile time instead of runtime. Once TypeScript knows the types, it can prevent operations like calling .length on undefined before the code even runs.\",\n          \"isCorrect\": true,\n          \"text\": \"Add type annotations to catch errors early\"\n        },\n        {\n          \"feedback\": \"Try-catch only handles errors after they happen at runtime. We want to catch these bugs at compile time, before the code ever runs in production. Type annotations are the answer.\",\n          \"isCorrect\": false,\n          \"text\": \"Add more try-catch blocks around the code\"\n        },\n        {\n          \"feedback\": \"Logging helps find bugs after they occur, but doesn't prevent them. Type safety catches these errors at compile time — before the code runs — which is far more effective than runtime debugging.\",\n          \"isCorrect\": false,\n          \"text\": \"Add console.log statements to debug it\"\n        },\n        {\n          \"feedback\": \"Manual checks are error-prone and tedious. With proper type annotations, TypeScript will tell you exactly where undefined is possible and force you to handle it. Let the compiler do the work.\",\n          \"isCorrect\": false,\n          \"text\": \"Just check for undefined everywhere\"\n        }\n      ],\n      \"question\": \"What's the first step to prevent these runtime errors?\"\n    },\n    {\n      \"context\": \"Good call. I started adding types and found something interesting. Look at this — we have a CustomerData interface in the billing module and a UserInfo interface in the auth module. They have the exact same properties: id, email, and name. The checkout code accepts CustomerData, but we're passing UserInfo from auth. It's not throwing errors though. Why isn't TypeScript complaining?\",\n      \"options\": [\n        {\n          \"feedback\": \"Exactly! TypeScript uses structural typing — it cares about shape, not names. Since UserInfo and CustomerData have the same structure, they're compatible. This is actually a feature, not a bug.\",\n          \"isCorrect\": true,\n          \"text\": \"TypeScript uses structural typing\"\n        },\n        {\n          \"feedback\": \"Not a bug! TypeScript intentionally uses structural typing. It checks if types have compatible shapes, not matching names. Two types with the same properties are interchangeable.\",\n          \"isCorrect\": false,\n          \"text\": \"It's a TypeScript bug we should report\"\n        },\n        {\n          \"feedback\": \"No casting needed here. TypeScript uses structural typing — it compares the shape of types, not their names. If two types have the same properties, they're compatible automatically.\",\n          \"isCorrect\": false,\n          \"text\": \"Someone cast it with 'as CustomerData'\"\n        },\n        {\n          \"feedback\": \"No inheritance required. TypeScript's structural typing means any object with the right properties matches the type. Shape matters, not how the type was defined or named.\",\n          \"isCorrect\": false,\n          \"text\": \"The interfaces must secretly extend each other\"\n        }\n      ],\n      \"question\": \"Why does TypeScript accept UserInfo where CustomerData is expected?\"\n    },\n    {\n      \"context\": \"That makes sense — structural typing. Okay, I found the actual bug. Look at this function: it takes an order parameter and immediately calls order.items.length. But sometimes order.items is undefined when orders have no items yet. TypeScript isn't catching it because items is typed as Item[] | undefined. We need to handle this properly.\",\n      \"options\": [\n        {\n          \"feedback\": \"Perfect! This is type narrowing. Inside an if-block that checks for undefined, TypeScript knows items definitely exists. It narrows the type from 'Item[] | undefined' to just 'Item[]'.\",\n          \"isCorrect\": true,\n          \"text\": \"Check if items exists first, then access it\"\n        },\n        {\n          \"feedback\": \"The non-null assertion (!) tells TypeScript to trust you, but that's exactly how we got runtime errors! We need to actually check for undefined, which narrows the type safely.\",\n          \"isCorrect\": false,\n          \"text\": \"Use items!.length to assert it exists\"\n        },\n        {\n          \"feedback\": \"Casting lies to the compiler and doesn't make undefined go away at runtime. Use an if-check instead — TypeScript will narrow the type and you'll be safe.\",\n          \"isCorrect\": false,\n          \"text\": \"Cast order.items as Item[] to fix it\"\n        },\n        {\n          \"feedback\": \"If items really can be undefined, lying about the type causes runtime crashes. The right fix is type narrowing: check for undefined first, then TypeScript knows it's safe inside that block.\",\n          \"isCorrect\": false,\n          \"text\": \"Change the type to just Item[]\"\n        }\n      ],\n      \"question\": \"How should we safely access items.length?\"\n    },\n    {\n      \"context\": \"Type narrowing fixed that one! Now I'm looking at our utility functions and there's something weird. We have three nearly identical functions: formatUserName, formatProductName, and formatOrderName. They all do the same thing — take an object and return a formatted name string. This is a lot of duplication. Can we make one function that works for all of them?\",\n      \"options\": [\n        {\n          \"feedback\": \"Yes! Generic types let you write reusable code that works with multiple types while preserving type information. Something like formatName<T extends { name: string }>(item: T) works for any type with a name.\",\n          \"isCorrect\": true,\n          \"text\": \"Use generics to preserve type info\"\n        },\n        {\n          \"feedback\": \"'Any' disables type checking entirely — you'd lose all safety. Generics are better: they let you write flexible code while TypeScript still tracks the actual types being used.\",\n          \"isCorrect\": false,\n          \"text\": \"Use 'any' for the parameter type\"\n        },\n        {\n          \"feedback\": \"That works but requires changing all existing interfaces. Generics are more flexible — you can constrain to any shape without modifying existing types. Plus, generics preserve the specific type info.\",\n          \"isCorrect\": false,\n          \"text\": \"Create a base interface they all extend\"\n        },\n        {\n          \"feedback\": \"Casting throws away type information and can hide bugs. Generics preserve the exact type while allowing flexible, reusable code. You get both safety and reusability.\",\n          \"isCorrect\": false,\n          \"text\": \"Just pick one and cast the others\"\n        }\n      ],\n      \"question\": \"How can we create one reusable function for all these types?\"\n    },\n    {\n      \"context\": \"Nice, I refactored it with generics and it's way cleaner now. Okay, new problem — I'm reviewing some code from the intern and... {{NAME}}, they've used 'any' everywhere. The API response handler, the form data processor, even the database queries. They said 'it made the errors go away.' What do we tell them?\",\n      \"options\": [\n        {\n          \"feedback\": \"Exactly. 'Any' is an escape hatch that defeats the purpose of TypeScript. The errors 'went away' because TypeScript stopped checking. Those bugs are still there — they'll just crash at runtime instead.\",\n          \"isCorrect\": true,\n          \"text\": \"It disables type checking entirely\"\n        },\n        {\n          \"feedback\": \"'Any' doesn't affect runtime performance — types are erased during compilation. The real problem is it disables type checking, so TypeScript can't catch bugs. You lose all compile-time safety.\",\n          \"isCorrect\": false,\n          \"text\": \"It makes the code run slower\"\n        },\n        {\n          \"feedback\": \"'Any' isn't deprecated, but it does defeat the purpose of TypeScript by disabling type checking. The errors disappear because TypeScript stops looking — the bugs are still there, just hidden.\",\n          \"isCorrect\": false,\n          \"text\": \"It's deprecated in newer TypeScript\"\n        },\n        {\n          \"feedback\": \"Types don't affect bundle size since they're erased at compile time. The real issue is 'any' disables type checking completely. TypeScript can't catch bugs if it doesn't know the types.\",\n          \"isCorrect\": false,\n          \"text\": \"It makes the bundle size larger\"\n        }\n      ],\n      \"question\": \"What's the problem with using 'any' everywhere?\"\n    },\n    {\n      \"context\": \"I explained that to them. They asked what to use instead when we genuinely don't know the type — like when parsing JSON from an external API. That's a fair question actually. We can't always know the exact shape of incoming data.\",\n      \"options\": [\n        {\n          \"feedback\": \"Perfect! 'Unknown' is the type-safe alternative to 'any'. It forces you to validate and narrow the type before using the data. You can't accidentally call methods on unknown without checking first.\",\n          \"isCorrect\": true,\n          \"text\": \"Use 'unknown' and validate the data\"\n        },\n        {\n          \"feedback\": \"'Any' disables all checking, which is dangerous for external data. 'Unknown' is the safe alternative — it forces you to validate the data before using it, ensuring type safety.\",\n          \"isCorrect\": false,\n          \"text\": \"Use 'any' since we don't know the type\"\n        },\n        {\n          \"feedback\": \"'Object' is too vague and doesn't help with validation. 'Unknown' is better — it explicitly signals uncertainty and forces you to narrow the type before accessing any properties.\",\n          \"isCorrect\": false,\n          \"text\": \"Use 'object' as a generic type\"\n        },\n        {\n          \"feedback\": \"Defining an interface describes what you expect, but doesn't guarantee the data matches. With 'unknown', TypeScript forces you to validate before using the data — catching shape mismatches.\",\n          \"isCorrect\": false,\n          \"text\": \"Just define the expected interface\"\n        }\n      ],\n      \"question\": \"What should they use when the type truly isn't known?\"\n    },\n    {\n      \"context\": \"The intern is catching on. They're rewriting the API handler with 'unknown' now, but they're stuck. They need to check if the response is a valid Order object before processing it. A simple typeof check won't work for objects. They need something more sophisticated to tell TypeScript 'yes, this is definitely an Order.'\",\n      \"options\": [\n        {\n          \"feedback\": \"Exactly! Type guards are functions that return a type predicate like 'data is Order'. They validate the structure and tell TypeScript what the type is after the check passes.\",\n          \"isCorrect\": true,\n          \"text\": \"Write a type guard function\"\n        },\n        {\n          \"feedback\": \"Casting doesn't validate anything — it just tells TypeScript to trust you. If the data isn't actually an Order, you'll get runtime errors. Type guards actually check the structure.\",\n          \"isCorrect\": false,\n          \"text\": \"Cast it with 'as Order'\"\n        },\n        {\n          \"feedback\": \"'Instanceof' only works with classes, not interfaces or object shapes from JSON. Type guards let you check for specific properties and return a type predicate TypeScript understands.\",\n          \"isCorrect\": false,\n          \"text\": \"Use instanceof Order\"\n        },\n        {\n          \"feedback\": \"Typeof only returns 'object' for objects — it can't distinguish Order from any other object. You need a type guard that checks specific properties and returns a type predicate.\",\n          \"isCorrect\": false,\n          \"text\": \"Check with typeof data === 'Order'\"\n        }\n      ],\n      \"question\": \"What technique should they use to validate the Order type?\"\n    },\n    {\n      \"context\": \"They wrote a nice isOrder type guard that checks for id, items, and total properties. TypeScript is happy and the code is actually safe now. Hold on... {{NAME}}, I'm getting a Slack message from the platform team. They just pushed a change to the Order API. Orders now have an optional 'discounts' array, and if present, we need to apply them before calculating the total. Our type guard doesn't know about this.\",\n      \"options\": [\n        {\n          \"feedback\": \"Right approach! Add 'discounts?: Discount[]' to the Order interface. Then use type narrowing (if order.discounts) before accessing it. TypeScript will know it exists inside that block.\",\n          \"isCorrect\": true,\n          \"text\": \"Add discounts to the interface, narrow when used\"\n        },\n        {\n          \"feedback\": \"If discounts is optional in the API, making it required in our type is a lie. Old orders won't have it. Use an optional property with '?' and narrow when accessing it.\",\n          \"isCorrect\": false,\n          \"text\": \"Make discounts required in the interface\"\n        },\n        {\n          \"feedback\": \"TypeScript will error since discounts isn't in the Order type. Update the interface to include 'discounts?: Discount[]', then use type narrowing to safely access it when present.\",\n          \"isCorrect\": false,\n          \"text\": \"Just access discounts without changing types\"\n        },\n        {\n          \"feedback\": \"Using 'any' throws away all type safety. The right approach is adding the optional property to the interface and using type narrowing to safely handle orders with and without discounts.\",\n          \"isCorrect\": false,\n          \"text\": \"Use any for orders with discounts\"\n        }\n      ],\n      \"question\": \"How should we update our code for the new discounts field?\"\n    },\n    {\n      \"context\": \"Perfect, I updated the Order interface and added narrowing for discounts. The code is solid. But wait — {{NAME}}, the intern just pushed something to staging. They wrote a generic discount calculator: applyDiscount<T>(item: T, discount: number). But it's not working. They're trying to access item.price inside the function, but TypeScript says 'price' doesn't exist on type T.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correct! Unconstrained generics know nothing about the type. Use 'T extends { price: number }' to tell TypeScript that T will always have a price property. Then item.price works.\",\n          \"isCorrect\": true,\n          \"text\": \"T needs a constraint requiring price\"\n        },\n        {\n          \"feedback\": \"Generics can access properties — you just need to constrain them. Use 'T extends { price: number }' and TypeScript knows T has price. Unconstrained generics are too vague.\",\n          \"isCorrect\": false,\n          \"text\": \"Generics can't access properties at all\"\n        },\n        {\n          \"feedback\": \"'Any' disables type checking entirely. The fix is constraining T with 'extends { price: number }'. This preserves type safety while telling TypeScript that T has a price property.\",\n          \"isCorrect\": false,\n          \"text\": \"They should use any instead of T\"\n        },\n        {\n          \"feedback\": \"Casting defeats type safety. The right fix is adding a constraint: 'T extends { price: number }'. This tells TypeScript that T will have price, keeping the function fully type-safe.\",\n          \"isCorrect\": false,\n          \"text\": \"They need to cast item as any first\"\n        }\n      ],\n      \"question\": \"What's wrong with their generic function?\"\n    },\n    {\n      \"context\": \"They added the constraint and it works now. Actually, {{NAME}}, the whole checkout flow is looking really solid. Type annotations catching errors early, structural typing keeping things flexible, narrowing for safety, generics for reusability, and proper type guards for validation. Wait — one more Slack message. Oh no.\",\n      \"options\": [\n        {\n          \"feedback\": \"You're bracing for impact. Good instinct when dealing with production systems and eager interns. Let's see what this message says...\",\n          \"isCorrect\": true,\n          \"text\": \"Something unexpected with the types\"\n        },\n        {\n          \"feedback\": \"They've learned that lesson! But you're right to be suspicious. Something's definitely up with this message. Let's find out what went wrong this time.\",\n          \"isCorrect\": false,\n          \"text\": \"The intern used any again\"\n        },\n        {\n          \"feedback\": \"Our type coverage is pretty solid now... but you're right to be worried. Production always finds a way to surprise you. Let's see what happened.\",\n          \"isCorrect\": false,\n          \"text\": \"A runtime type error slipped through\"\n        },\n        {\n          \"feedback\": \"Optimistic! But that 'Oh no' suggests otherwise. Let's see what fresh adventure awaits us in this Slack message.\",\n          \"isCorrect\": false,\n          \"text\": \"Nothing, probably good news for once\"\n        }\n      ],\n      \"question\": \"What could possibly go wrong now?\"\n    },\n    {\n      \"context\": \"{{NAME}}... the platform team's 'Order API update' wasn't the only change. They also changed the Order ID from a number to a string — a UUID now. But they didn't tell anyone. Our type guard still checks 'typeof id === number' and it's rejecting every single order in production. Nothing's getting through. The whole checkout is down.\",\n      \"options\": [\n        {\n          \"feedback\": \"That's the immediate fix! Update the type guard to check for string, update the Order interface to match, and orders will flow again. Then have a chat with the platform team about communication...\",\n          \"isCorrect\": true,\n          \"text\": \"Update the check to typeof id === 'string'\"\n        },\n        {\n          \"feedback\": \"Removing validation entirely would let invalid data through and cause runtime errors elsewhere. Fix the guard to check for string instead of number, then update the Order interface.\",\n          \"isCorrect\": false,\n          \"text\": \"Remove the type guard entirely\"\n        },\n        {\n          \"feedback\": \"Converting UUIDs to numbers would lose data and break things. The API sends strings now — update the type guard and interface to expect strings. That's the correct fix.\",\n          \"isCorrect\": false,\n          \"text\": \"Convert all IDs to numbers in the guard\"\n        },\n        {\n          \"feedback\": \"Using 'any' masks the problem instead of fixing it. Update the type guard to check for string and fix the Order interface. Type safety should match reality, not hide from it.\",\n          \"isCorrect\": false,\n          \"text\": \"Use any for the id field temporarily\"\n        }\n      ],\n      \"question\": \"What's the immediate fix for the type guard?\"\n    },\n    {\n      \"context\": \"Fixed! Orders are flowing again. {{NAME}}, I just realized something. If our types had been the source of truth — if the platform team's API was generated from TypeScript interfaces — we would have seen this breaking change in a PR before it ever hit production. Type safety isn't just about catching bugs in our code. It's about making changes visible and intentional.\",\n      \"options\": [\n        {\n          \"feedback\": \"Exactly! Type safety does more than catch bugs — it makes your system's contracts explicit. When types are shared and enforced, breaking changes become visible in code review, not in production incidents.\",\n          \"isCorrect\": true,\n          \"text\": \"Types document contracts and make changes visible\"\n        },\n        {\n          \"feedback\": \"The trust issue is real, but the deeper insight is that types make contracts explicit. With shared types, breaking changes appear in PRs, not production. Types are documentation that compilers enforce.\",\n          \"isCorrect\": false,\n          \"text\": \"Never trust other teams with API changes\"\n        },\n        {\n          \"feedback\": \"Type guards aren't fragile — they caught the mismatch! The issue was the API contract changed silently. Shared types between teams would have made this change visible before deployment.\",\n          \"isCorrect\": false,\n          \"text\": \"Type guards are too fragile for production\"\n        },\n        {\n          \"feedback\": \"'Any' would have let the bug through silently, causing mysterious runtime errors. Our types caught the mismatch quickly. The lesson is to share types across teams so changes are coordinated.\",\n          \"isCorrect\": false,\n          \"text\": \"We should have used any to be flexible\"\n        }\n      ],\n      \"question\": \"What's the key insight from this whole experience?\"\n    }\n  ]\n}",
      "outputTokens": 4949,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "en-cs-typescript-type-safety-1",
      "userPrompt": "LESSON_TITLE: Type Safety in Practice\nLESSON_DESCRIPTION: Applying TypeScript's type system to catch bugs early and write more maintainable code\nCHAPTER_TITLE: Type Systems\nCOURSE_TITLE: Advanced TypeScript\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. Compile-Time Safety: Type safety catches errors at compile time instead of runtime. When TypeScript knows a variable's type, it can prevent operations that would fail — like calling .length on undefined.\n2. Structural Typing: TypeScript uses structural typing — it cares about shape, not names. Two types are compatible if they have the same structure, even if defined separately.\n3. Type Narrowing: Type narrowing lets TypeScript understand more specific types after checks. Inside an if-block that checks for null, TypeScript knows the value isn't null.\n4. Generics: Generic types let you write reusable code that works with multiple types while preserving type information. Array<T> knows what's inside, unlike just 'Array'.\n5. Any vs Unknown: The 'any' type disables type checking entirely. It's an escape hatch but defeats the purpose of TypeScript. Use 'unknown' when the type truly isn't known.\n6. Type Guards: Type guards are functions that narrow types. They return a type predicate that tells TypeScript what the type is after the check passes."
    },
    {
      "duration": 75329.36837499996,
      "inputTokens": 4176,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, I'm glad you picked up. We've got a situation. Remember that new market we're trying to enter? Our main competitor just announced they're slashing prices by 20%. The CEO wants our recommendation in an hour. Do we match their price cut or hold firm?\",\n      \"options\": [\n        {\n          \"feedback\": \"Rushing to match ignores strategic interdependence. Your outcome depends on how they'll respond to your response. You need to think through the whole interaction, not just react.\",\n          \"isCorrect\": false,\n          \"text\": \"Match their price immediately\"\n        },\n        {\n          \"feedback\": \"Exactly right. This is classic game theory — your best move depends on their likely responses, and theirs on yours. Understanding the strategic structure first will lead to a better decision.\",\n          \"isCorrect\": true,\n          \"text\": \"Analyze it as a strategic interaction\"\n        },\n        {\n          \"feedback\": \"In competitive markets, you can't ignore rivals. Your outcome depends on their choices too. This is strategic interdependence — what you should do depends on what they do.\",\n          \"isCorrect\": false,\n          \"text\": \"Ignore them and focus on our costs\"\n        },\n        {\n          \"feedback\": \"That's premature without analyzing the situation. Game theory helps us find optimal strategies in competitive situations — sometimes the right move isn't obvious at first glance.\",\n          \"isCorrect\": false,\n          \"text\": \"Exit the market entirely\"\n        }\n      ],\n      \"question\": \"How should you frame this pricing decision?\"\n    },\n    {\n      \"context\": \"Smart. Okay, so let's map this out. If we both keep prices high, we each make solid margins. If we both cut prices, we're in a race to the bottom — lower profits for everyone. But here's the thing: if only ONE of us cuts while the other holds, the cutter takes most of the market share.\",\n      \"options\": [\n        {\n          \"feedback\": \"Spot on. Each company has an incentive to cut (their dominant strategy), but if both cut, both end up worse off than if they'd cooperated on high prices. Classic collective irrationality from individual rationality.\",\n          \"isCorrect\": true,\n          \"text\": \"A prisoner's dilemma\"\n        },\n        {\n          \"feedback\": \"Not quite. In a zero-sum game, one player's gain equals another's loss. Here, mutual price-cutting can destroy value for BOTH companies — that's what makes the dilemma so tricky.\",\n          \"isCorrect\": false,\n          \"text\": \"A zero-sum game\"\n        },\n        {\n          \"feedback\": \"Coordination games are about aligning on the same strategy. This is different — each side is tempted to defect even when cooperation would be better for both.\",\n          \"isCorrect\": false,\n          \"text\": \"A coordination game\"\n        },\n        {\n          \"feedback\": \"This could involve sequential moves, but the core structure — temptation to defect despite mutual benefit from cooperation — is a prisoner's dilemma.\",\n          \"isCorrect\": false,\n          \"text\": \"A sequential game\"\n        }\n      ],\n      \"question\": \"What classic game theory structure does this resemble?\"\n    },\n    {\n      \"context\": \"Right, it's a prisoner's dilemma. So here's what's bugging me. If cutting prices is our dominant strategy — best for us no matter what they do — shouldn't we just... do it? That's what game theory says, right?\",\n      \"options\": [\n        {\n          \"feedback\": \"In a one-shot game, yes. But the prisoner's dilemma shows how individual rationality leads to collective irrationality. Both choosing dominant strategies leaves BOTH worse off than mutual cooperation.\",\n          \"isCorrect\": false,\n          \"text\": \"Yes, always play your dominant strategy\"\n        },\n        {\n          \"feedback\": \"They do exist here — cutting IS dominant for each player in isolation. The problem is that when both play their dominant strategy, the outcome is worse for everyone.\",\n          \"isCorrect\": false,\n          \"text\": \"No, dominant strategies don't exist\"\n        },\n        {\n          \"feedback\": \"Exactly! In repeated interactions, the calculus changes. Future punishment for defection makes cooperation rational. If you'll see each other again, today's defection invites tomorrow's retaliation.\",\n          \"isCorrect\": true,\n          \"text\": \"It depends on whether we'll compete again\"\n        },\n        {\n          \"feedback\": \"Cost structure matters for pricing, but the strategic question here is about interdependence. The key insight is whether this is a one-time interaction or an ongoing relationship.\",\n          \"isCorrect\": false,\n          \"text\": \"Only if our costs are lower\"\n        }\n      ],\n      \"question\": \"Is the dominant strategy always the right choice?\"\n    },\n    {\n      \"context\": \"Good point. We're definitely going to be competing with them for years — this isn't a one-and-done situation. So in a repeated game, you're saying the math changes. But how does that actually help us? They already made the first move by cutting prices.\",\n      \"options\": [\n        {\n          \"feedback\": \"Repetition fundamentally changes the game. When there's a future, cooperation becomes sustainable because defectors face punishment in subsequent rounds.\",\n          \"isCorrect\": false,\n          \"text\": \"It doesn't — we still need to match them\"\n        },\n        {\n          \"feedback\": \"Exactly. In repeated games, today's short-term gain from defecting must be weighed against the long-term cost of retaliation. Cooperation becomes rational when the future matters enough.\",\n          \"isCorrect\": true,\n          \"text\": \"Future retaliation makes defection costly\"\n        },\n        {\n          \"feedback\": \"Customer behavior isn't the key insight here. It's that YOUR competitor knows they'll face you again — so their optimal strategy changes when the game repeats.\",\n          \"isCorrect\": false,\n          \"text\": \"Customers have short memories anyway\"\n        },\n        {\n          \"feedback\": \"Not always — it depends on how much both sides value the future and whether punishment is credible. But repetition DOES create conditions where cooperation can be sustained.\",\n          \"isCorrect\": false,\n          \"text\": \"Repeated games always lead to cooperation\"\n        }\n      ],\n      \"question\": \"Why does repetition change the strategic logic?\"\n    },\n    {\n      \"context\": \"Okay, I'm following. But wait — they already defected by cutting prices. If we're in a repeated game and we want to signal that defection has consequences, what's our move? Do we punish them or try to get back to cooperation?\",\n      \"options\": [\n        {\n          \"feedback\": \"Just matching might be seen as capitulating. In repeated games, you need to signal that defection triggers consequences — but also leave room for returning to cooperation.\",\n          \"isCorrect\": false,\n          \"text\": \"Immediately match their cut\"\n        },\n        {\n          \"feedback\": \"Escalation can spiral into destructive price wars. The goal in repeated games is to make defection costly while preserving the possibility of returning to mutual cooperation.\",\n          \"isCorrect\": false,\n          \"text\": \"Cut even deeper to punish them\"\n        },\n        {\n          \"feedback\": \"This is the repeated game insight — respond to defection (so it's not free) but make clear you'd rather cooperate. A 'tit-for-tat' approach punishes defection while rewarding cooperation.\",\n          \"isCorrect\": true,\n          \"text\": \"Match but signal willingness to cooperate\"\n        },\n        {\n          \"feedback\": \"Ignoring defection signals that it's costless, encouraging more of it. In repeated games, you need to respond to establish that unilateral defection won't be tolerated.\",\n          \"isCorrect\": false,\n          \"text\": \"Do nothing and hope they raise prices\"\n        }\n      ],\n      \"question\": \"What's the strategic response to their price cut?\"\n    },\n    {\n      \"context\": \"Match but leave the door open for cooperation — that makes sense. Okay, I'm drafting the recommendation. We'll match their price cut for now, but we'll also reach out through back channels to discuss 'market stability.' The CEO will like that we're being strategic, not just reactive.\",\n      \"options\": [\n        {\n          \"feedback\": \"This isn't about PR — it's about game theory. In repeated interactions, you need the other player to know that mutual cooperation is still possible and preferred.\",\n          \"isCorrect\": false,\n          \"text\": \"It's just good public relations\"\n        },\n        {\n          \"feedback\": \"Right! Pure punishment can lock you into mutual defection forever. Signaling that you'll cooperate IF they cooperate makes the beneficial equilibrium achievable again.\",\n          \"isCorrect\": true,\n          \"text\": \"It keeps the repeated game cooperative\"\n        },\n        {\n          \"feedback\": \"Price signaling can actually raise legal issues. But the strategic logic here is that sustained cooperation requires both sides to see a path back to it after defection.\",\n          \"isCorrect\": false,\n          \"text\": \"Legal requirements for competition\"\n        },\n        {\n          \"feedback\": \"The opposite — you want to be clear and predictable. In repeated games, credible signaling helps both parties understand how to reach the mutually beneficial outcome.\",\n          \"isCorrect\": false,\n          \"text\": \"To confuse the competitor\"\n        }\n      ],\n      \"question\": \"Why is signaling willingness to cooperate important?\"\n    },\n    {\n      \"context\": \"Perfect. I just sent the recommendation to the CEO. Match their prices, signal openness to stabilizing the market, and— hold on, I'm getting an email. {{NAME}}... this changes everything. Their price cut wasn't strategic. Their CFO just got fired for fraud. They're in crisis mode and slashing prices to generate cash. Fast.\",\n      \"options\": [\n        {\n          \"feedback\": \"This fundamentally changes the game. If their cut is about survival, not strategy, the repeated game logic shifts. They may not be able to respond to cooperation signals right now.\",\n          \"isCorrect\": false,\n          \"text\": \"It doesn't — we still match prices\"\n        },\n        {\n          \"feedback\": \"Exactly. We assumed strategic interdependence, but they're making desperate moves for survival. Their payoffs have changed — they're not optimizing market position, they're generating cash.\",\n          \"isCorrect\": true,\n          \"text\": \"They're not playing the same game we are\"\n        },\n        {\n          \"feedback\": \"Predatory pricing against a distressed competitor raises ethical and legal issues. More importantly, you need to reassess the entire strategic structure given this new information.\",\n          \"isCorrect\": false,\n          \"text\": \"We should cut prices even more\"\n        },\n        {\n          \"feedback\": \"They might not be ABLE to cooperate — their crisis forces short-term thinking. The game theory insight is that you must understand what game you're actually playing.\",\n          \"isCorrect\": false,\n          \"text\": \"This means we definitely cooperate\"\n        }\n      ],\n      \"question\": \"How does this new information change your analysis?\"\n    },\n    {\n      \"context\": \"You're right. We were analyzing a prisoner's dilemma between two rational competitors. But they're not being strategic — they're being desperate. This isn't about market share; they need cash to survive the scandal. Our whole framework assumed they were optimizing the same thing we are.\",\n      \"options\": [\n        {\n          \"feedback\": \"Game theory only works when you correctly understand what everyone is optimizing. If their payoffs changed (survival vs. profit), the entire strategic structure changes. Know your game.\",\n          \"isCorrect\": true,\n          \"text\": \"Always verify opponents' payoffs\"\n        },\n        {\n          \"feedback\": \"We already established dominant strategies aren't always optimal. The key lesson here is about understanding the actual game being played — including what others are really optimizing for.\",\n          \"isCorrect\": false,\n          \"text\": \"Dominant strategies always win\"\n        },\n        {\n          \"feedback\": \"Nash equilibrium can be stable — the issue is that we were analyzing the WRONG game. Their crisis changed their payoff structure entirely.\",\n          \"isCorrect\": false,\n          \"text\": \"Nash equilibrium is unstable\"\n        },\n        {\n          \"feedback\": \"Repeated games still matter when both players are strategic. The lesson here is that you need to correctly identify the game before applying game theory concepts.\",\n          \"isCorrect\": false,\n          \"text\": \"Repeated games don't matter\"\n        }\n      ],\n      \"question\": \"What game theory principle did we almost miss?\"\n    },\n    {\n      \"context\": \"So what's our actual recommendation now? If they're in survival mode, they'll keep prices low until the crisis passes — or until they go under. This isn't tit-for-tat anymore. We're playing against a wounded competitor making non-strategic moves.\",\n      \"options\": [\n        {\n          \"feedback\": \"If their low prices aren't sustainable and aren't strategically motivated, matching them just hurts your margins for no reason. Let them burn cash while you maintain profitability.\",\n          \"isCorrect\": true,\n          \"text\": \"Keep prices high and wait them out\"\n        },\n        {\n          \"feedback\": \"Matching makes sense against a strategic rival. But against a desperate competitor who CAN'T raise prices regardless of your response, you're just sacrificing margins needlessly.\",\n          \"isCorrect\": false,\n          \"text\": \"Match their prices anyway\"\n        },\n        {\n          \"feedback\": \"That's a corporate strategy decision beyond this pricing question. The immediate insight is that you don't need to match prices that stem from desperation rather than strategy.\",\n          \"isCorrect\": false,\n          \"text\": \"Buy their company immediately\"\n        },\n        {\n          \"feedback\": \"Aggressive price cuts against a distressed competitor could invite regulatory scrutiny. And strategically, it's unnecessary — their situation isn't sustainable anyway.\",\n          \"isCorrect\": false,\n          \"text\": \"Cut prices even lower than theirs\"\n        }\n      ],\n      \"question\": \"What should your revised strategy be?\"\n    },\n    {\n      \"context\": \"Wait them out — I like it. Okay, new recommendation: hold our prices, maybe offer some targeted promotions to keep customers from switching, but don't engage in a price war with someone who's not really fighting for market position. {{NAME}}, I think we just saved the company a lot of money.\",\n      \"options\": [\n        {\n          \"feedback\": \"The lesson isn't about trust — it's about understanding context. Game theory gives us powerful tools, but they only work when we correctly understand what game we're actually playing.\",\n          \"isCorrect\": false,\n          \"text\": \"Never trust competitor announcements\"\n        },\n        {\n          \"feedback\": \"Exactly! Game theory provides a framework, but you must correctly identify players' actual payoffs and constraints. Strategic interdependence only applies when everyone is being strategic.\",\n          \"isCorrect\": true,\n          \"text\": \"Game theory requires understanding context\"\n        },\n        {\n          \"feedback\": \"That's a conclusion from prisoner's dilemma analysis, but not today's key insight. The bigger lesson is that game theory requires correctly understanding the game before applying frameworks.\",\n          \"isCorrect\": false,\n          \"text\": \"Price wars always hurt everyone\"\n        },\n        {\n          \"feedback\": \"Analysis paralysis isn't the answer. The insight is that game theory is powerful, but it depends on correctly understanding players' actual motivations and constraints.\",\n          \"isCorrect\": false,\n          \"text\": \"Always wait for more information\"\n        }\n      ],\n      \"question\": \"What's the key takeaway from this analysis?\"\n    }\n  ]\n}",
      "outputTokens": 3005,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "en-economics-game-theory-strategy-1",
      "userPrompt": "LESSON_TITLE: Strategic Thinking with Game Theory\nLESSON_DESCRIPTION: Using game theory to analyze competitive situations and make better strategic decisions\nCHAPTER_TITLE: Strategic Decision Making\nCOURSE_TITLE: Microeconomics\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. Strategic Interdependence: Game theory studies strategic interactions where your outcome depends on others' choices too. It's not about games — it's about any situation where what you should do depends on what others do.\n2. Nash Equilibrium: A Nash equilibrium is a stable state where no player can improve by changing only their own strategy. Everyone is doing their best given what everyone else is doing.\n3. Dominant Strategies: A dominant strategy is best regardless of what others do. If you have one, use it. But most real situations don't have dominant strategies — you must anticipate others.\n4. The Prisoner's Dilemma: The prisoner's dilemma shows how individual rationality can lead to collective irrationality. Both players choosing their dominant strategy leaves both worse off.\n5. Repeated Interactions: Repeated games change the calculus. When you'll interact again, cooperation becomes rational because future punishment makes defection costly."
    },
    {
      "duration": 121362.23691700003,
      "inputTokens": 4222,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, we've got a situation. The gene therapy team just sent over their CRISPR construct for the sickle cell trial. They want us to review it before they move to patient cells. I'm looking at their guide RNA design right now and something's bothering me.\",\n      \"options\": [\n        {\n          \"feedback\": \"Exactly right. The guide RNA must base-pair precisely with the DNA you want to edit. If the sequence match isn't perfect at the target site, Cas9 won't cut where you need it to.\",\n          \"isCorrect\": true,\n          \"text\": \"Check if it matches the target sequence\"\n        },\n        {\n          \"feedback\": \"Concentration matters for efficiency, but the guide RNA's sequence complementarity to the target DNA is the fundamental requirement. Without proper matching, no amount of Cas9 will help.\",\n          \"isCorrect\": false,\n          \"text\": \"Check the Cas9 protein concentration\"\n        },\n        {\n          \"feedback\": \"Delivery is crucial, but comes later. First we need to verify the guide RNA actually targets the right DNA sequence through base-pairing. No point delivering a poorly designed construct.\",\n          \"isCorrect\": false,\n          \"text\": \"Check the delivery vehicle first\"\n        },\n        {\n          \"feedback\": \"Cell culture conditions affect editing efficiency, but the guide RNA's ability to match the target DNA sequence is the core mechanism. That's where we start.\",\n          \"isCorrect\": false,\n          \"text\": \"Check the cell culture conditions\"\n        }\n      ],\n      \"question\": \"What should we check first in their guide RNA design?\"\n    },\n    {\n      \"context\": \"Good thinking. I ran their guide RNA sequence through the alignment tool. It matches the beta-globin gene perfectly at the sickle cell mutation site. But here's what's bugging me — I'm seeing several other genomic locations with near-matches. Some differ by only 2-3 nucleotides.\",\n      \"options\": [\n        {\n          \"feedback\": \"Exactly. Off-target effects occur when CRISPR cuts unintended locations. Guide RNAs with near-matches in the genome can direct Cas9 to cut at those sites too, potentially causing harmful mutations elsewhere.\",\n          \"isCorrect\": true,\n          \"text\": \"They could cause off-target cuts\"\n        },\n        {\n          \"feedback\": \"Speed isn't the main concern. Those near-match sites could be cut by Cas9 too, creating unintended mutations throughout the genome. That's a major safety issue for therapeutic applications.\",\n          \"isCorrect\": false,\n          \"text\": \"They'll slow down the editing process\"\n        },\n        {\n          \"feedback\": \"Guide RNA length is usually standard (around 20 nucleotides). The real issue is that similar sequences elsewhere in the genome could also be targeted, causing dangerous off-target cuts.\",\n          \"isCorrect\": false,\n          \"text\": \"They indicate the sequence is too short\"\n        },\n        {\n          \"feedback\": \"These aren't duplicates of the target gene — they're similar sequences in completely different genes. If Cas9 cuts there too, we could damage genes the patient actually needs.\",\n          \"isCorrect\": false,\n          \"text\": \"They mean the target gene is duplicated\"\n        }\n      ],\n      \"question\": \"Why are these near-matches concerning?\"\n    },\n    {\n      \"context\": \"Right, off-target effects are a major safety concern. The team is proposing to use this in patient hematopoietic stem cells. If we accidentally cut the wrong gene in a stem cell, that mutation gets passed to every blood cell it produces. We need to redesign this guide RNA.\",\n      \"options\": [\n        {\n          \"feedback\": \"Perfect. Designing guide RNAs that target sequences with fewer near-matches elsewhere in the genome dramatically reduces off-target cutting. Specificity starts with smart sequence selection.\",\n          \"isCorrect\": true,\n          \"text\": \"Choose a more unique target sequence\"\n        },\n        {\n          \"feedback\": \"More Cas9 would actually increase off-target effects — you'd have more molecular scissors making cuts at all those near-match sites. We need a more specific target sequence instead.\",\n          \"isCorrect\": false,\n          \"text\": \"Use more Cas9 protein\"\n        },\n        {\n          \"feedback\": \"Multiple cuts would multiply the risk of off-target damage, not reduce it. We need to find a target sequence that's unique enough that our guide RNA won't match other genomic locations.\",\n          \"isCorrect\": false,\n          \"text\": \"Cut the DNA in multiple places\"\n        },\n        {\n          \"feedback\": \"Stem cells are actually ideal for this therapy — editing them means all descendant blood cells carry the fix. We just need better guide RNA design to minimize off-target risks.\",\n          \"isCorrect\": false,\n          \"text\": \"Skip the stem cells entirely\"\n        }\n      ],\n      \"question\": \"What's the best approach to reduce off-target effects?\"\n    },\n    {\n      \"context\": \"I found a better target site. It's still in the beta-globin gene, still corrects the sickle mutation, but the sequence is much more unique — the closest off-target match has 5 nucleotide differences. Way safer. Now, here's my next question: do we want to knock out the mutant gene or try to insert the corrected sequence?\",\n      \"options\": [\n        {\n          \"feedback\": \"Yes! Homology-directed repair can insert new sequences when you provide a DNA template. For sickle cell, we can provide a template with the correct beta-globin sequence to replace the mutation.\",\n          \"isCorrect\": true,\n          \"text\": \"Homology-directed repair\"\n        },\n        {\n          \"feedback\": \"Non-homologous end joining typically introduces small errors when repairing — good for knockouts, but it won't precisely insert a corrected sequence. We need homology-directed repair with a template for that.\",\n          \"isCorrect\": false,\n          \"text\": \"Non-homologous end joining\"\n        },\n        {\n          \"feedback\": \"Cas9 only cuts DNA — it doesn't insert anything. To get precise sequence insertion, we need to provide a DNA template and rely on the cell's homology-directed repair pathway.\",\n          \"isCorrect\": false,\n          \"text\": \"Direct Cas9 insertion\"\n        },\n        {\n          \"feedback\": \"Guide RNA just directs where Cas9 cuts — it doesn't participate in repair. Inserting a corrected sequence requires homology-directed repair with a matching DNA template.\",\n          \"isCorrect\": false,\n          \"text\": \"Guide RNA recombination\"\n        }\n      ],\n      \"question\": \"What repair pathway would insert the corrected sequence?\"\n    },\n    {\n      \"context\": \"Homology-directed repair it is. I'll design a repair template with the corrected hemoglobin sequence. Now we need to figure out delivery. The patient cells are going to be extracted, edited ex vivo, and transplanted back. But even in a dish, getting CRISPR into hematopoietic stem cells isn't trivial.\",\n      \"options\": [\n        {\n          \"feedback\": \"Exactly. CRISPR components — the Cas9 protein and guide RNA — are large molecules that can't simply diffuse across cell membranes. We need specialized delivery methods even in controlled lab conditions.\",\n          \"isCorrect\": true,\n          \"text\": \"Cells don't easily take up large molecules\"\n        },\n        {\n          \"feedback\": \"Temperature control in labs is quite precise. The real challenge is that CRISPR's large molecular components can't easily cross cell membranes without specialized delivery vehicles or techniques.\",\n          \"isCorrect\": false,\n          \"text\": \"The dish temperature is too variable\"\n        },\n        {\n          \"feedback\": \"Actually, hematopoietic stem cells divide relatively slowly. The delivery challenge is getting large CRISPR components across the cell membrane, regardless of division rate.\",\n          \"isCorrect\": false,\n          \"text\": \"Stem cells divide too quickly\"\n        },\n        {\n          \"feedback\": \"The dish itself isn't the obstacle. The challenge is that Cas9 protein and guide RNA are large molecules that don't naturally cross into cells — we need delivery vehicles to get them inside.\",\n          \"isCorrect\": false,\n          \"text\": \"Lab dishes block the guide RNA\"\n        }\n      ],\n      \"question\": \"Why is delivery challenging even for cells in a lab dish?\"\n    },\n    {\n      \"context\": \"For ex vivo editing, we have some good options. Electroporation can punch temporary holes in the membrane. Or we could use lipid nanoparticles — basically tiny fat bubbles that fuse with the cell membrane. The team originally wanted to use viral vectors, but I'm not sure that's the best choice here.\",\n      \"options\": [\n        {\n          \"feedback\": \"Right. Some viral vectors integrate their genetic cargo into the patient's DNA, which could cause insertional mutagenesis. For a therapy that's already editing the genome, we want tight control over what changes are made.\",\n          \"isCorrect\": true,\n          \"text\": \"They could integrate into the genome\"\n        },\n        {\n          \"feedback\": \"Viral vectors are actually quite efficient at delivering genetic material. The concern is that some types integrate into the genome unpredictably, potentially causing additional unwanted genetic changes.\",\n          \"isCorrect\": false,\n          \"text\": \"They work too slowly\"\n        },\n        {\n          \"feedback\": \"Viral vectors can definitely carry guide RNA sequences. The issue is that certain viral vectors integrate into the genome, adding uncontrolled genetic modifications on top of our intended CRISPR edit.\",\n          \"isCorrect\": false,\n          \"text\": \"They can't carry guide RNA\"\n        },\n        {\n          \"feedback\": \"Viral vectors work in many cell types, not just stem cells. The real concern is genomic integration — some viral vectors insert themselves into DNA, creating additional mutations we didn't plan for.\",\n          \"isCorrect\": false,\n          \"text\": \"They only work in stem cells\"\n        }\n      ],\n      \"question\": \"What's a concern with viral vectors for this application?\"\n    },\n    {\n      \"context\": \"Agreed. Let's go with electroporation — temporary membrane pores, direct delivery of Cas9 protein and guide RNA, no viral sequences to worry about. The editing happens, and then the components degrade. Much cleaner. Okay, I'm prepping the protocol. We'll electroporate the stem cells, give them time to edit and repair, then check our results.\",\n      \"options\": [\n        {\n          \"feedback\": \"Exactly. Direct sequencing of the beta-globin gene will show if we successfully introduced the corrected sequence via homology-directed repair. We can see exactly what changed at the molecular level.\",\n          \"isCorrect\": true,\n          \"text\": \"Sequence the target site and check for changes\"\n        },\n        {\n          \"feedback\": \"Survival indicates the cells tolerated the procedure, but tells us nothing about whether the edit worked. We need to sequence the target site to confirm the correction was made.\",\n          \"isCorrect\": false,\n          \"text\": \"Count how many cells survived\"\n        },\n        {\n          \"feedback\": \"Cas9 levels tell us delivery worked, but not whether the edit succeeded. We need to sequence the beta-globin gene to verify the sickle mutation was actually corrected.\",\n          \"isCorrect\": false,\n          \"text\": \"Measure Cas9 protein levels\"\n        },\n        {\n          \"feedback\": \"Cell division indicates health, not editing success. To confirm we corrected the sickle mutation, we need to sequence the target site and see the corrected hemoglobin sequence.\",\n          \"isCorrect\": false,\n          \"text\": \"Check if the cells are still dividing\"\n        }\n      ],\n      \"question\": \"How should we verify successful editing?\"\n    },\n    {\n      \"context\": \"The sequencing results just came back. Target site shows 73% of cells have the corrected sequence — that's really good for homology-directed repair. But {{NAME}}, I also ran whole genome sequencing on a subset of cells. I'm seeing something unexpected at one of those near-match sites we were worried about.\",\n      \"options\": [\n        {\n          \"feedback\": \"Unfortunately, yes. Despite our improved guide RNA design, some off-target cutting still occurred at a near-match site. The cell repaired it, likely with errors from non-homologous end joining. This is why we check.\",\n          \"isCorrect\": true,\n          \"text\": \"An off-target cut that got repaired\"\n        },\n        {\n          \"feedback\": \"DNA corrections don't migrate to other genomic locations. What we're likely seeing is an off-target cut that was repaired — probably with errors, since non-homologous end joining often introduces mutations.\",\n          \"isCorrect\": false,\n          \"text\": \"The corrected sequence migrated there\"\n        },\n        {\n          \"feedback\": \"If it's at one of those near-match sites we flagged, it's almost certainly an off-target effect from our CRISPR editing, not natural variation. The guide RNA likely directed some cuts there too.\",\n          \"isCorrect\": false,\n          \"text\": \"Natural genetic variation\"\n        },\n        {\n          \"feedback\": \"At a site we specifically flagged as a near-match? That's too coincidental. This is most likely an off-target cut that got repaired. It's exactly the kind of result we screen for.\",\n          \"isCorrect\": false,\n          \"text\": \"A sequencing error\"\n        }\n      ],\n      \"question\": \"What might we be seeing at that near-match site?\"\n    },\n    {\n      \"context\": \"Ugh. The off-target site is in a gene called MTOR — it's involved in cell growth regulation. About 12% of the edited cells show small insertions or deletions there. Classic non-homologous end joining errors. {{NAME}}, this is a problem. We can't give patients cells with random mutations in a growth regulation gene.\",\n      \"options\": [\n        {\n          \"feedback\": \"Exactly right. We can sort and select cells that have the corrected beta-globin gene but no off-target mutations. It reduces our yield, but ensures patient safety. Quality over quantity.\",\n          \"isCorrect\": true,\n          \"text\": \"Select only correctly-edited cells\"\n        },\n        {\n          \"feedback\": \"12% is not low when we're talking about mutations in a growth regulation gene that could contribute to cancer. We need to select only the cells without off-target damage before transplanting.\",\n          \"isCorrect\": false,\n          \"text\": \"Proceed anyway — 12% is low\"\n        },\n        {\n          \"feedback\": \"More Cas9 won't fix the damage — it would likely cause more off-target cuts. We need to select only the cells that were correctly edited without off-target mutations.\",\n          \"isCorrect\": false,\n          \"text\": \"Add more Cas9 to fix the off-targets\"\n        },\n        {\n          \"feedback\": \"We don't need to start over. We have 73% correctly edited cells. We just need to sort out the ~12% that also have off-target mutations and use only the clean population.\",\n          \"isCorrect\": false,\n          \"text\": \"Repeat the entire experiment\"\n        }\n      ],\n      \"question\": \"What should we do about the cells with off-target mutations?\"\n    },\n    {\n      \"context\": \"Good call. We can use single-cell sorting to isolate correctly-edited cells and screen out the ones with MTOR mutations. It's more work, but this is gene therapy — we don't cut corners on safety. I'm writing this up for the review board now.\",\n      \"options\": [\n        {\n          \"feedback\": \"Exactly. Even with careful guide RNA design, off-target effects can still occur. Comprehensive genomic screening before patient use is essential. It's a major safety requirement for therapeutic CRISPR applications.\",\n          \"isCorrect\": true,\n          \"text\": \"Always screen for off-target effects\"\n        },\n        {\n          \"feedback\": \"CRISPR is actually very promising for blood disorders because we can edit cells ex vivo. The lesson is to always screen for off-target effects — that applies to any therapeutic CRISPR application.\",\n          \"isCorrect\": false,\n          \"text\": \"Avoid CRISPR for blood disorders\"\n        },\n        {\n          \"feedback\": \"Viral vectors have their own integration risks. The key lesson is that off-target screening is essential regardless of delivery method. We need to verify no unintended genomic changes occurred.\",\n          \"isCorrect\": false,\n          \"text\": \"Only use viral vector delivery\"\n        },\n        {\n          \"feedback\": \"Homology-directed repair worked great — 73% correction rate. The off-target issue was from guide RNA specificity, not the repair pathway. The lesson is comprehensive genomic screening for any CRISPR therapy.\",\n          \"isCorrect\": false,\n          \"text\": \"Homology-directed repair is too risky\"\n        }\n      ],\n      \"question\": \"What's the key safety lesson for the review board?\"\n    },\n    {\n      \"context\": \"{{NAME}}, I just got a message from the PI. She's thrilled with our analysis. But she's asking if we could use the same approach for an in vivo treatment — injecting CRISPR directly into a patient to edit liver cells. Same guide RNA, just different target organ.\",\n      \"options\": [\n        {\n          \"feedback\": \"Exactly. In a living body, CRISPR components might reach unintended cell types. Ex vivo, we choose exactly which cells to edit. In vivo, we're dependent on delivery vehicles to find the right cells in a complex organism.\",\n          \"isCorrect\": true,\n          \"text\": \"We can't control which cells get edited\"\n        },\n        {\n          \"feedback\": \"Guide RNAs work the same way in any cell — they base-pair with target DNA. The challenge with in vivo delivery is directing CRISPR components to the right cells among billions of others in a living organism.\",\n          \"isCorrect\": false,\n          \"text\": \"Guide RNAs don't work in living tissue\"\n        },\n        {\n          \"feedback\": \"Cas9 functions fine at body temperature. The real challenge is targeting — in a living organism, how do you get CRISPR components into the specific cells you want to edit without affecting others?\",\n          \"isCorrect\": false,\n          \"text\": \"Cas9 is destroyed by body temperature\"\n        },\n        {\n          \"feedback\": \"Liver cells have the same DNA repair pathways as any other cell. The in vivo challenge is getting CRISPR to the right cells in a living organism — we can't hand-pick which cells get edited.\",\n          \"isCorrect\": false,\n          \"text\": \"The liver can't repair DNA cuts\"\n        }\n      ],\n      \"question\": \"Why is in vivo delivery more challenging than ex vivo?\"\n    },\n    {\n      \"context\": \"Right, and that's scary for the off-target situation. In our ex vivo approach, we could screen cells before giving them to patients. In vivo? Once those edits happen in the body, there's no take-backs. We'd need an incredibly specific delivery system and probably an even better guide RNA design.\",\n      \"options\": [\n        {\n          \"feedback\": \"Yes! Lipid nanoparticles can be engineered with surface molecules that preferentially bind to liver cell receptors. The liver also naturally takes up many lipid particles, making it a relatively accessible target for this approach.\",\n          \"isCorrect\": true,\n          \"text\": \"Lipid nanoparticles that target liver\"\n        },\n        {\n          \"feedback\": \"Guide RNA length doesn't affect which organ gets the delivery. We need a delivery vehicle like lipid nanoparticles that can be targeted to liver cells specifically through their surface properties.\",\n          \"isCorrect\": false,\n          \"text\": \"Using a longer guide RNA sequence\"\n        },\n        {\n          \"feedback\": \"Direct injection doesn't guarantee liver-specific editing — CRISPR components could still enter the bloodstream and reach other organs. We need delivery vehicles that specifically target liver cells.\",\n          \"isCorrect\": false,\n          \"text\": \"Injecting directly into the liver\"\n        },\n        {\n          \"feedback\": \"More Cas9 wouldn't improve tissue specificity — it would just increase editing everywhere the CRISPR reaches. We need delivery vehicles like lipid nanoparticles engineered to target liver cells.\",\n          \"isCorrect\": false,\n          \"text\": \"Using more Cas9 protein\"\n        }\n      ],\n      \"question\": \"What would help with targeting CRISPR to liver cells specifically?\"\n    },\n    {\n      \"context\": \"I'll suggest liver-targeted lipid nanoparticles to the PI. They naturally accumulate in the liver anyway, plus we can add targeting ligands. But honestly, {{NAME}}, for a first-in-human trial with this mutation, I think ex vivo is still the way to go. We can actually verify our edits before they go into a patient.\",\n      \"options\": [\n        {\n          \"feedback\": \"Exactly. Ex vivo gives us a critical checkpoint. We can verify successful editing AND check for off-target effects before cells ever go into a patient. That quality control isn't possible with in vivo editing.\",\n          \"isCorrect\": true,\n          \"text\": \"We can screen cells before transplanting\"\n        },\n        {\n          \"feedback\": \"The amount of Cas9 isn't the safety advantage. Ex vivo editing lets us screen cells for correct editing and off-target effects before putting them in a patient — that verification step is impossible in vivo.\",\n          \"isCorrect\": false,\n          \"text\": \"It requires less Cas9 protein\"\n        },\n        {\n          \"feedback\": \"DNA repair happens similarly inside or outside the body. The safety advantage of ex vivo is that we can verify edits and screen out cells with off-target mutations before transplanting.\",\n          \"isCorrect\": false,\n          \"text\": \"The cells heal faster outside the body\"\n        },\n        {\n          \"feedback\": \"Guide RNA specificity is the same regardless of context. The key advantage of ex vivo is our ability to screen cells for successful editing and off-target effects before they enter the patient.\",\n          \"isCorrect\": false,\n          \"text\": \"Guide RNAs are more accurate in dishes\"\n        }\n      ],\n      \"question\": \"What makes ex vivo editing safer for new therapies?\"\n    },\n    {\n      \"context\": \"Just got off a call with the review board. They approved our ex vivo protocol! First patient treatment is scheduled for next month. Oh, and {{NAME}} — they specifically praised our off-target analysis. Said it should be the standard for every CRISPR therapeutic proposal going forward.\",\n      \"options\": [\n        {\n          \"feedback\": \"Exactly. By doing whole genome sequencing before transplant, we found the MTOR off-targets and removed those cells. The patient will only receive correctly-edited, safe cells. That's the whole point of rigorous screening.\",\n          \"isCorrect\": true,\n          \"text\": \"We caught problems before patient exposure\"\n        },\n        {\n          \"feedback\": \"Actually, we proved the opposite — we found off-target cuts despite careful guide RNA design. The value was catching those mistakes before patient exposure and selecting only safe cells.\",\n          \"isCorrect\": false,\n          \"text\": \"We proved CRISPR never makes mistakes\"\n        },\n        {\n          \"feedback\": \"Our delivery choice was good, but that wasn't the key insight. The valuable lesson was using whole genome sequencing to catch off-target effects before cells go into patients.\",\n          \"isCorrect\": false,\n          \"text\": \"We showed viral vectors are unnecessary\"\n        },\n        {\n          \"feedback\": \"We actually made it more complex by adding selection steps. But that complexity is worth it — we caught cells with off-target mutations and removed them before patient treatment.\",\n          \"isCorrect\": false,\n          \"text\": \"We simplified the treatment protocol\"\n        }\n      ],\n      \"question\": \"What made our off-target analysis valuable?\"\n    },\n    {\n      \"context\": \"{{NAME}}, one more thing before we celebrate. I just realized something funny. Remember how we spent hours redesigning the guide RNA to avoid off-targets, switched to electroporation to avoid viral integration, added whole genome sequencing, and implemented cell selection protocols?\",\n      \"options\": [\n        {\n          \"feedback\": \"Exactly! What seems like \\\"just cutting DNA\\\" requires careful guide RNA design, appropriate delivery methods, thorough off-target screening, and quality control. Responsible CRISPR application is as much about safety as it is about the edit itself.\",\n          \"isCorrect\": true,\n          \"text\": \"Responsible CRISPR requires many safeguards\"\n        },\n        {\n          \"feedback\": \"The timeline wasn't the point. She's reflecting on how many layers of safety we needed — guide RNA design, delivery choice, screening, selection. Responsible CRISPR therapy isn't just one step, it's a whole system of safeguards.\",\n          \"isCorrect\": false,\n          \"text\": \"The project took too long\"\n        },\n        {\n          \"feedback\": \"The original design had near-match off-target sites! Her point is that all our careful work — redesign, delivery choice, screening, selection — represents what responsible CRISPR application actually requires.\",\n          \"isCorrect\": false,\n          \"text\": \"We should have used the original design\"\n        },\n        {\n          \"feedback\": \"Not too complicated — just requiring appropriate care. Her point is that responsible application of CRISPR means thinking through every step: targeting, delivery, verification, and safety selection.\",\n          \"isCorrect\": false,\n          \"text\": \"CRISPR is too complicated to use\"\n        }\n      ],\n      \"question\": \"What's she getting at?\"\n    },\n    {\n      \"context\": \"Exactly, {{NAME}}. And you know what the beautiful irony is? All that complexity we added? That's what made this therapy actually work. The original sloppy design would have failed the safety review. Sometimes the 'harder' path is the only real path.\",\n      \"options\": [\n        {\n          \"feedback\": \"Perfect. The molecular scissors are powerful, but using them responsibly in therapy means meticulous attention to guide RNA specificity, delivery method, off-target screening, and cell selection. That's CRISPR in practice.\",\n          \"isCorrect\": true,\n          \"text\": \"Effective CRISPR therapy requires careful design\"\n        },\n        {\n          \"feedback\": \"Complexity for its own sake isn't the point. The principle is that responsible CRISPR therapy requires thoughtful design at every step — specificity, delivery, verification — to be both effective AND safe.\",\n          \"isCorrect\": false,\n          \"text\": \"Always choose the most complex protocol\"\n        },\n        {\n          \"feedback\": \"We actually minimized off-targets through better guide RNA design and caught the remaining ones through screening. The principle is that careful design and verification make CRISPR therapy work responsibly.\",\n          \"isCorrect\": false,\n          \"text\": \"Off-target effects are unavoidable\"\n        },\n        {\n          \"feedback\": \"Each approach has its place. The broader principle is that responsible CRISPR application — whether ex vivo or in vivo — requires careful attention to targeting, delivery, and verification.\",\n          \"isCorrect\": false,\n          \"text\": \"Ex vivo is always better than in vivo\"\n        }\n      ],\n      \"question\": \"What's the core principle she's emphasizing?\"\n    }\n  ]\n}",
      "outputTokens": 5388,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "en-biology-crispr-applications-1",
      "userPrompt": "LESSON_TITLE: CRISPR Gene Editing in Practice\nLESSON_DESCRIPTION: Understanding how to apply CRISPR gene editing technology effectively and responsibly\nCHAPTER_TITLE: Genetic Engineering\nCOURSE_TITLE: Modern Biotechnology\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. The Molecular Scissors: CRISPR-Cas9 is a molecular scissors that cuts DNA at specific locations. The Cas9 protein does the cutting; a guide RNA tells it exactly where to cut.\n2. Guide RNA Targeting: Guide RNA is a short sequence that matches the target DNA. It base-pairs with the DNA sequence you want to edit, bringing Cas9 to the exact spot.\n3. Cellular Repair Pathways: After CRISPR cuts, the cell's repair machinery fixes the break. Non-homologous end joining often introduces errors (knockouts). Homology-directed repair can insert new sequences (knock-ins).\n4. Off-Target Effects: Off-target effects occur when CRISPR cuts unintended locations. Guide RNA design and delivery methods affect specificity. This is a major safety concern for therapeutic applications.\n5. Delivery Challenges: Delivery is a key challenge. Getting CRISPR components into the right cells in a living organism is harder than in a lab dish. Viral vectors and lipid nanoparticles are common approaches."
    },
    {
      "duration": 127972.51329100004,
      "inputTokens": 4282,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, preciso da sua ajuda urgente. A gente lançou aquele curso de onboarding na semana passada e os números estão péssimos. Taxa de conclusão de 23%. Vinte e três por cento! O RH está furioso.\",\n      \"options\": [\n        {\n          \"feedback\": \"A dificuldade do conteúdo é só parte da equação. Antes de culpar a complexidade inerente (carga intrínseca), precisamos investigar se há problemas de design que estamos criando desnecessariamente.\",\n          \"isCorrect\": false,\n          \"text\": \"Verificar se o conteúdo está muito difícil\"\n        },\n        {\n          \"feedback\": \"Exato! Antes de assumir que o conteúdo é difícil demais, precisamos verificar se não estamos adicionando carga extrânseca desnecessária com design ruim. Essa é a primeira coisa que podemos controlar.\",\n          \"isCorrect\": true,\n          \"text\": \"Analisar o design do material primeiro\"\n        },\n        {\n          \"feedback\": \"Feedback qualitativo ajuda, mas usuários nem sempre conseguem articular problemas de carga cognitiva. Eles dirão 'foi confuso' sem saber exatamente por quê. Melhor analisar o design primeiro.\",\n          \"isCorrect\": false,\n          \"text\": \"Perguntar aos usuários o que acharam\"\n        },\n        {\n          \"feedback\": \"Cortar conteúdo sem entender o problema pode eliminar informações essenciais. O problema pode não ser a quantidade, mas como o material está sendo apresentado.\",\n          \"isCorrect\": false,\n          \"text\": \"Encurtar o curso inteiro\"\n        }\n      ],\n      \"question\": \"Por onde você sugere começar a investigar?\"\n    },\n    {\n      \"context\": \"Boa ideia. Deixa eu compartilhar a tela... Olha o primeiro módulo aqui. Tem um vídeo de 45 minutos explicando todos os processos da empresa, com texto na tela, narração, e uma música de fundo 'para ficar mais dinâmico'. O pessoal de marketing adorou.\",\n      \"options\": [\n        {\n          \"feedback\": \"A duração é um problema, mas não o principal. Um vídeo longo bem estruturado pode funcionar. O problema real é a sobrecarga sensorial com múltiplos canais competindo pela atenção.\",\n          \"isCorrect\": false,\n          \"text\": \"O vídeo é longo demais\"\n        },\n        {\n          \"feedback\": \"Perfeito! Música de fundo + narração + texto na tela = três canais competindo pela memória de trabalho limitada. Isso é carga extrânseca pura — elementos de design que atrapalham, não ajudam.\",\n          \"isCorrect\": true,\n          \"text\": \"Música e narração competem pela atenção\"\n        },\n        {\n          \"feedback\": \"Interatividade pode ajudar, mas adicionar mais elementos a um design já sobrecarregado só piora. Primeiro precisamos eliminar o que está atrapalhando.\",\n          \"isCorrect\": false,\n          \"text\": \"Falta interatividade no módulo\"\n        },\n        {\n          \"feedback\": \"Vídeo pode ser excelente para aprendizagem. O problema não é o formato, mas os elementos desnecessários competindo pela atenção do aprendiz.\",\n          \"isCorrect\": false,\n          \"text\": \"O conteúdo deveria ser em texto\"\n        }\n      ],\n      \"question\": \"Qual é o principal problema aqui?\"\n    },\n    {\n      \"context\": \"Faz sentido. Música de fundo em material instrucional é cilada. Deixa eu ver o segundo módulo... Ah não. {{NAME}}, olha isso. Eles colocaram uma lista com 47 políticas da empresa numa única tela. Quarenta e sete. Numa tela só.\",\n      \"options\": [\n        {\n          \"feedback\": \"Verdade, mas o problema é mais profundo. Mesmo que lessem, a memória de trabalho só processa cerca de 4 itens por vez. 47 itens de uma vez simplesmente não cabem no processamento cognitivo.\",\n          \"isCorrect\": false,\n          \"text\": \"Ninguém vai ler tudo isso\"\n        },\n        {\n          \"feedback\": \"Exatamente! A memória de trabalho processa apenas ~4 itens simultaneamente. 47 políticas numa tela sobrecarrega completamente o sistema. A aprendizagem simplesmente para quando isso acontece.\",\n          \"isCorrect\": true,\n          \"text\": \"Excede a capacidade da memória de trabalho\"\n        },\n        {\n          \"feedback\": \"Imagens podem ajudar, mas adicionar elementos visuais a 47 itens não resolve o problema fundamental: é informação demais para processar de uma vez.\",\n          \"isCorrect\": false,\n          \"text\": \"O texto deveria ter imagens\"\n        },\n        {\n          \"feedback\": \"O problema não é o assunto ser chato — é a quantidade de informação apresentada simultaneamente. Mesmo conteúdo interessante seria impossível de processar assim.\",\n          \"isCorrect\": false,\n          \"text\": \"Políticas são conteúdo chato\"\n        }\n      ],\n      \"question\": \"Por que isso é problemático para a aprendizagem?\"\n    },\n    {\n      \"context\": \"A memória de trabalho não é infinita, né? Precisamos fazer alguma coisa com essas 47 políticas. Não dá pra simplesmente deletar — o jurídico precisa que todas estejam lá. Alguma ideia?\",\n      \"options\": [\n        {\n          \"feedback\": \"Isso é chunking! Agrupar as políticas em categorias significativas (RH, Segurança, TI, etc.) transforma 47 itens soltos em poucos grupos gerenciáveis. O cérebro processa grupos muito melhor que itens isolados.\",\n          \"isCorrect\": true,\n          \"text\": \"Dividir em categorias menores\"\n        },\n        {\n          \"feedback\": \"Ordem alfabética não reduz a carga cognitiva — ainda são 47 itens para processar. Precisamos agrupar por significado, não por letra inicial.\",\n          \"isCorrect\": false,\n          \"text\": \"Colocar em ordem alfabética\"\n        },\n        {\n          \"feedback\": \"Quizzes podem ajudar a consolidar, mas não resolvem o problema de apresentação. Ainda estaríamos sobrecarregando a memória de trabalho com muitos itens de uma vez.\",\n          \"isCorrect\": false,\n          \"text\": \"Fazer um quiz depois de cada 10\"\n        },\n        {\n          \"feedback\": \"Ícones podem ajudar no reconhecimento, mas 47 ícones diferentes também sobrecarregam. O problema é a quantidade de itens, não a falta de elementos visuais.\",\n          \"isCorrect\": false,\n          \"text\": \"Adicionar ícones para cada política\"\n        }\n      ],\n      \"question\": \"Como reorganizar essas 47 políticas?\"\n    },\n    {\n      \"context\": \"Chunking! Claro. A gente pode agrupar por departamento ou por situação... tipo 'Quando você tem uma emergência', 'Quando precisa de férias'. Boa, {{NAME}}. Deixa eu ver o terceiro módulo agora... Hmm. Aqui eles explicam o sistema de reembolso.\",\n      \"options\": [\n        {\n          \"feedback\": \"Clareza é importante, mas precisamos ser mais específicos. Qual tipo de carga cognitiva pode estar atrapalhando? O design? A complexidade? A forma de apresentação?\",\n          \"isCorrect\": false,\n          \"text\": \"Se a explicação está clara\"\n        },\n        {\n          \"feedback\": \"Ótimo instinto! Sempre começamos verificando se há elementos de design atrapalhando (carga extrânseca) antes de mexer no conteúdo. Essa é a carga que podemos e devemos eliminar.\",\n          \"isCorrect\": true,\n          \"text\": \"Se há carga extrânseca desnecessária\"\n        },\n        {\n          \"feedback\": \"Isso seria carga intrínseca — a complexidade inerente do conteúdo. Mas primeiro precisamos garantir que não estamos piorando as coisas com design ruim antes de culpar a complexidade.\",\n          \"isCorrect\": false,\n          \"text\": \"Se o sistema é muito complicado\"\n        },\n        {\n          \"feedback\": \"Duração é um fator, mas não conta a história toda. Um módulo curto mal desenhado pode ser pior que um longo bem estruturado.\",\n          \"isCorrect\": false,\n          \"text\": \"Quanto tempo o módulo dura\"\n        }\n      ],\n      \"question\": \"O que você quer verificar nesse módulo?\"\n    },\n    {\n      \"context\": \"Boa pergunta. Deixa eu ver... O módulo mostra um fluxograma do processo de reembolso. Mas {{NAME}}, o fluxograma está numa página e o texto explicando cada passo está noutra página separada. O usuário tem que ficar alternando entre as duas.\",\n      \"options\": [\n        {\n          \"feedback\": \"Fluxogramas são ótimos para visualizar processos! O problema não é o formato, mas a separação entre o visual e a explicação, forçando o usuário a integrar mentalmente informações de lugares diferentes.\",\n          \"isCorrect\": false,\n          \"text\": \"Fluxogramas são difíceis de entender\"\n        },\n        {\n          \"feedback\": \"Pelo contrário! O fluxograma ajuda a visualizar o processo. O problema é que separar visual e texto força o aprendiz a gastar energia mental integrando informações de fontes diferentes.\",\n          \"isCorrect\": false,\n          \"text\": \"Deveria ter só texto, sem fluxograma\"\n        },\n        {\n          \"feedback\": \"Exato! Quando visual e explicação estão separados, o aprendiz gasta energia mental integrando as duas fontes. Isso é carga extrânseca pura. Texto e imagem relacionados devem estar juntos.\",\n          \"isCorrect\": true,\n          \"text\": \"Força integração mental desnecessária\"\n        },\n        {\n          \"feedback\": \"Mais passos não resolveriam o problema de design. A questão é a separação espacial entre o fluxograma e suas explicações, que força trabalho mental desnecessário.\",\n          \"isCorrect\": false,\n          \"text\": \"Faltam mais passos no fluxograma\"\n        }\n      ],\n      \"question\": \"Por que esse design é problemático?\"\n    },\n    {\n      \"context\": \"Então a gente precisa colocar as explicações junto do fluxograma, não em página separada. Anotado. {{NAME}}, agora olha o quarto módulo. Eles ensinam a usar o sistema de ponto eletrônico. Instruções bem detalhadas, passo a passo, sem distrações visuais.\",\n      \"options\": [\n        {\n          \"feedback\": \"Excelente! Se eliminamos a carga extrânseca, o próximo passo é garantir que estamos promovendo esforço produtivo. O aprendiz está só lendo passivamente ou está processando ativamente, fazendo conexões?\",\n          \"isCorrect\": true,\n          \"text\": \"Se tem carga germânica suficiente\"\n        },\n        {\n          \"feedback\": \"Instruções curtas nem sempre são melhores. Às vezes precisamos de detalhe. A questão é se o aprendiz está engajado ativamente no processamento, não só a quantidade de texto.\",\n          \"isCorrect\": false,\n          \"text\": \"Se as instruções são curtas o bastante\"\n        },\n        {\n          \"feedback\": \"Exemplos podem ajudar, mas a pergunta certa é: o aprendiz está processando ativamente ou só consumindo passivamente? Mais conteúdo não resolve falta de engajamento cognitivo.\",\n          \"isCorrect\": false,\n          \"text\": \"Se precisa de mais exemplos\"\n        },\n        {\n          \"feedback\": \"Estética é secundária aqui. Um design limpo é bom, mas o objetivo é aprendizagem. Precisamos garantir que há oportunidade para processamento ativo, não só consumo passivo.\",\n          \"isCorrect\": false,\n          \"text\": \"Se o visual está atraente\"\n        }\n      ],\n      \"question\": \"Esse módulo parece bem desenhado. O que verificar agora?\"\n    },\n    {\n      \"context\": \"Hmm, pensando bem... O módulo é só um PDF com instruções. Leia e pronto. Não tem nenhuma atividade, nenhum momento pra pessoa pensar ou aplicar. É consumo passivo puro.\",\n      \"options\": [\n        {\n          \"feedback\": \"Animações são elementos visuais, não oportunidades de processamento ativo. Podem até adicionar carga extrânseca se não forem bem feitas. Precisamos de atividades que façam o aprendiz pensar.\",\n          \"isCorrect\": false,\n          \"text\": \"Adicionar animações nas instruções\"\n        },\n        {\n          \"feedback\": \"Perfeito! Exercícios práticos promovem carga germânica — o esforço produtivo de criar conexões e aplicar o conhecimento. É isso que consolida a aprendizagem na memória de longo prazo.\",\n          \"isCorrect\": true,\n          \"text\": \"Incluir exercícios de aplicação prática\"\n        },\n        {\n          \"feedback\": \"Mais detalhe não aumenta processamento ativo. O aprendiz ainda estaria só lendo. Carga germânica vem de atividades que exigem elaboração, conexão e aplicação.\",\n          \"isCorrect\": false,\n          \"text\": \"Deixar as instruções mais detalhadas\"\n        },\n        {\n          \"feedback\": \"Quiz no final testa memorização, não promove aprendizagem profunda. Carga germânica vem de atividades durante o processo que fazem o aprendiz pensar e aplicar, não só verificar depois.\",\n          \"isCorrect\": false,\n          \"text\": \"Colocar um quiz no final\"\n        }\n      ],\n      \"question\": \"Como podemos aumentar a carga germânica aqui?\"\n    },\n    {\n      \"context\": \"Tipo simular o registro de ponto? Ou pedir pra pessoa identificar erros em exemplos? Isso faz o cérebro trabalhar de verdade, né? Não é só decorar. Beleza, {{NAME}}, acho que temos um diagnóstico. Deixa eu resumir...\",\n      \"options\": [\n        {\n          \"feedback\": \"O conteúdo em si (carga intrínseca) não era o vilão. Onboarding não é física quântica. O problema estava no design que adicionava dificuldade desnecessária e não promovia aprendizagem ativa.\",\n          \"isCorrect\": false,\n          \"text\": \"Conteúdo difícil demais\"\n        },\n        {\n          \"feedback\": \"Exatamente! Carga extrânseca alta (música, texto separado, 47 itens) + carga germânica baixa (consumo passivo) = aprendizagem travada. Precisamos eliminar o ruim e adicionar o produtivo.\",\n          \"isCorrect\": true,\n          \"text\": \"Muito design ruim, pouca atividade boa\"\n        },\n        {\n          \"feedback\": \"A duração era sintoma, não causa. Um curso mais curto com os mesmos problemas de design ainda teria taxa de conclusão baixa. O problema era como o conteúdo estava sendo apresentado.\",\n          \"isCorrect\": false,\n          \"text\": \"Curso longo demais\"\n        },\n        {\n          \"feedback\": \"Culpar o aprendiz é a saída fácil. Se 77% não completam, o problema está no design, não nas pessoas. Quando facilitamos a aprendizagem, as pessoas aprendem.\",\n          \"isCorrect\": false,\n          \"text\": \"Falta de motivação dos funcionários\"\n        }\n      ],\n      \"question\": \"Qual foi o problema central desse curso?\"\n    },\n    {\n      \"context\": \"Ótimo diagnóstico, {{NAME}}. Vou preparar um relatório com as recomendações. Mas... espera. Acabou de chegar um email do diretor. Ele quer que a gente adicione mais dois módulos obrigatórios: compliance e segurança da informação. Até sexta.\",\n      \"options\": [\n        {\n          \"feedback\": \"Recusar sem propor alternativa não resolve. Esses conteúdos provavelmente são necessários. A questão é como integrar sem piorar a sobrecarga cognitiva do curso.\",\n          \"isCorrect\": false,\n          \"text\": \"Impossível, já está sobrecarregado\"\n        },\n        {\n          \"feedback\": \"Adicionar mais conteúdo a um curso já problemático vai piorar tudo. Precisamos pensar estrategicamente em como integrar sem aumentar a carga cognitiva total.\",\n          \"isCorrect\": false,\n          \"text\": \"Aceitar e adicionar rapidamente\"\n        },\n        {\n          \"feedback\": \"Estratégico! Se vamos redesenhar o curso, podemos integrar os novos conteúdos de forma inteligente — usando chunking, eliminando redundâncias, agrupando temas relacionados.\",\n          \"isCorrect\": true,\n          \"text\": \"Propor integrar ao redesenho\"\n        },\n        {\n          \"feedback\": \"Mais um curso significa mais carga total para os funcionários. Se há sobreposição de temas, integrar é mais eficiente do que fragmentar em múltiplos cursos.\",\n          \"isCorrect\": false,\n          \"text\": \"Criar um curso separado para isso\"\n        }\n      ],\n      \"question\": \"Como você reage a esse pedido?\"\n    },\n    {\n      \"context\": \"Boa, a gente aproveita o redesenho pra integrar tudo de forma coerente. Mas {{NAME}}, compliance tem umas regulamentações bem densas. O jurídico mandou um documento de 30 páginas que 'precisa estar no curso'. Como lidar com essa complexidade?\",\n      \"options\": [\n        {\n          \"feedback\": \"Resumir demais pode perder informação crítica — e o jurídico não vai aprovar. A complexidade é inerente ao conteúdo. Precisamos gerenciar, não eliminar artificialmente.\",\n          \"isCorrect\": false,\n          \"text\": \"Resumir em bullet points curtos\"\n        },\n        {\n          \"feedback\": \"Certo! Conteúdo com alta carga intrínseca deve ser dividido em partes gerenciáveis, apresentadas sequencialmente. Não podemos simplificar compliance, mas podemos dosificar a complexidade.\",\n          \"isCorrect\": true,\n          \"text\": \"Dividir em módulos menores sequenciais\"\n        },\n        {\n          \"feedback\": \"Isso é desistir de ensinar e só arquivar. PDFs de referência são úteis, mas não substituem um design que ajude as pessoas a realmente entender e lembrar as regulamentações.\",\n          \"isCorrect\": false,\n          \"text\": \"Colocar tudo num PDF para referência\"\n        },\n        {\n          \"feedback\": \"O formato não resolve o problema de volume. Mesmo vídeos curtos com 30 páginas de conteúdo = muitos vídeos. A questão é sequenciar e dosificar a complexidade primeiro.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar vídeos curtos com animação\"\n        }\n      ],\n      \"question\": \"Como abordar esse conteúdo denso?\"\n    },\n    {\n      \"context\": \"Faz sentido. A gente quebra em pedaços menores e apresenta ao longo do tempo, não tudo de uma vez. Posso começar a montar o plano de redesenho. Ah, {{NAME}}, uma última coisa... Lembra que eu disse que a taxa era 23%?\",\n      \"options\": [\n        {\n          \"feedback\": \"Curioso, mas vamos ver o que ela descobriu. Às vezes os dados iniciais escondem informações importantes sobre onde exatamente os problemas estão acontecendo.\",\n          \"isCorrect\": false,\n          \"text\": \"Era ainda pior?\"\n        },\n        {\n          \"feedback\": \"Boa intuição! Dados agregados podem esconder padrões importantes. Talvez a taxa varie muito entre módulos, departamentos ou momentos específicos do curso.\",\n          \"isCorrect\": true,\n          \"text\": \"Você descobriu algo nos dados?\"\n        },\n        {\n          \"feedback\": \"23% de conclusão é objetivamente baixo, não é exagero. Mas pode haver mais na história. Vamos ver o que ela descobriu nos dados.\",\n          \"isCorrect\": false,\n          \"text\": \"O RH exagerou o problema?\"\n        },\n        {\n          \"feedback\": \"Ignorar dados é desperdício. Entender onde exatamente as pessoas abandonam pode informar prioridades no redesenho. Vamos ver o que ela encontrou.\",\n          \"isCorrect\": false,\n          \"text\": \"Vamos ignorar e focar no redesenho\"\n        }\n      ],\n      \"question\": \"O que tem sobre a taxa de 23%?\"\n    },\n    {\n      \"context\": \"Eu fui olhar os dados por módulo. {{NAME}}, 67% das pessoas desistem no primeiro módulo — aquele vídeo de 45 minutos com música. As outras que passam dali completam quase tudo. O problema principal era a porta de entrada.\",\n      \"options\": [\n        {\n          \"feedback\": \"O primeiro módulo é crítico, mas não o único problema. Encontramos issues em vários módulos. A diferença é que agora sabemos a prioridade: a primeira impressão mata o curso.\",\n          \"isCorrect\": false,\n          \"text\": \"Precisamos focar só no primeiro módulo\"\n        },\n        {\n          \"feedback\": \"Exato! Se a maioria desiste na entrada, o primeiro módulo precisa ser exemplar: sem carga extrânseca, bem estruturado, engajante. Primeira impressão determina se a pessoa continua.\",\n          \"isCorrect\": true,\n          \"text\": \"Priorizar o redesenho do início\"\n        },\n        {\n          \"feedback\": \"Não necessariamente. As pessoas que passam do primeiro módulo podem estar completando por obrigação, não porque os outros módulos são bons. Encontramos problemas em vários.\",\n          \"isCorrect\": false,\n          \"text\": \"Os outros módulos estão bons\"\n        },\n        {\n          \"feedback\": \"Eliminar não resolve — o conteúdo de introdução é necessário. O problema é o design do módulo (vídeo longo, música, sobrecarga), não sua existência.\",\n          \"isCorrect\": false,\n          \"text\": \"Devemos eliminar o primeiro módulo\"\n        }\n      ],\n      \"question\": \"O que isso muda na nossa estratégia?\"\n    },\n    {\n      \"context\": \"Então a gente redesenha tudo, mas começa pelo primeiro módulo. Se acertarmos a porta de entrada, as pessoas vão experimentar o resto. {{NAME}}, antes de eu começar... me dá um resumo rápido do que aprendemos hoje? Quero ter claro na cabeça.\",\n      \"options\": [\n        {\n          \"feedback\": \"Essa é uma simplificação. O problema não é tamanho, mas equilíbrio de cargas: eliminar o que atrapalha (extrânseca), gerenciar o que é difícil (intrínseca), e promover o que ajuda (germânica).\",\n          \"isCorrect\": false,\n          \"text\": \"O curso precisa ser mais curto e simples\"\n        },\n        {\n          \"feedback\": \"Resumo perfeito! Design ruim adiciona carga desnecessária. Conteúdo complexo precisa ser dosificado. E aprendizagem real exige esforço produtivo. Equilibrar esses três tipos é a chave.\",\n          \"isCorrect\": true,\n          \"text\": \"Eliminar extrânseca, gerenciar intrínseca, promover germânica\"\n        },\n        {\n          \"feedback\": \"Tempo não é a variável principal. O problema era como o conteúdo estava sendo apresentado. Um design melhor pode até ser mais rápido porque não desperdiça energia mental.\",\n          \"isCorrect\": false,\n          \"text\": \"Os funcionários precisam de mais tempo\"\n        },\n        {\n          \"feedback\": \"Recursos visuais podem ajudar ou atrapalhar, dependendo do uso. O que aprendemos é sobre equilíbrio de cargas cognitivas, não sobre adicionar mais elementos.\",\n          \"isCorrect\": false,\n          \"text\": \"Precisamos de mais recursos visuais\"\n        }\n      ],\n      \"question\": \"Qual é o resumo do que descobrimos?\"\n    },\n    {\n      \"context\": \"Perfeito. Eliminar o lixo, dosar o difícil, e fazer o cérebro trabalhar no que importa. Simples assim. Vou começar o redesenho agora mesmo. {{NAME}}, obrigada pela ajuda — você salvou esse projeto. E provavelmente a minha sanidade também.\",\n      \"options\": [\n        {\n          \"feedback\": \"Parece bom senso depois que você aprende, mas quantos cursos ruins existem por aí? Entender a teoria da carga cognitiva transforma intuição vaga em decisões fundamentadas.\",\n          \"isCorrect\": false,\n          \"text\": \"Design instrucional é só bom senso\"\n        },\n        {\n          \"feedback\": \"Exatamente! Não é teoria abstrata — é uma ferramenta de diagnóstico e design. Quando algo não funciona, você sabe onde procurar: extrânseca demais? Germânica de menos? Intrínseca mal gerenciada?\",\n          \"isCorrect\": true,\n          \"text\": \"A teoria da carga cognitiva é um guia prático\"\n        },\n        {\n          \"feedback\": \"Não é sempre culpar, mas verificar primeiro. Às vezes o problema é realmente o conteúdo ou o contexto. A teoria ajuda a diagnosticar corretamente, não a assumir respostas.\",\n          \"isCorrect\": false,\n          \"text\": \"Sempre culpe o design primeiro\"\n        },\n        {\n          \"feedback\": \"Onboarding não é inerentemente problemático. Qualquer conteúdo mal desenhado falha. O que aprendemos se aplica a todo material de aprendizagem, não só a onboarding.\",\n          \"isCorrect\": false,\n          \"text\": \"Cursos de onboarding são problemáticos\"\n        }\n      ],\n      \"question\": \"O que você conclui dessa experiência?\"\n    }\n  ]\n}",
      "outputTokens": 5835,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "pt-psychology-cognitive-load-1",
      "userPrompt": "LESSON_TITLE: Carga Cognitiva na Pratica\nLESSON_DESCRIPTION: Aplicando a teoria da carga cognitiva para criar materiais de aprendizagem mais eficazes\nCHAPTER_TITLE: Psicologia da Aprendizagem\nCOURSE_TITLE: Design Instrucional\nLANGUAGE: pt\nEXPLANATION_STEPS:\n1. Limites da Memoria: A memoria de trabalho tem capacidade limitada — cerca de 4 itens simultaneamente. Quando sobrecarregada, a aprendizagem para. O cerebro nao consegue processar mais.\n2. Carga Intrinseca: Carga intrinseca vem da complexidade inerente do conteudo. Algumas coisas sao simplesmente dificeis. Nao da para eliminar, mas da para gerenciar.\n3. Carga Extrinseca: Carga extrinseca vem do design ruim — instrucoes confusas, distracao visual, navegacao complicada. Essa carga pode e deve ser eliminada.\n4. Carga Germanica: Carga germanica e o esforco produtivo de aprender — criar conexoes, elaborar, integrar. Queremos maximizar essa carga enquanto minimizamos a extrinseca.\n5. Chunking: Chunking agrupa informacoes em unidades significativas. Um numero de telefone e mais facil de lembrar como blocos (99-8765-4321) do que como 10 digitos soltos."
    },
    {
      "duration": 108246.48991599999,
      "inputTokens": 4273,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, tenemos un problema serio. El cliente de la planta química acaba de llamar — su nuevo motor térmico está funcionando al 65% de eficiencia. Dicen que según sus cálculos, debería ser posible. Pero algo no cuadra. La fuente caliente está a 800 K y el sumidero frío a 300 K.\",\n      \"options\": [\n        {\n          \"feedback\": \"¡Exacto! La eficiencia de Carnot es 1 - (Tc/Th) = 1 - (300/800) = 0.625 o 62.5%. Si dicen que opera al 65%, hay algo mal — ningún motor real puede superar a Carnot.\",\n          \"isCorrect\": true,\n          \"text\": \"62.5% según el límite de Carnot\"\n        },\n        {\n          \"feedback\": \"Imposible. El límite de Carnot para estas temperaturas es 1 - (300/800) = 62.5%. Ningún motor real puede superar este límite teórico según la segunda ley.\",\n          \"isCorrect\": false,\n          \"text\": \"65% es perfectamente posible\"\n        },\n        {\n          \"feedback\": \"No, estás calculando Tc/Th en vez de 1 - (Tc/Th). El límite de Carnot es 1 - (300/800) = 62.5%, no 37.5%.\",\n          \"isCorrect\": false,\n          \"text\": \"37.5% como máximo\"\n        },\n        {\n          \"feedback\": \"Ni con aislamiento perfecto. La segunda ley prohíbe convertir todo el calor en trabajo. Siempre debe haber rechazo de calor al sumidero frío.\",\n          \"isCorrect\": false,\n          \"text\": \"100% con aislamiento perfecto\"\n        }\n      ],\n      \"question\": \"¿Qué eficiencia máxima puede alcanzar este motor?\"\n    },\n    {\n      \"context\": \"Tienes razón, {{NAME}}. El límite de Carnot es 62.5%. Les acabo de decir al cliente que su motor está violando las leyes de la física. No lo tomaron bien. Insisten en que sus mediciones son correctas. Vamos a revisar sus datos: entrada de calor 1000 kJ, trabajo producido 650 kJ.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto. La primera ley dice Q_entrada = W + Q_salida. Si los números violan a Carnot, hay error de medición. Los sensores de flujo de calor o el dinamómetro deben estar descalibrados.\",\n          \"isCorrect\": true,\n          \"text\": \"Los sensores de calor o trabajo están fallando\"\n        },\n        {\n          \"feedback\": \"No existe motor que viole la segunda ley. Después de siglos de intentos, sabemos que Carnot es inquebrantable. El problema está en las mediciones, no en la física.\",\n          \"isCorrect\": false,\n          \"text\": \"El motor es revolucionario\"\n        },\n        {\n          \"feedback\": \"Mejor aislamiento no permitiría superar a Carnot — solo acercarse más a él. El problema aquí es que reportan eficiencia imposible, lo cual indica error de medición.\",\n          \"isCorrect\": false,\n          \"text\": \"Necesitan mejor aislamiento\"\n        },\n        {\n          \"feedback\": \"Aunque verificar temperaturas es buena idea, el problema principal es que sus números de calor y trabajo son inconsistentes. Algo en la instrumentación está mal.\",\n          \"isCorrect\": false,\n          \"text\": \"La temperatura del sumidero es incorrecta\"\n        }\n      ],\n      \"question\": \"¿Qué está mal con estas mediciones?\"\n    },\n    {\n      \"context\": \"Buena llamada. Les pedí que recalibraran y... bingo. El sensor de calor de entrada estaba leyendo bajo. El valor real es 1200 kJ, no 1000 kJ. Ahora con 650 kJ de trabajo sobre 1200 kJ de entrada... eso es 54% de eficiencia. Mucho más razonable.\",\n      \"options\": [\n        {\n          \"feedback\": \"¡Exacto! Por la primera ley: Q_entrada = W + Q_salida. Entonces 1200 = 650 + 550. Esos 550 kJ van al sumidero frío. Todo motor real debe rechazar calor — es inevitable.\",\n          \"isCorrect\": true,\n          \"text\": \"Se rechazan al sumidero frío como calor\"\n        },\n        {\n          \"feedback\": \"La fricción convierte trabajo en calor, pero ese calor también termina en el sumidero frío. Los 550 kJ son el calor rechazado total, incluyendo cualquier pérdida por fricción.\",\n          \"isCorrect\": false,\n          \"text\": \"Se pierden por fricción interna\"\n        },\n        {\n          \"feedback\": \"En un ciclo completo, la energía interna vuelve al inicio (ΔU = 0). Los 550 kJ no se quedan en el sistema — salen como calor rechazado al sumidero frío.\",\n          \"isCorrect\": false,\n          \"text\": \"Se almacenan como energía interna\"\n        },\n        {\n          \"feedback\": \"La energía nunca desaparece — primera ley. Los 1200 kJ de entrada se dividen en 650 kJ de trabajo útil y 550 kJ de calor rechazado al sumidero. Todo contabilizado.\",\n          \"isCorrect\": false,\n          \"text\": \"Desaparecen del sistema\"\n        }\n      ],\n      \"question\": \"¿Qué pasa con los 550 kJ restantes?\"\n    },\n    {\n      \"context\": \"Perfecto, {{NAME}}. El cliente está más tranquilo ahora que los números tienen sentido. Pero tienen otra pregunta: quieren mejorar la eficiencia. Proponen instalar un intercambiador de calor regenerativo para recuperar parte de esos 550 kJ. ¿Funcionará?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto. Un regenerador mejora eficiencia al precalentar fluidos usando calor que se perdería, pero nunca supera a Carnot. Puede llevarlos de 54% más cerca del 62.5%, no más allá.\",\n          \"isCorrect\": true,\n          \"text\": \"No, pero puede acercar más al límite\"\n        },\n        {\n          \"feedback\": \"Imposible. Ningún dispositivo viola la segunda ley. Los regeneradores solo reducen irreversibilidades, acercando la eficiencia real al límite teórico, nunca superándolo.\",\n          \"isCorrect\": false,\n          \"text\": \"Sí, los regeneradores superan a Carnot\"\n        },\n        {\n          \"feedback\": \"Sí sirven — los regeneradores son muy útiles. Recuperan calor interno reduciendo irreversibilidades. Solo no pueden superar a Carnot, pero sí acercarse más a ese límite.\",\n          \"isCorrect\": false,\n          \"text\": \"No, los regeneradores no sirven\"\n        },\n        {\n          \"feedback\": \"Bajar Tc sí aumentaría el límite de Carnot, pero es diferente a usar un regenerador. Este último mejora eficiencia real sin cambiar las temperaturas de operación.\",\n          \"isCorrect\": false,\n          \"text\": \"Solo si bajan la temperatura del sumidero\"\n        }\n      ],\n      \"question\": \"¿Puede un regenerador ayudar a superar el límite de Carnot?\"\n    },\n    {\n      \"context\": \"Les expliqué eso y ahora quieren explorar otra opción. Dicen: '¿Y si en vez de mejorar el motor, usamos el calor rechazado para alimentar un refrigerador industrial?' Tienen cámaras frías que mantener a -20°C. Quieren usar esos 550 kJ de calor residual.\",\n      \"options\": [\n        {\n          \"feedback\": \"Exacto. Un refrigerador necesita trabajo, no calor de baja temperatura. El calor a 300 K no puede hacer trabajo útil sin un sumidero más frío. Necesitarían convertir ese calor en trabajo primero.\",\n          \"isCorrect\": true,\n          \"text\": \"No directamente, el calor no puede mover el refrigerador\"\n        },\n        {\n          \"feedback\": \"Los refrigeradores requieren trabajo para mover calor de frío a caliente. El calor a 300 K no puede generar trabajo sin un sumidero más frío. Segunda ley en acción.\",\n          \"isCorrect\": false,\n          \"text\": \"Sí, el calor residual mueve el refrigerador\"\n        },\n        {\n          \"feedback\": \"Las bombas de calor también necesitan trabajo como entrada, no calor de baja temperatura. El calor residual a 300 K está demasiado degradado para hacer trabajo directamente.\",\n          \"isCorrect\": false,\n          \"text\": \"Sí, usando una bomba de calor\"\n        },\n        {\n          \"feedback\": \"No es problema de primera ley sino de segunda ley. La energía existe, pero está degradada a baja temperatura. No puede espontáneamente hacer trabajo sin un gradiente térmico útil.\",\n          \"isCorrect\": false,\n          \"text\": \"No, violaría la conservación de energía\"\n        }\n      ],\n      \"question\": \"¿Es termodinámicamente viable esta propuesta?\"\n    },\n    {\n      \"context\": \"Buen punto, {{NAME}}. Le dije que el calor a 300 K es de muy baja calidad termodinámica — alta entropía. Pero me preguntó algo interesante: '¿Y si la fuente caliente estuviera más caliente? ¿Ese calor residual podría hacer algo útil?' Supongamos que el rechazo fuera a 500 K en vez de 300 K.\",\n      \"options\": [\n        {\n          \"feedback\": \"¡Exacto! Con calor a 500 K como fuente caliente y ambiente a 300 K como sumidero, podrías operar un segundo motor. Es el principio de los ciclos combinados. Aprovechas mejor la exergía.\",\n          \"isCorrect\": true,\n          \"text\": \"Podría alimentar un segundo ciclo térmico\"\n        },\n        {\n          \"feedback\": \"Al revés — rechazar a mayor temperatura REDUCE la eficiencia del primer motor. Carnot dice η = 1 - Tc/Th. Mayor Tc significa menor eficiencia. La ventaja es otra.\",\n          \"isCorrect\": false,\n          \"text\": \"Aumentaría la eficiencia del primer motor\"\n        },\n        {\n          \"feedback\": \"Calor a mayor temperatura tiene menor entropía por unidad de energía, sí. Pero la ventaja práctica es que puede alimentar otro ciclo térmico usando el ambiente como sumidero.\",\n          \"isCorrect\": false,\n          \"text\": \"El calor tendría menor entropía\"\n        },\n        {\n          \"feedback\": \"Sí hay ventaja: calor a 500 K puede ser fuente caliente para un segundo motor. Es el concepto de ciclo combinado que aumenta eficiencia total del sistema.\",\n          \"isCorrect\": false,\n          \"text\": \"No habría ninguna ventaja\"\n        }\n      ],\n      \"question\": \"¿Qué ventaja tendría rechazar calor a mayor temperatura?\"\n    },\n    {\n      \"context\": \"Les encantó la idea del ciclo combinado. Pero espera, {{NAME}}... acabo de recibir otro correo. Ahora dicen que instalaron el refrigerador y está 'funcionando increíblemente bien'. Afirman que con 100 kJ de trabajo eléctrico, mueven 400 kJ de calor desde la cámara a -20°C. El ambiente está a 30°C.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correcto. COP_Carnot = Tc/(Th-Tc) = 253/(303-253) = 5.06. Un COP real de 4 (400kJ/100kJ) está por debajo del límite teórico. Es un buen refrigerador, pero físicamente posible.\",\n          \"isCorrect\": true,\n          \"text\": \"Sí, el COP teórico máximo es mayor a 4\"\n        },\n        {\n          \"feedback\": \"No la viola. COP_Carnot = 253/(303-253) = 5.06. Un COP de 4 es menor al máximo teórico. Es excelente rendimiento pero termodinámicamente válido.\",\n          \"isCorrect\": false,\n          \"text\": \"No, viola la segunda ley\"\n        },\n        {\n          \"feedback\": \"Error común. Los refrigeradores pueden tener COP > 1 porque no están convirtiendo calor en trabajo (limitado por Carnot), sino moviendo calor usando trabajo. Son procesos diferentes.\",\n          \"isCorrect\": false,\n          \"text\": \"No, el COP no puede ser mayor a 1\"\n        },\n        {\n          \"feedback\": \"Tienes todos los datos. Tc = -20°C = 253 K, Th = 30°C = 303 K. COP_Carnot = Tc/(Th-Tc) = 5.06. COP real = 4. Está dentro del límite físico.\",\n          \"isCorrect\": false,\n          \"text\": \"Necesito más datos para calcular\"\n        }\n      ],\n      \"question\": \"¿Es creíble este rendimiento del refrigerador?\"\n    },\n    {\n      \"context\": \"Qué alivio, {{NAME}}. Al menos el refrigerador sí funciona correctamente. Pero aquí viene lo raro... acaban de llamar de nuevo. Aparentemente el gerente de planta, sin consultar a nadie, decidió 'optimizar' el sistema. Conectó el calor rechazado del motor DIRECTAMENTE al refrigerador. Dice que así 'recicla la energía'.\",\n      \"options\": [\n        {\n          \"feedback\": \"Exacto. El gerente confundió energía con trabajo. El refrigerador necesita trabajo mecánico o eléctrico para funcionar. Calor a 300 K no puede sustituir eso — está demasiado degradado termodinámicamente.\",\n          \"isCorrect\": true,\n          \"text\": \"El refrigerador necesita trabajo, no calor\"\n        },\n        {\n          \"feedback\": \"El problema no es temperatura sino tipo de energía. Aunque el calor estuviera más caliente, el refrigerador necesita trabajo (energía ordenada), no calor (energía desordenada).\",\n          \"isCorrect\": false,\n          \"text\": \"El calor está muy frío para el refrigerador\"\n        },\n        {\n          \"feedback\": \"No viola primera ley — la energía sigue existiendo. El problema es de segunda ley: calor de baja temperatura no puede hacer el trabajo que el refrigerador requiere para mover calor cuesta arriba.\",\n          \"isCorrect\": false,\n          \"text\": \"Viola la primera ley\"\n        },\n        {\n          \"feedback\": \"El problema es más fundamental: el refrigerador simplemente no funcionará. Necesita trabajo mecánico/eléctrico como entrada. Calor no puede sustituir trabajo en este proceso.\",\n          \"isCorrect\": false,\n          \"text\": \"El refrigerador se sobrecalentará\"\n        }\n      ],\n      \"question\": \"¿Qué está mal con esta 'optimización'?\"\n    },\n    {\n      \"context\": \"Le expliqué al gerente que calor ≠ trabajo y que la entropía importa. Pareció entenderlo. Pero ahora pregunta: 'Entonces, si tengo calor residual que no puedo usar... ¿a dónde va? ¿Desaparece?' Creo que necesita una explicación sobre el destino final de la energía.\",\n      \"options\": [\n        {\n          \"feedback\": \"Exacto. La energía no desaparece (primera ley), pero se degrada a formas menos útiles (segunda ley). El calor se dispersa al ambiente, aumentando la entropía del universo. Sigue ahí, pero inutilizable.\",\n          \"isCorrect\": true,\n          \"text\": \"Se dispersa al ambiente, aumentando entropía total\"\n        },\n        {\n          \"feedback\": \"La segunda ley no destruye energía — eso violaría la primera ley. Lo que aumenta es la entropía. La energía se conserva pero se dispersa hasta ser irrecuperable para trabajo.\",\n          \"isCorrect\": false,\n          \"text\": \"Se destruye según la segunda ley\"\n        },\n        {\n          \"feedback\": \"Se transfiere al sumidero, sí, pero no se 'almacena' permanentemente. Se disipa al ambiente, eventualmente equilibrándose. La energía existe pero a temperatura ambiente es inútil para trabajo.\",\n          \"isCorrect\": false,\n          \"text\": \"Se almacena en el sumidero frío\"\n        },\n        {\n          \"feedback\": \"No se transforma — sigue siendo energía térmica. El problema es que a temperatura ambiente, sin gradiente térmico aprovechable, no puede realizar trabajo. Alta entropía = baja utilidad.\",\n          \"isCorrect\": false,\n          \"text\": \"Se convierte en otra forma de energía\"\n        }\n      ],\n      \"question\": \"¿Qué le pasa a la energía que no podemos aprovechar?\"\n    },\n    {\n      \"context\": \"{{NAME}}, no vas a creer esto. El gerente acaba de mandar un último correo. Dice: 'Entendí todo. La termodinámica me limita. Pero encontré la solución: contraté a un consultor que dice tener un motor que funciona con el calor del ambiente sin necesidad de fuente caliente. ¡Energía gratis del aire!'\",\n      \"options\": [\n        {\n          \"feedback\": \"¡Exacto! La segunda ley requiere diferencia de temperatura para extraer trabajo. Usar solo el ambiente como fuente es un móvil perpetuo de segunda especie — imposible. El 'consultor' es un fraude.\",\n          \"isCorrect\": true,\n          \"text\": \"Sin gradiente de temperatura, no hay trabajo posible\"\n        },\n        {\n          \"feedback\": \"El ambiente tiene ENORME cantidad de energía térmica. El problema no es cantidad sino calidad. Sin sumidero más frío que el ambiente, no hay gradiente para extraer trabajo. Segunda ley.\",\n          \"isCorrect\": false,\n          \"text\": \"El ambiente no tiene suficiente energía\"\n        },\n        {\n          \"feedback\": \"Un refrigerador crearía un sumidero frío, sí, pero requiere trabajo para operar. Terminarías gastando más trabajo del que produces. No hay ganancia neta — las leyes ganan siempre.\",\n          \"isCorrect\": false,\n          \"text\": \"Necesitaría un refrigerador auxiliar\"\n        },\n        {\n          \"feedback\": \"La primera ley se cumple — no crea energía de la nada. El problema es la segunda ley: sin gradiente térmico (fuente caliente y sumidero frío), no puedes convertir calor en trabajo. Es otro límite.\",\n          \"isCorrect\": false,\n          \"text\": \"La primera ley lo prohíbe\"\n        }\n      ],\n      \"question\": \"¿Cómo le explicas que esto es imposible?\"\n    },\n    {\n      \"context\": \"Le mandé un correo detallado explicando por qué ese 'consultor' es un estafador. Citando la segunda ley, el límite de Carnot, todo. El gerente respondió: 'Tienen razón. Casi caigo. Gracias por salvarme de tirar dinero a la basura.' Creo que finalmente lo entiende, {{NAME}}.\",\n      \"options\": [\n        {\n          \"feedback\": \"¡Exacto! Primera ley: la energía se conserva. Segunda ley: hay límites de eficiencia y dirección. Carnot es el techo. Cualquier propuesta que los viole es fraudulenta. La física no negocia.\",\n          \"isCorrect\": true,\n          \"text\": \"Las leyes de la termodinámica son límites absolutos\"\n        },\n        {\n          \"feedback\": \"La calibración es importante, pero la lección central es que las leyes termodinámicas son absolutas. Ningún dispositivo las viola — si los números dicen lo contrario, el error es de medición.\",\n          \"isCorrect\": false,\n          \"text\": \"Los sensores siempre deben estar calibrados\"\n        },\n        {\n          \"feedback\": \"No es cuestión de cuál es 'mejor' — son procesos inversos con diferentes métricas. La lección clave es que ambos obedecen límites termodinámicos inquebrantables.\",\n          \"isCorrect\": false,\n          \"text\": \"Los refrigeradores son más eficientes que los motores\"\n        },\n        {\n          \"feedback\": \"No siempre — los ciclos combinados aprovechan calor residual a alta temperatura. La lección es que las leyes termodinámicas determinan qué es posible y qué no. Son límites absolutos.\",\n          \"isCorrect\": false,\n          \"text\": \"El calor residual siempre es inútil\"\n        }\n      ],\n      \"question\": \"¿Cuál es la lección más importante de este caso?\"\n    }\n  ]\n}",
      "outputTokens": 5556,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "es-physics-thermodynamics-applications-1",
      "userPrompt": "LESSON_TITLE: Termodinamica Aplicada\nLESSON_DESCRIPTION: Aplicando las leyes de la termodinamica para entender y disenar sistemas energeticos\nCHAPTER_TITLE: Termodinamica\nCOURSE_TITLE: Fisica para Ingenieros\nLANGUAGE: es\nEXPLANATION_STEPS:\n1. Conservacion de Energia: La primera ley dice que la energia se conserva — no se crea ni destruye, solo se transforma. El calor que entra menos el trabajo que sale iguala el cambio de energia interna.\n2. Direccion del Calor: La segunda ley establece una direccion: el calor fluye espontaneamente de caliente a frio, nunca al reves. Esto limita la eficiencia de cualquier motor termico.\n3. Entropia: La entropia mide la dispersion de energia. Cuando la energia se dispersa (calor fluyendo a lo frio), la entropia aumenta. Concentrar energia requiere trabajo externo.\n4. Limite de Carnot: El ciclo de Carnot define la eficiencia maxima teorica. Ningun motor real puede ser mas eficiente. La eficiencia depende de las temperaturas de las fuentes caliente y fria.\n5. Refrigeracion: Los refrigeradores y bombas de calor mueven calor de frio a caliente usando trabajo. No violan la segunda ley — el trabajo compensa el flujo 'antinatural' de calor."
    },
    {
      "duration": 83979.536166,
      "inputTokens": 4226,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, we've got a situation. The product team wants to launch a flash sale in two hours, but our inventory service just started throwing errors. Three of our five database replicas can't reach each other. Sales is panicking because if we show wrong stock counts, we'll either oversell or lose revenue.\",\n      \"options\": [\n        {\n          \"feedback\": \"This isn't about security. With a network partition happening, we're facing the classic CAP theorem trade-off: do we prioritize consistency or availability?\",\n          \"isCorrect\": false,\n          \"text\": \"Speed vs. security\"\n        },\n        {\n          \"feedback\": \"Exactly. With a network partition in progress, CAP theorem tells us we can't have both. We need to decide: reject some requests to stay consistent, or stay available and risk stale data.\",\n          \"isCorrect\": true,\n          \"text\": \"Consistency vs. availability\"\n        },\n        {\n          \"feedback\": \"Budget isn't the issue right now. We have a network partition, which forces us to choose between consistency and availability. That's the CAP theorem trade-off.\",\n          \"isCorrect\": false,\n          \"text\": \"Cost vs. performance\"\n        },\n        {\n          \"feedback\": \"Those are related but not the core issue. With nodes unable to communicate, we're hitting the CAP theorem — we must choose between consistent data and staying available.\",\n          \"isCorrect\": false,\n          \"text\": \"Latency vs. throughput\"\n        }\n      ],\n      \"question\": \"What's the core trade-off we're facing here?\"\n    },\n    {\n      \"context\": \"Right, CAP theorem. So here's where we're at: two replicas are on one side of the partition, three on the other. The flash sale is inventory-sensitive — we absolutely cannot sell items we don't have. But if we go completely offline, we lose millions in revenue. What approach should we take?\",\n      \"options\": [\n        {\n          \"feedback\": \"With inventory, overselling creates real problems — angry customers, refunds, reputation damage. For this use case, we need consistency even if it means some requests fail.\",\n          \"isCorrect\": false,\n          \"text\": \"Prioritize availability, fix later\"\n        },\n        {\n          \"feedback\": \"Smart call. Inventory is a case where consistency matters more than availability. Overselling has real consequences. Better to reject some requests than sell items we don't have.\",\n          \"isCorrect\": true,\n          \"text\": \"Prioritize consistency for inventory\"\n        },\n        {\n          \"feedback\": \"That would eliminate partition tolerance entirely. If that one node fails, we lose everything. We need to work within our distributed setup, not abandon it.\",\n          \"isCorrect\": false,\n          \"text\": \"Switch to a single replica\"\n        },\n        {\n          \"feedback\": \"Local caches would quickly become stale and diverge, making the consistency problem worse. We need coordinated reads for accurate inventory counts.\",\n          \"isCorrect\": false,\n          \"text\": \"Cache everything locally\"\n        }\n      ],\n      \"question\": \"Given the risk of overselling, what should we prioritize?\"\n    },\n    {\n      \"context\": \"Okay, consistency it is. Now, we're using a quorum system. With five replicas total, what's our situation? We need writes to succeed on enough nodes that any read will see the latest data. The partition has split us 3-2. Can the side with three nodes still serve consistent reads and writes?\",\n      \"options\": [\n        {\n          \"feedback\": \"Quorums don't require all nodes. With 5 replicas, if read quorum + write quorum > 5, we're guaranteed overlap. A majority (3 nodes) can satisfy both quorums.\",\n          \"isCorrect\": false,\n          \"text\": \"No, we need all five nodes\"\n        },\n        {\n          \"feedback\": \"Correct! With 5 nodes, we typically need 3 for write quorum and 3 for read quorum. 3+3=6 > 5, so there's guaranteed overlap. The majority partition can operate consistently.\",\n          \"isCorrect\": true,\n          \"text\": \"Yes, three nodes can form quorum\"\n        },\n        {\n          \"feedback\": \"Actually, 3 nodes can satisfy both read and write quorums. The key is R+W > N (3+3 > 5). The majority partition can handle both operations consistently.\",\n          \"isCorrect\": false,\n          \"text\": \"Only for reads, not writes\"\n        },\n        {\n          \"feedback\": \"Two nodes can't form a quorum with 5 total replicas. We need 3 nodes for a majority. That's why the 3-node partition can continue, but the 2-node side cannot.\",\n          \"isCorrect\": false,\n          \"text\": \"Yes, but only with two nodes\"\n        }\n      ],\n      \"question\": \"Can the majority partition maintain consistency?\"\n    },\n    {\n      \"context\": \"Perfect. So the three-node partition can keep running with full consistency. But what about the two isolated nodes? Some customers might be routed to them. If we let them accept writes, we'll have conflicting inventory counts. If we reject all requests, those customers see errors. What's the play?\",\n      \"options\": [\n        {\n          \"feedback\": \"For inventory, this is dangerous. Two partitions could both sell the last item. Merging can't un-sell products. We need to reject writes that could cause inconsistency.\",\n          \"isCorrect\": false,\n          \"text\": \"Accept writes, merge later\"\n        },\n        {\n          \"feedback\": \"Even reads could be stale and misleading during a flash sale. Showing 'in stock' when it's sold out causes problems. For critical inventory, the minority should reject requests entirely.\",\n          \"isCorrect\": false,\n          \"text\": \"Accept reads only, reject writes\"\n        },\n        {\n          \"feedback\": \"Right. The minority partition can't guarantee consistency, so it should refuse to operate. Better to show an error than to oversell or show incorrect inventory. This is choosing C over A.\",\n          \"isCorrect\": true,\n          \"text\": \"Reject all requests, show error\"\n        },\n        {\n          \"feedback\": \"If the nodes can't communicate with the majority, they can't redirect to it either — that's what a partition means. They need to refuse requests until connectivity is restored.\",\n          \"isCorrect\": false,\n          \"text\": \"Redirect to majority partition\"\n        }\n      ],\n      \"question\": \"How should the minority partition handle requests?\"\n    },\n    {\n      \"context\": \"Agreed. Minority partition goes into reject mode. Now the product team is asking about our user session service. It's on the same infrastructure. Should we apply the same strict consistency rules there? Users might get logged out if their session data isn't available.\",\n      \"options\": [\n        {\n          \"feedback\": \"Not all data needs the same guarantees. Sessions being slightly stale is annoying but not catastrophic. Logging everyone out during a flash sale would hurt more than a briefly stale session.\",\n          \"isCorrect\": false,\n          \"text\": \"Yes, consistency everywhere\"\n        },\n        {\n          \"feedback\": \"Exactly! Different data has different needs. Session data can tolerate eventual consistency — a slightly stale session is fine. Inventory needs strong consistency. Match the model to the use case.\",\n          \"isCorrect\": true,\n          \"text\": \"No, sessions can be eventually consistent\"\n        },\n        {\n          \"feedback\": \"Sessions still need replication for fault tolerance. The question is what consistency model to use. Eventual consistency is fine here since the cost of stale data is low.\",\n          \"isCorrect\": false,\n          \"text\": \"Sessions don't need replication\"\n        },\n        {\n          \"feedback\": \"While possible, that's not the main point. The insight is that different data types can use different consistency models. Sessions can be eventually consistent while inventory stays strongly consistent.\",\n          \"isCorrect\": false,\n          \"text\": \"Use a completely separate system\"\n        }\n      ],\n      \"question\": \"Should sessions use the same consistency model?\"\n    },\n    {\n      \"context\": \"Nice. So we're running strong consistency for inventory, eventual consistency for sessions. The partition's been going for 20 minutes now. Network team says they're close to fixing it. But here's a concern: once connectivity is restored, the two sides might have diverged. What happens then?\",\n      \"options\": [\n        {\n          \"feedback\": \"Since the minority rejected writes, there shouldn't be conflicting data to lose. The concern is making sure all nodes sync up properly, not data loss.\",\n          \"isCorrect\": false,\n          \"text\": \"Data loss from the minority side\"\n        },\n        {\n          \"feedback\": \"Right. The minority nodes missed updates during the partition. They need to catch up with the majority's state. This resync needs to happen before they can rejoin the quorum.\",\n          \"isCorrect\": true,\n          \"text\": \"Replicas need to resync\"\n        },\n        {\n          \"feedback\": \"A full restart isn't necessary. The nodes just need to resync — the minority catches up on missed writes from the majority. Modern systems handle this automatically.\",\n          \"isCorrect\": false,\n          \"text\": \"We need to restart all services\"\n        },\n        {\n          \"feedback\": \"Since the minority rejected writes, there shouldn't be duplicates. The issue is that minority nodes are behind and need to catch up with the majority's current state.\",\n          \"isCorrect\": false,\n          \"text\": \"Users will see duplicate data\"\n        }\n      ],\n      \"question\": \"What's the main concern when the partition heals?\"\n    },\n    {\n      \"context\": \"The network's back! Minority nodes are resyncing now. But wait — I'm seeing something weird in the logs. Looks like one of our microservices wasn't following our consistency rules. It was set to eventual consistency and kept accepting writes on both sides of the partition. Now we have conflicting order records.\",\n      \"options\": [\n        {\n          \"feedback\": \"Deleting customer orders would be catastrophic! We need a conflict resolution strategy that preserves the data while resolving inconsistencies. Last-write-wins or manual merge.\",\n          \"isCorrect\": false,\n          \"text\": \"Delete all conflicting records\"\n        },\n        {\n          \"feedback\": \"Yes! We need to pick a strategy: last-write-wins is simple but might lose data, vector clocks track causality, or we use application-specific merge logic. For orders, we probably want human review.\",\n          \"isCorrect\": true,\n          \"text\": \"Apply a conflict resolution strategy\"\n        },\n        {\n          \"feedback\": \"That could discard valid customer orders from the minority side. Conflict resolution needs to be more nuanced — maybe merge both, use timestamps, or flag for human review.\",\n          \"isCorrect\": false,\n          \"text\": \"Keep only the majority's version\"\n        },\n        {\n          \"feedback\": \"A backup would lose all recent orders from both sides. We need to resolve the conflicts, not roll back. Strategies like merging or last-write-wins can reconcile the divergent data.\",\n          \"isCorrect\": false,\n          \"text\": \"Restore from backup\"\n        }\n      ],\n      \"question\": \"How do we resolve these conflicting writes?\"\n    },\n    {\n      \"context\": \"Okay, we're flagging conflicting orders for manual review and using timestamps for simpler conflicts. Crisis is stabilizing. But {{NAME}}, I just realized something. The service that caused this mess? It's handling payment confirmations. If we'd had conflicting payment records instead of just orders... we could have charged customers twice or not at all.\",\n      \"options\": [\n        {\n          \"feedback\": \"Opposite! Payments are exactly where eventual consistency is dangerous. Double charges or missed payments are serious. Financial data needs strong consistency guarantees.\",\n          \"isCorrect\": false,\n          \"text\": \"Payments need eventual consistency\"\n        },\n        {\n          \"feedback\": \"Absolutely. Financial transactions can't tolerate conflicts or stale data. Double charges, missed payments, incorrect balances — these have real consequences. Strong consistency is non-negotiable for payments.\",\n          \"isCorrect\": true,\n          \"text\": \"Payments need strong consistency\"\n        },\n        {\n          \"feedback\": \"Synchronous vs asynchronous is a different concern. The key insight is that payments need strong consistency because financial conflicts have serious real-world consequences.\",\n          \"isCorrect\": false,\n          \"text\": \"Payments should be synchronous only\"\n        },\n        {\n          \"feedback\": \"Payments absolutely need replication for durability and fault tolerance. The point is they need strongly consistent replication, not eventual consistency.\",\n          \"isCorrect\": false,\n          \"text\": \"Payments don't need replication\"\n        }\n      ],\n      \"question\": \"What's the lesson for payment systems?\"\n    },\n    {\n      \"context\": \"{{NAME}}, plot twist. I just checked the payment service config. It WAS set to strong consistency. But someone added a 'performance optimization' flag three months ago that silently downgrades to eventual consistency under high load. Guess what? Flash sales are high load. We've been running eventual consistency on payments for every major sale this year.\",\n      \"options\": [\n        {\n          \"feedback\": \"Critical first step. We need to check if any payment conflicts actually occurred during past sales. If customers were double-charged or payments were lost, we need to fix that immediately.\",\n          \"isCorrect\": true,\n          \"text\": \"Audit all past flash sale payments\"\n        },\n        {\n          \"feedback\": \"That's not productive. The immediate priority is assessing damage — did conflicting payments actually happen? Then we fix the config and add safeguards to prevent this.\",\n          \"isCorrect\": false,\n          \"text\": \"Fire whoever added the flag\"\n        },\n        {\n          \"feedback\": \"We need to fix the flag, yes, but first we must audit past transactions. If there were payment conflicts, customers may have been affected. We can't just pretend it didn't happen.\",\n          \"isCorrect\": false,\n          \"text\": \"Just remove the flag and move on\"\n        },\n        {\n          \"feedback\": \"The database isn't the problem — the misconfiguration is. First, audit for damage from past sales. Then fix the config and add safeguards. Changing databases doesn't address the real issue.\",\n          \"isCorrect\": false,\n          \"text\": \"Switch to a different database\"\n        }\n      ],\n      \"question\": \"What's the immediate priority?\"\n    },\n    {\n      \"context\": \"Audit's running. So far it looks like we got lucky — no actual payment conflicts materialized, just the potential was there. I'm removing that flag permanently. But this whole incident taught me something. {{NAME}}, how would you summarize what we learned today about consistency in distributed systems?\",\n      \"options\": [\n        {\n          \"feedback\": \"Not quite. Strong consistency isn't always the answer — sessions were fine with eventual consistency. The key is matching consistency level to data criticality. Payments need strong, sessions don't.\",\n          \"isCorrect\": false,\n          \"text\": \"Always use strong consistency\"\n        },\n        {\n          \"feedback\": \"Perfect summary! Inventory and payments need strong consistency because conflicts have real consequences. Sessions can be eventual. The right consistency model depends on what happens if your data is wrong.\",\n          \"isCorrect\": true,\n          \"text\": \"Match consistency to data criticality\"\n        },\n        {\n          \"feedback\": \"That's not realistic — distributed systems are necessary for scale and reliability. The lesson is to understand trade-offs and choose the right consistency model for each type of data.\",\n          \"isCorrect\": false,\n          \"text\": \"Avoid distributed systems entirely\"\n        },\n        {\n          \"feedback\": \"We survived this partition fine! The lesson isn't that partitions are fatal, but that you need to design for them. Different data types can handle partitions differently based on their consistency needs.\",\n          \"isCorrect\": false,\n          \"text\": \"Network partitions are always fatal\"\n        }\n      ],\n      \"question\": \"What's the key takeaway from this incident?\"\n    }\n  ]\n}",
      "outputTokens": 3880,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "en-cs-distributed-systems-consistency-1",
      "userPrompt": "LESSON_TITLE: Consistency in Distributed Systems\nLESSON_DESCRIPTION: Navigating consistency and availability trade-offs in distributed systems\nCHAPTER_TITLE: Distributed Data\nCOURSE_TITLE: System Design\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. CAP Theorem: The CAP theorem states you can only have two of three: Consistency, Availability, and Partition tolerance. Since network partitions happen, you're really choosing between C and A.\n2. Strong Consistency: Strong consistency means all nodes see the same data at the same time. Every read returns the most recent write. This requires coordination that can slow things down.\n3. Eventual Consistency: Eventual consistency means replicas will converge given enough time without new writes. Reads might return stale data temporarily, but the system stays available.\n4. Partition Handling: Network partitions occur when nodes can't communicate. The system must decide: reject requests (maintain consistency) or accept requests that might conflict (maintain availability).\n5. Quorum Systems: Quorum-based systems use voting. A write succeeds if enough replicas acknowledge it. Read quorum + write quorum > total nodes ensures reading at least one up-to-date copy.\n6. Conflict Resolution: Conflict resolution strategies handle divergent writes: last-write-wins, vector clocks, or application-specific merge logic. The right choice depends on your data semantics."
    },
    {
      "duration": 82696.34554200002,
      "inputTokens": 4182,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, I need your help. We just got the analytics back on our new savings app, and it's a disaster. Users sign up, but almost nobody actually sets up automatic deposits. The feature is right there on the dashboard. What are we missing?\",\n      \"options\": [\n        {\n          \"feedback\": \"Visibility matters, but you said the feature is right on the dashboard. The real issue is present bias — users see the value of future savings but the money feels more valuable to them right now.\",\n          \"isCorrect\": false,\n          \"text\": \"The feature isn't visible enough\"\n        },\n        {\n          \"feedback\": \"Exactly. Users intellectually know saving is good, but present bias makes today's money feel more valuable than tomorrow's security. We need to design around this psychological tendency.\",\n          \"isCorrect\": true,\n          \"text\": \"Users are experiencing present bias\"\n        },\n        {\n          \"feedback\": \"Even great rates won't overcome present bias. Users aren't doing a rational calculation — they're feeling the pull of having money available now versus locked away for later.\",\n          \"isCorrect\": false,\n          \"text\": \"The interest rates aren't competitive\"\n        },\n        {\n          \"feedback\": \"Trust matters for new apps, but this is about the psychology of saving itself. Present bias makes immediate money feel more valuable than future security, regardless of trust.\",\n          \"isCorrect\": false,\n          \"text\": \"Users don't trust the app yet\"\n        }\n      ],\n      \"question\": \"What's likely causing the low adoption of automatic deposits?\"\n    },\n    {\n      \"context\": \"Present bias, right. That makes sense — they want to save 'someday' but not today. Okay, so I was thinking we could add more educational content about compound interest. Show them charts of how much they'll have in 30 years. That should motivate them, right?\",\n      \"options\": [\n        {\n          \"feedback\": \"People already know saving is smart — that's why they downloaded a savings app. Present bias isn't about knowledge; it's about the psychological pull of now versus later. Education won't overcome that.\",\n          \"isCorrect\": false,\n          \"text\": \"Yes, people need to understand the math\"\n        },\n        {\n          \"feedback\": \"Right. Users already know saving matters. Present bias is emotional, not intellectual. We need behavioral interventions like commitment devices or smart defaults, not more information.\",\n          \"isCorrect\": true,\n          \"text\": \"No, present bias isn't a knowledge gap\"\n        },\n        {\n          \"feedback\": \"The format isn't the issue. Users already understand saving is valuable — that's why they signed up. Present bias requires behavioral solutions, not better explanations.\",\n          \"isCorrect\": false,\n          \"text\": \"Yes, but use videos instead of charts\"\n        },\n        {\n          \"feedback\": \"Gamification can help engagement, but it doesn't address the core issue. Present bias requires structural interventions like commitment devices that help users lock in future behavior now.\",\n          \"isCorrect\": false,\n          \"text\": \"Partially — combine education with gamification\"\n        }\n      ],\n      \"question\": \"Will education about future benefits solve this problem?\"\n    },\n    {\n      \"context\": \"Okay, so more education won't cut it. What if we redesign the onboarding flow? Right now, users set up their profile, link their bank account, and then land on a dashboard where they can optionally set up automatic deposits. Most people just skip that last step.\",\n      \"options\": [\n        {\n          \"feedback\": \"Perfect use of default effects. People tend to stick with pre-selected options. Making a reasonable deposit amount the default — while still allowing opt-out — can dramatically increase adoption without forcing anyone.\",\n          \"isCorrect\": true,\n          \"text\": \"Make automatic deposits the default\"\n        },\n        {\n          \"feedback\": \"We just established that education won't overcome present bias. The issue isn't understanding — it's the friction of making an active choice. Default effects are much more powerful here.\",\n          \"isCorrect\": false,\n          \"text\": \"Add a tutorial explaining the benefits\"\n        },\n        {\n          \"feedback\": \"Forcing the action removes choice and would likely tank signups entirely. Default effects work because they guide behavior while preserving freedom — people can still opt out if they want.\",\n          \"isCorrect\": false,\n          \"text\": \"Require deposits to complete signup\"\n        },\n        {\n          \"feedback\": \"Reminders just repeat the same decision point where present bias already won. Default effects work at the moment of choice, making the beneficial behavior the path of least resistance.\",\n          \"isCorrect\": false,\n          \"text\": \"Send reminder emails after signup\"\n        }\n      ],\n      \"question\": \"How should we restructure this onboarding?\"\n    },\n    {\n      \"context\": \"I love the default idea. So we pre-select, say, $25 per week as the default, and users can change it or turn it off if they want. But wait — what if users feel manipulated when they realize we pre-selected something for them? That could backfire.\",\n      \"options\": [\n        {\n          \"feedback\": \"Hiding defaults would be genuinely manipulative and erode trust. Transparency is key — ethical default design means the default is clearly visible and easily changeable.\",\n          \"isCorrect\": false,\n          \"text\": \"Hide that it's a default\"\n        },\n        {\n          \"feedback\": \"Exactly right. Ethical nudges are transparent. Users should clearly see the pre-selected amount and easily adjust it. This respects autonomy while still leveraging default effects for their benefit.\",\n          \"isCorrect\": true,\n          \"text\": \"Make the default transparent and changeable\"\n        },\n        {\n          \"feedback\": \"Removing defaults doesn't eliminate influence — it just shifts the default to 'no action.' Every design choice nudges somehow. Better to use thoughtful, transparent defaults that help users achieve their stated goals.\",\n          \"isCorrect\": false,\n          \"text\": \"Remove the default to avoid any risk\"\n        },\n        {\n          \"feedback\": \"This doesn't address the manipulation concern — it just limits who experiences it. The real answer is transparency: make defaults visible and easy to change for everyone.\",\n          \"isCorrect\": false,\n          \"text\": \"Only apply defaults to premium users\"\n        }\n      ],\n      \"question\": \"How do we address this manipulation concern?\"\n    },\n    {\n      \"context\": \"Transparent and easy to change. Got it. Okay, new problem: we also have a feature where users can set savings goals — like 'vacation fund' or 'emergency savings.' Hardly anyone uses it. They just dump money into one generic account.\",\n      \"options\": [\n        {\n          \"feedback\": \"Rewards might get initial engagement but don't address why users skip goals. Social proof — showing that most successful savers use goals — taps into our tendency to follow what others do.\",\n          \"isCorrect\": false,\n          \"text\": \"Offer rewards for setting goals\"\n        },\n        {\n          \"feedback\": \"Social proof is powerful. Showing that '73% of our top savers use specific goals' leverages our tendency to look at what others do. It signals that goal-setting is normal and effective.\",\n          \"isCorrect\": true,\n          \"text\": \"Show social proof of goal-setters\"\n        },\n        {\n          \"feedback\": \"Forcing goals removes user agency and could frustrate people who just want simplicity. Social proof gently encourages without coercion — it shows what successful users do.\",\n          \"isCorrect\": false,\n          \"text\": \"Make goals mandatory\"\n        },\n        {\n          \"feedback\": \"More options can actually increase decision paralysis. The issue is motivation to set any goal. Social proof shows that other successful users set goals, which is more compelling than more choices.\",\n          \"isCorrect\": false,\n          \"text\": \"Add more goal templates\"\n        }\n      ],\n      \"question\": \"What behavioral principle could increase goal-setting?\"\n    },\n    {\n      \"context\": \"Nice — '73% of our top savers set specific goals.' I like that. Okay, we're making progress. But here's another issue: users who DO set goals often abandon them halfway through. They start strong, then life happens, and they stop contributing.\",\n      \"options\": [\n        {\n          \"feedback\": \"Goal difficulty is a factor, but the pattern of starting strong then fading is classic present bias. Initial motivation fades, and without a commitment device, users revert to prioritizing immediate spending.\",\n          \"isCorrect\": false,\n          \"text\": \"The goals are set too high\"\n        },\n        {\n          \"feedback\": \"Exactly. Initial motivation overcomes present bias temporarily, but it fades. Without a commitment device to lock in the behavior, users gradually return to prioritizing immediate spending over future goals.\",\n          \"isCorrect\": true,\n          \"text\": \"Present bias reasserts itself over time\"\n        },\n        {\n          \"feedback\": \"Forgetting might contribute, but reminders alone won't solve this. The core issue is present bias — even when reminded, today's spending feels more urgent than tomorrow's goals.\",\n          \"isCorrect\": false,\n          \"text\": \"Users forget about their goals\"\n        },\n        {\n          \"feedback\": \"Celebration helps, but it doesn't address the fundamental pull of present bias. Users need commitment devices that make it harder to abandon goals, not just encouragement to continue.\",\n          \"isCorrect\": false,\n          \"text\": \"The app doesn't celebrate progress\"\n        }\n      ],\n      \"question\": \"What causes this mid-goal abandonment?\"\n    },\n    {\n      \"context\": \"Right, so we need commitment devices — ways to help users lock in their future behavior now, before present bias kicks back in. What kind of commitment mechanism would work here?\",\n      \"options\": [\n        {\n          \"feedback\": \"Penalties can work but feel punitive. A better approach uses loss aversion positively — showing progress and what they'd lose by quitting, rather than punishing failure.\",\n          \"isCorrect\": false,\n          \"text\": \"Let users set penalties for missing deposits\"\n        },\n        {\n          \"feedback\": \"Loss aversion makes losses hurt twice as much as gains feel good. Showing 'You've saved $340 toward your vacation — stopping now means losing 3 months of progress' is powerful motivation to continue.\",\n          \"isCorrect\": true,\n          \"text\": \"Show them what they'll lose by quitting\"\n        },\n        {\n          \"feedback\": \"Reminders don't create commitment — they just repeat the decision point where present bias wins. True commitment devices make abandoning the goal feel costly, leveraging loss aversion.\",\n          \"isCorrect\": false,\n          \"text\": \"Send more frequent reminders\"\n        },\n        {\n          \"feedback\": \"Hard locks might feel too restrictive and discourage goal-setting entirely. A softer approach — showing what they'd lose by quitting — leverages loss aversion while preserving flexibility.\",\n          \"isCorrect\": false,\n          \"text\": \"Lock funds until the goal is reached\"\n        }\n      ],\n      \"question\": \"What's an effective commitment device for savings goals?\"\n    },\n    {\n      \"context\": \"Loss aversion — show them what they'd lose. 'You've saved $340. Quitting now means losing 3 months of progress.' That's clever. It's not a penalty, but it makes quitting feel costly. Okay, I think we've got a solid redesign plan here.\",\n      \"options\": [\n        {\n          \"feedback\": \"Exactly. Default deposits overcome present bias at signup, social proof encourages goal-setting, and loss aversion framing creates commitment to continue. Multiple principles working together.\",\n          \"isCorrect\": true,\n          \"text\": \"Defaults, social proof, and loss aversion\"\n        },\n        {\n          \"feedback\": \"We specifically moved away from education because present bias isn't a knowledge problem. Our redesign uses defaults, social proof, and loss aversion — behavioral interventions, not information.\",\n          \"isCorrect\": false,\n          \"text\": \"Education, gamification, and rewards\"\n        },\n        {\n          \"feedback\": \"Those are marketing tactics, not what we designed. We're using default effects for adoption, social proof for goal-setting, and loss aversion framing to maintain commitment.\",\n          \"isCorrect\": false,\n          \"text\": \"Scarcity, urgency, and exclusivity\"\n        },\n        {\n          \"feedback\": \"Those are technical features, not behavioral principles. Our redesign specifically leverages default effects, social proof, and loss aversion — psychological principles that shape behavior.\",\n          \"isCorrect\": false,\n          \"text\": \"Personalization, automation, and AI\"\n        }\n      ],\n      \"question\": \"What behavioral principles are we now using together?\"\n    },\n    {\n      \"context\": \"Wait, {{NAME}}. I just got a message from legal. They're concerned about our new default deposits feature. They want us to add a big warning screen that says 'AUTOMATIC WITHDRAWALS WILL OCCUR' with scary red text. They think it protects users.\",\n      \"options\": [\n        {\n          \"feedback\": \"This isn't about aesthetics. The problem is framing effects — 'automatic withdrawals' frames saving as losing money. The same action framed as 'automatic savings' feels completely different.\",\n          \"isCorrect\": false,\n          \"text\": \"Red text is bad for brand aesthetics\"\n        },\n        {\n          \"feedback\": \"Classic framing effect. 'Automatic withdrawals' makes saving feel like money being taken away. 'Automatic savings' frames the identical action as building wealth. Same reality, opposite emotional response.\",\n          \"isCorrect\": true,\n          \"text\": \"It frames saving as a loss, not a gain\"\n        },\n        {\n          \"feedback\": \"Whether they read it isn't the core issue. The problem is that 'withdrawals' frames saving as losing money. Framing effects mean how we present information shapes how it feels, even subconsciously.\",\n          \"isCorrect\": false,\n          \"text\": \"Users won't read warning screens anyway\"\n        },\n        {\n          \"feedback\": \"We can meet legal requirements with better framing. The issue is that 'automatic withdrawals' triggers loss aversion negatively — framing it as 'automatic savings' is equally transparent but psychologically positive.\",\n          \"isCorrect\": false,\n          \"text\": \"Legal requirements should always come first\"\n        }\n      ],\n      \"question\": \"What's the problem with this framing?\"\n    },\n    {\n      \"context\": \"Oh wow, you're right. 'Automatic withdrawals will occur' versus 'Your automatic savings will begin.' Same exact thing, totally different feeling. I'll work with legal on better language that's still transparent. One more thing — our competitor just launched a similar app.\",\n      \"options\": [\n        {\n          \"feedback\": \"Rates matter but aren't behavioral design. Our competitive advantage is thoughtful application of defaults, social proof, and loss aversion framing — psychology-informed design that helps users succeed.\",\n          \"isCorrect\": false,\n          \"text\": \"Offer higher interest rates\"\n        },\n        {\n          \"feedback\": \"Exactly. Most apps ignore behavioral economics. Thoughtful defaults, social proof, loss aversion framing, and smart commitment devices create a product that actually helps users overcome their psychological barriers.\",\n          \"isCorrect\": true,\n          \"text\": \"Apply behavioral principles more thoughtfully\"\n        },\n        {\n          \"feedback\": \"Feature count isn't the answer — many apps have features people don't use. Behavioral design means fewer features that work with human psychology, not more features that fight against it.\",\n          \"isCorrect\": false,\n          \"text\": \"Add more features than competitors\"\n        },\n        {\n          \"feedback\": \"Marketing gets users in the door, but behavioral design keeps them succeeding. Apps that work with human psychology — using defaults, framing, social proof — create loyal users who achieve their goals.\",\n          \"isCorrect\": false,\n          \"text\": \"Spend more on marketing\"\n        }\n      ],\n      \"question\": \"How might we differentiate using behavioral design?\"\n    },\n    {\n      \"context\": \"{{NAME}}, I just realized something funny. Remember how we started this conversation because nobody was using our features? Turns out the problem wasn't our features at all. It was that we designed them like humans are perfectly rational decision-makers.\",\n      \"options\": [\n        {\n          \"feedback\": \"'Irrational' is too dismissive. Humans are predictably influenced by psychology — loss aversion, present bias, defaults, framing, social proof. Good design works with these tendencies, not against them.\",\n          \"isCorrect\": false,\n          \"text\": \"Users are irrational and need guidance\"\n        },\n        {\n          \"feedback\": \"That's the key insight. Humans aren't irrational — we're predictably human. Behavioral design means understanding psychological patterns like present bias and defaults, then designing products that work with them.\",\n          \"isCorrect\": true,\n          \"text\": \"Design must work with human psychology\"\n        },\n        {\n          \"feedback\": \"We learned the opposite. Present bias isn't a knowledge gap. Behavioral design uses structural interventions — defaults, commitment devices, framing — not more information.\",\n          \"isCorrect\": false,\n          \"text\": \"More education solves behavior problems\"\n        },\n        {\n          \"feedback\": \"Simplicity helps usability, but that's not the insight here. Behavioral design is about psychology — understanding how defaults, framing, and loss aversion shape behavior, then designing accordingly.\",\n          \"isCorrect\": false,\n          \"text\": \"Simple interfaces are always better\"\n        }\n      ],\n      \"question\": \"What's the core insight about behavioral design?\"\n    }\n  ]\n}",
      "outputTokens": 3386,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "en-economics-behavioral-design-1",
      "userPrompt": "LESSON_TITLE: Behavioral Design in Practice\nLESSON_DESCRIPTION: Applying behavioral economics principles to design products and systems that work with human psychology\nCHAPTER_TITLE: Applied Behavioral Economics\nCOURSE_TITLE: Product Psychology\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. Loss Aversion: Loss aversion means losses hurt more than equivalent gains feel good — roughly twice as much. People will take irrational risks to avoid losses they wouldn't take to achieve gains.\n2. Framing Effects: Framing effects show that how you present options matters as much as what the options are. '90% survival rate' and '10% mortality rate' are logically identical but feel different.\n3. Default Effects: Default effects are powerful because people tend to stick with pre-selected options. Changing the default can dramatically change outcomes without restricting choice.\n4. Present Bias: Present bias makes us overvalue immediate rewards over future ones. We know we should save for retirement, but the money feels more valuable now. Commitment devices help.\n5. Social Proof: Social proof drives behavior — we look to others to decide what's appropriate. Showing that 'most people do X' is often more effective than explaining why X is good."
    },
    {
      "duration": 84126.38945900003,
      "inputTokens": 4335,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, preciso da sua ajuda urgente! A professora Mariana acabou de mandar mensagem — o experimento de síntese que o pessoal do terceiro ano montou deu problema. Eles queriam fazer uma substituição nucleofílica num haleto de alquila primário usando iodeto como nucleófilo, mas a reação tá demorando uma eternidade. Ela quer que a gente analise o protocolo e descubra o que está errado.\",\n      \"options\": [\n        {\n          \"feedback\": \"Exato! Para um substrato primário com nucleófilo forte como iodeto, esperamos SN2. Identificar o mecanismo correto é o primeiro passo para diagnosticar o problema.\",\n          \"isCorrect\": true,\n          \"text\": \"Verificar o mecanismo esperado\"\n        },\n        {\n          \"feedback\": \"Aumentar temperatura sem entender o problema pode causar reações laterais. Primeiro precisamos identificar qual mecanismo deveria operar aqui.\",\n          \"isCorrect\": false,\n          \"text\": \"Aumentar a temperatura imediatamente\"\n        },\n        {\n          \"feedback\": \"Nucleófilo mais fraco tornaria a reação ainda mais lenta! Iodeto já é um bom nucleófilo para SN2.\",\n          \"isCorrect\": false,\n          \"text\": \"Trocar o nucleófilo por um mais fraco\"\n        },\n        {\n          \"feedback\": \"Mais substrato não resolve se há um problema fundamental no protocolo. Precisamos diagnosticar antes de modificar.\",\n          \"isCorrect\": false,\n          \"text\": \"Adicionar mais substrato\"\n        }\n      ],\n      \"question\": \"Por onde devemos começar a análise?\"\n    },\n    {\n      \"context\": \"Boa, {{NAME}}! Então, substrato primário com iodeto de sódio... isso grita SN2, né? Mecanismo concertado, nucleófilo forte atacando por trás enquanto o grupo de saída sai. Deixa eu ver o protocolo aqui... Eles estão usando brometo de n-butila como substrato em etanol como solvente. Hmm, percebeu algo estranho aí?\",\n      \"options\": [\n        {\n          \"feedback\": \"Isso mesmo! Solventes polares próticos solvatam o nucleófilo, reduzindo sua reatividade. Para SN2, solventes apróticos como acetona ou DMSO seriam muito melhores.\",\n          \"isCorrect\": true,\n          \"text\": \"Etanol é polar prótico, desfavorece SN2\"\n        },\n        {\n          \"feedback\": \"Brometo de n-butila é solúvel em etanol. O problema é que etanol solvata o nucleófilo, diminuindo sua força e prejudicando SN2.\",\n          \"isCorrect\": false,\n          \"text\": \"Etanol não dissolve o substrato\"\n        },\n        {\n          \"feedback\": \"Etanol não reage significativamente com iodeto. O problema é a solvatação do nucleófilo, que reduz sua reatividade em SN2.\",\n          \"isCorrect\": false,\n          \"text\": \"Etanol reage com o iodeto\"\n        },\n        {\n          \"feedback\": \"Eliminação seria mais problema em substratos terciários ou com bases fortes. Aqui o problema é que etanol solvata o iodeto, diminuindo a velocidade de SN2.\",\n          \"isCorrect\": false,\n          \"text\": \"Etanol favorece eliminação\"\n        }\n      ],\n      \"question\": \"Qual é o problema com o solvente escolhido?\"\n    },\n    {\n      \"context\": \"Exatamente o que eu pensei, {{NAME}}! Etanol formando ligações de hidrogênio com o iodeto, deixando ele menos disponível pra atacar. Vou mandar mensagem pra professora sugerindo trocar pra acetona ou DMSO. Ela respondeu! Diz que tem acetona no lab e perguntou se precisa mudar mais alguma coisa no protocolo.\",\n      \"options\": [\n        {\n          \"feedback\": \"Perfeito! Em SN2, a velocidade depende tanto do substrato quanto do nucleófilo (reação bimolecular). Garantir boa concentração de iodeto vai acelerar ainda mais.\",\n          \"isCorrect\": true,\n          \"text\": \"Verificar a concentração do nucleófilo\"\n        },\n        {\n          \"feedback\": \"Ácido não catalisa SN2 e poderia protonar o nucleófilo, tornando-o menos reativo. Não é uma boa ideia aqui.\",\n          \"isCorrect\": false,\n          \"text\": \"Adicionar catalisador ácido\"\n        },\n        {\n          \"feedback\": \"Excesso de substrato não ajuda tanto. Em SN2, é mais eficaz ter excesso de nucleófilo, já que a velocidade depende de ambas as concentrações.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar excesso de substrato\"\n        },\n        {\n          \"feedback\": \"Só esperar não resolve o problema fundamental do solvente. Com acetona e boa concentração de nucleófilo, a reação será muito mais rápida.\",\n          \"isCorrect\": false,\n          \"text\": \"Esperar mais tempo apenas\"\n        }\n      ],\n      \"question\": \"Devemos sugerir alguma outra modificação?\"\n    },\n    {\n      \"context\": \"Mandei as sugestões. A professora disse que vai ajustar e... espera, ela mandou outra mensagem. Parece que tem mais um problema. O outro grupo está fazendo uma reação diferente — substituição num substrato terciário usando água como nucleófilo. Eles escolheram DMSO como solvente porque ouviram nossa conversa. Mas ela acha que isso não vai funcionar bem.\",\n      \"options\": [\n        {\n          \"feedback\": \"Exato! Substratos terciários impedem SN2 (impedimento estérico) e favorecem SN1. Para SN1, precisamos de solvente polar prótico que estabilize o carbocátion intermediário.\",\n          \"isCorrect\": true,\n          \"text\": \"Substrato terciário favorece SN1, não SN2\"\n        },\n        {\n          \"feedback\": \"DMSO é compatível com água. O problema é que substrato terciário vai por SN1, que precisa de solvente polar prótico para estabilizar o carbocátion.\",\n          \"isCorrect\": false,\n          \"text\": \"DMSO reage com água\"\n        },\n        {\n          \"feedback\": \"Custo não é a questão aqui. O problema é mecanístico — substrato terciário segue SN1, que funciona melhor com solventes polares próticos.\",\n          \"isCorrect\": false,\n          \"text\": \"DMSO é muito caro\"\n        },\n        {\n          \"feedback\": \"Na verdade, água é nucleófilo fraco, o que é compatível com SN1. O problema é que DMSO não estabiliza bem o carbocátion intermediário de SN1.\",\n          \"isCorrect\": false,\n          \"text\": \"Água é nucleófilo muito forte\"\n        }\n      ],\n      \"question\": \"Por que DMSO não é ideal para essa reação?\"\n    },\n    {\n      \"context\": \"Isso, {{NAME}}! Substrato terciário é muito impedido pra SN2 — o nucleófilo não consegue atacar por trás. Então vai por SN1, formando carbocátion primeiro. E carbocátions adoram solventes que possam estabilizá-los com ligações de hidrogênio e alta polaridade. Vou sugerir etanol ou metanol pra eles. Mas espera... a professora perguntou outra coisa. Se usarem um substrato opticamente ativo, o que eles devem esperar do produto?\",\n      \"options\": [\n        {\n          \"feedback\": \"Correto! O carbocátion intermediário é planar, permitindo ataque do nucleófilo por ambos os lados. Isso leva à racemização, embora às vezes haja leve excesso de inversão.\",\n          \"isCorrect\": true,\n          \"text\": \"Mistura racêmica ou parcialmente racêmica\"\n        },\n        {\n          \"feedback\": \"Inversão completa é característica de SN2, não SN1. Em SN1, o carbocátion planar permite ataque por ambos os lados, gerando mistura de estereoisômeros.\",\n          \"isCorrect\": false,\n          \"text\": \"Inversão completa de configuração\"\n        },\n        {\n          \"feedback\": \"Retenção não ocorre em SN1. O carbocátion intermediário é planar e pode ser atacado por qualquer lado, resultando em mistura racêmica.\",\n          \"isCorrect\": false,\n          \"text\": \"Retenção completa de configuração\"\n        },\n        {\n          \"feedback\": \"A estereoquímica do produto em SN1 depende da geometria do carbocátion planar, não da estabilidade relativa dos produtos. Resulta em mistura racêmica.\",\n          \"isCorrect\": false,\n          \"text\": \"Apenas o isômero mais estável\"\n        }\n      ],\n      \"question\": \"Qual será a estereoquímica do produto em SN1?\"\n    },\n    {\n      \"context\": \"Perfeito! Carbocátion planar, ataque dos dois lados, racemização. A professora adorou a explicação. Ah, mas agora ela mandou uma situação mais complicada. Um aluno trouxe um álcool que ele quer converter em éter por substituição nucleofílica. Mas ele tentou direto e não funcionou. Disse que usou etóxido de sódio como nucleófilo num álcool secundário.\",\n      \"options\": [\n        {\n          \"feedback\": \"Exatamente! OH⁻ é base forte, péssimo grupo de saída. Para substituição em álcoois, primeiro precisamos converter OH em bom grupo de saída (tosilato, mesilato) ou protonar.\",\n          \"isCorrect\": true,\n          \"text\": \"Grupo hidroxila é péssimo grupo de saída\"\n        },\n        {\n          \"feedback\": \"Etóxido é nucleófilo forte! O problema é que hidroxila é péssimo grupo de saída — bases fortes não saem facilmente. Precisamos ativar o grupo de saída.\",\n          \"isCorrect\": false,\n          \"text\": \"Etóxido é nucleófilo muito fraco\"\n        },\n        {\n          \"feedback\": \"Álcoois secundários podem reagir por ambos mecanismos. O problema aqui é que OH⁻ é péssimo grupo de saída, independente do mecanismo.\",\n          \"isCorrect\": false,\n          \"text\": \"Álcool secundário só reage por SN1\"\n        },\n        {\n          \"feedback\": \"O problema não é catálise, é que hidroxila não sai. Precisamos converter OH em bom grupo de saída como tosilato, ou usar condições ácidas para protonar.\",\n          \"isCorrect\": false,\n          \"text\": \"Falta de catalisador\"\n        }\n      ],\n      \"question\": \"Por que a reação direta não funcionou?\"\n    },\n    {\n      \"context\": \"Isso mesmo! Hidroxila é base forte demais pra sair assim. A professora perguntou o que o aluno deveria fazer. Eu sugeri converter pra tosilato primeiro — cloreto de tosila com piridina, depois adicionar o etóxido. Ela gostou! Mas aí veio a pergunta difícil: por que tosilato é bom grupo de saída?\",\n      \"options\": [\n        {\n          \"feedback\": \"Perfeito! Bons grupos de saída são bases fracas — estáveis após sair. O ânion tosilato é estabilizado por ressonância com o grupo sulfonila, tornando-o excelente grupo de saída.\",\n          \"isCorrect\": true,\n          \"text\": \"Tosilato é base fraca e estável ao sair\"\n        },\n        {\n          \"feedback\": \"Eletrofilicidade não define grupo de saída. O que importa é estabilidade após sair. Tosilato é base fraca, estabilizado por ressonância, por isso sai facilmente.\",\n          \"isCorrect\": false,\n          \"text\": \"Tosilato é muito eletrofílico\"\n        },\n        {\n          \"feedback\": \"Não é a força da ligação C-O que importa aqui. Tosilato é bom grupo de saída porque o ânion resultante é estável (base fraca, estabilizado por ressonância).\",\n          \"isCorrect\": false,\n          \"text\": \"Tosilato forma ligação fraca com carbono\"\n        },\n        {\n          \"feedback\": \"Tosilato não é pequeno! O que importa é que o ânion tosilato é base fraca, estabilizado por ressonância com o grupo sulfonila.\",\n          \"isCorrect\": false,\n          \"text\": \"Tosilato é pequeno e não causa impedimento\"\n        }\n      ],\n      \"question\": \"O que torna o tosilato um bom grupo de saída?\"\n    },\n    {\n      \"context\": \"{{NAME}}, você tá mandando muito bem! A professora ficou impressionada. Mas agora... ela mandou uma mensagem preocupante. O primeiro grupo — lembra deles? Brometo de n-butila com iodeto em acetona? A reação funcionou, MAS eles isolaram o produto e mediram a rotação óptica. O substrato era opticamente ativo e eles esperavam inversão completa, mas mediram só 85% de inversão. Ela está confusa.\",\n      \"options\": [\n        {\n          \"feedback\": \"Boa análise! Mesmo em condições que favorecem SN2, um pouco de SN1 pode ocorrer, especialmente se houver traços de solvente prótico. SN1 causa racemização parcial, reduzindo a inversão líquida.\",\n          \"isCorrect\": true,\n          \"text\": \"Pode ter ocorrido algum SN1 competindo\"\n        },\n        {\n          \"feedback\": \"Em SN2, o ataque é sempre por trás do grupo de saída — é geometricamente necessário para a reação concertada. Ataque frontal não é possível em SN2.\",\n          \"isCorrect\": false,\n          \"text\": \"O nucleófilo atacou pela frente\"\n        },\n        {\n          \"feedback\": \"Degradação causaria perda de rendimento, não mudança na proporção estereoquímica. A inversão incompleta sugere competição mecanística.\",\n          \"isCorrect\": false,\n          \"text\": \"O produto degradou durante isolamento\"\n        },\n        {\n          \"feedback\": \"Antes de culpar o equipamento, devemos considerar explicações químicas. Competição entre SN2 e SN1 pode explicar inversão incompleta.\",\n          \"isCorrect\": false,\n          \"text\": \"O instrumento mediu errado\"\n        }\n      ],\n      \"question\": \"O que pode explicar a inversão incompleta?\"\n    },\n    {\n      \"context\": \"Faz sentido! Mesmo em acetona, traços de água ou impurezas próticas podem permitir um pouco de SN1. A professora disse que vai pedir pra secarem melhor o solvente na próxima vez. Mas espera... ela acabou de mandar uma foto do caderno do aluno. {{NAME}}, olha isso — eles na verdade usaram 2-bromobutano, não n-bromobutano! Substrato secundário, não primário! Isso muda tudo!\",\n      \"options\": [\n        {\n          \"feedback\": \"Exato! Substratos secundários estão na zona de competição — SN1 e SN2 competem. Carbocátions secundários são mais estáveis que primários, permitindo mais SN1.\",\n          \"isCorrect\": true,\n          \"text\": \"Secundário permite mais SN1 que primário\"\n        },\n        {\n          \"feedback\": \"Substratos secundários ainda podem fazer SN2 com nucleófilos fortes. O problema é que SN1 também é possível, criando competição entre os mecanismos.\",\n          \"isCorrect\": false,\n          \"text\": \"Secundário bloqueia completamente SN2\"\n        },\n        {\n          \"feedback\": \"Eliminação pode competir, mas aqui o produto de substituição foi formado. Substratos secundários permitem competição SN1/SN2, explicando a inversão incompleta.\",\n          \"isCorrect\": false,\n          \"text\": \"Secundário favorece apenas eliminação\"\n        },\n        {\n          \"feedback\": \"Afeta muito! Substratos secundários permitem ambos mecanismos. Carbocátions secundários são mais estáveis que primários, aumentando a contribuição de SN1.\",\n          \"isCorrect\": false,\n          \"text\": \"Não afeta, o mecanismo é o mesmo\"\n        }\n      ],\n      \"question\": \"Como substrato secundário afeta a competição SN1/SN2?\"\n    },\n    {\n      \"context\": \"Agora tudo faz sentido! 2-bromobutano é secundário — SN1 e SN2 competindo. Por isso a inversão não foi completa. A professora agradeceu muito e disse que vai usar nosso diagnóstico como exemplo na próxima aula. Mas antes de desligar... ela fez uma última pergunta de desafio. Se eles quisessem maximizar SN2 e minimizar SN1 com esse mesmo substrato secundário, o que deveriam mudar?\",\n      \"options\": [\n        {\n          \"feedback\": \"Perfeito, {{NAME}}! SN2 é favorecida por solventes apróticos (nucleófilo livre) e alta concentração de nucleófilo (reação bimolecular). Essa combinação maximiza SN2 sobre SN1.\",\n          \"isCorrect\": true,\n          \"text\": \"Solvente aprótico + alta concentração de nucleófilo\"\n        },\n        {\n          \"feedback\": \"Isso faria o oposto! Solvente polar prótico estabiliza carbocátion e solvata nucleófilo, favorecendo SN1 sobre SN2.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar solvente polar prótico aquecido\"\n        },\n        {\n          \"feedback\": \"Diminuir nucleófilo favorece SN1, pois a velocidade de SN2 depende de [nucleófilo], mas SN1 não depende (etapa lenta é unimolecular).\",\n          \"isCorrect\": false,\n          \"text\": \"Diminuir concentração de nucleófilo\"\n        },\n        {\n          \"feedback\": \"Água é solvente polar prótico e nucleófilo fraco — ambos favorecem SN1. Para maximizar SN2, queremos solvente aprótico e nucleófilo forte concentrado.\",\n          \"isCorrect\": false,\n          \"text\": \"Adicionar água ao meio reacional\"\n        }\n      ],\n      \"question\": \"Como maximizar SN2 sobre SN1 aqui?\"\n    }\n  ]\n}",
      "outputTokens": 4210,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "pt-chemistry-organic-reactions-1",
      "userPrompt": "LESSON_TITLE: Mecanismos de Substituicao\nLESSON_DESCRIPTION: Aplicando mecanismos de reacao organica para prever e otimizar sinteses quimicas\nCHAPTER_TITLE: Reacoes Organicas\nCOURSE_TITLE: Quimica Organica II\nLANGUAGE: pt\nEXPLANATION_STEPS:\n1. Nucleofilos e Eletrofilos: Nucleofilos sao especies ricas em eletrons que doam pares de eletrons. Eletrofilos sao especies pobres em eletrons que aceitam. Reacoes organicas sao geralmente nucleofilos atacando eletrofilos.\n2. Mecanismo SN2: SN2 e um mecanismo concertado — o nucleofilo ataca enquanto o grupo de saida sai, em um unico passo. Funciona melhor com substratos primarios e nucleofilos fortes.\n3. Mecanismo SN1: SN1 ocorre em dois passos: primeiro o grupo de saida sai formando um carbocation, depois o nucleofilo ataca. Favorecido por substratos terciarios e solventes polares proticos.\n4. Estereoquimica: A estereoquimica revela o mecanismo. SN2 inverte a configuracao (ataque por tras). SN1 pode dar mistura racemicacon (carbocation planar atacado de ambos os lados).\n5. Grupos de Saida: Grupos de saida precisam ser estaveis apos sair. Bons grupos de saida sao bases fracas — haletos, tosilatos, agua protonada. Grupos de saida ruins sao bases fortes."
    },
    {
      "duration": 91042.92266600003,
      "inputTokens": 4310,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, tenemos un problema gordo. El modelo de clasificación de imágenes médicas que entrenamos lleva dos semanas y el accuracy en validación no pasa del 62%. El cliente necesita al menos 90% para el lunes. Estoy mirando la arquitectura y creo que el problema está en el diseño base.\",\n      \"options\": [\n        {\n          \"feedback\": \"Exacto. Antes de cambiar hiperparámetros o datos, hay que asegurar que la arquitectura es adecuada para el problema. Las capas convolucionales, pooling y activaciones deben estar bien diseñadas para imágenes médicas.\",\n          \"isCorrect\": true,\n          \"text\": \"Revisar la arquitectura de capas\"\n        },\n        {\n          \"feedback\": \"Más datos puede ayudar, pero si la arquitectura es inadecuada, solo estarás alimentando un modelo mal diseñado. Primero diagnostiquemos la estructura de la red.\",\n          \"isCorrect\": false,\n          \"text\": \"Agregar más datos de entrenamiento\"\n        },\n        {\n          \"feedback\": \"Si el accuracy lleva dos semanas estancado, más épocas no van a resolver un problema arquitectónico. El modelo probablemente ya convergió a un mínimo local.\",\n          \"isCorrect\": false,\n          \"text\": \"Entrenar por más épocas\"\n        },\n        {\n          \"feedback\": \"El optimizador afecta la velocidad de convergencia, pero no compensa una arquitectura mal diseñada. Hay que revisar la estructura primero.\",\n          \"isCorrect\": false,\n          \"text\": \"Cambiar el optimizador a Adam\"\n        }\n      ],\n      \"question\": \"¿Por dónde empezamos a diagnosticar?\"\n    },\n    {\n      \"context\": \"Buena idea. Mira, aquí está la arquitectura actual: tres capas convolucionales con filtros de 3x3, pero sin ningún tipo de pooling entre ellas. Las imágenes de entrada son de 512x512. ¿Ves el problema?\",\n      \"options\": [\n        {\n          \"feedback\": \"¡Exacto! Sin pooling, las representaciones mantienen la dimensión 512x512 a través de las capas, creando millones de parámetros innecesarios. El pooling reduce dimensiones y hace la representación más compacta.\",\n          \"isCorrect\": true,\n          \"text\": \"Demasiados parámetros y sin reducción\"\n        },\n        {\n          \"feedback\": \"Los filtros 3x3 sí detectan bordes y patrones locales. El problema es que sin pooling no reducimos la dimensión espacial y el modelo es enorme.\",\n          \"isCorrect\": false,\n          \"text\": \"Los filtros no pueden detectar bordes\"\n        },\n        {\n          \"feedback\": \"Agregar más capas sin pooling empeoraría el problema. Primero necesitamos reducir las dimensiones espaciales entre capas para manejar la complejidad.\",\n          \"isCorrect\": false,\n          \"text\": \"Faltan más capas convolucionales\"\n        },\n        {\n          \"feedback\": \"Filtros 3x3 son estándar y efectivos. El problema real es la falta de pooling para reducir la dimensión espacial de las representaciones.\",\n          \"isCorrect\": false,\n          \"text\": \"El tamaño del filtro es muy pequeño\"\n        }\n      ],\n      \"question\": \"¿Cuál es el problema sin pooling?\"\n    },\n    {\n      \"context\": \"Perfecto, agregué max pooling de 2x2 después de cada capa convolucional. Ahora el modelo entrena más rápido, pero noto algo raro: el training accuracy llega a 99% pero el validation accuracy sigue en 68%. Algo huele a sobreajuste.\",\n      \"options\": [\n        {\n          \"feedback\": \"¡Correcto! Dropout desactiva neuronas aleatoriamente durante el entrenamiento, forzando redundancia. La red no puede depender de neuronas específicas, lo que reduce el sobreajuste.\",\n          \"isCorrect\": true,\n          \"text\": \"Agregar dropout entre capas\"\n        },\n        {\n          \"feedback\": \"Un batch más grande puede acelerar el entrenamiento pero no ataca directamente el sobreajuste. Dropout es la técnica específica para forzar redundancia y generalización.\",\n          \"isCorrect\": false,\n          \"text\": \"Aumentar el tamaño del batch\"\n        },\n        {\n          \"feedback\": \"Filtros más grandes capturan patrones más amplios pero no reducen el sobreajuste. Necesitamos regularización como dropout para forzar que la red generalice.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar filtros más grandes\"\n        },\n        {\n          \"feedback\": \"Reducir la capacidad del modelo es una opción, pero dropout es más elegante: mantiene la capacidad pero fuerza redundancia para prevenir sobreajuste.\",\n          \"isCorrect\": false,\n          \"text\": \"Quitar capas convolucionales\"\n        }\n      ],\n      \"question\": \"¿Qué técnica aplicamos contra el sobreajuste?\"\n    },\n    {\n      \"context\": \"Agregué dropout de 0.5 en las capas densas y ahora el gap entre training y validation se redujo bastante. Pero hay otro problema: el entrenamiento se volvió muy inestable. Las pérdidas saltan mucho entre batches y a veces explota completamente.\",\n      \"options\": [\n        {\n          \"feedback\": \"¡Exacto! Batch normalization normaliza las activaciones entre capas, estabilizando el entrenamiento. Permite usar tasas de aprendizaje más altas sin que el modelo explote.\",\n          \"isCorrect\": true,\n          \"text\": \"Batch normalization entre capas\"\n        },\n        {\n          \"feedback\": \"Sigmoid causaría el problema del gradiente desvaneciente en capas profundas. ReLU es mejor, pero necesitamos batch normalization para estabilizar las activaciones.\",\n          \"isCorrect\": false,\n          \"text\": \"Cambiar ReLU por sigmoid\"\n        },\n        {\n          \"feedback\": \"Menos épocas no resuelve la inestabilidad durante el entrenamiento. Batch normalization normaliza las activaciones y estabiliza el proceso de aprendizaje.\",\n          \"isCorrect\": false,\n          \"text\": \"Reducir el número de épocas\"\n        },\n        {\n          \"feedback\": \"La validación cruzada evalúa mejor el modelo, pero no estabiliza el entrenamiento. Batch normalization normaliza activaciones y previene que los gradientes exploten.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar validación cruzada\"\n        }\n      ],\n      \"question\": \"¿Qué estabilizaría el entrenamiento?\"\n    },\n    {\n      \"context\": \"Genial, con batch norm el entrenamiento es super estable. Pero {{NAME}}, hay un elefante en la habitación: solo tenemos 500 imágenes médicas etiquetadas. Entrenar una CNN profunda desde cero con tan pocos datos es casi imposible. ¿Cómo resolvemos esto?\",\n      \"options\": [\n        {\n          \"feedback\": \"¡Perfecto! Transfer learning usa redes pre-entrenadas en millones de imágenes. Las capas tempranas ya aprendieron patrones generales como bordes y texturas, solo ajustamos las capas finales a nuestra tarea.\",\n          \"isCorrect\": true,\n          \"text\": \"Transfer learning con red pre-entrenada\"\n        },\n        {\n          \"feedback\": \"Con pocos datos, más épocas solo causará más sobreajuste. Transfer learning aprovecha patrones ya aprendidos en grandes datasets, solucionando la falta de datos.\",\n          \"isCorrect\": false,\n          \"text\": \"Entrenar por muchas más épocas\"\n        },\n        {\n          \"feedback\": \"Una red muy simple no capturará la complejidad de imágenes médicas. Transfer learning nos da la capacidad de una red profunda sin necesitar entrenarla desde cero.\",\n          \"isCorrect\": false,\n          \"text\": \"Reducir la red a dos capas\"\n        },\n        {\n          \"feedback\": \"Duplicar datos no agrega información nueva. Transfer learning es más efectivo: aprovecha patrones generales ya aprendidos de millones de imágenes.\",\n          \"isCorrect\": false,\n          \"text\": \"Duplicar las imágenes existentes\"\n        }\n      ],\n      \"question\": \"¿Cómo aprovechamos los pocos datos?\"\n    },\n    {\n      \"context\": \"Cargué ResNet50 pre-entrenada en ImageNet. Ahora la pregunta es: ¿congelamos todas las capas y solo entrenamos el clasificador final, o descongelamos algunas capas para que se adapten a imágenes médicas?\",\n      \"options\": [\n        {\n          \"feedback\": \"¡Exacto! Las capas tempranas detectan patrones universales como bordes y texturas. Las tardías capturan patrones específicos del dominio, así que las ajustamos a imágenes médicas.\",\n          \"isCorrect\": true,\n          \"text\": \"Congelar tempranas, ajustar tardías\"\n        },\n        {\n          \"feedback\": \"Con solo 500 imágenes, reentrenar todo causaría sobreajuste y perderíamos los patrones generales aprendidos. Mejor congelar las capas tempranas que ya funcionan bien.\",\n          \"isCorrect\": false,\n          \"text\": \"Descongelar todo y reentrenar\"\n        },\n        {\n          \"feedback\": \"Esto puede funcionar como baseline, pero las capas tardías de ImageNet están optimizadas para objetos comunes. Ajustarlas a imágenes médicas suele mejorar el rendimiento.\",\n          \"isCorrect\": false,\n          \"text\": \"Congelar todas, solo entrenar salida\"\n        },\n        {\n          \"feedback\": \"Las capas tempranas aprenden patrones universales que transfieren bien. Son las tardías las que necesitan ajustarse porque capturan patrones específicos del dominio original.\",\n          \"isCorrect\": false,\n          \"text\": \"Ajustar solo las capas tempranas\"\n        }\n      ],\n      \"question\": \"¿Qué capas deberíamos ajustar?\"\n    },\n    {\n      \"context\": \"El modelo está funcionando mucho mejor, llegamos a 87% en validación. Pero {{NAME}}, acabo de revisar las imágenes de prueba que envió el cliente y... son radiografías de tórax con diferentes niveles de contraste. Algunas casi no se ven. El modelo no ha visto nada así.\",\n      \"options\": [\n        {\n          \"feedback\": \"¡Bien pensado! Augmentation con variaciones de brillo, contraste y ruido simula las condiciones reales. Las capas convolucionales aprenderán a detectar patrones independientemente de estas variaciones.\",\n          \"isCorrect\": true,\n          \"text\": \"Data augmentation con variaciones\"\n        },\n        {\n          \"feedback\": \"Normalizar el entrenamiento no prepara al modelo para variaciones reales. Data augmentation expone al modelo a diferentes contrastes durante el entrenamiento.\",\n          \"isCorrect\": false,\n          \"text\": \"Normalizar todas las imágenes igual\"\n        },\n        {\n          \"feedback\": \"Más pooling reduce resolución pero no ayuda con variaciones de contraste. Data augmentation simula estas condiciones durante el entrenamiento.\",\n          \"isCorrect\": false,\n          \"text\": \"Agregar más capas de pooling\"\n        },\n        {\n          \"feedback\": \"El tamaño de filtros afecta qué patrones detecta, no la robustez a variaciones de contraste. Augmentation expone al modelo a diferentes condiciones.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar filtros más pequeños\"\n        }\n      ],\n      \"question\": \"¿Cómo preparamos el modelo para esto?\"\n    },\n    {\n      \"context\": \"Implementé augmentation agresivo: rotaciones, zoom, variaciones de brillo y contraste. El accuracy en validación subió a 91%. ¡Pasamos el umbral del cliente! Pero espera... acabo de notar algo en los logs. La función de activación en las capas ocultas es sigmoid, no ReLU.\",\n      \"options\": [\n        {\n          \"feedback\": \"¡Exacto! Sigmoid satura en valores extremos, haciendo que los gradientes se vuelvan casi cero en capas profundas. ReLU evita esto porque no satura para valores positivos.\",\n          \"isCorrect\": true,\n          \"text\": \"Causa gradiente desvaneciente en redes profundas\"\n        },\n        {\n          \"feedback\": \"Sigmoid funciona técnicamente con batch norm, pero el problema real es el gradiente desvaneciente: sigmoid satura y los gradientes se vuelven casi cero en redes profundas.\",\n          \"isCorrect\": false,\n          \"text\": \"No funciona con batch normalization\"\n        },\n        {\n          \"feedback\": \"La memoria no es el problema principal. Sigmoid causa gradiente desvaneciente porque satura en valores extremos, dificultando el aprendizaje en capas profundas.\",\n          \"isCorrect\": false,\n          \"text\": \"Consume más memoria que ReLU\"\n        },\n        {\n          \"feedback\": \"Sigmoid produce valores entre 0 y 1, no negativos. El problema es que satura en los extremos, causando gradientes muy pequeños en redes profundas.\",\n          \"isCorrect\": false,\n          \"text\": \"Solo produce valores negativos\"\n        }\n      ],\n      \"question\": \"¿Por qué sigmoid es problemático aquí?\"\n    },\n    {\n      \"context\": \"Cambié a ReLU y el entrenamiento se aceleró notablemente. {{NAME}}, el modelo final tiene 91.5% de accuracy. Pero antes de enviarlo al cliente, quiero asegurarme de que entendemos por qué cada decisión funcionó. ¿Puedes explicarme el rol de las capas convolucionales?\",\n      \"options\": [\n        {\n          \"feedback\": \"¡Perfecto! Los filtros se deslizan sobre la imagen detectando patrones locales como bordes, texturas y formas. El mismo filtro aplicado en todas partes reduce parámetros y captura patrones sin importar su posición.\",\n          \"isCorrect\": true,\n          \"text\": \"Detectan patrones locales con filtros\"\n        },\n        {\n          \"feedback\": \"Eso es el pooling. Las capas convolucionales detectan patrones locales usando filtros que se deslizan sobre la entrada, capturando características sin importar su posición.\",\n          \"isCorrect\": false,\n          \"text\": \"Reducen la dimensión de la imagen\"\n        },\n        {\n          \"feedback\": \"Eso es batch normalization. Las convolucionales usan filtros para detectar patrones locales como bordes y texturas en diferentes posiciones de la imagen.\",\n          \"isCorrect\": false,\n          \"text\": \"Normalizan las activaciones\"\n        },\n        {\n          \"feedback\": \"Eso es dropout. Las convolucionales detectan patrones locales mediante filtros compartidos, lo cual reduce parámetros pero no es su función principal de regularización.\",\n          \"isCorrect\": false,\n          \"text\": \"Previenen el sobreajuste\"\n        }\n      ],\n      \"question\": \"¿Qué hacen las capas convolucionales?\"\n    },\n    {\n      \"context\": \"Genial, el modelo está listo para producción. Pero {{NAME}}, acabo de recibir un mensaje del cliente... Dicen que quieren usar el mismo modelo para detectar fracturas en radiografías de huesos. Las imágenes son completamente diferentes. ¿Tenemos que empezar de cero?\",\n      \"options\": [\n        {\n          \"feedback\": \"¡Exacto! Nuestro modelo ya aprendió patrones de radiografías en las capas tempranas. Podemos usarlo como base y ajustar las capas tardías para detectar fracturas. Transfer learning funciona en cascada.\",\n          \"isCorrect\": true,\n          \"text\": \"Transfer learning desde nuestro modelo\"\n        },\n        {\n          \"feedback\": \"El modelo actual clasifica algo diferente. Pero podemos aprovechar lo que aprendió: transfer learning desde nuestro modelo, ajustando las capas tardías para la nueva tarea.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar exactamente el mismo modelo\"\n        },\n        {\n          \"feedback\": \"Nuestro modelo ya está especializado en radiografías, mejor punto de partida que ImageNet. Transfer learning desde nuestro modelo aprovecha los patrones específicos de rayos X.\",\n          \"isCorrect\": false,\n          \"text\": \"Empezar desde ImageNet otra vez\"\n        },\n        {\n          \"feedback\": \"Desperdiciaríamos todo el conocimiento adquirido. Transfer learning desde nuestro modelo aprovecha que las capas tempranas ya entienden patrones de radiografías.\",\n          \"isCorrect\": false,\n          \"text\": \"Entrenar una red nueva desde cero\"\n        }\n      ],\n      \"question\": \"¿Qué hacemos con el nuevo problema?\"\n    },\n    {\n      \"context\": \"¡El cliente está encantado! El modelo de fracturas alcanzó 93% con solo 200 imágenes nuevas gracias al transfer learning en cascada. {{NAME}}, acaba de pasar algo inesperado: el radiólogo jefe del hospital revisó nuestros modelos y dice que detectan cosas que ellos no ven a simple vista.\",\n      \"options\": [\n        {\n          \"feedback\": \"¡Exacto! Las capas convolucionales detectan patrones que el ojo humano no percibe fácilmente. Combinado con transfer learning, dropout, batch norm y buena arquitectura, creamos algo que complementa la expertise médica. ¡Gran trabajo, {{NAME}}!\",\n          \"isCorrect\": true,\n          \"text\": \"Las CNNs capturan patrones sutiles\"\n        },\n        {\n          \"feedback\": \"Si detecta patrones válidos que los expertos confirman, no es sobreajuste. Las CNNs pueden capturar patrones sutiles en las imágenes gracias a sus filtros especializados.\",\n          \"isCorrect\": false,\n          \"text\": \"El modelo está sobreajustado\"\n        },\n        {\n          \"feedback\": \"El radiólogo está validando los hallazgos, no cuestionándolos. Las CNNs pueden detectar patrones sutiles que complementan la visión humana.\",\n          \"isCorrect\": false,\n          \"text\": \"Hay un error en los datos\"\n        },\n        {\n          \"feedback\": \"Si el modelo generaliza bien y detecta patrones que expertos validan, la regularización es adecuada. Esto demuestra el poder de las arquitecturas bien diseñadas.\",\n          \"isCorrect\": false,\n          \"text\": \"Necesitamos más regularización\"\n        }\n      ],\n      \"question\": \"¿Qué significa esto para el proyecto?\"\n    }\n  ]\n}",
      "outputTokens": 4940,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "es-cs-neural-network-architecture-1",
      "userPrompt": "LESSON_TITLE: Arquitecturas de Deep Learning\nLESSON_DESCRIPTION: Disenando y optimizando arquitecturas de redes neuronales para problemas reales\nCHAPTER_TITLE: Arquitecturas de Redes Neuronales\nCOURSE_TITLE: Deep Learning Aplicado\nLANGUAGE: es\nEXPLANATION_STEPS:\n1. Capas Convolucionales: Las capas convolucionales detectan patrones locales usando filtros que se deslizan sobre la entrada. El mismo filtro se aplica en todas partes, lo que reduce parametros y captura patrones sin importar su posicion.\n2. Pooling: El pooling reduce la dimension espacial tomando el maximo o promedio de regiones. Esto hace la representacion mas compacta y algo invariante a pequenas traslaciones.\n3. Activaciones: Las funciones de activacion introducen no-linealidad. ReLU (max(0,x)) es popular por ser simple y evitar el problema del gradiente desvaneciente en capas profundas.\n4. Dropout: El dropout desactiva neuronas aleatoriamente durante el entrenamiento. Esto fuerza redundancia y reduce el sobreajuste — la red no puede depender de ninguna neurona especifica.\n5. Transfer Learning: El transfer learning usa redes pre-entrenadas en grandes datasets. Las capas tempranas aprenden patrones generales; las tardias se ajustan a tu tarea especifica.\n6. Batch Normalization: El batch normalization normaliza activaciones entre capas. Estabiliza el entrenamiento, permite tasas de aprendizaje mas altas, y actua como regularizador."
    },
    {
      "duration": 126703.368708,
      "inputTokens": 4237,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, I need your help. Marketing just ran an A/B test on the new checkout flow. They're saying it's a massive success — p-value of 0.03. But something feels off. They tested it on 50,000 users per group and the conversion rate went from 2.1% to 2.15%. They want to roll it out company-wide by Friday.\",\n      \"options\": [\n        {\n          \"feedback\": \"A p-value of 0.03 is below the typical 0.05 threshold. The issue isn't the p-value itself — it's what it's detecting. With huge samples, even tiny differences become 'significant.'\",\n          \"isCorrect\": false,\n          \"text\": \"The p-value should be lower than 0.03\"\n        },\n        {\n          \"feedback\": \"Exactly right. A 0.05 percentage point increase is statistically significant with 100,000 users, but is it worth the engineering effort? Statistical significance ≠ practical significance.\",\n          \"isCorrect\": true,\n          \"text\": \"The effect size is tiny despite significance\"\n        },\n        {\n          \"feedback\": \"Actually, they might have too many users. Large samples detect trivially small effects. The question is whether the detected effect matters practically.\",\n          \"isCorrect\": false,\n          \"text\": \"They should have used more users\"\n        },\n        {\n          \"feedback\": \"A/B tests are ideal for conversion rates. The problem here is confusing statistical significance with practical importance — a common trap with large sample sizes.\",\n          \"isCorrect\": false,\n          \"text\": \"A/B tests can't measure conversion rates\"\n        }\n      ],\n      \"question\": \"What's your first concern about these results?\"\n    },\n    {\n      \"context\": \"That's exactly what I was thinking. A 0.05 percentage point lift... let me calculate. That's about 25 extra conversions per 50,000 users. At our average order value, that's maybe $1,500 extra revenue. The new checkout flow cost $80,000 to build. But here's the thing — when I mentioned this to the marketing lead, she said 'But the p-value proves it works!'\",\n      \"options\": [\n        {\n          \"feedback\": \"P-values don't 'prove' anything. They tell us how surprising our data would be if there were truly no difference. That's very different from proving an effect exists.\",\n          \"isCorrect\": false,\n          \"text\": \"It proves the new checkout is better\"\n        },\n        {\n          \"feedback\": \"This is the most common p-value misinterpretation! The p-value is NOT the probability H0 is true. It's the probability of this data (or more extreme) IF H0 were true.\",\n          \"isCorrect\": false,\n          \"text\": \"It's the probability the null hypothesis is true\"\n        },\n        {\n          \"feedback\": \"Perfect. The p-value answers: 'If there were truly no difference, how often would we see data this extreme?' It says nothing about whether the effect is meaningful or large.\",\n          \"isCorrect\": true,\n          \"text\": \"It shows how unlikely this data is if no effect\"\n        },\n        {\n          \"feedback\": \"P-values say nothing about effect size. You can have a tiny p-value with a meaningless effect (large sample) or a large p-value with an important effect (small sample).\",\n          \"isCorrect\": false,\n          \"text\": \"It measures the size of the effect\"\n        }\n      ],\n      \"question\": \"How do you explain what the p-value actually tells us?\"\n    },\n    {\n      \"context\": \"Okay, she's starting to get it. But now she's asking about the flip side. She goes, 'Well, what if we DON'T roll this out and we're missing a real improvement? What kind of mistake would that be?' Good question, actually.\",\n      \"options\": [\n        {\n          \"feedback\": \"Type I error is rejecting a true null — saying there's an effect when there isn't. She's worried about the opposite: missing a real effect that exists.\",\n          \"isCorrect\": false,\n          \"text\": \"Type I error — false positive\"\n        },\n        {\n          \"feedback\": \"Right. Type II error is failing to reject a false null — missing a real effect. She's worried they might not roll out something that actually works. It's a valid concern.\",\n          \"isCorrect\": true,\n          \"text\": \"Type II error — false negative\"\n        },\n        {\n          \"feedback\": \"Measurement error is about data accuracy, not decision errors. She's describing the scenario where they miss a real improvement — that's a Type II error (false negative).\",\n          \"isCorrect\": false,\n          \"text\": \"Measurement error\"\n        },\n        {\n          \"feedback\": \"Sampling error is natural variation in samples. She's asking about the decision error of not acting when an effect is real — that's Type II error.\",\n          \"isCorrect\": false,\n          \"text\": \"Sampling error\"\n        }\n      ],\n      \"question\": \"What type of error is she describing?\"\n    },\n    {\n      \"context\": \"She nods, then asks something clever: 'Can we design our tests to avoid BOTH types of errors?' I can tell she's really trying to understand the trade-offs here. This is actually a great teaching moment.\",\n      \"options\": [\n        {\n          \"feedback\": \"Better data helps, but you can never eliminate both errors simultaneously. There's a fundamental trade-off — reducing one increases the other at a fixed sample size.\",\n          \"isCorrect\": false,\n          \"text\": \"You can eliminate both with better data\"\n        },\n        {\n          \"feedback\": \"Which error is worse depends on context. In drug safety, Type I (approving a harmful drug) is worse. In cancer screening, Type II (missing cancer) is worse.\",\n          \"isCorrect\": false,\n          \"text\": \"Type I errors are always worse\"\n        },\n        {\n          \"feedback\": \"Exactly. At a fixed sample size, reducing Type I error (stricter threshold) increases Type II error (missing real effects). You can improve both only by increasing sample size.\",\n          \"isCorrect\": true,\n          \"text\": \"There's a fundamental trade-off between them\"\n        },\n        {\n          \"feedback\": \"These error types matter in any hypothesis testing context — marketing, product, finance, anywhere you're making decisions based on statistical evidence.\",\n          \"isCorrect\": false,\n          \"text\": \"They only matter in medical research\"\n        }\n      ],\n      \"question\": \"What's the truth about Type I and Type II errors?\"\n    },\n    {\n      \"context\": \"Great explanation. Now the data science lead, Jordan, jumps in. 'Actually, I ran power analysis before this test. With 50,000 per group and alpha at 0.05, we had 99% power to detect a 0.1 percentage point difference.' He seems proud of this. But wait...\",\n      \"options\": [\n        {\n          \"feedback\": \"High power is generally good — it means you'll catch real effects. The problem is WHAT effect size they powered for. They can detect effects too small to matter.\",\n          \"isCorrect\": false,\n          \"text\": \"99% power is too high\"\n        },\n        {\n          \"feedback\": \"Changing alpha wouldn't address the core issue. The problem is they designed the study to detect effects that are statistically detectable but practically meaningless.\",\n          \"isCorrect\": false,\n          \"text\": \"Alpha should have been 0.01\"\n        },\n        {\n          \"feedback\": \"Bingo. Having power to detect a 0.1pp difference means they'll flag tiny, meaningless effects as 'significant.' Power analysis should target the minimum MEANINGFUL effect size.\",\n          \"isCorrect\": true,\n          \"text\": \"They powered for a trivially small effect\"\n        },\n        {\n          \"feedback\": \"Power analysis is crucial for A/B tests! The issue is they set the target effect size too small. They should power for the minimum practically important effect.\",\n          \"isCorrect\": false,\n          \"text\": \"Power analysis isn't useful for A/B tests\"\n        }\n      ],\n      \"question\": \"What's the problem with this power analysis?\"\n    },\n    {\n      \"context\": \"Jordan looks a bit defensive. 'Okay fine, but at least we only ran ONE test. I've seen teams run like 20 variations at once and claim victory on whatever wins.' He's got a point. Actually, that reminds me — didn't the growth team do exactly that last month?\",\n      \"options\": [\n        {\n          \"feedback\": \"Time isn't the statistical issue. The problem is that testing many hypotheses at alpha=0.05 means you EXPECT false positives. 20 tests × 0.05 = 1 expected false positive.\",\n          \"isCorrect\": false,\n          \"text\": \"It takes too long to run\"\n        },\n        {\n          \"feedback\": \"Sample size per group matters, but the core issue is multiple comparisons. Even with huge samples, testing 20 things at 0.05 expects one false positive by chance alone.\",\n          \"isCorrect\": false,\n          \"text\": \"You need more users per variation\"\n        },\n        {\n          \"feedback\": \"Exactly. Testing 20 hypotheses at alpha=0.05 means you expect one false positive even if nothing is real. This requires corrections like Bonferroni or FDR control.\",\n          \"isCorrect\": true,\n          \"text\": \"Multiple comparisons inflate false positives\"\n        },\n        {\n          \"feedback\": \"You can compare multiple things, but you must adjust for multiple comparisons. Without correction, you'll likely find 'significant' results that are just noise.\",\n          \"isCorrect\": false,\n          \"text\": \"You can only compare two things at once\"\n        }\n      ],\n      \"question\": \"What's the statistical problem with testing 20 variations?\"\n    },\n    {\n      \"context\": \"Right on cue, Priya from the growth team walks over. 'Hey, you talking about our button color test? We tested 20 colors and found three winners! All p-values under 0.05!' She's beaming. Oh boy. {{NAME}}, how do we break this to her gently?\",\n      \"options\": [\n        {\n          \"feedback\": \"Without correction, those 'wins' are suspect. At alpha=0.05 with 20 tests, you expect ~1 false positive. Her 3 winners might include spurious results.\",\n          \"isCorrect\": false,\n          \"text\": \"Launch all three winning colors\"\n        },\n        {\n          \"feedback\": \"Picking the lowest p-value doesn't solve the multiple comparisons problem. All three 'significant' results are suspect without proper correction applied.\",\n          \"isCorrect\": false,\n          \"text\": \"Pick the one with the lowest p-value\"\n        },\n        {\n          \"feedback\": \"Right. Bonferroni divides alpha by the number of tests (0.05/20 = 0.0025). Only results below this stricter threshold survive. Some or all of her winners might disappear.\",\n          \"isCorrect\": true,\n          \"text\": \"Apply a correction like Bonferroni\"\n        },\n        {\n          \"feedback\": \"That defeats the purpose of running the test. The right approach is to apply a multiple comparisons correction, then interpret the adjusted results.\",\n          \"isCorrect\": false,\n          \"text\": \"Ignore the test and trust her intuition\"\n        }\n      ],\n      \"question\": \"What should Priya do about her 'three winners'?\"\n    },\n    {\n      \"context\": \"Priya rechecks her data with Bonferroni correction. 'Okay, only one color survives at the adjusted threshold. But {{NAME}}, the p-value for that one is 0.001! That's definitely real, right?' She's looking for validation.\",\n      \"options\": [\n        {\n          \"feedback\": \"P-values never 'prove' anything. A low p-value means the data is unlikely under the null, but you still need to consider effect size and study design.\",\n          \"isCorrect\": false,\n          \"text\": \"Yes, 0.001 proves the effect exists\"\n        },\n        {\n          \"feedback\": \"Exactly. Even with p=0.001, the effect might be trivially small. Ask: How much better is this color? Is the lift worth the implementation cost? Statistical ≠ practical significance.\",\n          \"isCorrect\": true,\n          \"text\": \"No, we still need to check effect size\"\n        },\n        {\n          \"feedback\": \"The Bonferroni correction made the test more conservative, which is correct. Results that survive correction are MORE credible, not less. But effect size still matters.\",\n          \"isCorrect\": false,\n          \"text\": \"No, the correction made it invalid\"\n        },\n        {\n          \"feedback\": \"There's no magic p-value threshold that guarantees truth. What matters is the effect size, study design, and whether the finding is practically meaningful.\",\n          \"isCorrect\": false,\n          \"text\": \"We need at least p < 0.0001\"\n        }\n      ],\n      \"question\": \"Can a very low p-value alone confirm the effect is real?\"\n    },\n    {\n      \"context\": \"Priya checks the effect size. 'The winning color increased clicks by 0.3%. Our baseline is 2% click rate, so that's... a 15% relative improvement!' Now she's excited again. That actually sounds more meaningful. But Jordan raises an eyebrow. 'Wait, what was your sample size per color?'\",\n      \"options\": [\n        {\n          \"feedback\": \"Power matters before the study. Jordan is likely concerned that with 20 colors, each group might be too small, leading to unreliable effect size estimates.\",\n          \"isCorrect\": false,\n          \"text\": \"To verify the power calculation\"\n        },\n        {\n          \"feedback\": \"Bigger samples give more precise estimates, but that's not Jordan's concern. With 20 colors splitting traffic, each group might be underpowered.\",\n          \"isCorrect\": false,\n          \"text\": \"Bigger samples always give better results\"\n        },\n        {\n          \"feedback\": \"Right. If traffic was split 20 ways, each color had few users. Small samples produce noisy, unreliable effect size estimates. That 15% lift could be much smaller (or larger) in reality.\",\n          \"isCorrect\": true,\n          \"text\": \"Small groups make effect estimates noisy\"\n        },\n        {\n          \"feedback\": \"Sample size does affect p-values, but Jordan's concern is about effect size reliability. With small groups, the estimated 15% lift might be very imprecise.\",\n          \"isCorrect\": false,\n          \"text\": \"Sample size affects the p-value directly\"\n        }\n      ],\n      \"question\": \"Why is Jordan asking about sample size now?\"\n    },\n    {\n      \"context\": \"Priya checks: 'We had 2,000 users per color.' Jordan winces. 'That's... not great for a 2% baseline. Your confidence interval on that effect is probably huge.' He's right — we need to think about precision here, not just significance.\",\n      \"options\": [\n        {\n          \"feedback\": \"Sample size requirements depend on baseline rate and effect size. 2,000 might be fine for a 50% baseline, but at 2%, you only expect ~40 conversions — that's noisy.\",\n          \"isCorrect\": false,\n          \"text\": \"2,000 users is always too small\"\n        },\n        {\n          \"feedback\": \"Exactly. At 2% baseline, 2,000 users yields only ~40 conversions. Small counts mean high variance. The 15% lift estimate could easily be off by 50% or more.\",\n          \"isCorrect\": true,\n          \"text\": \"Low baseline rate needs larger samples\"\n        },\n        {\n          \"feedback\": \"You can absolutely A/B test colors. The issue is statistical: low baseline rates require larger samples because you're working with small counts of actual conversions.\",\n          \"isCorrect\": false,\n          \"text\": \"You can't run A/B tests on colors\"\n        },\n        {\n          \"feedback\": \"The p-value calculation might be fine. The issue is that with small samples and low baselines, effect size estimates are imprecise even when they pass significance thresholds.\",\n          \"isCorrect\": false,\n          \"text\": \"The p-value calculation was wrong\"\n        }\n      ],\n      \"question\": \"What's the core issue with 2,000 users at a 2% baseline?\"\n    },\n    {\n      \"context\": \"Priya sighs. 'So what you're saying is... even my one 'winner' might just be noise amplified by a small sample?' She's getting it. 'What should I actually do next?' This is the practical question we need to answer.\",\n      \"options\": [\n        {\n          \"feedback\": \"Perfect. A focused replication study on just the winner with adequate sample size will give a reliable effect estimate. If it holds up, she has a real finding.\",\n          \"isCorrect\": true,\n          \"text\": \"Run a confirmation test on the winner\"\n        },\n        {\n          \"feedback\": \"That's premature. She has a promising candidate that survived correction. The right move is to validate it with a properly powered confirmation study.\",\n          \"isCorrect\": false,\n          \"text\": \"Abandon the project entirely\"\n        },\n        {\n          \"feedback\": \"Stricter thresholds don't fix the sample size problem. She needs a confirmation study with enough users to get a precise effect estimate.\",\n          \"isCorrect\": false,\n          \"text\": \"Lower the significance threshold more\"\n        },\n        {\n          \"feedback\": \"Reporting an unreliable estimate could lead to bad decisions. First, confirm the effect with a properly powered study, then report findings she can trust.\",\n          \"isCorrect\": false,\n          \"text\": \"Report the 15% lift to leadership\"\n        }\n      ],\n      \"question\": \"What's the best next step for Priya?\"\n    },\n    {\n      \"context\": \"Just as we're wrapping up, the VP of Product walks over. 'Great timing, team. I need a quick decision. We're testing a new fraud detection model. If we're too aggressive, we block legitimate customers. If we're too lenient, we lose money to fraud. What error rate should we optimize for?'\",\n      \"options\": [\n        {\n          \"feedback\": \"This isn't about p-values — it's about which type of error matters more. Blocking good customers (false positive) vs. missing fraud (false negative). It's a business decision.\",\n          \"isCorrect\": false,\n          \"text\": \"Which p-value threshold to use\"\n        },\n        {\n          \"feedback\": \"Exactly. Blocking legitimate customers is Type I (false positive). Missing fraud is Type II (false negative). The right balance depends on the relative costs of each.\",\n          \"isCorrect\": true,\n          \"text\": \"The trade-off between Type I and Type II errors\"\n        },\n        {\n          \"feedback\": \"More data helps precision, but the core question is about error trade-offs. Which is worse: falsely blocking good customers or missing fraudsters?\",\n          \"isCorrect\": false,\n          \"text\": \"How much data to collect\"\n        },\n        {\n          \"feedback\": \"The method isn't the issue. The VP needs to decide the relative costs of two error types — that determines how to tune the model's threshold.\",\n          \"isCorrect\": false,\n          \"text\": \"Whether to use hypothesis testing at all\"\n        }\n      ],\n      \"question\": \"This is really a question about what?\"\n    },\n    {\n      \"context\": \"The VP nods. 'So it depends on the cost of each error type?' Exactly. 'A blocked legitimate customer costs us about $50 in support and goodwill. A missed fraud costs us $500 on average.' Now we have real numbers to work with.\",\n      \"options\": [\n        {\n          \"feedback\": \"Type I costs $50, Type II costs $500. Since missing fraud is 10x more expensive, we should be more aggressive at catching fraud, accepting more false positives.\",\n          \"isCorrect\": false,\n          \"text\": \"Type I — blocking good customers\"\n        },\n        {\n          \"feedback\": \"Right. At $500 vs $50, missing fraud is 10x more costly. We should tune toward catching more fraud even if it means blocking more legitimate customers occasionally.\",\n          \"isCorrect\": true,\n          \"text\": \"Type II — missing fraudsters\"\n        },\n        {\n          \"feedback\": \"Equal weighting ignores the 10:1 cost difference. We should weight toward catching fraud more aggressively, since Type II errors are much more expensive.\",\n          \"isCorrect\": false,\n          \"text\": \"Both equally — find the middle ground\"\n        },\n        {\n          \"feedback\": \"More data doesn't change the cost ratio. The business reality is that missed fraud costs 10x more, so we should prioritize reducing Type II errors.\",\n          \"isCorrect\": false,\n          \"text\": \"Neither — collect more data instead\"\n        }\n      ],\n      \"question\": \"Given these costs, which error should we minimize more?\"\n    },\n    {\n      \"context\": \"{{NAME}}, the VP is impressed. 'This is exactly the kind of thinking I want from the team. One last question though — my data science friend told me we should always use p < 0.01 instead of 0.05. Should we make that a company standard?'\",\n      \"options\": [\n        {\n          \"feedback\": \"Stricter thresholds reduce Type I errors but increase Type II errors. The right threshold depends on the context: costs of each error type, sample size, and stakes involved.\",\n          \"isCorrect\": false,\n          \"text\": \"Yes, stricter is always better\"\n        },\n        {\n          \"feedback\": \"No single threshold works for all contexts. Fraud detection, marketing tests, and safety research have different error cost trade-offs that demand different thresholds.\",\n          \"isCorrect\": false,\n          \"text\": \"Yes, but use p < 0.001 instead\"\n        },\n        {\n          \"feedback\": \"Exactly. The right threshold depends on relative costs of Type I and Type II errors, which vary by situation. One-size-fits-all thresholds ignore important context.\",\n          \"isCorrect\": true,\n          \"text\": \"No, optimal thresholds depend on context\"\n        },\n        {\n          \"feedback\": \"P-values have limitations, but they're still useful when properly understood. The issue isn't p-values — it's that different contexts need different decision criteria.\",\n          \"isCorrect\": false,\n          \"text\": \"No, p-values are fundamentally flawed\"\n        }\n      ],\n      \"question\": \"Should a single p-value threshold be the company standard?\"\n    },\n    {\n      \"context\": \"The VP smiles. 'I'm starting to see why 'statistically significant' drove me crazy. It sounded so final, but there's so much more nuance.' Jordan suddenly looks at his phone and laughs. 'Uh, {{NAME}}? You're not going to believe this. That checkout flow marketing tested? I just found out they actually ran SIX versions, not one. They only reported the winner.'\",\n      \"options\": [\n        {\n          \"feedback\": \"More variations would make this worse! The problem is they tested six versions, found one winner, and hid the fact that it was a multiple comparison situation.\",\n          \"isCorrect\": false,\n          \"text\": \"They didn't use enough test variations\"\n        },\n        {\n          \"feedback\": \"Exactly. Testing six versions and reporting only the winner is textbook p-hacking. With six tests at alpha=0.05, false positives become likely. They hid the multiple comparisons.\",\n          \"isCorrect\": true,\n          \"text\": \"They cherry-picked results without disclosure\"\n        },\n        {\n          \"feedback\": \"Duration isn't the issue. They ran multiple tests, reported only the success, and didn't adjust for multiple comparisons or disclose the full testing scope.\",\n          \"isCorrect\": false,\n          \"text\": \"They should have tested for longer\"\n        },\n        {\n          \"feedback\": \"With 50,000 per group, sample size was fine. The issue is hidden multiple testing — they only reported the winner of six comparisons, not the full picture.\",\n          \"isCorrect\": false,\n          \"text\": \"The sample size was still too small\"\n        }\n      ],\n      \"question\": \"What did marketing actually do wrong here?\"\n    },\n    {\n      \"context\": \"Everyone groans. Priya mutters, 'So their p-value of 0.03... with six tests...' Right. And that 'tiny but significant' effect is even more suspicious now. The VP shakes his head. 'Okay, new rule. All test results need to include how many variations were tested and the effect sizes. Not just the p-values of winners.'\",\n      \"options\": [\n        {\n          \"feedback\": \"A/B tests are valuable when done right. The rule addresses the real problem: requiring transparency about the full scope of testing and practical significance.\",\n          \"isCorrect\": false,\n          \"text\": \"Banning A/B tests entirely\"\n        },\n        {\n          \"feedback\": \"Multiple tests are fine with proper correction and disclosure. The key is transparency about how many tests were run and what the effect sizes were.\",\n          \"isCorrect\": false,\n          \"text\": \"Only allowing one test at a time\"\n        },\n        {\n          \"feedback\": \"Perfect. Knowing how many tests were run (for corrections) and the effect sizes (for practical significance) lets decision-makers properly evaluate findings.\",\n          \"isCorrect\": true,\n          \"text\": \"Requiring full context for interpretation\"\n        },\n        {\n          \"feedback\": \"Statistician review could help, but the core insight is transparency. Reporting full context — number of tests, effect sizes — enables proper interpretation by anyone.\",\n          \"isCorrect\": false,\n          \"text\": \"Making statisticians approve everything\"\n        }\n      ],\n      \"question\": \"What's the most important element of the VP's new rule?\"\n    },\n    {\n      \"context\": \"As everyone disperses, Priya stops you. 'Hey {{NAME}}, quick summary for my notes. What's the one thing I should always ask when someone shows me a significant p-value?' Perfect question to end on.\",\n      \"options\": [\n        {\n          \"feedback\": \"That's important for multiple comparisons, but there's a broader question. You want to know if the effect matters in practice, not just whether it's statistically detectable.\",\n          \"isCorrect\": false,\n          \"text\": \"How many hypotheses were actually tested?\"\n        },\n        {\n          \"feedback\": \"This is the essential question. Statistical significance just means 'detectable with this sample.' The real question is always: Is the effect practically meaningful? Does it justify action?\",\n          \"isCorrect\": true,\n          \"text\": \"Is the effect large enough to matter?\"\n        },\n        {\n          \"feedback\": \"The software rarely matters. What matters is whether the detected effect is large enough to care about in the real world, not just statistically detectable.\",\n          \"isCorrect\": false,\n          \"text\": \"What statistical software did you use?\"\n        },\n        {\n          \"feedback\": \"Chasing lower p-values misses the point. The question should be about practical significance: Is this effect big enough to matter for our decisions?\",\n          \"isCorrect\": false,\n          \"text\": \"Can we get a lower p-value?\"\n        }\n      ],\n      \"question\": \"What's the key question to ask about any 'significant' result?\"\n    }\n  ]\n}",
      "outputTokens": 5388,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "en-statistics-hypothesis-testing-1",
      "userPrompt": "LESSON_TITLE: Hypothesis Testing in Practice\nLESSON_DESCRIPTION: Applying statistical hypothesis testing correctly to make sound data-driven decisions\nCHAPTER_TITLE: Statistical Inference\nCOURSE_TITLE: Applied Statistics\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. Null Hypothesis: The null hypothesis (H0) is the default assumption of no effect. We try to reject it. The p-value measures how surprising the data would be IF the null were true.\n2. P-Value Meaning: A p-value is NOT the probability the null is true. It's the probability of seeing data this extreme (or more) if the null IS true. A common and dangerous misinterpretation.\n3. Error Types: Type I error (false positive) is rejecting a true null. Type II error (false negative) is failing to reject a false null. You can't minimize both — there's a trade-off.\n4. Statistical Power: Statistical power is the probability of detecting a real effect. It depends on sample size, effect size, and significance level. Low-powered studies miss real effects.\n5. Practical Significance: Statistical significance doesn't mean practical significance. A huge sample can detect tiny effects that don't matter in practice. Always consider effect size.\n6. Multiple Comparisons: Multiple comparisons inflate Type I errors. Testing 20 hypotheses at alpha=0.05 expects one false positive. Corrections like Bonferroni or FDR control this."
    },
    {
      "duration": 86127.54158300004,
      "inputTokens": 4227,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, I need your help. A biotech startup just pitched us. They claim they need quantum computing to simulate protein folding for their drug discovery pipeline. The CEO is excited, but I'm skeptical. Before we commit resources, I need to figure out if this is actually a good use case for quantum.\",\n      \"options\": [\n        {\n          \"feedback\": \"Exactly right. Quantum simulation is one of the few areas where quantum computers have genuine advantage — simulating molecular and chemical systems is naturally suited to quantum mechanics.\",\n          \"isCorrect\": true,\n          \"text\": \"Yes, simulation is a quantum sweet spot\"\n        },\n        {\n          \"feedback\": \"Classical ML approximates protein structure, but accurate quantum simulation of molecular interactions is fundamentally hard classically. This is actually where quantum shines.\",\n          \"isCorrect\": false,\n          \"text\": \"No, classical ML handles proteins fine\"\n        },\n        {\n          \"feedback\": \"While current hardware is limited, quantum simulation is still the right problem type. The question isn't whether it's valid — it's whether current hardware can handle their specific problem.\",\n          \"isCorrect\": false,\n          \"text\": \"Only if they have millions of qubits\"\n        },\n        {\n          \"feedback\": \"That's too pessimistic. While we're in the NISQ era, quantum simulation of small molecules is already demonstrating value. The use case type is valid.\",\n          \"isCorrect\": false,\n          \"text\": \"Quantum can't do anything useful yet\"\n        }\n      ],\n      \"question\": \"Is protein simulation a valid quantum use case?\"\n    },\n    {\n      \"context\": \"Good call. Okay, so the use case is valid in principle. But here's the thing — they're talking about simulating a protein with 200 amino acids. That's thousands of electrons. They want results in six months. Their investor deck says 'quantum advantage by Q3.'\",\n      \"options\": [\n        {\n          \"feedback\": \"Bingo. A 200-amino-acid protein would require far more logical qubits than any current system. They need to understand the gap between quantum's potential and today's NISQ limitations.\",\n          \"isCorrect\": true,\n          \"text\": \"Current hardware can't handle that scale\"\n        },\n        {\n          \"feedback\": \"Not even close. Current quantum computers can simulate maybe dozens of electrons with significant error. Thousands of electrons is years away, not months.\",\n          \"isCorrect\": false,\n          \"text\": \"Six months is tight but doable\"\n        },\n        {\n          \"feedback\": \"Algorithms help, but the fundamental constraint is hardware. We don't have enough qubits, and decoherence limits how long we can run computations.\",\n          \"isCorrect\": false,\n          \"text\": \"They just need better algorithms\"\n        },\n        {\n          \"feedback\": \"For large proteins, classical is currently the only option — but not because it's fundamentally better. Quantum will eventually win here; it's just not ready yet.\",\n          \"isCorrect\": false,\n          \"text\": \"Classical simulation is actually faster\"\n        }\n      ],\n      \"question\": \"What's the reality check here?\"\n    },\n    {\n      \"context\": \"That's what I thought. So I told them the 200-amino-acid dream is premature. But they pushed back: 'Fine, what CAN quantum do for us right now?' They mentioned they also do some optimization work — finding the best drug candidates from a library of millions. They think quantum parallelism means testing all candidates at once.\",\n      \"options\": [\n        {\n          \"feedback\": \"Exactly. Quantum parallelism evaluates all inputs simultaneously, but measurement collapses to one result. The trick is using interference to amplify the right answer — you can't just 'read out' everything.\",\n          \"isCorrect\": true,\n          \"text\": \"Quantum tests all inputs but reads one\"\n        },\n        {\n          \"feedback\": \"Common misconception. While quantum does evaluate all inputs in superposition, you can only extract one measurement. Without clever interference, you lose most of that parallel computation.\",\n          \"isCorrect\": false,\n          \"text\": \"Parallelism works exactly as they think\"\n        },\n        {\n          \"feedback\": \"It's real and powerful — but misunderstood. The parallelism exists; the limitation is that measurement collapses the superposition. You need algorithms that exploit interference.\",\n          \"isCorrect\": false,\n          \"text\": \"Quantum parallelism is marketing hype\"\n        },\n        {\n          \"feedback\": \"They need both. But their core misunderstanding is about how measurement works. Even with entanglement, you can't extract all parallel results simultaneously.\",\n          \"isCorrect\": false,\n          \"text\": \"They need entanglement, not parallelism\"\n        }\n      ],\n      \"question\": \"How do you address their parallelism misconception?\"\n    },\n    {\n      \"context\": \"Nice explanation, {{NAME}}. They seemed to get it. Then their CTO asked something interesting: 'If we built a quantum optimization algorithm for our drug library, could we at least get a quantum advantage for smaller problems while we wait for better hardware?'\",\n      \"options\": [\n        {\n          \"feedback\": \"Right. Quantum advantage isn't automatic — it requires problems where quantum interference can outperform classical heuristics. Many optimization problems don't qualify. They need to analyze their specific structure.\",\n          \"isCorrect\": true,\n          \"text\": \"Problem type must favor quantum approaches\"\n        },\n        {\n          \"feedback\": \"Qubit count matters, but it's not sufficient. The problem must have structure that quantum algorithms exploit. Many optimization problems are solved well classically.\",\n          \"isCorrect\": false,\n          \"text\": \"Just need more qubits than the problem size\"\n        },\n        {\n          \"feedback\": \"False. Quantum speedups are problem-specific. Many optimization problems have excellent classical algorithms. Quantum advantage requires the right problem structure.\",\n          \"isCorrect\": false,\n          \"text\": \"Any optimization shows quantum speedup\"\n        },\n        {\n          \"feedback\": \"Noise is a challenge, but some near-term algorithms can tolerate it. The bigger question is whether their problem type benefits from quantum at all.\",\n          \"isCorrect\": false,\n          \"text\": \"Current noise makes all advantage impossible\"\n        }\n      ],\n      \"question\": \"What determines if they'd see quantum advantage?\"\n    },\n    {\n      \"context\": \"They're going to analyze whether their drug candidate selection has the right structure for quantum optimization. Smart move. But now their CTO is asking about building a hybrid approach — running part of the computation on quantum and part on classical. She wants to know how to handle the quantum portion's errors.\",\n      \"options\": [\n        {\n          \"feedback\": \"Correct. Current NISQ devices have high error rates and short coherence times. Practical near-term algorithms need to be noise-tolerant or use hybrid approaches that minimize quantum circuit depth.\",\n          \"isCorrect\": true,\n          \"text\": \"Errors are frequent; algorithms must tolerate them\"\n        },\n        {\n          \"feedback\": \"Not yet. Quantum error correction requires thousands of physical qubits per logical qubit. We don't have that overhead available on current hardware. They'll face raw, uncorrected errors.\",\n          \"isCorrect\": false,\n          \"text\": \"Error correction solves this problem now\"\n        },\n        {\n          \"feedback\": \"Errors accumulate with every gate and every microsecond. Even short computations on NISQ devices have significant error rates. Decoherence is always fighting you.\",\n          \"isCorrect\": false,\n          \"text\": \"Errors only matter for long computations\"\n        },\n        {\n          \"feedback\": \"Once a quantum state decoheres or an error occurs, the quantum information is lost. You can't classically recover it after the fact. Error mitigation helps but isn't perfect.\",\n          \"isCorrect\": false,\n          \"text\": \"Classical post-processing fixes quantum errors\"\n        }\n      ],\n      \"question\": \"What's the error situation for near-term systems?\"\n    },\n    {\n      \"context\": \"Good, they understand the noise challenge. The CTO then mentioned they've been reading about quantum error correction. She asked: 'If we wait two years, won't fault-tolerant quantum computers just solve all our problems? Maybe we should pause until then.'\",\n      \"options\": [\n        {\n          \"feedback\": \"Correct. Fault-tolerant quantum computing requires massive overhead — thousands of physical qubits per logical qubit. We're talking 5-10+ years, not 2. They shouldn't pause; they should start learning now.\",\n          \"isCorrect\": true,\n          \"text\": \"Fault tolerance is still many years away\"\n        },\n        {\n          \"feedback\": \"Way too optimistic. Current error correction demonstrations use maybe 10-50 physical qubits. Practical fault tolerance needs millions. The timeline is measured in decades, not years.\",\n          \"isCorrect\": false,\n          \"text\": \"Yes, two years is a reasonable estimate\"\n        },\n        {\n          \"feedback\": \"It absolutely will — simulation and optimization will benefit enormously. The issue is timeline, not applicability. They're underestimating how far away it is.\",\n          \"isCorrect\": false,\n          \"text\": \"Fault tolerance won't help their use case\"\n        },\n        {\n          \"feedback\": \"Quantum error correction is proven theoretically and demonstrated experimentally. The challenge is scaling it up, which requires hardware advances we don't have yet.\",\n          \"isCorrect\": false,\n          \"text\": \"Error correction is theoretically impossible\"\n        }\n      ],\n      \"question\": \"Is waiting for fault tolerance a good strategy?\"\n    },\n    {\n      \"context\": \"I love how you broke that down. Two years definitely isn't happening. Now here's where it gets interesting — the startup's lead physicist just joined the call. She's been quiet, but now she says: 'We've been discussing our entangled qubit system. If we entangle enough qubits, we can transmit information faster than light, right? That would speed up our distributed computing cluster.'\",\n      \"options\": [\n        {\n          \"feedback\": \"Exactly. Entanglement creates correlations between measurements, but you can't use it to transmit information. You still need classical communication to compare results. No faster-than-light messaging.\",\n          \"isCorrect\": true,\n          \"text\": \"Entanglement correlates but can't send data\"\n        },\n        {\n          \"feedback\": \"No. Entanglement cannot transmit any information faster than light — quantum or classical. The correlations are real, but they can't be used for communication without classical channels.\",\n          \"isCorrect\": false,\n          \"text\": \"FTL works but only for quantum data\"\n        },\n        {\n          \"feedback\": \"Quantity doesn't help. Entanglement fundamentally cannot transmit information. The no-communication theorem proves this. More pairs = more correlation, not faster communication.\",\n          \"isCorrect\": false,\n          \"text\": \"She's right with enough entangled pairs\"\n        },\n        {\n          \"feedback\": \"It's not faster at all. There's no information transfer happening. Entanglement is a correlation resource for algorithms, not a communication channel.\",\n          \"isCorrect\": false,\n          \"text\": \"It's faster but not useful for computing\"\n        }\n      ],\n      \"question\": \"How do you address this entanglement claim?\"\n    },\n    {\n      \"context\": \"Whew, {{NAME}}, that could have gone sideways. The physicist looked embarrassed but thanked you for the clarification. She admitted she'd been conflating correlation with communication. Okay, so now they're asking the practical question: 'Given all this, what should we actually do? Where do we start?'\",\n      \"options\": [\n        {\n          \"feedback\": \"Perfect advice. Start with systems small enough for current hardware, learn the technology's quirks, build expertise. They can scale up as hardware improves. Walk before you run.\",\n          \"isCorrect\": true,\n          \"text\": \"Start with small molecule simulations\"\n        },\n        {\n          \"feedback\": \"Bad strategy. The learning curve is steep. Companies that start now will be ready when hardware matures. Waiting means falling behind competitors who are building expertise today.\",\n          \"isCorrect\": false,\n          \"text\": \"Wait for better hardware entirely\"\n        },\n        {\n          \"feedback\": \"Hardware alone won't help. They need algorithms, expertise, and problem formulation skills. Starting small and learning is more valuable than raw qubit count.\",\n          \"isCorrect\": false,\n          \"text\": \"Buy the biggest quantum computer available\"\n        },\n        {\n          \"feedback\": \"They'd be giving up on a genuine long-term advantage. Simulation is one of quantum's best use cases. They should invest in learning now, not abandon the approach.\",\n          \"isCorrect\": false,\n          \"text\": \"Abandon quantum and use classical ML\"\n        }\n      ],\n      \"question\": \"What's the right first step for them?\"\n    },\n    {\n      \"context\": \"They loved that advice. Start small, build expertise, scale with the hardware. The CEO is now nodding along. But then — plot twist — the CTO pulls up an email. 'Our competitor just announced they achieved quantum advantage on a drug discovery problem. It's all over the news. Are we already behind?'\",\n      \"options\": [\n        {\n          \"feedback\": \"Smart skepticism. 'Quantum advantage' claims often compare against deliberately weak classical algorithms or solve artificial problems. The media loves quantum hype. Look at what they actually demonstrated.\",\n          \"isCorrect\": true,\n          \"text\": \"Read the fine print — likely overhyped\"\n        },\n        {\n          \"feedback\": \"Panicking over press releases is never the right move. Quantum advantage claims are frequently exaggerated or narrowly defined. They should analyze the actual results critically.\",\n          \"isCorrect\": false,\n          \"text\": \"They're years behind — panic is warranted\"\n        },\n        {\n          \"feedback\": \"Absolutely not. Quantum advantage is always problem-specific and often narrow. One demonstration doesn't mean practical drug discovery is solved. The devil is in the details.\",\n          \"isCorrect\": false,\n          \"text\": \"Quantum advantage means all problems solved\"\n        },\n        {\n          \"feedback\": \"Almost certainly not — we're years from fault tolerance. Near-term 'advantage' demos use NISQ devices for very specific, often contrived problems. This doesn't imply a breakthrough.\",\n          \"isCorrect\": false,\n          \"text\": \"The competitor must have fault tolerance\"\n        }\n      ],\n      \"question\": \"How should they interpret this announcement?\"\n    },\n    {\n      \"context\": \"{{NAME}}, you called it. I just read the paper. They compared their quantum algorithm against a basic brute-force classical search on a toy problem with 50 molecules. Our startup could beat that 'quantum advantage' with a laptop and a decent heuristic. The CEO laughed. 'So the press release was basically marketing?'\",\n      \"options\": [\n        {\n          \"feedback\": \"Exactly right. There IS real progress in quantum computing, but press releases optimize for attention, not accuracy. The field advances incrementally while headlines promise revolution.\",\n          \"isCorrect\": true,\n          \"text\": \"Promising progress, but hype outpaces reality\"\n        },\n        {\n          \"feedback\": \"Too cynical. Real progress is happening — just slower than headlines suggest. The technology is genuine; the marketing is overenthusiastic. Stay skeptical but not dismissive.\",\n          \"isCorrect\": false,\n          \"text\": \"All quantum claims are fraudulent\"\n        },\n        {\n          \"feedback\": \"Wrong conclusion. One overhyped press release doesn't invalidate the field. Quantum simulation has solid theoretical foundations. Progress is real, just hyped.\",\n          \"isCorrect\": false,\n          \"text\": \"This proves quantum will never work\"\n        },\n        {\n          \"feedback\": \"Vendors have even more incentive to hype! The answer is critical reading — check peer-reviewed papers, compare against strong classical baselines, and ignore marketing copy.\",\n          \"isCorrect\": false,\n          \"text\": \"Ignore all news and trust vendors only\"\n        }\n      ],\n      \"question\": \"What's the honest take on such announcements?\"\n    },\n    {\n      \"context\": \"The CEO just made a decision: 'We're going to start small like you suggested, build real expertise, and not chase headlines. One last question though, {{NAME}} — if we actually get this right, what does the endgame look like? When quantum hardware matures, what becomes possible that's impossible today?'\",\n      \"options\": [\n        {\n          \"feedback\": \"Perfect summary. The endgame is simulating molecular systems that classical computers fundamentally cannot handle — drug design, materials science, catalysis. Not everything, but genuinely transformative for the right problems.\",\n          \"isCorrect\": true,\n          \"text\": \"Simulate chemistry classically intractable today\"\n        },\n        {\n          \"feedback\": \"No. Quantum excels at specific problem types — simulation, certain optimizations, factoring. Your laptop will still run spreadsheets. Quantum is a specialized tool, not a replacement.\",\n          \"isCorrect\": false,\n          \"text\": \"Quantum will replace all classical computing\"\n        },\n        {\n          \"feedback\": \"Quantum doesn't provide unlimited power. It provides exponential speedups for specific problems. Many algorithms will always run better classically. Know your problem type.\",\n          \"isCorrect\": false,\n          \"text\": \"Unlimited computing power for any problem\"\n        },\n        {\n          \"feedback\": \"Shor's algorithm threatens certain encryption, but post-quantum cryptography already exists. And running Shor at scale requires fault-tolerant systems we don't have. This isn't the main value proposition.\",\n          \"isCorrect\": false,\n          \"text\": \"Breaking all encryption instantly\"\n        }\n      ],\n      \"question\": \"What's the realistic quantum promise?\"\n    }\n  ]\n}",
      "outputTokens": 3471,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "en-physics-quantum-computing-basics-1",
      "userPrompt": "LESSON_TITLE: Quantum Computing Fundamentals\nLESSON_DESCRIPTION: Understanding quantum computing capabilities and limitations for practical problem-solving\nCHAPTER_TITLE: Quantum Information\nCOURSE_TITLE: Quantum Computing Fundamentals\nLANGUAGE: en\nEXPLANATION_STEPS:\n1. Superposition: Qubits can exist in superposition — a weighted combination of 0 and 1 states. This isn't 'both at once' — it's a probability amplitude that interferes before measurement.\n2. Entanglement: Entanglement links qubits so measuring one instantly determines the other, regardless of distance. This correlation is a resource for quantum algorithms.\n3. Quantum Parallelism: Quantum parallelism lets algorithms evaluate functions on all inputs simultaneously. But you can only read one result — the art is using interference to amplify the right answer.\n4. Decoherence: Decoherence destroys quantum information when qubits interact with their environment. Real qubits are noisy and maintain coherence only briefly.\n5. Error Correction: Quantum error correction encodes logical qubits in many physical qubits. The overhead is huge — thousands of physical qubits per logical qubit for fault tolerance.\n6. Where Quantum Helps: Quantum advantage requires the right problem type. Factoring, simulation, and certain optimization problems benefit. Most classical algorithms won't be replaced."
    },
    {
      "duration": 114390.07141700003,
      "inputTokens": 4306,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, estou olhando pra esse diagrama do monolito e o pessoal quer quebrar tudo em microserviços. O sistema de e-commerce tem pedidos, inventário, pagamentos e notificações. A galera quer criar um serviço só pro banco de dados e outro só pra API. O que você acha dessa divisão?\",\n      \"options\": [\n        {\n          \"feedback\": \"Dividir por camadas técnicas é um anti-pattern. Você criaria acoplamento forte entre serviços e perderia a independência que microserviços deveriam trazer.\",\n          \"isCorrect\": false,\n          \"text\": \"Serviço de BD e serviço de API\"\n        },\n        {\n          \"feedback\": \"Exato! Limites de serviço devem seguir domínios de negócio, não camadas técnicas. Assim cada serviço pode evoluir e escalar independentemente.\",\n          \"isCorrect\": true,\n          \"text\": \"Por domínios: Pedidos, Inventário, etc.\"\n        },\n        {\n          \"feedback\": \"Isso ainda é divisão técnica, não por negócio. Você teria serviços sem lógica coesa e precisaria de transações distribuídas pra tudo.\",\n          \"isCorrect\": false,\n          \"text\": \"Um serviço por tabela do banco\"\n        },\n        {\n          \"feedback\": \"Pode ser válido em alguns casos, mas a pergunta é sobre como dividir se formos fazer. A divisão por domínio é a abordagem correta.\",\n          \"isCorrect\": false,\n          \"text\": \"Manter o monolito por enquanto\"\n        }\n      ],\n      \"question\": \"Como devemos dividir os serviços?\"\n    },\n    {\n      \"context\": \"Boa, {{NAME}}! Domínios de negócio faz sentido. Agora, o serviço de Pedidos precisa consultar o Inventário pra saber se tem estoque antes de confirmar. E o time quer que a resposta seja instantânea pro cliente. Qual tipo de comunicação você sugere aqui?\",\n      \"options\": [\n        {\n          \"feedback\": \"Assíncrona é mais resiliente, mas o cliente precisa de resposta imediata sobre o estoque. Fila não garante resposta em tempo real.\",\n          \"isCorrect\": false,\n          \"text\": \"Assíncrona com fila de mensagens\"\n        },\n        {\n          \"feedback\": \"Quando o cliente precisa de resposta imediata, comunicação síncrona faz sentido. REST ou gRPC permitem a consulta em tempo real que você precisa.\",\n          \"isCorrect\": true,\n          \"text\": \"Síncrona via REST ou gRPC\"\n        },\n        {\n          \"feedback\": \"Compartilhar banco quebra a independência dos serviços. Cada serviço deve ter seu próprio banco — dados descentralizados são essenciais.\",\n          \"isCorrect\": false,\n          \"text\": \"Compartilhar o banco de dados\"\n        },\n        {\n          \"feedback\": \"Cache pode ajudar, mas não resolve a comunicação inicial. Você ainda precisa de um mecanismo para buscar dados atualizados do Inventário.\",\n          \"isCorrect\": false,\n          \"text\": \"Cache local com dados do inventário\"\n        }\n      ],\n      \"question\": \"Qual comunicação usar entre Pedidos e Inventário?\"\n    },\n    {\n      \"context\": \"Legal, REST pro Inventário então. Agora, depois que o pedido é confirmado, precisamos notificar o cliente por email e SMS. Isso pode demorar uns segundos, às vezes mais. O cliente não precisa esperar por isso. Como fazemos?\",\n      \"options\": [\n        {\n          \"feedback\": \"Por que fazer o cliente esperar por algo que não afeta a confirmação? Síncrono aqui adiciona latência desnecessária ao fluxo principal.\",\n          \"isCorrect\": false,\n          \"text\": \"REST síncrono para Notificações\"\n        },\n        {\n          \"feedback\": \"Perfeito! Comunicação assíncrona via eventos é ideal aqui. Pedidos publica o evento, Notificações processa quando puder. Cliente não espera.\",\n          \"isCorrect\": true,\n          \"text\": \"Publicar evento e Notificações consome\"\n        },\n        {\n          \"feedback\": \"Isso mistura responsabilidades. Notificações devem ser um serviço separado. Além disso, se Pedidos reiniciar, a thread morre e o email não sai.\",\n          \"isCorrect\": false,\n          \"text\": \"Thread em background no Pedidos\"\n        },\n        {\n          \"feedback\": \"Polling é ineficiente e adiciona delay. Eventos são mais elegantes e permitem processamento imediato quando a mensagem chega.\",\n          \"isCorrect\": false,\n          \"text\": \"Cron job que busca pedidos novos\"\n        }\n      ],\n      \"question\": \"Qual abordagem para as notificações?\"\n    },\n    {\n      \"context\": \"Show, {{NAME}}! Eventos pra notificações, REST pra inventário. Agora o time de Pedidos quer acessar direto o banco de Inventário pra ganhar performance. Dizem que é 'só uma query'. O que você responde?\",\n      \"options\": [\n        {\n          \"feedback\": \"Performance é importante, mas compartilhar banco cria acoplamento forte. Mudanças no schema do Inventário podem quebrar Pedidos.\",\n          \"isCorrect\": false,\n          \"text\": \"Sim, performance é prioridade\"\n        },\n        {\n          \"feedback\": \"Exato! Dados descentralizados são fundamentais. Cada serviço é dono do seu banco. Acesso direto quebra a independência e cria acoplamento perigoso.\",\n          \"isCorrect\": true,\n          \"text\": \"Não, cada serviço tem seu banco\"\n        },\n        {\n          \"feedback\": \"Mesmo leitura cria acoplamento de schema. Se Inventário mudar uma coluna, Pedidos quebra. A API do serviço é o contrato correto.\",\n          \"isCorrect\": false,\n          \"text\": \"Só leitura, nunca escrita\"\n        },\n        {\n          \"feedback\": \"View ainda é acesso direto ao banco. O problema de acoplamento de schema permanece. APIs são o contrato entre serviços.\",\n          \"isCorrect\": false,\n          \"text\": \"Criar uma view compartilhada\"\n        }\n      ],\n      \"question\": \"Devemos permitir acesso direto ao banco?\"\n    },\n    {\n      \"context\": \"O time entendeu. Cada um com seu banco. Mas agora surgiu uma dúvida: quando um cliente faz um pedido, precisamos debitar o estoque E criar o pedido. Se um falhar, o outro precisa reverter. Como garantimos isso?\",\n      \"options\": [\n        {\n          \"feedback\": \"Two-phase commit é complexo, lento e frágil. Em microserviços, transações distribuídas devem ser evitadas. Há formas melhores.\",\n          \"isCorrect\": false,\n          \"text\": \"Transação distribuída com 2PC\"\n        },\n        {\n          \"feedback\": \"Sim! Sagas orquestram operações com compensações se algo falhar. Consistência eventual é a realidade em microserviços — transações distribuídas são um anti-pattern.\",\n          \"isCorrect\": true,\n          \"text\": \"Aceitar consistência eventual com sagas\"\n        },\n        {\n          \"feedback\": \"Isso viola a separação de domínios. Pedidos e Inventário têm responsabilidades distintas. Sagas mantêm a separação com consistência eventual.\",\n          \"isCorrect\": false,\n          \"text\": \"Fazer tudo no mesmo serviço\"\n        },\n        {\n          \"feedback\": \"Isso causaria problemas sérios. Pedidos sem estoque reservado ou estoque debitado sem pedido. Sagas resolvem isso com compensações.\",\n          \"isCorrect\": false,\n          \"text\": \"Ignorar e deixar inconsistente\"\n        }\n      ],\n      \"question\": \"Como lidar com a consistência entre serviços?\"\n    },\n    {\n      \"context\": \"Sagas! Boa, {{NAME}}. Implementamos tudo, tá funcionando. Mas aí o serviço de Pagamentos começou a ficar lento — às vezes leva 30 segundos pra responder. E agora Pedidos tá travando esperando Pagamentos. Os outros serviços também começaram a degradar. Tá uma bagunça.\",\n      \"options\": [\n        {\n          \"feedback\": \"Não é só rede. O problema é que a lentidão de Pagamentos está se propagando. Isso tem nome: falha em cascata.\",\n          \"isCorrect\": false,\n          \"text\": \"Problema de rede isolado\"\n        },\n        {\n          \"feedback\": \"Exatamente! Falhas em cascata acontecem quando um serviço lento trava outros. As threads de Pedidos ficam presas esperando Pagamentos.\",\n          \"isCorrect\": true,\n          \"text\": \"Falha em cascata por Pagamentos lento\"\n        },\n        {\n          \"feedback\": \"Não é bug em Pedidos. O padrão é clássico: um serviço lento está causando backpressure em todos que dependem dele.\",\n          \"isCorrect\": false,\n          \"text\": \"Bug no código de Pedidos\"\n        },\n        {\n          \"feedback\": \"O problema começa em Pagamentos. Mesmo que fosse o banco, a lentidão está se propagando — isso é falha em cascata e precisa de proteção.\",\n          \"isCorrect\": false,\n          \"text\": \"Banco de dados sobrecarregado\"\n        }\n      ],\n      \"question\": \"O que está acontecendo no sistema?\"\n    },\n    {\n      \"context\": \"Falha em cascata, {{NAME}}. Clássico. Precisamos proteger Pedidos de quando Pagamentos está lento ou fora. O que implementamos?\",\n      \"options\": [\n        {\n          \"feedback\": \"Retry infinito só piora! Você vai sobrecarregar ainda mais o Pagamentos que já está lento. É jogar gasolina no fogo.\",\n          \"isCorrect\": false,\n          \"text\": \"Retry infinito até funcionar\"\n        },\n        {\n          \"feedback\": \"Perfeito! Circuit breaker 'abre' quando detecta falhas, parando de chamar Pagamentos por um tempo. Fallback dá uma resposta alternativa ao usuário.\",\n          \"isCorrect\": true,\n          \"text\": \"Circuit breaker com fallback\"\n        },\n        {\n          \"feedback\": \"Timeout maior só segura as threads por mais tempo! Você precisa falhar rápido, não esperar mais. Circuit breaker é a resposta.\",\n          \"isCorrect\": false,\n          \"text\": \"Aumentar o timeout para 60s\"\n        },\n        {\n          \"feedback\": \"Mais instâncias de Pedidos só criam mais threads travadas esperando Pagamentos. O problema é a dependência, não a capacidade.\",\n          \"isCorrect\": false,\n          \"text\": \"Escalar Pedidos horizontalmente\"\n        }\n      ],\n      \"question\": \"Qual mecanismo de resiliência aplicar?\"\n    },\n    {\n      \"context\": \"Circuit breaker implementado! Quando Pagamentos está lento, Pedidos agora retorna 'processamento pendente' pro cliente. Muito melhor. Mas aí o PM veio perguntar: 'Como vocês vão saber quando Pagamentos ficar lento de novo? Não quero descobrir pelo cliente reclamando.'\",\n      \"options\": [\n        {\n          \"feedback\": \"Logs locais são inúteis em microserviços. Você tem N instâncias, cada uma com seu log. Precisa centralizar tudo num lugar só.\",\n          \"isCorrect\": false,\n          \"text\": \"Logs em arquivo local em cada serviço\"\n        },\n        {\n          \"feedback\": \"Isso! Observabilidade requer logs centralizados, métricas e tracing distribuído. Sem isso, debugar problemas em produção é quase impossível.\",\n          \"isCorrect\": true,\n          \"text\": \"Observabilidade: logs, métricas e tracing\"\n        },\n        {\n          \"feedback\": \"Health check básico não mostra latência, erros ou gargalos. Você precisa de observabilidade completa: logs, métricas e traces.\",\n          \"isCorrect\": false,\n          \"text\": \"Script que pinga os serviços\"\n        },\n        {\n          \"feedback\": \"Alertas são parte, mas você precisa de visibilidade contínua. Métricas mostram degradação ANTES do breaker abrir. Observabilidade é mais ampla.\",\n          \"isCorrect\": false,\n          \"text\": \"Email quando o circuit breaker abrir\"\n        }\n      ],\n      \"question\": \"O que precisamos implementar?\"\n    },\n    {\n      \"context\": \"Implementamos Datadog pra métricas, ELK pra logs e Jaeger pra tracing. Agora conseguimos ver tudo! Mas aí, {{NAME}}, olha só o que apareceu no dashboard: o serviço de Notificações tá com latência de 5 segundos, mas... ninguém reclamou. Os emails tão chegando. O que tá acontecendo?\",\n      \"options\": [\n        {\n          \"feedback\": \"Improvável. A latência está sendo medida corretamente. A questão é entender por que 5 segundos não é problema nesse caso.\",\n          \"isCorrect\": false,\n          \"text\": \"O dashboard está com bug\"\n        },\n        {\n          \"feedback\": \"Exato! Como Notificações consome eventos de forma assíncrona, a latência dele não afeta a experiência do usuário. O cliente já recebeu a confirmação.\",\n          \"isCorrect\": true,\n          \"text\": \"Notificações é assíncrono, não impacta UX\"\n        },\n        {\n          \"feedback\": \"Não é sobre o que é aceitável. A questão é que Notificações é assíncrono — a latência dele não bloqueia ninguém. Diferente do Inventário.\",\n          \"isCorrect\": false,\n          \"text\": \"5 segundos é aceitável para email\"\n        },\n        {\n          \"feedback\": \"Volume não explica a falta de impacto. Mesmo com muitos usuários, não haveria reclamação porque Notificações é assíncrono.\",\n          \"isCorrect\": false,\n          \"text\": \"Poucos usuários estão usando\"\n        }\n      ],\n      \"question\": \"Por que alta latência sem impacto aparente?\"\n    },\n    {\n      \"context\": \"Faz sentido, é assíncrono! Bom, {{NAME}}, tá tudo rodando liso. Aí na sexta-feira às 18h, o CTO manda mensagem: 'O novo sistema de Frete precisa estar no ar segunda. Só mais um microserviço, tranquilo né?' Já to vendo a cara do time...\",\n      \"options\": [\n        {\n          \"feedback\": \"Testes são importantes, mas a preocupação maior é se realmente precisamos de mais um serviço. Microserviços têm overhead significativo.\",\n          \"isCorrect\": false,\n          \"text\": \"Não temos tempo de escrever testes\"\n        },\n        {\n          \"feedback\": \"Isso! Cada microserviço adiciona complexidade operacional. Antes de criar, precisamos avaliar: faz sentido como serviço separado? O custo operacional vale?\",\n          \"isCorrect\": true,\n          \"text\": \"Adicionar serviço sem avaliar trade-offs\"\n        },\n        {\n          \"feedback\": \"Conhecimento é importante, mas a questão maior é se microserviço é a arquitetura certa. Às vezes um módulo no monolito é mais adequado.\",\n          \"isCorrect\": false,\n          \"text\": \"O time não conhece o domínio de Frete\"\n        },\n        {\n          \"feedback\": \"Prazo é problema, mas deployar rápido sem pensar é pior. A pergunta real é: precisamos mesmo de mais um serviço independente?\",\n          \"isCorrect\": false,\n          \"text\": \"Segunda-feira é muito perto\"\n        }\n      ],\n      \"question\": \"Qual a maior preocupação com essa demanda?\"\n    },\n    {\n      \"context\": \"Falei exatamente isso pro CTO, {{NAME}}. Aí ele perguntou: 'Tá, então quando FAZ sentido criar um novo microserviço? Me dá critérios objetivos.'\",\n      \"options\": [\n        {\n          \"feedback\": \"Tamanho de código não é critério. Um serviço pequeno mal definido é pior que um grande bem estruturado. Domínio é o que importa.\",\n          \"isCorrect\": false,\n          \"text\": \"Quando o código fica grande demais\"\n        },\n        {\n          \"feedback\": \"Perfeito! Um microserviço faz sentido quando tem domínio claro, pode evoluir independentemente e o time pode fazer deploy sem coordenar com outros.\",\n          \"isCorrect\": true,\n          \"text\": \"Domínio distinto com ciclo de deploy próprio\"\n        },\n        {\n          \"feedback\": \"Tecnologia pode ser fator, mas não é o principal. O critério é domínio de negócio independente e necessidade de deploy/escala separados.\",\n          \"isCorrect\": false,\n          \"text\": \"Quando precisamos de tecnologia diferente\"\n        },\n        {\n          \"feedback\": \"Escala é benefício, mas não justifica sozinha. Você pode escalar partes de um monolito também. Domínio independente é o critério central.\",\n          \"isCorrect\": false,\n          \"text\": \"Quando queremos escalar uma parte\"\n        }\n      ],\n      \"question\": \"Quando um novo microserviço faz sentido?\"\n    },\n    {\n      \"context\": \"O CTO entendeu. Decidimos que Frete realmente faz sentido como serviço — domínio claro, time dedicado, precisa escalar diferente na Black Friday. Mas {{NAME}}, olha essa mensagem que acabou de chegar do DevOps: 'Pessoal, descobri que o serviço de Inventário tá fazendo 47 chamadas REST pro serviço de Produtos em cada request. Latência tá em 800ms.'\",\n      \"options\": [\n        {\n          \"feedback\": \"gRPC é mais rápido, mas 47 chamadas ainda seriam um problema. O issue é o design conversacional excessivo, não o protocolo.\",\n          \"isCorrect\": false,\n          \"text\": \"REST é muito lento, usar gRPC\"\n        },\n        {\n          \"feedback\": \"Isso! Design 'chatty' com muitas chamadas pequenas é anti-pattern. Os limites de serviço podem estar errados, ou Inventário precisa de uma API batch.\",\n          \"isCorrect\": true,\n          \"text\": \"Serviço muito 'chatty', granularidade errada\"\n        },\n        {\n          \"feedback\": \"Cache pode ajudar, mas mascara o problema real. 47 chamadas sugere que os limites de serviço podem estar mal definidos.\",\n          \"isCorrect\": false,\n          \"text\": \"Precisa de cache entre os serviços\"\n        },\n        {\n          \"feedback\": \"Duplicar todos os dados de Produtos em Inventário viola separação de responsabilidades. O problema é o design das APIs, não a localização dos dados.\",\n          \"isCorrect\": false,\n          \"text\": \"Inventário deveria ter os dados locais\"\n        }\n      ],\n      \"question\": \"Qual o problema arquitetural aqui?\"\n    },\n    {\n      \"context\": \"Refatoramos a API pra batch e caiu pra 3 chamadas. Latência foi pra 120ms. Muito melhor! Mas {{NAME}}, agora o plot twist: lembra do circuit breaker que implementamos? Acabei de ver no Jaeger que ele abriu 15 vezes na última hora pro serviço de Pagamentos. Só que... Pagamentos tá respondendo em 200ms. Não tá lento. O que tá acontecendo?\",\n      \"options\": [\n        {\n          \"feedback\": \"Pode parecer, mas primeiro precisamos investigar. O breaker abre por falhas, não só por lentidão. Vamos olhar os traces com mais cuidado.\",\n          \"isCorrect\": false,\n          \"text\": \"Bug na configuração do breaker\"\n        },\n        {\n          \"feedback\": \"Bingo! Se o timeout de Pedidos é 100ms e Pagamentos responde em 200ms, toda chamada estoura timeout. O breaker vê como falha e abre.\",\n          \"isCorrect\": true,\n          \"text\": \"Timeouts muito agressivos em Pedidos\"\n        },\n        {\n          \"feedback\": \"Se fosse rede, a latência de Pagamentos variaria. Está constante em 200ms. O problema é que alguém considera 200ms como falha.\",\n          \"isCorrect\": false,\n          \"text\": \"Problema de rede intermitente\"\n        },\n        {\n          \"feedback\": \"O trace mostra respostas normais em 200ms. O problema é que algo está interpretando 200ms como lento demais.\",\n          \"isCorrect\": false,\n          \"text\": \"Pagamentos está retornando erros\"\n        }\n      ],\n      \"question\": \"Por que o circuit breaker está abrindo?\"\n    },\n    {\n      \"context\": \"Era o timeout! Configurado em 100ms, Pagamentos responde em 200ms. Ajustamos pra 500ms com margem. Problema resolvido! {{NAME}}, o CTO acabou de passar aqui e disse: 'O sistema tá estável, parabéns. Agora me conta: qual foi o maior aprendizado de vocês nessa jornada toda?'\",\n      \"options\": [\n        {\n          \"feedback\": \"Longe disso! Microserviços adicionam complexidade enorme. A lição é avaliar trade-offs: ganhos de independência vs. custo operacional.\",\n          \"isCorrect\": false,\n          \"text\": \"Microserviços sempre são melhores\"\n        },\n        {\n          \"feedback\": \"Exato, {{NAME}}! Limites por domínio, sync vs async, consistência eventual, resiliência, observabilidade — cada escolha tem trade-offs. Consciência disso é o que separa arquitetura boa de desastre.\",\n          \"isCorrect\": true,\n          \"text\": \"Trade-offs conscientes em cada decisão\"\n        },\n        {\n          \"feedback\": \"Observabilidade é essencial, mas não resolve problemas de design. Ela mostra os problemas — você ainda precisa de arquitetura sólida.\",\n          \"isCorrect\": false,\n          \"text\": \"Observabilidade resolve tudo\"\n        },\n        {\n          \"feedback\": \"Nano-serviços são anti-pattern! Muito pequeno gera overhead de comunicação e complexidade. O tamanho certo é definido pelo domínio, não por linhas de código.\",\n          \"isCorrect\": false,\n          \"text\": \"Quanto menor o serviço, melhor\"\n        }\n      ],\n      \"question\": \"Qual o maior aprendizado sobre microserviços?\"\n    }\n  ]\n}",
      "outputTokens": 6080,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "pt-cs-microservices-architecture-1",
      "userPrompt": "LESSON_TITLE: Microservicos na Pratica\nLESSON_DESCRIPTION: Projetando e implementando arquiteturas de microservicos com consciencia dos trade-offs\nCHAPTER_TITLE: Arquitetura de Software\nCOURSE_TITLE: Engenharia de Software Avancada\nLANGUAGE: pt\nEXPLANATION_STEPS:\n1. Definicao de Microservicos: Microservicos sao servicos pequenos e independentes que fazem uma coisa bem. Cada um pode ser desenvolvido, implantado e escalado separadamente.\n2. Limites de Servico: Limites de servico devem seguir dominios de negocio, nao camadas tecnicas. Um servico de 'Pedidos' faz sentido; um servico de 'Banco de Dados' nao.\n3. Comunicacao: A comunicacao entre servicos pode ser sincrona (REST, gRPC) ou assincrona (filas, eventos). Assincrona e mais resiliente mas mais complexa de debugar.\n4. Dados Descentralizados: Dados descentralizados significam que cada servico tem seu banco. Consistencia eventual e a realidade — transacoes distribuidas sao dificeis e devem ser evitadas.\n5. Resiliencia: Falhas em cascata acontecem quando um servico lento trava outros. Circuit breakers, timeouts e fallbacks sao essenciais para resiliencia.\n6. Observabilidade: Observabilidade requer logs centralizados, metricas e tracing distribuido. Sem isso, debugar problemas em producao e quase impossivel."
    },
    {
      "duration": 122104.64437499997,
      "inputTokens": 4277,
      "output": "{\n  \"steps\": [\n    {\n      \"context\": \"{{NAME}}, menos mal que te encuentro. Tenemos un problema urgente con el proyecto de la planta de tratamiento de agua. El cliente quiere minimizar el costo del tanque cilíndrico, pero con una capacidad fija de 1000 litros. Me pasaron los costos: el material de la base cuesta el doble que el de las paredes laterales. ¿Por dónde empezamos?\",\n      \"options\": [\n        {\n          \"feedback\": \"No podemos derivar sin antes tener una función. Primero necesitamos modelar el problema: definir la función de costo en términos de las variables (radio y altura) y la restricción de volumen.\",\n          \"isCorrect\": false,\n          \"text\": \"Calcular directamente la derivada\"\n        },\n        {\n          \"feedback\": \"¡Exacto! Modelar correctamente es la mitad del trabajo. Necesitamos expresar el costo total como función del radio y altura, con la restricción de que el volumen sea 1000 litros.\",\n          \"isCorrect\": true,\n          \"text\": \"Modelar la función objetivo y restricciones\"\n        },\n        {\n          \"feedback\": \"Los multiplicadores de Lagrange son útiles, pero primero debemos definir claramente qué estamos optimizando y cuál es la restricción. Sin el modelo, no hay nada que optimizar.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar multiplicadores de Lagrange\"\n        },\n        {\n          \"feedback\": \"Evaluar extremos es parte del proceso, pero viene después. Primero necesitamos establecer la función de costo y la restricción de volumen para saber qué estamos optimizando.\",\n          \"isCorrect\": false,\n          \"text\": \"Evaluar los extremos del dominio\"\n        }\n      ],\n      \"question\": \"¿Cuál es el primer paso para resolver este problema?\"\n    },\n    {\n      \"context\": \"Perfecto, vamos a modelar. El volumen es V = πr²h = 1000 litros. El costo de la base circular es proporcional a πr² y cuesta el doble. Las paredes laterales tienen área 2πrh. Entonces el costo total sería... C = 2πr² + 2πrh, ¿no? Pero tenemos dos variables, r y h.\",\n      \"options\": [\n        {\n          \"feedback\": \"No podemos ignorar h porque afecta el costo de las paredes. La restricción de volumen nos permite expresar h en función de r: h = 1000/(πr²), y sustituir en la función de costo.\",\n          \"isCorrect\": false,\n          \"text\": \"Ignorar h y optimizar solo en r\"\n        },\n        {\n          \"feedback\": \"¡Correcto! De πr²h = 1000, despejamos h = 1000/(πr²). Sustituyendo en C: C(r) = 2πr² + 2πr(1000/πr²) = 2πr² + 2000/r. Ahora tenemos una función de una variable.\",\n          \"isCorrect\": true,\n          \"text\": \"Usar la restricción para eliminar h\"\n        },\n        {\n          \"feedback\": \"Derivar parcialmente es válido, pero para este problema es más directo sustituir la restricción. Con h = 1000/(πr²), obtenemos C como función solo de r.\",\n          \"isCorrect\": false,\n          \"text\": \"Derivar respecto a ambas variables\"\n        },\n        {\n          \"feedback\": \"Asumir r = h es arbitrario y probablemente no nos dará el óptimo. Debemos usar la restricción de volumen para relacionar r y h matemáticamente.\",\n          \"isCorrect\": false,\n          \"text\": \"Fijar r = h para simplificar\"\n        }\n      ],\n      \"question\": \"¿Cómo reducimos a una sola variable?\"\n    },\n    {\n      \"context\": \"Bien, tenemos C(r) = 2πr² + 2000/r. Ahora necesito encontrar el valor de r que minimiza el costo. Derivé y obtuve C'(r) = 4πr - 2000/r². ¿Cómo encuentro los puntos críticos?\",\n      \"options\": [\n        {\n          \"feedback\": \"¡Exacto! Los puntos críticos son candidatos a extremos. Igualando 4πr - 2000/r² = 0, obtenemos 4πr³ = 2000, así que r³ = 500/π. La derivada no existe en r=0, pero eso está fuera del dominio físico.\",\n          \"isCorrect\": true,\n          \"text\": \"Donde C'(r) = 0 o no existe\"\n        },\n        {\n          \"feedback\": \"Casi. Los puntos críticos son donde la derivada es cero O donde no existe. Aquí C'(r) no existe en r=0, pero como el radio debe ser positivo, solo nos interesa donde C'(r) = 0.\",\n          \"isCorrect\": false,\n          \"text\": \"Solo donde C'(r) = 0\"\n        },\n        {\n          \"feedback\": \"No buscamos donde la función es cero, sino donde su derivada es cero. Los puntos críticos son donde C'(r) = 0 o no existe, no donde C(r) = 0.\",\n          \"isCorrect\": false,\n          \"text\": \"Donde C(r) = 0\"\n        },\n        {\n          \"feedback\": \"La segunda derivada se usa para clasificar puntos críticos, no para encontrarlos. Primero encontramos dónde C'(r) = 0, luego usamos C''(r) para determinar si es máximo o mínimo.\",\n          \"isCorrect\": false,\n          \"text\": \"Donde C''(r) = 0\"\n        }\n      ],\n      \"question\": \"¿Cómo encontramos los puntos críticos?\"\n    },\n    {\n      \"context\": \"De 4πr³ = 2000 obtuve r = ∛(500/π) ≈ 5.42 cm. Pero espera, {{NAME}}, encontrar un punto crítico no garantiza que sea un mínimo, ¿verdad? ¿Cómo confirmamos que este valor realmente minimiza el costo?\",\n      \"options\": [\n        {\n          \"feedback\": \"Solo hay un punto crítico en el dominio válido. Para confirmar que es mínimo, usamos la prueba de la segunda derivada: si C''(r) > 0 en ese punto, es un mínimo local.\",\n          \"isCorrect\": false,\n          \"text\": \"Comparar con otros puntos críticos\"\n        },\n        {\n          \"feedback\": \"¡Perfecto! Calculamos C''(r) = 4π + 4000/r³. Como r > 0, tenemos C''(r) > 0 siempre. En nuestro punto crítico, C''(r) > 0 confirma que es un mínimo local.\",\n          \"isCorrect\": true,\n          \"text\": \"Aplicar la prueba de segunda derivada\"\n        },\n        {\n          \"feedback\": \"Graficar puede ayudar visualmente, pero matemáticamente usamos la segunda derivada. Si C''(r) > 0 en el punto crítico, es un mínimo. Es más riguroso que una gráfica.\",\n          \"isCorrect\": false,\n          \"text\": \"Graficar la función completa\"\n        },\n        {\n          \"feedback\": \"Nunca asumimos. Debemos verificar con la prueba de segunda derivada: C''(r) = 4π + 4000/r³ > 0 para todo r > 0, lo que confirma matemáticamente que es un mínimo.\",\n          \"isCorrect\": false,\n          \"text\": \"Asumir que es mínimo por contexto\"\n        }\n      ],\n      \"question\": \"¿Cómo verificamos que es un mínimo?\"\n    },\n    {\n      \"context\": \"C''(r) = 4π + 4000/r³, que siempre es positivo para r > 0. Así que confirmamos que r ≈ 5.42 cm es un mínimo local. Pero {{NAME}}, el jefe siempre pregunta: ¿es el mínimo GLOBAL? ¿Cómo sabemos que no hay un costo menor en otro lugar?\",\n      \"options\": [\n        {\n          \"feedback\": \"No siempre. Pero aquí, como solo hay un punto crítico y el dominio es (0, ∞), debemos analizar el comportamiento en los extremos: cuando r→0⁺ y r→∞, C(r)→∞. Esto confirma que es global.\",\n          \"isCorrect\": false,\n          \"text\": \"Un mínimo local siempre es global\"\n        },\n        {\n          \"feedback\": \"¡Exacto! Los extremos globales pueden estar en puntos críticos O en los bordes. Aquí, cuando r→0⁺ el costo explota por 2000/r, y cuando r→∞ explota por 2πr². El único mínimo es nuestro punto crítico.\",\n          \"isCorrect\": true,\n          \"text\": \"Evaluar también los extremos del dominio\"\n        },\n        {\n          \"feedback\": \"La tercera derivada no determina si un extremo es global. Para eso, comparamos el valor en el punto crítico con los valores en los extremos del dominio (r→0⁺ y r→∞).\",\n          \"isCorrect\": false,\n          \"text\": \"Calcular la tercera derivada\"\n        },\n        {\n          \"feedback\": \"Tener un solo punto crítico no garantiza que sea global. Debemos verificar qué pasa en los extremos del dominio. Aquí, C(r)→∞ en ambos extremos, confirmando que es el mínimo global.\",\n          \"isCorrect\": false,\n          \"text\": \"Solo existe un punto crítico, es global\"\n        }\n      ],\n      \"question\": \"¿Cómo determinamos si es el mínimo global?\"\n    },\n    {\n      \"context\": \"Genial, tenemos r ≈ 5.42 cm y de ahí h = 1000/(π·5.42²) ≈ 10.84 cm. El costo mínimo está calculado. Le mandé el informe al cliente y... {{NAME}}, me acaba de responder. Dice que olvidó mencionar algo: el tanque debe caber en un espacio donde la altura no puede exceder 8 cm. ¡Nuestra solución óptima tiene h = 10.84 cm!\",\n      \"options\": [\n        {\n          \"feedback\": \"Nuestra solución tiene h = 10.84 cm, pero ahora h ≤ 8 cm. El punto óptimo original está FUERA del nuevo dominio factible. Necesitamos reoptimizar con la restricción adicional.\",\n          \"isCorrect\": false,\n          \"text\": \"Nada, el óptimo sigue siendo válido\"\n        },\n        {\n          \"feedback\": \"¡Correcto! Como nuestro óptimo sin restricción viola h ≤ 8, y la función es convexa, el mejor punto factible está en el borde: h = 8 cm. De ahí calculamos r = √(1000/8π) ≈ 6.31 cm.\",\n          \"isCorrect\": true,\n          \"text\": \"El óptimo ahora está en el borde h = 8\"\n        },\n        {\n          \"feedback\": \"Los multiplicadores de Lagrange son para restricciones de igualdad g(x,y) = 0. Aquí tenemos h ≤ 8, una desigualdad. El óptimo estará en el borde h = 8 porque la solución libre lo viola.\",\n          \"isCorrect\": false,\n          \"text\": \"Usamos multiplicadores de Lagrange\"\n        },\n        {\n          \"feedback\": \"No hay otro punto crítico interior. Como el óptimo sin restricción está fuera del dominio factible (h > 8), y la función es convexa, el mínimo factible está en el borde donde h = 8.\",\n          \"isCorrect\": false,\n          \"text\": \"Buscamos otro punto crítico interior\"\n        }\n      ],\n      \"question\": \"¿Qué cambia con esta nueva restricción?\"\n    },\n    {\n      \"context\": \"Con h = 8 cm fijo, r = √(1000/8π) ≈ 6.31 cm. El costo sube un poco, pero cumple la restricción. El cliente está contento... por ahora. Pero {{NAME}}, me preocupa algo. El proveedor ofrece un descuento si el radio está entre 5 y 7 cm. ¿Nuestro nuevo diseño califica?\",\n      \"options\": [\n        {\n          \"feedback\": \"¡Exacto! 6.31 está entre 5 y 7, así que calificamos para el descuento. A veces la suerte ayuda, pero fue el análisis riguroso lo que nos llevó a una solución que además resulta económicamente ventajosa.\",\n          \"isCorrect\": true,\n          \"text\": \"Sí, está dentro del rango\"\n        },\n        {\n          \"feedback\": \"Verifiquemos: 5 ≤ 6.31 ≤ 7 es verdadero. El radio de 6.31 cm SÍ está dentro del rango del descuento. ¡Buenas noticias para el presupuesto!\",\n          \"isCorrect\": false,\n          \"text\": \"No, necesitamos recalcular\"\n        },\n        {\n          \"feedback\": \"Incluso con variaciones de redondeo, 6.31 cm está cómodamente entre 5 y 7 cm. No es un caso límite; el radio cumple claramente con el requisito del descuento.\",\n          \"isCorrect\": false,\n          \"text\": \"Depende del redondeo que usemos\"\n        },\n        {\n          \"feedback\": \"Tenemos toda la información: r ≈ 6.31 cm y el rango es 5 ≤ r ≤ 7. Como 5 < 6.31 < 7, el radio cumple con el requisito para obtener el descuento.\",\n          \"isCorrect\": false,\n          \"text\": \"Falta información para determinarlo\"\n        }\n      ],\n      \"question\": \"¿El radio r ≈ 6.31 cm cumple con 5 ≤ r ≤ 7?\"\n    },\n    {\n      \"context\": \"Perfecto, calificamos para el descuento. Pero espera, {{NAME}}... el gerente de compras acaba de entrar a la oficina con cara de pánico. Dice que encontró un error en los datos que nos dieron. El material de la base NO cuesta el doble que las paredes... ¡cuesta la MITAD! Alguien invirtió los números en el correo original.\",\n      \"options\": [\n        {\n          \"feedback\": \"¡Exacto! La función objetivo cambia de C = 2πr² + 2πrh a C = 0.5πr² + 2πrh. Con costos diferentes, los puntos críticos serán distintos. Debemos rehacer todo el análisis desde el modelado.\",\n          \"isCorrect\": true,\n          \"text\": \"El óptimo cambia completamente\"\n        },\n        {\n          \"feedback\": \"No. El óptimo depende de la RELACIÓN entre costos. Si la base es más barata, convendrá un tanque más ancho y bajo. Toda la optimización cambia porque la función objetivo es diferente.\",\n          \"isCorrect\": false,\n          \"text\": \"Solo cambia el costo final, no el diseño\"\n        },\n        {\n          \"feedback\": \"No es un simple ajuste. Cambiar los coeficientes de la función objetivo mueve el punto donde la derivada es cero. El radio y altura óptimos serán completamente diferentes.\",\n          \"isCorrect\": false,\n          \"text\": \"Ajustamos el resultado por un factor\"\n        },\n        {\n          \"feedback\": \"La restricción h ≤ 8 puede o no ser activa con la nueva función. Con base más barata, el óptimo libre podría tener h < 8, haciendo irrelevante esa restricción. Hay que recalcular.\",\n          \"isCorrect\": false,\n          \"text\": \"La restricción de altura sigue dominando\"\n        }\n      ],\n      \"question\": \"¿Cómo afecta esto a nuestra optimización?\"\n    },\n    {\n      \"context\": \"Tienes razón, {{NAME}}. Con C = 0.5πr² + 2πrh y la restricción πr²h = 1000, sustituyo h = 1000/(πr²) y obtengo C(r) = 0.5πr² + 2000/r. La derivada es C'(r) = πr - 2000/r². Igualando a cero: πr³ = 2000, entonces r = ∛(2000/π) ≈ 8.60 cm. Y h = 1000/(π·8.60²) ≈ 4.30 cm.\",\n      \"options\": [\n        {\n          \"feedback\": \"¡Exacto! Con h ≈ 4.30 cm, la restricción h ≤ 8 se cumple automáticamente. El óptimo libre es factible. Con base más barata, conviene un tanque ancho y bajo, que naturalmente tiene poca altura.\",\n          \"isCorrect\": true,\n          \"text\": \"h < 8, la restricción ya no aplica\"\n        },\n        {\n          \"feedback\": \"Al contrario: h ≈ 4.30 cm es menor que 8 cm. La restricción h ≤ 8 se satisface holgadamente. Con base barata, el óptimo natural ya tiene poca altura.\",\n          \"isCorrect\": false,\n          \"text\": \"Violamos la restricción de altura\"\n        },\n        {\n          \"feedback\": \"Es cierto que r ≈ 8.60 cm > 7 cm, pero la observación clave es que h ≈ 4.30 < 8. La restricción de altura ya no es activa. El tema del descuento es secundario.\",\n          \"isCorrect\": false,\n          \"text\": \"El radio está fuera del rango de descuento\"\n        },\n        {\n          \"feedback\": \"Verificar C''(r) es correcto para confirmar que es mínimo, pero la observación importante aquí es que h ≈ 4.30 < 8: la restricción de altura ya no limita el diseño.\",\n          \"isCorrect\": false,\n          \"text\": \"Necesitamos verificar la segunda derivada\"\n        }\n      ],\n      \"question\": \"¿Qué observas sobre esta nueva solución óptima?\"\n    },\n    {\n      \"context\": \"Increíble cómo un cambio en los costos cambia todo el diseño. Pero {{NAME}}, el gerente de compras se quedó mirando los números y dice: 'Esperen... si el radio óptimo ahora es 8.60 cm, perdemos el descuento del proveedor que requería r entre 5 y 7'. ¿Vale la pena forzar r = 7 para obtener el descuento?\",\n      \"options\": [\n        {\n          \"feedback\": \"¡Exacto! Calculamos C(8.60) sin descuento y C(7) con descuento aplicado. Si el ahorro del descuento supera el incremento por alejarnos del óptimo, conviene r = 7. Es optimización con restricciones discretas.\",\n          \"isCorrect\": true,\n          \"text\": \"Comparar costos: óptimo vs r = 7 con descuento\"\n        },\n        {\n          \"feedback\": \"El óptimo matemático minimiza C(r), pero no considera el descuento. En la vida real, debemos comparar: ¿el descuento compensa el costo extra de usar r = 7 en vez de r = 8.60?\",\n          \"isCorrect\": false,\n          \"text\": \"El óptimo matemático siempre es mejor\"\n        },\n        {\n          \"feedback\": \"Los multiplicadores de Lagrange son para restricciones continuas tipo g(x,y) = 0. El descuento es una decisión discreta. Simplemente comparamos los costos totales de ambas opciones.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar multiplicadores de Lagrange\"\n        },\n        {\n          \"feedback\": \"No necesariamente. Depende del porcentaje del descuento y cuánto aumenta C(r) al movernos de r = 8.60 a r = 7. Hay que hacer las cuentas para decidir.\",\n          \"isCorrect\": false,\n          \"text\": \"El descuento siempre vale la pena\"\n        }\n      ],\n      \"question\": \"¿Cómo evaluamos si conviene forzar r = 7?\"\n    },\n    {\n      \"context\": \"Calculé ambos escenarios. Con r = 8.60 el costo es C ≈ 348 unidades. Con r = 7 es C ≈ 363 unidades, pero el descuento del 10% lo baja a ≈ 327 unidades. ¡El descuento SÍ conviene! {{NAME}}, esto es fascinante: el óptimo matemático no siempre es el óptimo económico real.\",\n      \"options\": [\n        {\n          \"feedback\": \"Es cierto, pero la lección más profunda es sobre el modelado. Nuestro modelo inicial no incluía el descuento. Al agregar esa realidad, la decisión óptima cambió. El modelo debe capturar todo lo relevante.\",\n          \"isCorrect\": false,\n          \"text\": \"Las restricciones del mundo real importan\"\n        },\n        {\n          \"feedback\": \"¡Exacto! Modelar el problema correctamente es la mitad del trabajo. Empezamos con costos incorrectos, luego apareció la restricción de altura, luego el descuento. Cada cambio en el modelo cambió la solución óptima.\",\n          \"isCorrect\": true,\n          \"text\": \"Modelar correctamente es fundamental\"\n        },\n        {\n          \"feedback\": \"La segunda derivada sí sirvió para confirmar mínimos. La lección es más amplia: el modelo matemático debe reflejar la realidad completa, incluyendo restricciones y factores económicos como descuentos.\",\n          \"isCorrect\": false,\n          \"text\": \"La segunda derivada no sirve aquí\"\n        },\n        {\n          \"feedback\": \"Los puntos críticos fueron esenciales en cada iteración. La lección es que el MODELO debe ser correcto primero. Cambiar costos, agregar restricciones o descuentos cambia todo el problema de optimización.\",\n          \"isCorrect\": false,\n          \"text\": \"Los puntos críticos son irrelevantes\"\n        }\n      ],\n      \"question\": \"¿Qué lección clave nos deja este caso?\"\n    },\n    {\n      \"context\": \"{{NAME}}, acabo de colgar con el cliente. Le expliqué todo: radio 7 cm, altura calculada de la restricción de volumen, y el descuento que obtuvimos. Está encantado. Pero antes de celebrar, me preguntó algo que me dejó pensando: '¿Y si en el futuro necesitamos optimizar con DOS restricciones simultáneas?'\",\n      \"options\": [\n        {\n          \"feedback\": \"¡Perfecto! Para optimizar f(x,y,z) sujeto a g₁ = 0 y g₂ = 0, usamos multiplicadores de Lagrange: ∇f = λ₁∇g₁ + λ₂∇g₂. Los gradientes deben ser combinación lineal. Es la herramienta para restricciones múltiples.\",\n          \"isCorrect\": true,\n          \"text\": \"Multiplicadores de Lagrange\"\n        },\n        {\n          \"feedback\": \"Con dos restricciones y tres variables, la sustitución puede funcionar, pero se complica. Multiplicadores de Lagrange es el método sistemático: ∇f = λ₁∇g₁ + λ₂∇g₂ maneja múltiples restricciones elegantemente.\",\n          \"isCorrect\": false,\n          \"text\": \"Sustituir ambas restricciones\"\n        },\n        {\n          \"feedback\": \"Las restricciones actúan simultáneamente, no por separado. Para optimización con múltiples restricciones de igualdad, usamos multiplicadores de Lagrange, que requiere que ∇f sea combinación lineal de los ∇gᵢ.\",\n          \"isCorrect\": false,\n          \"text\": \"Resolver cada restricción por separado\"\n        },\n        {\n          \"feedback\": \"Ignorar una restricción daría una solución no factible. Con restricciones múltiples, usamos multiplicadores de Lagrange: la condición ∇f = λ₁∇g₁ + λ₂∇g₂ garantiza optimalidad respetando todas las restricciones.\",\n          \"isCorrect\": false,\n          \"text\": \"Ignorar una restricción\"\n        }\n      ],\n      \"question\": \"¿Qué técnica usaríamos con dos restricciones de igualdad?\"\n    },\n    {\n      \"context\": \"Exacto, multiplicadores de Lagrange. El cliente quedó impresionado con nuestra explicación. Dijo que tiene otro proyecto: optimizar el diseño de una caja con volumen fijo Y superficie total fija. Dos restricciones. Quiere que lo ayudemos la próxima semana. {{NAME}}, creo que le demostramos que sabemos lo que hacemos.\",\n      \"options\": [\n        {\n          \"feedback\": \"Derivar es solo una parte. Hoy vimos que primero hay que modelar bien, luego encontrar puntos críticos, clasificarlos con la segunda derivada, verificar los extremos del dominio, y adaptar a restricciones reales.\",\n          \"isCorrect\": false,\n          \"text\": \"Derivar, igualar a cero, y listo\"\n        },\n        {\n          \"feedback\": \"¡Exacto! El proceso completo: 1) Modelar función objetivo y restricciones, 2) Encontrar puntos críticos (derivada = 0), 3) Clasificar con segunda derivada, 4) Evaluar extremos del dominio, 5) Adaptar a restricciones del mundo real.\",\n          \"isCorrect\": true,\n          \"text\": \"Modelar, encontrar críticos, verificar extremos\"\n        },\n        {\n          \"feedback\": \"Los multiplicadores son para restricciones de igualdad específicas. Hoy usamos sustitución directa y análisis de bordes. El enfoque completo incluye modelar, encontrar críticos, clasificarlos y verificar extremos.\",\n          \"isCorrect\": false,\n          \"text\": \"Usar siempre multiplicadores de Lagrange\"\n        },\n        {\n          \"feedback\": \"La intuición ayuda, pero vimos que los números sorprenden. Cambiar costos invirtió el diseño óptimo. El método riguroso —modelar, derivar, clasificar, verificar extremos— es lo que garantiza la mejor solución.\",\n          \"isCorrect\": false,\n          \"text\": \"Confiar en la intuición de ingeniería\"\n        }\n      ],\n      \"question\": \"¿Qué resume mejor nuestro enfoque de hoy?\"\n    }\n  ]\n}",
      "outputTokens": 6177,
      "systemPrompt": "# Role\n\nYou are an expert interactive story designer creating a **Story** activity for a learning app. Your mission is to place learners in a first-person dialogue scenario where they work alongside a colleague to solve a real-world problem using the lesson's concepts.\n\nYou specialize in crafting immersive, dialogue-driven experiences that make learners feel like they're actually solving problems in their field — not just answering quiz questions.\n\n# The Art of Dialogue-Driven Learning\n\nA great Story activity doesn't lecture or test recall — it puts learners IN the situation. Think of it like an interactive movie where the learner IS the main character, making real decisions that matter.\n\n## Why Dialogue Scenarios Work\n\n1. **Authentic Context**: When learners apply concepts to solve realistic problems with a colleague, they see WHY the knowledge matters to them personally.\n\n2. **Active Reasoning**: Making decisions in context requires thinking through principles, not just recognizing memorized facts.\n\n3. **Emotional Investment**: Dialogue creates stakes. The learner cares about the outcome because they're part of the story.\n\n## The Collaborative Problem-Solving Principle\n\nEvery great Story activity creates a sense of partnership:\n\n- **Shared Goal**: You and your colleague are tackling something together\n- **Natural Dialogue**: Conversations feel like real workplace exchanges\n- **Meaningful Choices**: Each decision requires applying what you've learned\n- **Satisfying Resolution**: The problem gets solved and the takeaway sticks\n\n## Why Pure Dialogue Works\n\nEach scene should feel like you're eavesdropping on a real conversation — no narrator, no stage directions, just two people working through a problem. Pure dialogue:\n\n- Immerses learners completely in the scenario\n- Makes abstract concepts feel like lived experience\n- Creates natural pacing through back-and-forth exchange\n- Lets context emerge organically from what people say\n\n# Inputs\n\n- `LESSON_TITLE`: The topic to create a story around\n- `LESSON_DESCRIPTION`: Additional context about what this lesson covers\n- `CHAPTER_TITLE`: The chapter context (for understanding scope)\n- `COURSE_TITLE`: The course context (for understanding audience level)\n- `LANGUAGE`: Output language\n- `EXPLANATION_STEPS`: Array of {title, text} from all explanation activities (Background, Explanation, Mechanics, Examples) the learner completed before this one\n\n## Language Guidelines\n\n- `en`: Use US English unless the content is region-specific\n- `pt`: Use Brazilian Portuguese unless the content is region-specific\n- `es`: Use Latin American Spanish unless the content is region-specific\n\n# Requirements\n\n## Scene Structure\n\nEach scene must have:\n\n- **context**: Maximum 500 characters. Pure dialogue only — no narrator, no character name prefixes (like \"Sarah:\"), no descriptions. This is what your colleague says to you, setting up the decision point.\n- **question**: Maximum 100 characters. A short, clear question about what to do next.\n- **options**: Exactly 4 choices, each with:\n  - **text**: The answer choice (max 50 characters)\n  - **isCorrect**: Boolean indicating if this is the correct answer (exactly 1 must be true)\n  - **feedback**: Why this choice is right (with insight) or wrong (and what would be correct) — max 300 characters\n\n## Story Arc\n\nYour story must follow this structure:\n\n1. **Opening Scene**: Begin \"in the middle of the action\" — the learner and colleague are already working on something. No preamble or setup exposition.\n2. **Rising Complexity**: Each scene builds naturally from the previous dialogue. Decisions compound.\n3. **Plot Twist**: The second-to-last scene introduces an unexpected complication, surprise, or revelation.\n4. **Resolution**: The final scene resolves the problem AND reinforces the main learning takeaway.\n\n## Scene Count\n\n- Minimum: 7 scenes\n- Maximum: 20 scenes\n- Let the problem's complexity dictate the length. A simple concept might need 7-10 scenes; a complex one might need 15-20.\n\n## Tone & Style\n\n- **Pure dialogue**: NO narrator, NO character name prefixes, NO descriptions of actions or settings\n- **Natural conversation**: Write how colleagues actually talk on Slack when solving a problem together — casual, collaborative, sometimes humorous\n- **Professional but warm**: Light, smart humor when appropriate. Never forced or cheesy.\n- **Second-person immersion**: The colleague speaks TO the learner. Context emerges from what's said.\n- **Continuous flow**: Each scene's dialogue should naturally lead into the next\n\n## The {{NAME}} Placeholder\n\nUse `{{NAME}}` wherever the learner's name should appear in dialogue. For example:\n\n- \"{{NAME}}, I think we might have a problem here.\"\n- \"Good catch, {{NAME}}. That's exactly what I was thinking.\"\n\nThis personalizes the experience without requiring actual name input at content creation time.\n\n## Decision Design\n\nEvery decision must:\n\n- **Require reasoning**: Learners must apply principles from the lesson, not recall specific phrases\n- **Feel realistic**: These are choices someone might actually face in this situation\n- **Have plausible distractors**: Wrong options should be tempting but flawed for specific reasons\n- **Avoid \"obvious\" correct answers**: The right choice should require thought, not be the only non-silly option\n\n## What to Avoid\n\n- Narrator text (\"Meanwhile...\" or \"You walk into the office...\")\n- Character name prefixes (\"Sarah:\" or \"Your colleague says:\")\n- Description of actions or settings (except through dialogue itself)\n- Questions that test memorization of facts from earlier activities\n- Obvious \"correct\" answers that don't require applying the concept\n- Silly or clearly wrong distractors that no reasonable person would choose\n- Breaking the fourth wall or meta-commentary\n- Starting with \"In this activity...\" or setup exposition\n\n## Scope\n\n- **Stay focused**: The problem should specifically require THIS lesson's concept to solve\n- **Don't expand**: Other lessons cover related topics — this story tests this lesson\n- **Don't narrow**: If the lesson is broad, the problem should engage multiple aspects of it\n\n## Relationship to Previous Activities\n\nThe learner has already completed:\n\n- **Background**: WHY this exists (origin story, problems solved, historical context)\n- **Explanation**: WHAT it is (core concepts, components, definitions)\n- **Mechanics**: HOW it works (processes in action, cause-effect chains)\n- **Examples**: WHERE it appears (real-world contexts, applications)\n\nYour Story activity answers WHEN DO I USE THIS? (applying concepts to solve realistic problems). These complement each other:\n\n- Background: \"WHY did we need this?\"\n- Explanation: \"WHAT exactly is it?\"\n- Mechanics: \"HOW does it actually work?\"\n- Examples: \"WHERE will I encounter this?\"\n- Story: \"WHEN do I apply this to solve real problems?\"\n\nThe learner knows what the concept IS, how it WORKS, and where they'll SEE it. Now they practice USING it in a realistic scenario.\n\n# Structure Guide\n\nWhile every story is unique, most follow this arc (adapt as needed):\n\n1. **The Hook**: Jump straight into the situation. Something needs to be figured out or decided.\n2. **Initial Assessment**: What's the situation? What do we know? First decisions.\n3. **Deepening Complexity**: The problem has layers. Apply the concept more deeply.\n4. **Complications**: Things aren't as simple as they seemed. Adapt your approach.\n5. **The Twist**: A surprise, revelation, or unexpected turn that requires rethinking.\n6. **The Resolution**: Solve the problem AND crystallize the key insight from the lesson.\n\nNote: Sometimes the final twist can have a humorous or unexpected resolution that still reinforces the learning. Something that makes the learner smile and think \"I didn't see that coming!\"\n\n# Dialogue Tone Examples\n\nThe following examples show the **tone and style** to aim for — not complete scenes, just the kind of dialogue that makes stories feel alive. Adapt freely to your topic.\n\n## Opening Hooks (Jump Into the Action)\n\n> \"{{NAME}}, I've been staring at this bug for an hour. The shopping cart total keeps showing yesterday's prices. The database is fine. Something's wrong with how we're storing them.\"\n\n> \"Okay, {{NAME}}, the client just called. Their entire inventory system crashed right before Black Friday. They're panicking. We need to figure this out fast.\"\n\n> \"{{NAME}}, you're not going to believe this. Remember that algorithm we deployed last week? It's been recommending the exact opposite of what users want. Sales are tanking.\"\n\n## Building Tension (Problems Get Deeper)\n\n> \"Wait. If this pattern is everywhere in the codebase... inventory counts, user roles, discount percentages... we might have a much bigger problem than I thought.\"\n\n> \"Hold on. The logs show someone accessed the admin panel at 3 AM last night. But nobody on the team was working then. {{NAME}}, who else has those credentials?\"\n\n> \"The numbers don't add up. We're showing 500 successful transactions, but the bank only received 487. Where did the other 13 go?\"\n\n## Plot Twists (The Unexpected Turn)\n\n> \"{{NAME}}... I just ran the analysis twice. The bug isn't in our code. It's been in the library we've trusted for three years. Every project using it has this vulnerability.\"\n\n> \"I found the source of the data leak. {{NAME}}, it's not a hacker. It's our own caching system. We've been accidentally exposing user data to anyone who knew where to look.\"\n\n> \"Plot twist: the 'broken' feature? It's working exactly as designed. The original spec was just... completely wrong. We've been solving the wrong problem this whole time.\"\n\n## Humorous Moments (Light Relief)\n\n> \"Well, {{NAME}}, the good news is we found the bug. The bad news? It's been there since 2019. The worse news? I wrote it. The even worse news? So did you. We pair-programmed this disaster together.\"\n\n> \"Congratulations, {{NAME}}. We just spent four hours debugging what turned out to be a typo. 'userID' vs 'userId'. Camel case strikes again.\"\n\n> \"{{NAME}}, remember when I said 'this should be a quick fix'? That was three coffees and one existential crisis ago.\"\n\n## Satisfying Resolutions (Problem Solved + Insight Crystallized)\n\n> \"There it is. The fix works. {{NAME}}, I don't think I'll ever forget this — always check if your data source can change while you're holding onto a copy of it.\"\n\n> \"We did it. The system's stable. You know what the real lesson here was? Sometimes the simplest explanation IS the right one. We kept looking for complex bugs when the answer was right in front of us.\"\n\n> \"That's it — problem solved, client happy, crisis averted. {{NAME}}, I think we just learned more about distributed systems in the last hour than in any textbook.\"\n\n## Unexpected/Funny Endings\n\n> \"So after all that debugging... it was a timezone issue. Every single time. I'm starting to think all bugs are secretly timezone issues in disguise.\"\n\n> \"{{NAME}}, the CEO just called to thank us. Apparently fixing that 'minor bug' saved them $2 million. I think we need to renegotiate our rates.\"\n\n> \"The system's fixed. Also, I may have accidentally discovered that our competitor's product has the exact same bug. Should we... tell them? Actually, don't answer that.\"\n\nRemember: These are just **tone examples**. Your story should be original, fit the lesson topic, and create its own memorable journey. Mix problem-solving tension with moments of humor or surprise. The best stories make learners think \"I didn't see that coming!\" while still teaching the concept.\n\n# Quality Checks\n\nBefore finalizing, verify:\n\n- [ ] Is the dialogue pure conversation with NO narrator, NO character prefixes, NO descriptions?\n- [ ] Does every scene flow naturally from the previous one (continuous story)?\n- [ ] Do all decisions require applying lesson concepts, not just recalling facts?\n- [ ] Is there a genuine plot twist in the second-to-last scene?\n- [ ] Does the resolution both solve the problem AND reinforce the main learning?\n- [ ] Is `{{NAME}}` used appropriately to personalize the dialogue?\n- [ ] Are all distractors plausible (not obviously silly)?\n- [ ] Does the story feel like a real workplace conversation, not a quiz in disguise?\n- [ ] Is the scope exactly the lesson topic — not broader or narrower?\n- [ ] Are all constraints met (context ≤500 chars, question ≤100 chars, options ≤50 chars each, feedback ≤300 chars each)?\n- [ ] Is the scene count between 7 and 20?\n\n# Output Format\n\nReturn an array of scenes, each with:\n\n- **context**: Pure dialogue from colleague (max 500 chars)\n- **question**: Decision prompt (max 100 chars)\n- **options**: Array of exactly 4 objects, each with:\n  - **text**: The answer choice (max 50 chars)\n  - **isCorrect**: Boolean (exactly 1 must be true, 3 must be false)\n  - **feedback**: Why right or wrong (max 300 chars)\n\nUse 7-20 scenes to tell a complete, engaging story. Let the problem's complexity dictate the length.\n",
      "testCaseId": "es-math-calculus-optimization-1",
      "userPrompt": "LESSON_TITLE: Optimizacion con Calculo\nLESSON_DESCRIPTION: Aplicando tecnicas de calculo para encontrar optimos en problemas de ingenieria y negocios\nCHAPTER_TITLE: Aplicaciones del Calculo\nCOURSE_TITLE: Calculo para Ingenieria\nLANGUAGE: es\nEXPLANATION_STEPS:\n1. Puntos Criticos: Los puntos criticos son donde la derivada es cero o no existe. Son CANDIDATOS a extremos — no todos los puntos criticos son maximos o minimos.\n2. Prueba de Segunda Derivada: La prueba de la segunda derivada determina el tipo: si f''(x) > 0 en un punto critico, es minimo local; si f''(x) < 0, es maximo local; si f''(x) = 0, la prueba no concluye.\n3. Extremos Globales: Los extremos globales pueden estar en puntos criticos O en los extremos del dominio. Siempre evalua tambien los bordes del intervalo.\n4. Multiplicadores de Lagrange: Optimizacion con restricciones usa multiplicadores de Lagrange. Maximizar f(x,y) sujeto a g(x,y)=0 requiere que los gradientes sean paralelos.\n5. Modelado del Problema: Modelar el problema correctamente es la mitad del trabajo. Define la funcion objetivo, identifica las restricciones, y expresa todo en terminos de las variables relevantes."
    }
  ],
  "taskId": "activity-story"
}
